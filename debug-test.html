<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HypoLab ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .test-section {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .test-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        .status {
            font-size: 20px;
        }
        .pass { color: #10b981; }
        .fail { color: #ef4444; }
        .pending { color: #f59e0b; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #2563eb;
        }
        #console-log {
            background: #000;
            color: #0f0;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .error-log {
            color: #f00;
        }
        .info-log {
            color: #0af;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª HypoLab ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ è‡ªå‹•ãƒ†ã‚¹ãƒˆé …ç›®</h2>
        <div id="test-results"></div>
        <button onclick="runAllTests()">ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
    </div>

    <div class="test-section">
        <h2>ğŸ” LocalStorage ãƒ‡ãƒ¼ã‚¿ç¢ºèª</h2>
        <button onclick="checkLocalStorage()">ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</button>
        <button onclick="clearLocalStorage()">ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ³¨æ„ï¼ï¼‰</button>
        <div id="storage-info" style="margin-top: 10px;"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ’» ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°</h2>
        <div id="console-log"></div>
        <button onclick="clearConsole()">ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <script>
        const testResults = document.getElementById('test-results');
        const consoleLog = document.getElementById('console-log');
        const storageInfo = document.getElementById('storage-info');

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole(args.join(' '), 'warn');
        };

        function addToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error-log' : type === 'info' ? 'info-log' : '';
            consoleLog.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function clearConsole() {
            consoleLog.innerHTML = '';
        }

        // ãƒ†ã‚¹ãƒˆå®šç¾©
        const tests = [
            {
                name: 'LocalStorageãŒåˆ©ç”¨å¯èƒ½',
                test: () => {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return true;
                    } catch (e) {
                        return false;
                    }
                }
            },
            {
                name: 'HypoLabãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹',
                test: () => {
                    const data = localStorage.getItem('hypolab_local_data');
                    return data !== null;
                }
            },
            {
                name: 'ãƒ‡ãƒ¼ã‚¿ãŒæ­£ã—ã„JSONå½¢å¼',
                test: () => {
                    const data = localStorage.getItem('hypolab_local_data');
                    if (!data) return false;
                    try {
                        JSON.parse(data);
                        return true;
                    } catch (e) {
                        return false;
                    }
                }
            },
            {
                name: 'å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹',
                test: () => {
                    const data = localStorage.getItem('hypolab_local_data');
                    if (!data) return false;
                    try {
                        const parsed = JSON.parse(data);
                        return parsed.hasOwnProperty('currentHypotheses') &&
                               parsed.hasOwnProperty('completedHypotheses') &&
                               parsed.hasOwnProperty('cards');
                    } catch (e) {
                        return false;
                    }
                }
            },
            {
                name: 'DOMè¦ç´ ãŒå­˜åœ¨ã™ã‚‹ï¼ˆãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼‰',
                test: () => {
                    // iframeçµŒç”±ã§ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
                    return new Promise((resolve) => {
                        const iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.src = 'hypolab-local.html';
                        iframe.onload = () => {
                            try {
                                const doc = iframe.contentDocument;
                                const homeView = doc.getElementById('home-view');
                                const navButtons = doc.querySelectorAll('.nav-btn');
                                const result = homeView !== null && navButtons.length > 0;
                                document.body.removeChild(iframe);
                                resolve(result);
                            } catch (e) {
                                document.body.removeChild(iframe);
                                resolve(false);
                            }
                        };
                        document.body.appendChild(iframe);
                    });
                }
            },
            {
                name: 'Service WorkerãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹',
                test: async () => {
                    if (!('serviceWorker' in navigator)) return false;
                    const registrations = await navigator.serviceWorker.getRegistrations();
                    return registrations.length > 0;
                }
            }
        ];

        async function runAllTests() {
            testResults.innerHTML = '';
            
            for (const testDef of tests) {
                const item = document.createElement('div');
                item.className = 'test-item';
                
                try {
                    const result = await testDef.test();
                    item.innerHTML = `
                        <span class="status ${result ? 'pass' : 'fail'}">${result ? 'âœ…' : 'âŒ'}</span>
                        <span>${testDef.name}</span>
                    `;
                    console.log(`ãƒ†ã‚¹ãƒˆ: ${testDef.name} - ${result ? 'PASS' : 'FAIL'}`);
                } catch (e) {
                    item.innerHTML = `
                        <span class="status fail">âŒ</span>
                        <span>${testDef.name} (ã‚¨ãƒ©ãƒ¼: ${e.message})</span>
                    `;
                    console.error(`ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${testDef.name}`, e);
                }
                
                testResults.appendChild(item);
            }
        }

        function checkLocalStorage() {
            const data = localStorage.getItem('hypolab_local_data');
            if (!data) {
                storageInfo.innerHTML = '<p style="color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“</p>';
                return;
            }

            try {
                const parsed = JSON.parse(data);
                const info = `
                    <div style="margin-top: 10px;">
                        <p><strong>ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:</strong> ${(data.length / 1024).toFixed(2)} KB</p>
                        <p><strong>ç¾åœ¨ã®ç¿’æ…£æ•°:</strong> ${parsed.currentHypotheses?.length || 0}</p>
                        <p><strong>å®Œäº†ã—ãŸç¿’æ…£æ•°:</strong> ${parsed.completedHypotheses?.length || 0}</p>
                        <p><strong>ã‚«ãƒ¼ãƒ‰æ‰€æŒæ•°:</strong> ${parsed.cards?.inventory?.length || 0}</p>
                        <p><strong>ç²å¾—ãƒãƒƒã‚¸æ•°:</strong> ${parsed.unlockedBadges?.length || 0}</p>
                    </div>
                `;
                storageInfo.innerHTML = info;
                console.log('LocalStorageãƒ‡ãƒ¼ã‚¿:', parsed);
            } catch (e) {
                storageInfo.innerHTML = '<p style="color: #ef4444;">ãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
                console.error('ãƒ‡ãƒ¼ã‚¿è§£æã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        function clearLocalStorage() {
            if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                localStorage.removeItem('hypolab_local_data');
                localStorage.removeItem('lastAffirmationCheck');
                storageInfo.innerHTML = '<p style="color: #10b981;">ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ</p>';
                console.log('LocalStorageã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
        window.addEventListener('DOMContentLoaded', () => {
            console.log('ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
            console.log('User Agent:', navigator.userAgent);
            console.log('Screen Size:', `${screen.width}x${screen.height}`);
            console.log('Window Size:', `${window.innerWidth}x${window.innerHeight}`);
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (e) => {
            console.error('ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', e.message, 'at', e.filename, ':', e.lineno);
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('æœªå‡¦ç†ã®Promiseã‚¨ãƒ©ãƒ¼:', e.reason);
        });
    </script>
</body>
</html>