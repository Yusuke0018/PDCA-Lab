<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>HypoLab - ç¿’æ…£ãƒˆãƒ©ãƒƒã‚«ãƒ¼</title>
    
    <!-- PWAå¯¾å¿œ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.webmanifest">
    <link rel="icon" href="icons/icon.svg" sizes="any" type="image/svg+xml">
    <link rel="apple-touch-icon" href="icons/icon.svg">
    
    <style>
        /* ãƒªã‚»ãƒƒãƒˆ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* CSSå¤‰æ•° - ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
        :root {
            --primary: #10b981;
            --secondary: #3b82f6;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --gradient-1: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            --gradient-2: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);
            --gradient-3: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ï¼ˆJSã§å®Ÿæ¸¬ã—æ›´æ–°ï¼‰ */
            --header-height: 56px;
            /* ã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ï¼ˆiOS notchå¯¾å¿œï¼‰ */
            --safe-top: env(safe-area-inset-top, 0px);
        }

        /* ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ - ãƒ¢ãƒ€ãƒ³ã§æ´—ç·´ã•ã‚ŒãŸé…è‰² */
        :root.light-theme {
            --primary: #16a34a;
            --secondary: #3b82f6;
            --background: #fafafa;
            --surface: #ffffff;
            --surface-light: #f3f4f6;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border: rgba(0, 0, 0, 0.06);
            --gradient-1: linear-gradient(135deg, #34d399 0%, #60a5fa 100%);
            --gradient-2: linear-gradient(135deg, #a78bfa 0%, #f472b6 100%);
            --gradient-3: linear-gradient(135deg, #fbbf24 0%, #f87171 100%);
        }

        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            background: var(--surface);
            padding: 16px 20px;
            padding-top: calc(16px + var(--safe-top));
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            min-height: var(--header-height);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h1 {
            font-size: 24px;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ */
        .nav {
            background: rgba(30, 41, 59, 0.95);
            border-bottom: 1px solid var(--border);
            position: sticky;
            /* ãƒ˜ãƒƒãƒ€ãƒ¼ç›´ä¸‹ã«å¸ç€ã—ã€éš™é–“ã‚’ãªãã™ */
            top: var(--header-height);
            z-index: 99;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }

        .nav-content::-webkit-scrollbar {
            display: none;
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 16px 20px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            white-space: nowrap;
        }

        .nav-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--gradient-1);
            transition: width 0.3s;
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active {
            color: var(--text-primary);
        }

        .nav-btn.active::after {
            width: 100%;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .container {
            flex: 1;
            /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’ãªãã—ã¦ãƒŠãƒ“ç›´ä¸‹ã«æƒãˆã‚‹ */
            padding: 0 20px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* ã‚«ãƒ¼ãƒ‰å…±é€š */
        .card {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            box-sizing: border-box;
            width: 100%;
        }
        
        /* çµ±è¨ˆãƒ‘ãƒãƒ«å…±é€š */
        .stat-panel {
            box-sizing: border-box;
            width: 100%;
            overflow: hidden;
        }
        
        .stats-grid {
            box-sizing: border-box;
            width: 100%;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover::before {
            opacity: 1;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--gradient-1);
            color: white;
            border: none;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--surface-light);
            border: 1px solid var(--border);
            color: var(--text);
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #475569;
            box-shadow: 0 10px 30px rgba(71, 85, 105, 0.3);
            border-color: var(--primary);
        }

        /* ç¿’æ…£ãƒªã‚¹ãƒˆ */
        .hypothesis-list {
            display: grid;
            gap: 16px;
        }

        .hypothesis-item {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            user-select: none;
        }

        .hypothesis-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }
        
        .hypothesis-item.deleting {
            animation: pulse-delete 0.5s ease-in-out;
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        @keyframes pulse-delete {
            0% { transform: scale(1); }
            50% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        .hypothesis-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .hypothesis-description {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .hypothesis-meta {
            display: flex;
            gap: 16px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .hypothesis-days {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hypothesis-progress {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input, textarea {
            width: 100%;
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 16px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«é¸æŠ */
        .duration-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .duration-option {
            background: var(--surface-light);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .duration-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .duration-option.selected {
            background: var(--gradient-1);
            border-color: transparent;
            color: white;
        }

        .duration-option h3 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .duration-option p {
            font-size: 14px;
            opacity: 0.8;
        }

        /* ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .shuffle-container {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .shuffle-number {
            font-size: 80px;
            font-weight: 800;
            margin: 20px 0;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes shuffle {
            0% { transform: scale(1) rotate(0deg); opacity: 1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.5; }
            100% { transform: scale(1) rotate(360deg); opacity: 1; }
        }

        .shuffling {
            animation: shuffle 0.3s ease-in-out;
        }

        @keyframes slideIn {
            0% { 
                opacity: 0;
                transform: translateY(-10px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
        .calendar-container {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-size: 20px;
            font-weight: 600;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(40px, 1fr));
            gap: 8px;
            min-width: 320px;
            position: relative;
        }
        
        .week-info {
            grid-column: 1 / -1;
            padding: 6px 12px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            border-radius: 8px;
            margin: 4px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid var(--border);
        }
        
        .week-info .progress {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .week-info .progress-bar {
            width: 80px;
            height: 6px;
            background: var(--surface-dark);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .week-info .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            transition: width 0.3s ease;
        }

        @media (max-width: 640px) {
            .calendar-grid {
                gap: 4px;
            }
        }

        .day-cell {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            padding: 5px;
        }
        
        .day-cell small {
            font-size: 12px;
            font-weight: 400;
            color: var(--text-secondary);
            line-height: 1;
        }

        .day-cell::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.05);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .day-cell:hover::before {
            opacity: 1;
        }

        .day-cell.achieved {
            background: var(--gradient-1);
            color: white;
            position: relative;
            animation: achievedPulse 0.5s ease-out;
        }

        @keyframes achievedPulse {
            0% { 
                transform: scale(0.8) rotate(0deg);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            25% {
                transform: scale(1.3) rotate(90deg);
                box-shadow: 0 0 20px 10px rgba(16, 185, 129, 0.3);
            }
            50% { 
                transform: scale(1.1) rotate(180deg);
                box-shadow: 0 0 30px 20px rgba(16, 185, 129, 0.1);
            }
            75% {
                transform: scale(1.2) rotate(270deg);
                box-shadow: 0 0 10px 30px rgba(16, 185, 129, 0);
            }
            100% { 
                transform: scale(1) rotate(360deg);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .day-cell.achieved::after {
            content: 'âœ¨';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            animation: sparkle 1s ease-in-out;
        }

        @keyframes sparkle {
            0% {
                transform: scale(0) rotate(0deg) translateY(0);
                opacity: 0;
            }
            25% {
                transform: scale(1.8) rotate(90deg) translateY(-10px);
                opacity: 1;
            }
            50% {
                transform: scale(1.5) rotate(180deg) translateY(-5px);
                opacity: 1;
            }
            75% {
                transform: scale(1.3) rotate(270deg) translateY(-8px);
                opacity: 0.8;
            }
            100% {
                transform: scale(1) rotate(360deg) translateY(0);
                opacity: 1;
            }
        }

        /* ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .card-item {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
            cursor: pointer;
        }

        .card-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-item.reward {
            border-color: var(--primary);
        }

        .card-item.penalty {
            border-color: #ef4444;
        }

        .card-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .card-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .card-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .card-count {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--primary);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
        }

        @keyframes cardFlip {
            0% {
                transform: rotateY(0deg) scale(0.8);
                opacity: 0;
            }
            50% {
                transform: rotateY(180deg) scale(1.2);
            }
            100% {
                transform: rotateY(360deg) scale(1);
                opacity: 1;
            }
        }

        .card-reveal {
            animation: cardFlip 0.8s ease-out;
        }

        /* ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes penaltyShake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        .penalty-effect {
            animation: penaltyShake 0.5s ease-out;
            border: 3px solid #ef4444 !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãƒœã‚¿ãƒ³ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        @keyframes effortPulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(16, 185, 129, 0);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        @keyframes effortStar {
            0% {
                transform: translateY(0) rotate(0deg) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) rotate(360deg) scale(0);
                opacity: 0;
            }
        }

        .effort-click-effect {
            animation: effortPulse 0.4s ease-out;
        }

        .effort-star-particle {
            position: absolute;
            font-size: 20px;
            pointer-events: none;
            animation: effortStar 0.8s ease-out forwards;
            z-index: 1000;
        }

        .day-cell.not-achieved {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .day-cell.future {
            background: rgba(255, 255, 255, 0.02);
            color: var(--text-secondary);
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é€²æ—è¡¨ç¤º */
        .progress-container {
            background: var(--surface);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
        }

        .progress-percentage {
            font-size: 36px;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .progress-bar {
            background: var(--surface-light);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 16px;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-1);
            transition: width 0.5s ease-out;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: var(--surface-light);
            color: var(--text-primary);
        }

        /* é”æˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .achievement-animation {
            position: fixed;
            font-size: 60px;
            z-index: 2000;
            pointer-events: none;
            animation: achievementBurst 2s ease-out forwards;
        }

        @keyframes achievementBurst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 0;
            }
            20% {
                transform: scale(1.5) rotate(180deg);
                opacity: 1;
            }
            100% {
                transform: translateX(calc(var(--endX) - var(--startX))) 
                         translateY(calc(var(--endY) - var(--startY))) 
                         scale(0.8) 
                         rotate(720deg);
                opacity: 0;
            }
        }

        /* å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ */
        .completion-options {
            background: var(--gradient-1);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .completion-options h3 {
            font-size: 24px;
            margin-bottom: 16px;
            color: white;
        }

        .completion-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .completion-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            font-weight: 600;
        }

        .completion-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* å±¥æ­´ */
        .history-item {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-info h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .history-meta {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .achievement-badge {
            font-size: 32px;
            font-weight: 800;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .swipe-hint {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            font-size: 40px;
            opacity: 0;
            pointer-events: none;
            z-index: 2000;
            animation: swipeHint 0.5s ease-out;
        }
        
        .swipe-hint.left {
            left: 20px;
        }
        
        .swipe-hint.right {
            right: 20px;
        }
        
        @keyframes swipeHint {
            0% {
                opacity: 0;
                transform: translateY(-50%) scale(0.5);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateY(-50%) scale(1);
            }
        }

        /* é »åº¦é¸æŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .frequency-option {
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .frequency-option input[type="radio"] {
            position: absolute;
            opacity: 0;
        }
        
        .frequency-option input[type="radio"]:checked + label {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            color: white;
            font-weight: 600;
        }
        
        .frequency-option label {
            display: block;
            padding: 16px 20px;
            background: var(--surface-light);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .frequency-option label:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }
        
        .weekday-option {
            position: relative;
        }
        
        .weekday-option input[type="checkbox"] {
            position: absolute;
            opacity: 0;
        }
        
        .weekday-option input[type="checkbox"]:checked + label {
            background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            color: white;
            transform: scale(1.05);
        }
        
        .weekday-option label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            background: var(--surface-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 48px;
        }
        
        .weekday-option label:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 0 12px 100px; /* ä¸Šéƒ¨ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤ã€ãƒ•ãƒƒã‚¿ãƒ¼åˆ†ã®ä½™ç™½ã¯ç¶­æŒ */
            }
            
            .card {
                padding: 16px;
                border-radius: 16px;
            }
            
            .btn {
                padding: 16px 24px;
                font-size: 16px;
                min-height: 48px; /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®æœ€å°ã‚µã‚¤ã‚º */
            }
            
            .nav-btn {
                padding: 16px 16px;
                font-size: 14px;
            }
            
            .duration-selector {
                grid-template-columns: 1fr;
            }
            
            .duration-option {
                padding: 24px;
                min-height: 80px;
            }
            
            .calendar-grid {
                gap: 4px;
            }
            
            .day-cell {
                font-size: 14px;
                padding: 3px;
                min-height: 44px;
                min-width: 44px;
            }
            
            .day-cell small {
                font-size: 10px;
            }
            
            .progress-percentage {
                font-size: 28px;
            }
            
            .hypothesis-item {
                padding: 16px;
                margin-bottom: 12px;
            }
            
            input, textarea {
                padding: 14px 16px;
                font-size: 16px; /* iOS ã®ã‚ºãƒ¼ãƒ é˜²æ­¢ */
            }
            
            .header {
                padding: 12px 16px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .stats-grid {
                gap: 12px;
            }
            
            .stat-card {
                padding: 16px !important;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 22px;
            }
            
            .day-cell {
                font-size: 12px;
                padding: 2px;
            }
            
            .day-cell small {
                font-size: 9px;
            }
            
            .shuffle-number {
                font-size: 60px;
            }
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes cardEffectAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
        }
        
        /* ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 30px rgba(245, 158, 11, 0.5);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
            }
        }
        
        /* ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .skip-modal {
            background: var(--surface);
            padding: 32px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
        }
        
        .skip-modal .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .skip-modal .modal-header h3 {
            font-size: 24px;
            margin-bottom: 12px;
        }
        
        .skip-modal .modal-header p {
            color: var(--text-secondary);
            font-size: 16px;
        }
        
        .skip-dates {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 0;
            margin-bottom: 24px;
        }
        
        .date-button {
            flex: 0 0 calc(50% - 5px);
            padding: 12px;
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid #334155;
            color: #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
            font-weight: 500;
        }
        
        .date-button:hover {
            background: rgba(51, 65, 85, 0.5);
            transform: translateY(-1px);
        }
        
        .date-button.selected {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        .modal-footer .button {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 16px;
        }
        
        .modal-footer .button.primary {
            background: var(--primary);
            color: white;
        }
        
        .modal-footer .button.primary:hover:not(:disabled) {
            background: #0ea567;
            transform: translateY(-1px);
        }
        
        .modal-footer .button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .modal-footer .button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .modal-footer .button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼ˆçµ±è¨ˆãƒ“ãƒ¥ãƒ¼ï¼‰ ===== */
        @media (max-width: 480px) {
            .stats-grid { 
                grid-template-columns: 1fr 1fr !important; 
                gap: 4px !important; 
                padding: 0 !important;
                width: 100% !important;
                margin: 0 !important;
                box-sizing: border-box !important;
            }
            .stat-value { 
                font-size: 16px !important;
                word-break: break-all !important;
                line-height: 1.2 !important;
            }
            .stat-label {
                font-size: 9px !important;
                line-height: 1.2 !important;
                word-wrap: break-word !important;
            }
            .stat-card {
                padding: 6px !important;
                min-width: 0 !important;
                overflow: hidden !important;
                box-sizing: border-box !important;
            }
            .stat-panel {
                padding: 8px !important;
            }
            .stat-panel h3 {
                font-size: 13px !important;
                margin-bottom: 6px !important;
            }
            #stats-view .btn {
                font-size: 10px !important;
                padding: 6px 8px !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            #stats-view {
                padding: 4px !important;
                overflow-x: hidden !important;
                overflow-y: auto !important;
                width: 100% !important;
                box-sizing: border-box !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-y !important;
            }
            #stats-view .card {
                padding: 8px !important;
                margin: 0 !important;
                overflow-x: hidden !important;
                width: 100% !important;
                box-sizing: border-box !important;
            }
            #donut-intensity {
                width: 80px !important;
                height: 80px !important;
            }
            #donut-legend {
                font-size: 9px !important;
            }
            #weekday-stats {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                gap: 2px !important;
                padding-bottom: 4px !important;
                -webkit-overflow-scrolling: touch !important;
                justify-content: space-between !important;
            }
            #weekday-stats > div {
                flex: 1 1 calc(14% - 2px) !important;
                min-width: 38px !important;
                max-width: 50px !important;
            }
            .achievement-chart {
                gap: 6px !important;
            }
            #badge-collection {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 4px !important;
            }
            #badge-collection .badge-item {
                font-size: 10px !important;
                padding: 4px !important;
            }
            #achievement-level-distribution > div {
                margin-bottom: 6px !important;
            }
            #achievement-level-distribution .stage-name {
                font-size: 10px !important;
            }
            #ranking-list .ranking-item {
                font-size: 11px !important;
                padding: 6px !important;
            }
            #achievement-level-distribution { grid-template-columns: 1fr !important; }
            #badge-collection { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)) !important; gap: 8px !important; }
            .achievement-chart { gap: 12px !important; }
        }

        /* ===== ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ï¼ˆå…¨ä½“ï¼‰ ===== */
        @media (max-width: 480px) {
            .header { padding: 12px 16px; }
            h1 { font-size: 20px; }
            .nav-content { padding: 0 12px; }
            .nav-btn { padding: 12px 12px; font-size: 14px; }
            .nav-btn::after { height: 2px; }
            .container { padding: 0 12px 16px; }
            .card { padding: 16px; border-radius: 16px; }
            .btn { padding: 12px 16px; font-size: 15px; }
            .progress-percentage { font-size: 28px; }
            .progress-bar { height: 10px; }
            label { font-size: 14px; }
            input, textarea { font-size: 15px; }
        }
    </style>
</head>
<body>
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="header">
        <div class="header-content">
            <div class="header-logo">
                <h1>ğŸ§ª HypoLab</h1>
            </div>
            <!-- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¨ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º -->
            <div style="display: flex; align-items: center; gap: 12px;">
                <!-- ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <button id="theme-toggle" onclick="toggleTheme()" style="
                    background: var(--surface-light);
                    border: 1px solid var(--border);
                    border-radius: 12px;
                    padding: 8px 12px;
                    color: var(--text-primary);
                    cursor: pointer;
                    font-size: 20px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                " title="ãƒ†ãƒ¼ãƒã‚’åˆ‡ã‚Šæ›¿ãˆ">
                    <span id="theme-icon">ğŸŒ™</span>
                </button>
                <!-- ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤º -->
                <div id="point-display" style="
                display: flex;
                align-items: center;
                gap: 12px;
                background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
                padding: 8px 16px;
                border-radius: 12px;
                border: 1px solid rgba(251, 191, 36, 0.3);
                cursor: pointer;
                position: relative;
            " onclick="showLevelProgress()">
                <span class="point-amount" style="font-weight: bold; color: #fbbf24;">ğŸ’° 0pt</span>
                <span class="level-info" style="font-size: 12px; color: var(--text-secondary);">Lv.1 åˆå¿ƒè€…</span>
            </div>
            </div>
        </div>
    </header>

    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ -->
    <nav class="nav">
        <div class="nav-content">
            <button class="nav-btn active" onclick="showHomeView()" data-view="home">
                ğŸ  ãƒ›ãƒ¼ãƒ 
            </button>
            <button class="nav-btn" onclick="showPointsView()" data-view="points">
                ğŸ’° ãƒã‚¤ãƒ³ãƒˆ
            </button>
            <button class="nav-btn" onclick="showCardsView()" data-view="cards">
                ğŸ´ ã‚«ãƒ¼ãƒ‰
            </button>
            <button class="nav-btn" onclick="showStatsView()" data-view="stats">
                ğŸ“Š çµ±è¨ˆ
            </button>
            <button class="nav-btn" onclick="showHistoryView()" data-view="history">
                ğŸ“š å±¥æ­´
            </button>
        </div>
        <!-- ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
        <div class="page-indicator" style="position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); display: flex; gap: 4px;">
            <span class="dot active" data-page="0" style="width: 6px; height: 6px; background: var(--primary); border-radius: 50%; transition: all 0.3s;"></span>
            <span class="dot" data-page="1" style="width: 6px; height: 6px; background: var(--surface-light); border-radius: 50%; transition: all 0.3s;"></span>
            <span class="dot" data-page="2" style="width: 6px; height: 6px; background: var(--surface-light); border-radius: 50%; transition: all 0.3s;"></span>
            <span class="dot" data-page="3" style="width: 6px; height: 6px; background: var(--surface-light); border-radius: 50%; transition: all 0.3s;"></span>
            <span class="dot" data-page="4" style="width: 6px; height: 6px; background: var(--surface-light); border-radius: 50%; transition: all 0.3s;"></span>
        </div>
    </nav>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="container">
        <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
        <div id="home-view">
            <!-- ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div id="active-events" class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3); display: none;">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            
            <!-- ãƒ‡ã‚¤ãƒªãƒ¼ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card" id="daily-journal-section" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(168, 85, 247, 0.3);">
                <h3 style="margin-bottom: 12px; font-size: 16px;">ğŸ“” ä»Šæ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h3>
                <div id="journal-status" style="margin-bottom: 12px;">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <button class="btn btn-primary" onclick="openJournalModal()" style="width: 100%; padding: 10px; font-size: 14px; background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);">
                    ğŸ“ è¨˜éŒ²ã™ã‚‹
                </button>
            </div>
            
            <!-- åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3);">
                <h3 style="margin-bottom: 12px; font-size: 16px;">ä»Šæ—¥ã®åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹</h3>
                <div id="effort-bonus-plans" style="margin-bottom: 12px;">
                    <!-- äºˆå®šã•ã‚ŒãŸåŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
                <button class="btn btn-secondary" id="effort-bonus-btn" onclick="handleEffortBonusClick(event); showEffortBonusDialog()" style="padding: 8px 16px; font-size: 14px; position: relative; overflow: visible;">
                    ğŸ’ª ç›®æ¨™ã‚’è¿½åŠ ã™ã‚‹ (+1-3pt)
                </button>
            </div>
            
            <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3);">
                <h3 style="margin-bottom: 12px; font-size: 16px;">ğŸ¯ ä»Šæ—¥ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h3>
                <div id="daily-challenge-container" style="margin-bottom: 12px;">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <div id="weekly-challenge-container" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(139, 92, 246, 0.2);">
                    <h4 style="margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">ğŸ“… ä»Šé€±ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="card">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                    <h2>ç¾åœ¨ã®ç¿’æ…£</h2>
                    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                    <select id="category-filter" onchange="filterHabitsByCategory()" style="
                        padding: 6px 12px;
                        border: 1px solid var(--border);
                        border-radius: 8px;
                        background: var(--surface);
                        color: var(--text-primary);
                        font-size: 14px;
                        cursor: pointer;
                    ">
                        <!-- ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‹•çš„ã«ç”Ÿæˆ -->
                    </select>
                </div>
                <div id="current-hypothesis-list" class="hypothesis-list">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
                <button class="btn" onclick="showNewHypothesisView()" style="margin-top: 16px;">
                    â• æ–°è¦ç¿’æ…£ç«‹æ¡ˆ
                </button>
            </div>
            
            
        </div>

        <!-- æ–°è¦ç¿’æ…£ä½œæˆç”»é¢ -->
        <div id="new-hypothesis-view" style="display: none;">
            <div class="card">
                <h2 style="margin-bottom: 24px;">æ–°è¦ç¿’æ…£ç«‹æ¡ˆ</h2>
                <form onsubmit="createHypothesis(event)">
                    <div class="form-group">
                        <label for="hypothesis-title">ç¿’æ…£ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="hypothesis-title" required placeholder="ä¾‹: æ¯æ—¥10åˆ†ã®ç‘æƒ³" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                    </div>
                    
                    <div class="form-group">
                        <label for="hypothesis-description">ç¿’æ…£ã®è©³ç´°</label>
                        <textarea id="hypothesis-description" required placeholder="ã“ã®ç¿’æ…£ã§ä½•ã‚’å®Ÿç¾ã—ãŸã„ã‹è©³ã—ãè¨˜è¿°ã—ã¦ãã ã•ã„" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="hypothesis-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="hypothesis-category" required>
                            <!-- ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‹•çš„ã«ç”Ÿæˆ -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="hypothesis-benefit">æœã®1è¡Œå®£è¨€ï¼ˆâ­•ï¸ã«å…¥ã‚Œã‚‹è¨€è‘‰ï¼‰</label>
                        <input type="text" id="hypothesis-benefit" required placeholder="ä¾‹: é›†ä¸­åŠ›ãŒä¸ŠãŒã‚‹" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        <small style="color: var(--text-secondary);">å®£è¨€æ–‡: ã€Œã“ã®ç¿’æ…£ã‚’å®Ÿè¨¼ã™ã‚‹ã“ã¨ã§ï¼ˆã“ã®å…¥åŠ›ï¼‰ãŒå®Ÿç¾ã™ã‚‹ã€</small>
                    </div>

                    <div class="form-group">
                        <label>IF-THEN ãƒ«ãƒ¼ãƒ«</label>
                        <div id="ifthen-list" style="display:grid; gap:8px; margin-bottom:8px;"></div>
                        <button type="button" class="btn btn-secondary" onclick="addIfThenRow()">ï¼‹ IF-THEN ã‚’è¿½åŠ </button>
                        <small style="color: var(--text-secondary); display:block; margin-top:6px;">å½¢å¼: ã‚‚ã—ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ãªã‚‰ï¼ˆè¡Œå‹•ï¼‰ã™ã‚‹</small>
                    </div>
                    
                    <div class="form-group">
                        <label>é–‹å§‹æ—¥ã‚’é¸æŠ</label>
                        <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                            <button type="button" class="btn btn-secondary" onclick="setStartDate('today')" id="start-today-btn" style="flex: 1; padding: 12px; background: var(--primary); color: white;">
                                ä»Šæ—¥ã‹ã‚‰é–‹å§‹
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showDatePicker()" id="start-later-btn" style="flex: 1; padding: 12px;">
                                æ—¥ä»˜ã‚’æŒ‡å®š
                            </button>
                        </div>
                        <input type="date" id="habit-start-date" style="display: none; width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--surface);" onchange="updateStartDateDisplay()">
                        <div id="start-date-display" style="padding: 8px 12px; background: var(--surface-light); border-radius: 8px; margin-bottom: 12px; display: none;">
                            <span style="color: var(--text-secondary); font-size: 14px;">é–‹å§‹æ—¥: </span>
                            <span id="selected-start-date" style="font-weight: 600;"></span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>æ¤œè¨¼æœŸé–“ã‚’é¸æŠ</label>
                        <div class="duration-selector" id="duration-selector">
                            <div class="duration-option" onclick="selectDuration('short')" data-duration="short">
                                <h3>çŸ­æœŸé–“</h3>
                                <p id="duration-short-text">3ã€œ7æ—¥</p>
                            </div>
                            <div class="duration-option" onclick="selectDuration('medium')" data-duration="medium">
                                <h3>ä¸­æœŸé–“</h3>
                                <p id="duration-medium-text">8ã€œ14æ—¥</p>
                            </div>
                            <div class="duration-option" onclick="selectDuration('long')" data-duration="long">
                                <h3>é•·æœŸé–“</h3>
                                <p id="duration-long-text">15ã€œ30æ—¥</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å®Ÿæ–½é »åº¦ã‚’é¸æŠ</label>
                        <div style="display: grid; gap: 12px; margin-top: 12px;">
                            <!-- æ¯æ—¥ -->
                            <div class="frequency-option">
                                <input type="radio" id="freq-daily" name="frequency" value="daily" checked>
                                <label for="freq-daily">
                                    <div style="font-weight: 600; margin-bottom: 4px;">æ¯æ—¥</div>
                                    <div style="font-size: 12px; opacity: 0.8;">ã™ã¹ã¦ã®æ—¥ã§å®Ÿæ–½ã—ã¾ã™</div>
                                </label>
                            </div>
                            
                            <!-- é€±ã«â—¯å› -->
                            <div class="frequency-option">
                                <input type="radio" id="freq-weekly" name="frequency" value="weekly">
                                <label for="freq-weekly">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-weight: 600;">é€±ã«</span>
                                        <input type="number" id="weekly-count" min="1" max="7" value="3" 
                                               style="width: 50px; padding: 4px 8px; border: 1px solid var(--border); 
                                                      border-radius: 6px; background: var(--surface); text-align: center;" 
                                               onclick="event.stopPropagation(); document.getElementById('freq-weekly').click();">
                                        <span style="font-weight: 600;">å›</span>
                                    </div>
                                    <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">1é€±é–“ã‚ãŸã‚Šã®å®Ÿæ–½å›æ•°ã‚’æŒ‡å®š</div>
                                </label>
                            </div>
                            
                            <!-- ç‰¹å®šã®æ›œæ—¥ -->
                            <div class="frequency-option">
                                <input type="radio" id="freq-weekdays" name="frequency" value="weekdays">
                                <label for="freq-weekdays">
                                    <div style="font-weight: 600; margin-bottom: 4px;">ç‰¹å®šã®æ›œæ—¥</div>
                                    <div style="font-size: 12px; opacity: 0.8;">å®Ÿæ–½ã™ã‚‹æ›œæ—¥ã‚’é¸æŠ</div>
                                </label>
                            </div>
                            
                            <!-- æ›œæ—¥é¸æŠãƒœã‚¿ãƒ³ -->
                            <div id="weekdays-selector" style="display: none; margin-top: 12px; padding: 16px; background: var(--surface); border-radius: 12px; border: 1px solid var(--border);">
                                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-1" name="weekday" value="1">
                                        <label for="weekday-1">æœˆ</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-2" name="weekday" value="2">
                                        <label for="weekday-2">ç«</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-3" name="weekday" value="3">
                                        <label for="weekday-3">æ°´</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-4" name="weekday" value="4">
                                        <label for="weekday-4">æœ¨</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-5" name="weekday" value="5">
                                        <label for="weekday-5">é‡‘</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-6" name="weekday" value="6">
                                        <label for="weekday-6">åœŸ</label>
                                    </div>
                                    <div class="weekday-option">
                                        <input type="checkbox" id="weekday-0" name="weekday" value="0">
                                        <label for="weekday-0">æ—¥</label>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn">
                            ğŸ² ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦é–‹å§‹
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="showHomeView()" style="margin-left: 12px;">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”»é¢ -->
        <div id="shuffle-view" style="display: none;">
            <div class="card">
                <div class="shuffle-container">
                    <h2>æ¤œè¨¼æœŸé–“ã‚’æ±ºå®šä¸­...</h2>
                    <div class="shuffle-number" id="shuffle-number">?</div>
                    <p>æ—¥é–“</p>
                </div>
                <div style="text-align: center; display: none;" id="shuffle-result">
                    <h2 style="margin-bottom: 16px;">æ¤œè¨¼æœŸé–“ãŒæ±ºã¾ã‚Šã¾ã—ãŸï¼</h2>
                    <div class="shuffle-number" id="final-days">7</div>
                    <p style="margin-bottom: 24px;">æ—¥é–“</p>
                    <button class="btn" onclick="startHypothesis()">
                        æ¤œè¨¼ã‚’é–‹å§‹ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¤œè¨¼é€²æ—ç”»é¢ -->
        <div id="progress-view" style="display: none;">
            <div class="card">
                <h2 id="progress-hypothesis-title" style="margin-bottom: 8px;"></h2>
                <p id="progress-hypothesis-description" style="color: var(--text-secondary); margin-bottom: 16px;"></p>
                <div id="progress-days-info" style="margin-bottom: 24px; color: var(--text-secondary);"></div>
                <div id="affirmation-panel"></div>
            </div>

            <div class="progress-container">
                <div class="progress-header">
                    <div class="progress-title">é”æˆç‡</div>
                    <div class="progress-percentage" id="achievement-rate">0%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                </div>
                <div class="progress-info">
                    <span id="achieved-days">é”æˆ: 0æ—¥</span>
                    <span id="remaining-days">æ®‹ã‚Š: 0æ—¥</span>
                </div>
                
                <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåŠ¹æœã®è¡¨ç¤º -->
                <div id="active-effects-display" style="margin-top: 16px; display: none;">
                    <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 8px;">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåŠ¹æœ:</div>
                    <div id="active-effects-list" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
            </div>

            <!-- IF-THEN è¡¨ç¤º/ç·¨é›† -->
            <div class="card" id="ifthen-panel" style="display: none;"></div>

            <!-- ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒœã‚¿ãƒ³ -->
            <div id="card-use-section" style="margin-bottom: 20px; display: none;">
                <button class="btn btn-secondary" onclick="showCardUseMenu()" style="width: 100%;">
                    ğŸ´ ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
                </button>
            </div>

            <!-- ãƒ¡ãƒ¢å…¥åŠ›ï¼ˆã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆ/ã‚¤ãƒ³ãƒ—ãƒƒãƒˆï¼‰ã¯ãƒ‡ãƒ¼ã‚¿å…¥å‡ºåŠ›ã¨æ··åŒã‚’é¿ã‘ã‚‹ãŸã‚å‰Šé™¤ -->

            <!-- å®Œäº†å ±å‘Šãƒœã‚¿ãƒ³ -->
            <div id="completion-report-section" style="display: none; margin-bottom: 20px;">
                <button class="btn" onclick="showCompletionOptions()" style="width: 100%; background: var(--gradient-1);">
                    ğŸ“ å®Œäº†å ±å‘Šã™ã‚‹
                </button>
            </div>

            <div class="completion-options" id="completion-options" style="display: none;">
                <h3>ğŸ‰ æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h3>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                <div class="completion-buttons">
                    <button class="completion-btn" onclick="continueHypothesis()">
                        â¡ï¸ ç¶™ç¶šã™ã‚‹
                    </button>
                    <button class="completion-btn" onclick="modifyAndContinue()">
                        âœï¸ ä¿®æ­£ã—ã¦ç¶™ç¶š
                    </button>
                    <button class="completion-btn" onclick="completeHypothesis()">
                        âœ… å®Œäº†ã™ã‚‹
                    </button>
                </div>
            </div>

            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="calendar-title">é€²æ—ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
        </div>

        <!-- å±¥æ­´ç”»é¢ -->
        <div id="history-view" style="display: none;">
            <div class="card" style="margin-top: 0;">
                <h2 style="margin-bottom: 24px; margin-top: 0;">å®Œäº†ã—ãŸç¿’æ…£</h2>
                <div id="history-list">
                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card" style="margin-top: 24px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); border: 1px solid rgba(99, 102, 241, 0.3);">
                <h3 style="margin-bottom: 16px; font-size: 16px;">âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
                
                <!-- ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
                <div style="margin-bottom: 12px;">
                    <button class="btn btn-secondary" onclick="exportAllData()" style="width: 100%; padding: 10px; font-size: 14px; background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                        ğŸ“¤ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </button>
                    <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        ç¿’æ…£ã€ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã€ãƒã‚¤ãƒ³ãƒˆã€ã‚«ãƒ¼ãƒ‰ç­‰ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§ä¿å­˜
                    </small>
                </div>
                
                <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
                <div>
                    <input type="file" id="import-file-history" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('import-file-history').click()" style="width: 100%; padding: 10px; font-size: 14px; background: linear-gradient(135deg, #10b981, #3b82f6);">
                        ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </button>
                    <small style="display: block; margin-top: 6px; color: var(--text-secondary); font-size: 12px;">
                        ä»¥å‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸJSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                    </small>
                </div>
                
                <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
                <div style="margin-top: 12px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                    <small style="color: #ef4444; font-size: 11px;">
                        âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚äº‹å‰ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
                    </small>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆç”»é¢ -->
        <div id="stats-view" style="display: none;">
            <div class="card" style="margin-top: 0;">
                <h2 style="margin-bottom: 16px; margin-top: 0;">ğŸ“Š çµ±è¨ˆãƒ‡ãƒ¼ã‚¿</h2>
                <div class="stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                    <div class="stat-card" style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center; min-width: 0; overflow: hidden; box-sizing: border-box;">
                        <div class="stat-value" id="total-hypotheses" style="font-size: 28px; font-weight: 800; color: #6366f1;">0</div>
                        <div class="stat-label" style="color: var(--text-secondary); margin-top: 8px;">ç·ç¿’æ…£æ•°</div>
                    </div>
                    <div class="stat-card" style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center; min-width: 0; overflow: hidden; box-sizing: border-box;">
                        <div class="stat-value" id="avg-achievement" style="font-size: 28px; font-weight: 800; color: #f59e0b;">0%</div>
                        <div class="stat-label" style="color: var(--text-secondary); margin-top: 4px; font-size: 11px;">å¹³å‡é”æˆç‡</div>
                    </div>
                    <div class="stat-card" style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center; min-width: 0; overflow: hidden; box-sizing: border-box;">
                        <div class="stat-value" id="total-days" style="font-size: 28px; font-weight: 800; color: #10b981;">0</div>
                        <div class="stat-label" style="color: var(--text-secondary); margin-top: 4px; font-size: 11px;">ç·æ¤œè¨¼æ—¥æ•°</div>
                    </div>
                    <div class="stat-card" style="background: var(--background); padding: 12px; border-radius: 8px; text-align: center; min-width: 0; overflow: hidden; box-sizing: border-box;">
                        <div class="stat-value" id="weighted-achieved" style="font-size: 28px; font-weight: 800; color: #ef4444;">0</div>
                        <div class="stat-label" style="color: var(--text-secondary); margin-top: 4px; font-size: 11px;">é”æˆæ—¥æ•°</div>
                    </div>
                </div>
                <div class="achievement-chart" id="achievement-chart" style="display:grid; gap:16px;">
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px;">â° æ›œæ—¥åˆ¥é”æˆç‡ï¼ˆæ¯æ—¥ã®ç¿’æ…£ï¼‰</h3>
                        <div id="weekday-stats" style="display:flex; gap:3px; margin-top:8px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; justify-content: space-between;"></div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('achievement-level-distribution')">
                            <span id="achievement-level-distribution-arrow">â–¶</span> ğŸ® é”æˆç‡ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ
                        </h3>
                        <div id="achievement-level-distribution" style="display: none;" style="display:grid; gap:8px; margin-top:12px;"></div>
                    </div>
                    <!-- ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="stat-panel" id="journal-stats-section" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(59, 130, 246, 0.1)); padding: 16px; border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.3);">
                        <h3 style="margin-bottom:12px; cursor: pointer; user-select: none;" onclick="toggleStatSection('journal-stats-content')">
                            <span id="journal-stats-content-arrow">â–¶</span> ğŸ“” ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«çµ±è¨ˆ
                        </h3>
                        <div id="journal-stats-content" style="display: none;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="stat-panel" style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); padding: 16px; border-radius: 12px; border: 1px solid rgba(251, 191, 36, 0.3);">
                        <h3 style="margin-bottom:12px; cursor: pointer; user-select: none;" onclick="toggleStatSection('point-stats-content')">
                            <span id="point-stats-content-arrow">â–¶</span> ğŸ’° ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ
                        </h3>
                        <div id="point-stats-content" style="display: none;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div id="current-points-stat" style="font-size: 24px; font-weight: bold; color: #fbbf24;">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div id="lifetime-earned-stat" style="font-size: 24px; font-weight: bold; color: #10b981;">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç´¯è¨ˆç²å¾—</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div id="lifetime-spent-stat" style="font-size: 24px; font-weight: bold; color: #ef4444;">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç´¯è¨ˆæ¶ˆè²»</div>
                                </div>
                                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                    <div id="current-level-stat" style="font-size: 24px; font-weight: bold; color: #8b5cf6;">Lv.1</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«</div>
                                </div>
                            </div>
                            <!-- ãƒ¬ãƒ™ãƒ«é€²æ—ãƒãƒ¼ -->
                            <div style="margin-top: 16px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span id="level-progress-label" style="font-size: 12px; color: var(--text-secondary);">æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§</span>
                                    <span id="level-progress-text" style="font-size: 12px; color: var(--text-secondary);">0/50pt</span>
                                </div>
                                <div style="background: rgba(0,0,0,0.3); height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div id="level-progress-bar" style="background: linear-gradient(90deg, #fbbf24, #f59e0b); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                            
                            <!-- ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ• -->
                            <div id="point-trend-graph" style="margin-top: 16px;">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        
                        <!-- æ™‚é–“å¸¯åˆ¥ç²å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                            <div id="point-time-pattern" style="margin-top: 16px;">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                            
                            <!-- ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœåˆ†æ -->
                            <div id="boost-effect-analysis" style="margin-top: 16px;">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                            
                            <!-- æœ€è¿‘ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div style="margin-top: 16px;">
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ“ æœ€è¿‘ã®ç²å¾—/æ¶ˆè²»</h4>
                                <div id="recent-transactions" style="display: grid; gap: 4px; max-height: 150px; overflow-y: auto; font-size: 12px;">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('intensity-stats')">
                            <span id="intensity-stats-arrow">â–¶</span> ğŸ§© å¼·åº¦ãƒ©ãƒ™ãƒ«ä½¿ç”¨å‰²åˆ
                        </h3>
                        <div id="intensity-stats" style="display: none; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center;">
                            <svg id="donut-intensity" width="160" height="160" viewBox="0 0 160 160" style="flex-shrink: 0;"></svg>
                            <div id="donut-legend" style="display:grid; gap:6px; font-size:12px; min-width: 100px;"></div>
                        </div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('streak-stats')">
                            <span id="streak-stats-arrow">â–¶</span> ğŸ”¥ é€£ç¶šé”æˆæ—¥æ•°
                        </h3>
                        <div id="streak-stats" style="display: none;" style="display:flex; gap:16px; font-weight:700;"></div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('ranking-content')">
                            <span id="ranking-content-arrow">â–¶</span> ğŸ† ç¿’æ…£ãƒ©ãƒ³ã‚­ãƒ³ã‚°
                        </h3>
                        <div id="ranking-content" style="display: none;">
                        <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
                        <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <button id="ranking-achievement-tab" onclick="showAchievementRanking()" style="flex: 1; padding: 6px; font-size: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">é”æˆç‡</button>
                            <button id="ranking-points-tab" onclick="showPointsRanking()" style="flex: 1; padding: 6px; font-size: 12px; background: var(--surface); color: var(--text-primary); border: none; border-radius: 6px; cursor: pointer;">ãƒã‚¤ãƒ³ãƒˆ</button>
                            <button id="ranking-streak-tab" onclick="showStreakRanking()" style="flex: 1; padding: 6px; font-size: 12px; background: var(--surface); color: var(--text-primary); border: none; border-radius: 6px; cursor: pointer;">é€£ç¶š</button>
                        </div>
                        <div id="ranking-list" style="display:grid; gap:8px;"></div>
                        </div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('badge-collection')">
                            <span id="badge-collection-arrow">â–¶</span> ğŸ† ç²å¾—ãƒãƒƒã‚¸
                        </h3>
                        <div id="badge-collection" style="display: none; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:12px;"></div>
                    </div>
                    <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="stat-panel" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); padding: 16px; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.3);">
                        <h3 style="margin-bottom:12px; cursor: pointer; user-select: none;" onclick="toggleStatSection('challenge-stats-content')">
                            <span id="challenge-stats-content-arrow">â–¶</span> ğŸ¯ ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµ±è¨ˆ
                        </h3>
                        <div id="challenge-stats-content" style="display: none;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div id="challenge-streak" style="font-size: 24px; font-weight: bold; color: #fbbf24;">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">é€£ç¶šé”æˆæ—¥æ•°</div>
                            </div>
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div id="total-challenges-completed" style="font-size: 24px; font-weight: bold; color: #10b981;">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç´¯è¨ˆå®Œäº†</div>
                            </div>
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div id="daily-completion-rate" style="font-size: 24px; font-weight: bold; color: #8b5cf6;">0%</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ãƒ‡ã‚¤ãƒªãƒ¼é”æˆç‡</div>
                            </div>
                            <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                                <div id="weekly-completion-rate" style="font-size: 24px; font-weight: bold; color: #ec4899;">0%</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼é”æˆç‡</div>
                            </div>
                        </div>
                        <!-- ãŠæ°—ã«å…¥ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ -->
                        <div style="margin-bottom: 16px;">
                            <h4 style="font-size: 14px; margin-bottom: 8px;">â­ ã‚ˆãé”æˆã™ã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>
                            <div id="favorite-challenges" style="display: grid; gap: 8px; max-height: 150px; overflow-y: auto;">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        </div>
                        <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸å±¥æ­´ -->
                            <div>
                                <h4 style="font-size: 14px; margin-bottom: 8px;">ğŸ“ æœ€è¿‘ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆ</h4>
                                <div id="recent-challenges" style="display: grid; gap: 4px; max-height: 150px; overflow-y: auto; font-size: 12px;">
                                    <!-- å‹•çš„ã«ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="stat-panel" style="background: var(--background); padding: 10px; border-radius: 8px;">
                        <h3 style="margin-bottom:8px; cursor: pointer; user-select: none;" onclick="toggleStatSection('habit-report')">
                            <span id="habit-report-arrow">â–¶</span> ğŸ“ˆ ç¿’æ…£ãƒ¬ãƒãƒ¼ãƒˆ
                        </h3>
                        <div id="habit-report" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 16px;">
                            <button class="btn btn-secondary" onclick="showMonthlyReport()">ğŸ“… æœˆæ¬¡</button>
                            <button class="btn btn-secondary" onclick="showYearlyReport()">ğŸ“Š å¹´æ¬¡</button>
                            <button class="btn btn-secondary" onclick="exportHabitData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('import-file').click()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                            <input id="import-file" type="file" accept="application/json,.json" style="display:none" onchange="handleImportFile(event)">
                        </div>
                        </div>
                        <div id="report-container" style="display: none; padding: 16px; background: var(--surface); border-radius: 12px; margin-top: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ãƒã‚¤ãƒ³ãƒˆç”»é¢ -->
        <div id="points-view" style="display: none;">
            <!-- ãƒã‚¤ãƒ³ãƒˆçŠ¶æ³ -->
            <div class="card" style="margin-top: 0; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border: 1px solid rgba(251, 191, 36, 0.3);">
                <h2 style="margin-bottom: 16px; margin-top: 0;">ğŸ’° ãƒã‚¤ãƒ³ãƒˆ</h2>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px;">
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                        <div id="points-current" style="font-size: 24px; font-weight: bold; color: #fbbf24;">0</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">ç¾åœ¨</div>
                    </div>
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                        <div id="points-level" style="font-size: 24px; font-weight: bold; color: #8b5cf6;">Lv.1</div>
                        <div id="points-level-name" style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">åˆå¿ƒè€…</div>
                    </div>
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 12px;">
                        <div id="points-lifetime" style="font-size: 24px; font-weight: bold; color: #10b981;">0</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">ç´¯è¨ˆ</div>
                    </div>
                </div>
            </div>
            
            <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div style="display: flex; gap: 8px; margin-bottom: 16px; background: var(--surface); padding: 8px; border-radius: 12px;">
                <button id="rewards-tab" class="btn btn-secondary" onclick="showRewardsTab()" style="flex: 1; padding: 10px; font-size: 14px; background: var(--primary); color: white;">
                    ğŸ å ±é…¬
                </button>
                <button id="history-tab" class="btn btn-secondary" onclick="showHistoryTab()" style="flex: 1; padding: 10px; font-size: 14px;">
                    ğŸ“ å±¥æ­´
                </button>
                <button id="create-tab" class="btn btn-secondary" onclick="showCreateTab()" style="flex: 1; padding: 10px; font-size: 14px;">
                    â• ä½œæˆ
                </button>
            </div>
            
            <!-- å ±é…¬ã‚¿ãƒ– -->
            <div id="rewards-tab-content" class="card">
                <h3 style="margin-bottom: 16px;">ğŸ å ±é…¬ãƒªã‚¹ãƒˆ</h3>
                
                <!-- å ±é…¬çµ±è¨ˆ -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                    <div style="background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="total-rewards-count" style="font-size: 20px; font-weight: bold; color: #fbbf24;">0</div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">å ±é…¬æ•°</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="total-rewards-used" style="font-size: 20px; font-weight: bold; color: #8b5cf6;">0</div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">ä½¿ç”¨å›æ•°</div>
                    </div>
                    <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); padding: 12px; border-radius: 8px; text-align: center;">
                        <div id="total-rewards-spent" style="font-size: 20px; font-weight: bold; color: #10b981;">0pt</div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 2px;">ç´¯è¨ˆæ¶ˆè²»</div>
                    </div>
                </div>
                
                <!-- è©³ç´°çµ±è¨ˆãƒœã‚¿ãƒ³ -->
                <button onclick="window.toggleRewardStatistics()" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
                    border: 1px solid rgba(59, 130, 246, 0.3);
                    border-radius: 12px;
                    color: var(--text);
                    font-size: 14px;
                    font-weight: bold;
                    cursor: pointer;
                    margin-bottom: 16px;
                    transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    ğŸ“Š è©³ç´°çµ±è¨ˆã‚’è¦‹ã‚‹
                </button>
                
                <!-- è©³ç´°çµ±è¨ˆãƒ‘ãƒãƒ« -->
                <div id="reward-statistics-panel" style="display: none; margin-bottom: 16px;">
                    <!-- äººæ°—å ±é…¬ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
                    <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleStatSection('popular-rewards')">
                            <span id="popular-rewards-arrow">â–¼</span> ğŸ† äººæ°—å ±é…¬TOP5
                        </h4>
                        <div id="popular-rewards" style="display: grid; gap: 8px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥çµ±è¨ˆ -->
                    <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleStatSection('category-statistics')">
                            <span id="category-statistics-arrow">â–¼</span> ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥ä½¿ç”¨çŠ¶æ³
                        </h4>
                        <div id="category-statistics" style="display: grid; gap: 8px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æ™‚é–“å¸¯åˆ¥ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
                    <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleStatSection('reward-time-pattern')">
                            <span id="reward-time-pattern-arrow">â–¼</span> â° æ™‚é–“å¸¯åˆ¥ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
                        </h4>
                        <div id="reward-time-pattern" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- ã‚³ã‚¹ãƒˆåˆ†æ -->
                    <div style="background: var(--surface); padding: 16px; border-radius: 12px; margin-bottom: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleStatSection('cost-analysis')">
                            <span id="cost-analysis-arrow">â–¼</span> ğŸ’ ã‚³ã‚¹ãƒˆåˆ†æ
                        </h4>
                        <div id="cost-analysis" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <!-- æœ€è¿‘ä½¿ç”¨ã—ãŸå ±é…¬ -->
                    <div style="background: var(--surface); padding: 16px; border-radius: 12px;">
                        <h4 style="margin-bottom: 12px; font-size: 16px; cursor: pointer; user-select: none;" onclick="toggleStatSection('recent-used-rewards')">
                            <span id="recent-used-rewards-arrow">â–¼</span> â±ï¸ æœ€è¿‘ä½¿ç”¨ã—ãŸå ±é…¬
                        </h4>
                        <div id="recent-used-rewards" style="display: grid; gap: 8px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                
                <div id="rewards-list" style="display: grid; gap: 12px;">
                    <!-- å ±é…¬ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        å ±é…¬ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“<br>
                        ã€Œâ• ä½œæˆã€ã‚¿ãƒ–ã‹ã‚‰å ±é…¬ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>
            
            <!-- å±¥æ­´ã‚¿ãƒ– -->
            <div id="history-tab-content" class="card" style="display: none;">
                <h3 style="margin-bottom: 16px;">ğŸ“ å–å¼•å±¥æ­´</h3>
                <div id="points-history" style="display: grid; gap: 8px; max-height: 400px; overflow-y: auto;">
                    <!-- å±¥æ­´ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                </div>
            </div>
            
            <!-- ä½œæˆã‚¿ãƒ– -->
            <div id="create-tab-content" class="card" style="display: none;">
                <!-- ã‚¿ãƒ–é¸æŠ -->
                <div style="display: flex; gap: 8px; margin-bottom: 16px;">
                    <button class="btn btn-secondary" onclick="showRewardCreation()" id="reward-creation-btn" style="flex: 1; padding: 8px; font-size: 14px; background: var(--primary); color: white;">
                        ğŸ å ±é…¬ä½œæˆ
                    </button>
                    <button class="btn btn-secondary" onclick="showChallengeCreation()" id="challenge-creation-btn" style="flex: 1; padding: 8px; font-size: 14px;">
                        ğŸ¯ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä½œæˆ
                    </button>
                </div>
                
                <!-- å ±é…¬ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="reward-creation-form" style="display: block;">
                    <h3 style="margin-bottom: 16px;">â• æ–°ã—ã„å ±é…¬ã‚’ä½œæˆ</h3>
                <form onsubmit="createReward(event)">
                    <div class="form-group">
                        <label for="reward-name">å ±é…¬ã®åå‰</label>
                        <input type="text" id="reward-name" required placeholder="ä¾‹: 15åˆ†SNS" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="reward-cost">å¿…è¦ãƒã‚¤ãƒ³ãƒˆ</label>
                        <input type="number" id="reward-cost" required min="1" max="999" placeholder="ä¾‹: 10" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="reward-emoji">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
                        <input type="text" id="reward-emoji" placeholder="ä¾‹: ğŸ“±" maxlength="2" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label for="reward-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                        <select id="reward-category">
                            <option value="ä¼‘æ†©">ğŸµ ä¼‘æ†©</option>
                            <option value="å¨¯æ¥½">ğŸ® å¨¯æ¥½</option>
                            <option value="é£Ÿäº‹">ğŸ° é£Ÿäº‹</option>
                            <option value="è²·ã„ç‰©">ğŸ›ï¸ è²·ã„ç‰©</option>
                            <option value="ä½“é¨“">ğŸ­ ä½“é¨“</option>
                            <option value="è‡ªç”±æ™‚é–“">â° è‡ªç”±æ™‚é–“</option>
                            <option value="ãã®ä»–">ğŸ“¦ ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reward-memo">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                        <textarea id="reward-memo" placeholder="ã“ã®å ±é…¬ã®è©³ç´°èª¬æ˜" autocomplete="off"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">
                        âœ¨ å ±é…¬ã‚’ä½œæˆ
                    </button>
                </form>
                </div>
                
                <!-- ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="challenge-creation-form" style="display: none;">
                    <h3 style="margin-bottom: 16px;">ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆ</h3>
                    <form onsubmit="createCustomChallenge(event)">
                        <div class="form-group">
                            <label for="challenge-name">ãƒãƒ£ãƒ¬ãƒ³ã‚¸å</label>
                            <input type="text" id="challenge-name" required placeholder="ä¾‹: è…•ç«‹ã¦ä¼ã›20å›" autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label for="challenge-type">ã‚¿ã‚¤ãƒ—</label>
                            <select id="challenge-type" required>
                                <option value="daily">ãƒ‡ã‚¤ãƒªãƒ¼</option>
                                <option value="weekly">ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="challenge-points">å ±é…¬ãƒã‚¤ãƒ³ãƒˆ</label>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <input type="range" id="challenge-points-slider" min="1" max="30" value="5" style="flex: 1;" oninput="updateChallengePoints(this.value)">
                                <span id="challenge-points-display" style="min-width: 40px; text-align: right; font-weight: bold;">5pt</span>
                            </div>
                            <input type="hidden" id="challenge-points" value="5">
                        </div>
                        
                        <div class="form-group">
                            <label for="challenge-emoji">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
                            <input type="text" id="challenge-emoji" placeholder="ä¾‹: ğŸ’ª" maxlength="2" autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label for="challenge-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                            <select id="challenge-category">
                                <option value="health">ğŸƒ å¥åº·ãƒ»é‹å‹•</option>
                                <option value="study">ğŸ“š å­¦ç¿’ãƒ»æˆé•·</option>
                                <option value="mindfulness">ğŸ§˜ ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹</option>
                                <option value="social">ğŸ¤ ç¤¾ä¼šãƒ»äººé–“é–¢ä¿‚</option>
                                <option value="creativity">ğŸ¨ å‰µé€ æ€§</option>
                                <option value="productivity">âš¡ ç”Ÿç”£æ€§</option>
                                <option value="other">ğŸ“¦ ãã®ä»–</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; margin-top: 16px;">
                            ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆ
                        </button>
                    </form>
                    
                    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒªã‚¹ãƒˆ -->
                    <div style="margin-top: 24px;">
                        <h4 style="margin-bottom: 12px; font-size: 14px;">ğŸ“ ä½œæˆã—ãŸãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>
                        <div id="custom-challenges-list" style="display: grid; gap: 8px;">
                            <!-- å‹•çš„ã«ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚«ãƒ¼ãƒ‰ä¸€è¦§ç”»é¢ -->
        <div id="cards-view" style="display: none;">
            <div class="card" style="margin-top: 0;">
                <h2 style="margin-bottom: 24px; margin-top: 0;">ğŸ´ ã‚«ãƒ¼ãƒ‰ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
                
                <!-- ã‚«ãƒ¼ãƒ‰å›³é‘‘ãƒœã‚¿ãƒ³ -->
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="showCardAlbum()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #fbbf24, #f59e0b);">
                        ğŸ“– ã‚«ãƒ¼ãƒ‰å›³é‘‘ã‚’é–‹ã
                    </button>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 12px; color: var(--primary);">ğŸ“¦ æ‰€æŒã‚«ãƒ¼ãƒ‰</h3>
                    <div id="card-inventory" style="display: grid; gap: 12px;">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div style="margin-bottom: 24px;">
                    <h3 style="font-size: 18px; margin-bottom: 12px; color: var(--secondary);">âš ï¸ ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰</h3>
                    <div id="penalty-cards" style="display: grid; gap: 12px;">
                        <!-- å‹•çš„ã«ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="card-acquisition-modal" class="modal" style="display: none;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <h2 style="margin-bottom: 24px;">ğŸ‰ ã‚«ãƒ¼ãƒ‰ç²å¾—ï¼</h2>
            <div id="acquired-cards-container" style="display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px;">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
            <button class="btn" onclick="closeCardAcquisition()">ç¢ºèª</button>
        </div>
    </div>

    <!-- ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="card-use-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨</h2>
                <button class="close-btn" onclick="closeCardUseMenu()">Ã—</button>
            </div>
            <div id="usable-cards-container" style="display: grid; gap: 12px;">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer style="background: var(--surface); border-top: 1px solid var(--border); padding: 20px; margin-top: auto;">
        <div style="max-width: 1200px; margin: 0 auto; text-align: center; color: var(--text-secondary); font-size: 14px;">
            <p>Â© 2025 HypoLab - ç¿’æ…£æ¤œè¨¼ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
            <p style="margin-top: 8px; opacity: 0.7;">ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™</p>
        </div>
    </footer>

    <script>
        // PWA: service worker ç™»éŒ²
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(() => {});
            });
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
        const STORAGE_KEY = 'hypolab_local_data';

        // ç¾åœ¨ã®ç¿’æ…£
        let currentHypothesis = null;
        let selectedDuration = null;

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼ˆXSSå¯¾ç­–ï¼‰
        function escapeHTML(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã®YYYY-MM-DDã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆUTCã‚ºãƒ¬é˜²æ­¢ï¼‰
        function dateKeyLocal(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }
        
        // ç¿’æ…£ãƒ»ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”¨ã®æ—¥ä»˜ã‚­ãƒ¼ã‚’å–å¾—ï¼ˆæ·±å¤œ2æ™‚ã¾ã§å‰æ—¥æ‰±ã„ï¼‰
        function getActivityDateKey(date = new Date()) {
            const now = new Date(date);
            const hour = now.getHours();
            
            // 0æ™‚ã€œ2æ™‚ã®å ´åˆã¯å‰æ—¥ã®æ—¥ä»˜ã¨ã—ã¦æ‰±ã†
            if (hour < 2) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                return dateKeyLocal(yesterday);
            }
            
            return dateKeyLocal(now);
        }

        // ã‚«ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const CARD_MASTER = {
            skip_ticket: {
                id: 'skip_ticket',
                type: 'reward',
                name: 'ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆ',
                description: 'ä½¿ã£ãŸæ—¥ã‚’é”æˆæ¸ˆã¿ã«ã§ãã‚‹',
                icon: 'â­ï¸',
                rarity: 'common',
                color: '#3b82f6'
            },
            achievement_boost: {
                id: 'achievement_boost',
                type: 'reward',
                name: 'é”æˆãƒ–ãƒ¼ã‚¹ãƒˆ',
                description: 'ä»»æ„ã®2æ—¥ã‚’é”æˆæ¸ˆã¿ã«ã§ãã‚‹',
                icon: 'ğŸŒŸ',
                rarity: 'rare',
                color: '#10b981'
            },
            perfect_bonus: {
                id: 'perfect_bonus',
                type: 'reward',
                name: 'ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹',
                description: 'æ¬¡ã®ç¿’æ…£ã§100%é”æˆæ™‚ã€å ±é…¬ã‚«ãƒ¼ãƒ‰2æšç²å¾—',
                icon: 'ğŸ¯',
                rarity: 'legendary',
                color: '#f59e0b'
            },
            extension_card: {
                id: 'extension_card',
                type: 'penalty',
                name: 'å»¶é•·ã‚«ãƒ¼ãƒ‰',
                description: 'æ¬¡ã®ç¿’æ…£ãŒ3æ—¥é–“å»¶é•·ã•ã‚Œã‚‹',
                icon: 'â°',
                rarity: 'common',
                color: '#ef4444'
            },
            hard_mode: {
                id: 'hard_mode',
                type: 'penalty',
                name: 'ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰',
                description: 'æ¬¡ã®ç¿’æ…£ã¯é”æˆç‡90%ä»¥ä¸Šã§ãªã„ã¨ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã§ããªã„',
                icon: 'âš¡',
                rarity: 'rare',
                color: '#dc2626'
            },
            reset_risk: {
                id: 'reset_risk',
                type: 'penalty',
                name: 'ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯',
                description: '3æ—¥é€£ç¶šã§æœªé”æˆã ã¨å…¨ã¦ã®é”æˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹',
                icon: 'ğŸ”„',
                rarity: 'rare',
                color: '#dc2626'
            },
            short_term: {
                id: 'short_term',
                type: 'penalty',
                name: 'çŸ­æœŸé›†ä¸­',
                description: 'æ¬¡ã®ç¿’æ…£ã¯å¿…ãšçŸ­æœŸé–“ï¼ˆ3-5æ—¥ï¼‰ã«ãªã‚‹',
                icon: 'â±ï¸',
                rarity: 'common',
                color: '#ef4444'
            },
            achievement_decrease: {
                id: 'achievement_decrease',
                type: 'penalty',
                name: 'é”æˆç‡æ¸›å°‘',
                description: 'æœ€çµ‚é”æˆç‡ã‹ã‚‰10%å¼•ã‹ã‚Œã‚‹',
                icon: 'ğŸ“‰',
                rarity: 'common',
                color: '#ef4444'
            },
            // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰
            protect_shield: {
                id: 'protect_shield',
                type: 'reward',
                name: 'ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰',
                description: 'æ¬¡ã®ç¿’æ…£ã§ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹',
                icon: 'ğŸ›¡ï¸',
                rarity: 'rare',
                color: '#10b981'
            },
            achievement_booster: {
                id: 'achievement_booster',
                type: 'reward',
                name: 'é”æˆç‡ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼',
                description: 'æœ€çµ‚é”æˆç‡ã«+15%ã®ãƒœãƒ¼ãƒŠã‚¹',
                icon: 'ğŸ“ˆ',
                rarity: 'common',
                color: '#3b82f6'
            },
            chaos_vortex: {
                id: 'chaos_vortex',
                type: 'penalty',
                name: 'æ··ä¹±ã®æ¸¦',
                description: 'é”æˆ/æœªé”æˆãŒãƒ©ãƒ³ãƒ€ãƒ ã§3æ—¥åˆ†å…¥ã‚Œæ›¿ã‚ã‚‹',
                icon: 'ğŸŒ€',
                rarity: 'rare',
                color: '#dc2626'
            },
            second_chance: {
                id: 'second_chance',
                type: 'reward',
                name: 'ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹',
                description: 'ç¿’æ…£çµ‚äº†å¾Œã§ã‚‚3æ—¥åˆ†è¿½åŠ ã§æŒ‘æˆ¦ã§ãã‚‹',
                icon: 'ğŸ¯',
                rarity: 'rare',
                color: '#10b981'
            },
            // æ–°è¦è¿½åŠ ã‚«ãƒ¼ãƒ‰ - å ±é…¬ã‚«ãƒ¼ãƒ‰
            event_trigger: {
                id: 'event_trigger',
                type: 'reward',
                name: 'ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼',
                description: 'æ˜æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿç¢ºç‡ã‚’100%ã«ã™ã‚‹',
                icon: 'ğŸª',
                rarity: 'rare',
                color: '#8b5cf6'
            },
            event_combo: {
                id: 'event_combo',
                type: 'reward',
                name: 'ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ³ãƒœ',
                description: '3æ—¥é–“é€£ç¶šã§ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã™ã‚‹',
                icon: 'ğŸ”®',
                rarity: 'legendary',
                color: '#ec4899'
            },
            point_gem: {
                id: 'point_gem',
                type: 'reward',
                name: 'ãƒã‚¤ãƒ³ãƒˆã‚¸ã‚§ãƒ ',
                description: 'æ¬¡ã®3æ—¥é–“ã€ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ2å€ã«ãªã‚‹',
                icon: 'ğŸ’',
                rarity: 'rare',
                color: '#06b6d4'
            },
            mission_master: {
                id: 'mission_master',
                type: 'reward',
                name: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ãƒ¼',
                description: 'ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒè‡ªå‹•é”æˆã•ã‚Œã‚‹',
                icon: 'ğŸ¯',
                rarity: 'legendary',
                color: '#f59e0b'
            },
            rainbow_boost: {
                id: 'rainbow_boost',
                type: 'reward',
                name: 'ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ–ãƒ¼ã‚¹ãƒˆ',
                description: 'å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç¿’æ…£ãŒä»Šæ—¥ã¯2å€ãƒã‚¤ãƒ³ãƒˆ',
                icon: 'ğŸŒˆ',
                rarity: 'legendary',
                color: '#a855f7'
            },
            quick_start: {
                id: 'quick_start',
                type: 'reward',
                name: 'ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ',
                description: 'æ¬¡ã®ç¿’æ…£ã®æœ€åˆã®3æ—¥ãŒè‡ªå‹•é”æˆ',
                icon: 'âš¡',
                rarity: 'rare',
                color: '#14b8a6'
            },
            streak_bonus: {
                id: 'streak_bonus',
                type: 'reward',
                name: 'é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹',
                description: '7æ—¥é€£ç¶šé”æˆã§ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ç¢ºå®š',
                icon: 'ğŸ”¥',
                rarity: 'rare',
                color: '#f97316'
            },
            lucky_seven: {
                id: 'lucky_seven',
                type: 'reward',
                name: 'ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³',
                description: 'ä»Šæ—¥ã‹ã‚‰7æ—¥é–“ã€ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ç‡2å€',
                icon: 'ğŸ°',
                rarity: 'legendary',
                color: '#eab308'
            },
            // æ–°è¦è¿½åŠ ã‚«ãƒ¼ãƒ‰ - ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰
            event_seal: {
                id: 'event_seal',
                type: 'penalty',
                name: 'ã‚¤ãƒ™ãƒ³ãƒˆå°å°',
                description: '3æ—¥é–“ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ãªã„',
                icon: 'ğŸŒ‘',
                rarity: 'common',
                color: '#64748b'
            },
            mission_overload: {
                id: 'mission_overload',
                type: 'penalty',
                name: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³è¿½åŠ ',
                description: 'ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒ2ã¤è¿½åŠ ã•ã‚Œã‚‹',
                icon: 'â›“ï¸',
                rarity: 'rare',
                color: '#991b1b'
            },
            slowdown: {
                id: 'slowdown',
                type: 'penalty',
                name: 'ã‚¹ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³',
                description: '3æ—¥é–“ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ0.5å€',
                icon: 'ğŸ•¸ï¸',
                rarity: 'common',
                color: '#7c2d12'
            },
            reverse_curse: {
                id: 'reverse_curse',
                type: 'penalty',
                name: 'é€†è»¢ã®å‘ªã„',
                description: '3æ—¥é–“ã€é”æˆã¨æœªé”æˆã®åŠ¹æœãŒåè»¢',
                icon: 'ğŸ­',
                rarity: 'legendary',
                color: '#581c87'
            },
            // æ–°è¦è¿½åŠ ã‚«ãƒ¼ãƒ‰ - ç‰¹æ®Šã‚«ãƒ¼ãƒ‰
            conversion_magic: {
                id: 'conversion_magic',
                type: 'special',
                name: 'å¤‰æ›ã®é­”æ³•',
                description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰1æšã‚’å ±é…¬ã‚«ãƒ¼ãƒ‰ã«å¤‰æ›',
                icon: 'ğŸª„',
                rarity: 'legendary',
                color: '#0891b2'
            },
            fate_dice: {
                id: 'fate_dice',
                type: 'special',
                name: 'é‹å‘½ã®ãƒ€ã‚¤ã‚¹',
                description: 'ãƒ©ãƒ³ãƒ€ãƒ ã§å ±é…¬ã‹ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœãŒç™ºå‹•ï¼ˆ50/50ï¼‰',
                icon: 'ğŸ²',
                rarity: 'rare',
                color: '#059669'
            },
            double_or_nothing: {
                id: 'double_or_nothing',
                type: 'penalty',
                name: 'ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°',
                description: 'æ¬¡ã®ç¿’æ…£ã§100%é”æˆã—ãªã„ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰2æš',
                icon: 'âš ï¸',
                rarity: 'rare',
                color: '#dc2626'
            }
        };

        // æœŸé–“ä¸­ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©
        const HABIT_EVENTS = {
            // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆ7/14/21æ—¥é”æˆæ™‚ï¼‰
            milestones: {
                7: {
                    title: 'ğŸŠ 1é€±é–“é”æˆãŠã‚ã§ã¨ã†ï¼',
                    message: 'ç¿’æ…£åŒ–ã¸ã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ãŸï¼',
                    rewards: ['bonus_points', 'motivation_boost']
                },
                14: {
                    title: 'ğŸ‰ 2é€±é–“é”æˆãŠã‚ã§ã¨ã†ï¼',
                    message: 'ç¿’æ…£ãŒèº«ã«ã¤ã„ã¦ãã¦ã„ã¾ã™ï¼',
                    rewards: ['bonus_points', 'special_card']
                },
                21: {
                    title: 'ğŸ† 3é€±é–“é”æˆãŠã‚ã§ã¨ã†ï¼',
                    message: 'ç¿’æ…£åŒ–ã¾ã§ã‚ã¨ä¸€æ­©ï¼ç´ æ™´ã‚‰ã—ã„ï¼',
                    rewards: ['huge_bonus', 'rare_card', 'achievement_unlock']
                }
            },
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãƒ–ãƒ¼ã‚¹ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
            boosts: [
                // å¼·åº¦ç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'intensity_boost_a',
                    name: 'ğŸ”¥ ç‡ƒãˆã‚‹æœˆæ›œæ—¥',
                    description: 'ä»Šæ—¥ã ã‘Aå¼·åº¦ã®ç¿’æ…£ãŒ1.5å€ãƒã‚¤ãƒ³ãƒˆï¼',
                    condition: (data) => new Date().getDay() === 1,  // æœˆæ›œæ—¥ã®ã¿
                    effect: { type: 'intensity_multiplier', target: 'A', value: 1.5 },
                    rarity: 'common',
                    duration: 'today'
                },
                {
                    id: 'super_intensity',
                    name: 'âš¡ ã‚¹ãƒ¼ãƒ‘ãƒ¼å¼·åº¦ãƒ‡ãƒ¼',
                    description: 'ä»Šæ—¥ã¯å…¨ã¦ã®å¼·åº¦ãŒ+0.3å€ï¼',
                    condition: () => true,  // æ¡ä»¶ãªã—ï¼ˆãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡ï¼‰
                    effect: { type: 'all_intensity_bonus', value: 0.3 },
                    rarity: 'rare',
                    duration: 'today'
                },
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'exercise_fever',
                    name: 'ğŸ’ª é‹å‹•ãƒ•ã‚£ãƒ¼ãƒãƒ¼',
                    description: 'é‹å‹•ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç¿’æ…£ãŒ2å€ãƒã‚¤ãƒ³ãƒˆï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'category_multiplier', target: 'exercise', value: 2.0 },
                    rarity: 'uncommon',
                    duration: 'today'
                },
                {
                    id: 'study_power',
                    name: 'ğŸ“š å‹‰å¼·ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—',
                    description: 'å‹‰å¼·ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç¿’æ…£ãŒ+5ãƒã‚¤ãƒ³ãƒˆãƒœãƒ¼ãƒŠã‚¹ï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'category_bonus', target: 'study', value: 5 },
                    rarity: 'uncommon',
                    duration: 'today'
                },
                
                // é€£ç¶šé”æˆç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'streak_accelerator',
                    name: 'ğŸš€ ã‚¹ãƒˆãƒªãƒ¼ã‚¯åŠ é€Ÿ',
                    description: 'é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹ãŒ2å€ã«ãªã‚‹ï¼',
                    condition: (data) => {
                        // 3æ—¥ä»¥ä¸Šé€£ç¶šé”æˆã—ã¦ã„ã‚‹ç¿’æ…£ãŒã‚ã‚‹å ´åˆã®ã¿
                        return data.currentHypotheses.some(h => 
                            Object.keys(h.achievements || {}).length >= 3
                        );
                    },
                    effect: { type: 'streak_multiplier', value: 2.0 },
                    rarity: 'rare',
                    duration: 'today'
                },
                
                // æ™‚é–“å¸¯ç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'early_bird',
                    name: 'ğŸŒ… æ—©èµ·ããƒœãƒ¼ãƒŠã‚¹',
                    description: 'æœ6æ™‚ã€œ9æ™‚ã®é”æˆã§+10ãƒã‚¤ãƒ³ãƒˆï¼',
                    condition: () => {
                        const hour = new Date().getHours();
                        return hour >= 6 && hour <= 9;  // æœã®æ™‚é–“å¸¯ã®ã¿
                    },
                    effect: { type: 'time_bonus', value: 10 },
                    rarity: 'common',
                    duration: 'morning'
                },
                {
                    id: 'night_owl',
                    name: 'ğŸ¦‰ å¤œå‹ãƒœãƒ¼ãƒŠã‚¹',
                    description: 'å¤œ20æ™‚ã€œ23æ™‚ã®é”æˆã§+8ãƒã‚¤ãƒ³ãƒˆï¼',
                    condition: () => {
                        const hour = new Date().getHours();
                        return hour >= 20 && hour <= 23;  // å¤œã®æ™‚é–“å¸¯ã®ã¿
                    },
                    effect: { type: 'time_bonus', value: 8 },
                    rarity: 'common',
                    duration: 'night'
                },
                
                // ç‰¹æ®Šç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'perfect_day',
                    name: 'âœ¨ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼',
                    description: 'ä»Šæ—¥å…¨ã¦ã®ç¿’æ…£ã‚’é”æˆã™ã‚‹ã¨+30ãƒã‚¤ãƒ³ãƒˆï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'perfect_bonus', value: 30 },
                    rarity: 'legendary',
                    duration: 'today'
                },
                {
                    id: 'double_points',
                    name: 'ğŸ’° ãƒ€ãƒ–ãƒ«ãƒã‚¤ãƒ³ãƒˆãƒ‡ãƒ¼',
                    description: 'ä»Šæ—¥ã ã‘å…¨ã¦ã®ãƒã‚¤ãƒ³ãƒˆãŒ2å€ï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'global_multiplier', value: 2.0 },
                    rarity: 'legendary',
                    duration: 'today'
                },
                {
                    id: 'challenge_master',
                    name: 'ğŸ¯ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒã‚¹ã‚¿ãƒ¼',
                    description: 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆãƒã‚¤ãƒ³ãƒˆ+50%ï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'challenge_multiplier', value: 1.5 },
                    rarity: 'uncommon',
                    duration: 'today'
                },
                
                // é€±æœ«ç‰¹åˆ¥ã‚¤ãƒ™ãƒ³ãƒˆ
                {
                    id: 'weekend_special',
                    name: 'ğŸˆ é€±æœ«ã‚¹ãƒšã‚·ãƒ£ãƒ«',
                    description: 'åœŸæ—¥é™å®šï¼åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãŒç„¡åˆ¶é™ã«ï¼',
                    condition: () => {
                        const day = new Date().getDay();
                        return (day === 0 || day === 6);  // åœŸæ—¥ã®ã¿
                    },
                    effect: { type: 'unlimited_effort', value: true },
                    rarity: 'rare',
                    duration: 'weekend'
                },
                
                // ã‚«ãƒ¼ãƒ‰ç³»ãƒ–ãƒ¼ã‚¹ãƒˆ
                {
                    id: 'card_drop_up',
                    name: 'ğŸ´ ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ç‡UP',
                    description: 'ã‚«ãƒ¼ãƒ‰å‡ºç¾ç‡ãŒ2å€ï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'card_drop_rate', value: 2.0 },
                    rarity: 'rare',
                    duration: 'today'
                },
                {
                    id: 'rare_card_chance',
                    name: 'ğŸŒŸ ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ãƒãƒ£ãƒ³ã‚¹',
                    description: 'ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ã®å‡ºç¾ç‡ãŒå¤§å¹…UPï¼',
                    condition: () => true,  // ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã§åˆ¶å¾¡
                    effect: { type: 'rare_card_boost', value: 3.0 },
                    rarity: 'legendary',
                    duration: 'today'
                }
            ]
        };

        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿
        const DAILY_CHALLENGES = [
            // ç”Ÿæ´»æ”¹å–„ç³»
            { id: 'meditation_5min', name: '5åˆ†é–“ç‘æƒ³', points: 3, icon: 'ğŸ§˜' },
            { id: 'no_device_30min', name: '30åˆ†é–“é›»å­æ©Ÿå™¨ã«è§¦ã‚‰ãªã„', points: 4, icon: 'ğŸ“µ' },
            { id: 'burpee_plus10', name: 'ãƒãƒ¼ãƒ”ãƒ¼+10å›', points: 5, icon: 'ğŸ’ª' },
            { id: 'reading_plus5', name: 'èª­æ›¸+5åˆ†', points: 3, icon: 'ğŸ“š' },
            { id: 'english_review', name: 'è‹±èªå¾©ç¿’', points: 3, icon: 'ğŸŒ' },
            { id: 'gratitude_journal', name: 'æ„Ÿè¬æ—¥è¨˜ã‚’1ã¤æ›¸ã', points: 2, icon: 'ğŸ“' },
            { id: 'water_plus1', name: 'æ°´ã‚’è¿½åŠ ã§1æ¯é£²ã‚€', points: 2, icon: 'ğŸ’§' },
            { id: 'use_stairs', name: 'éšæ®µã‚’ä½¿ã†', points: 2, icon: 'ğŸªœ' },
            { id: 'deep_breath_10', name: 'æ·±å‘¼å¸10å›', points: 2, icon: 'ğŸ«' },
            { id: 'organize_one', name: '1ã¤ç‰‡ä»˜ã‘ã‚‹', points: 2, icon: 'ğŸ§¹' },
            { id: 'say_thanks', name: 'èª°ã‹ã«ã€Œã‚ã‚ŠãŒã¨ã†ã€ã‚’ä¼ãˆã‚‹', points: 3, icon: 'ğŸ™' },
            { id: 'stretch_5min', name: 'ã‚¹ãƒˆãƒ¬ãƒƒãƒ5åˆ†', points: 3, icon: 'ğŸ¤¸' },
            { id: 'learn_word', name: 'æ–°ã—ã„å˜èªã‚’1ã¤è¦šãˆã‚‹', points: 3, icon: 'ğŸ“–' },
            { id: 'plank_plus10', name: 'ãƒ—ãƒ©ãƒ³ã‚¯+10ç§’', points: 4, icon: 'ğŸ‹ï¸' },
            { id: 'mindful_eating', name: 'ã‚¹ãƒãƒ›ã‚’è¦‹ãšã«é£Ÿäº‹', points: 3, icon: 'ğŸ½ï¸' },
            
            // ç¿’æ…£é”æˆãƒŸãƒƒã‚·ãƒ§ãƒ³ç³»
            { id: 'complete_3_habits', name: 'ä»Šæ—¥3ã¤ä»¥ä¸Šã®ç¿’æ…£ã‚’é”æˆ', points: 5, icon: 'ğŸ¯', checkFunction: 'checkComplete3Habits' },
            { id: 'morning_routine', name: 'æœã®ç¿’æ…£ã‚’ã™ã¹ã¦å®Œäº†', points: 4, icon: 'ğŸŒ…', checkFunction: 'checkMorningRoutine' },
            { id: 'high_intensity_day', name: 'ä»Šæ—¥ã™ã¹ã¦é«˜å¼·åº¦(Ã—1.2)ã§é”æˆ', points: 6, icon: 'ğŸ”¥', checkFunction: 'checkHighIntensityDay' },
            { id: 'perfect_streak', name: '3æ—¥é€£ç¶šã§å…¨ç¿’æ…£é”æˆ', points: 8, icon: 'âš¡', checkFunction: 'checkPerfectStreak' },
            { id: 'category_master', name: 'åŒã˜ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç¿’æ…£ã‚’3ã¤é”æˆ', points: 4, icon: 'ğŸ“Š', checkFunction: 'checkCategoryMaster' },
            { id: 'early_bird', name: 'åˆå‰ä¸­ã«ç¿’æ…£ã‚’2ã¤ä»¥ä¸Šé”æˆ', points: 3, icon: 'ğŸ¦', checkFunction: 'checkEarlyBird' },
            { id: 'if_then_execute', name: 'IF-THENãƒ«ãƒ¼ãƒ«ã‚’3å›å®Ÿè¡Œ', points: 4, icon: 'ğŸ”„', checkFunction: 'checkIfThenExecute' },
            { id: 'variety_day', name: '4ç¨®é¡ã®ç•°ãªã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é”æˆ', points: 6, icon: 'ğŸŒˆ', checkFunction: 'checkVarietyDay' },
            { id: 'consistency_bonus', name: 'åŒã˜æ™‚é–“å¸¯ã«ç¿’æ…£ã‚’å®Ÿè¡Œ', points: 3, icon: 'â°', checkFunction: 'checkConsistencyBonus' },
            { id: 'effort_bonus_max', name: 'åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚’æœ€å¤§ã¾ã§ä½¿ç”¨', points: 4, icon: 'ğŸ’ª', checkFunction: 'checkEffortBonusMax' },
            { id: 'habit_and_challenge', name: 'ç¿’æ…£ã¨ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä¸¡æ–¹é”æˆ', points: 5, icon: 'ğŸ†', checkFunction: 'checkHabitAndChallenge' }
        ];

        const WEEKLY_CHALLENGES = [
            // ç”Ÿæ´»æ”¹å–„ç³»
            { id: 'new_habit', name: 'æ–°ã—ã„ç¿’æ…£ã‚’ä½œã‚‹', points: 15, icon: 'ğŸŒ±' },
            { id: 'walking_plus1', name: 'ã‚¦ã‚©ãƒ¼ã‚­ãƒ³ã‚°é€±ä¸€å›è¿½åŠ ', points: 10, icon: 'ğŸš¶' },
            { id: 'room_cleanup', name: 'éƒ¨å±‹ã®å¤§æƒé™¤ï¼ˆ1ã‚¨ãƒªã‚¢ï¼‰', points: 12, icon: 'ğŸ§¼' },
            { id: 'talk_stranger', name: 'çŸ¥ã‚‰ãªã„äººã¨ä¼šè©±ã™ã‚‹', points: 15, icon: 'ğŸ’¬' },
            { id: 'early_rise_3days', name: 'æ—©èµ·ã3æ—¥é€£ç¶š', points: 20, icon: 'ğŸŒ…' },
            { id: 'try_new_sport', name: 'æ–°ã—ã„é‹å‹•ã‚’è©¦ã™', points: 12, icon: 'ğŸƒ' },
            { id: 'read_book', name: 'æœ¬ã‚’1å†Šèª­ã¿åˆ‡ã‚‹', points: 25, icon: 'ğŸ“•' },
            { id: 'volunteer', name: 'å¯„ä»˜/ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•', points: 20, icon: 'ğŸ¤' },
            
            // é€±é–“ç¿’æ…£ãƒŸãƒƒã‚·ãƒ§ãƒ³ç³»
            { id: 'week_perfect', name: 'ä»Šé€±ã™ã¹ã¦ã®ç¿’æ…£ã‚’90%ä»¥ä¸Šé”æˆ', points: 30, icon: 'ğŸ’¯', checkFunction: 'checkWeekPerfect' },
            { id: 'week_consistency', name: 'æ¯æ—¥åŒã˜æ™‚é–“ã«ç¿’æ…£ã‚’å®Ÿè¡Œ', points: 20, icon: 'â°', checkFunction: 'checkWeekConsistency' },
            { id: 'week_intensity_up', name: 'é€±ã®å¾ŒåŠã¯å¼·åº¦ã‚’ä¸Šã’ã¦é”æˆ', points: 18, icon: 'ğŸ“ˆ', checkFunction: 'checkWeekIntensityUp' },
            { id: 'week_all_categories', name: 'å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é€±3å›ä»¥ä¸Šé”æˆ', points: 25, icon: 'ğŸŒˆ', checkFunction: 'checkWeekAllCategories' },
            { id: 'week_if_then_master', name: 'IF-THENãƒ«ãƒ¼ãƒ«ã‚’20å›ä»¥ä¸Šå®Ÿè¡Œ', points: 22, icon: 'ğŸ”„', checkFunction: 'checkWeekIfThenMaster' },
            { id: 'week_card_collector', name: 'ã‚«ãƒ¼ãƒ‰ã‚’5æšä»¥ä¸Šç²å¾—', points: 20, icon: 'ğŸ´', checkFunction: 'checkWeekCardCollector' },
            { id: 'week_comeback', name: '3æ—¥ã‚µãƒœã£ã¦ã‹ã‚‰å¾©æ´»', points: 15, icon: 'ğŸ’ª', checkFunction: 'checkWeekComeback' },
            { id: 'week_habit_combo', name: 'ç¿’æ…£ã‚³ãƒ³ãƒœã‚’10å›é”æˆ', points: 18, icon: 'ğŸ”¥', checkFunction: 'checkWeekHabitCombo' },
            { id: 'week_challenge_master', name: 'ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸7é€£ç¶šé”æˆ', points: 20, icon: 'ğŸ†', checkFunction: 'checkWeekChallengeMaster' }
        ];

        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadData() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (!data) {
                return {
                    currentHypotheses: [],
                    completedHypotheses: [],
                    cards: {
                        inventory: [],
                        pendingPenalties: []
                    },
                    challenges: {
                        daily: null,
                        weekly: null,
                        completedToday: [],
                        completedThisWeek: [],
                        lastDailyReset: new Date().toDateString(),
                        lastWeeklyReset: new Date().toISOString(),
                        history: [],
                        streak: 0,
                        lastStreakDate: null,
                        totalCompleted: 0,
                        customChallenges: []
                    },
                    events: {
                        activeBoosts: [],
                        lastEventCheck: new Date().toISOString(),
                        milestoneNotifications: {},
                        eventHistory: [],
                        boostEnabled: true
                    },
                    cardAlbum: {
                        collection: {},
                        totalCardsObtained: 0,
                        firstObtainedDates: {},
                        viewHistory: []
                    },
                    meta: {}
                };
            }
            const parsed = JSON.parse(data);
            // æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿å¯¾å¿œ
            if (!parsed.cards) {
                parsed.cards = {
                    inventory: [],
                    pendingPenalties: []
                };
            }
            if (!parsed.completedHypotheses) {
                parsed.completedHypotheses = [];
            }
            if (!parsed.currentHypotheses) {
                parsed.currentHypotheses = [];
            }
            if (!parsed.meta) {
                parsed.meta = {};
            }
            // ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!parsed.pointSystem) {
                parsed.pointSystem = {
                    currentPoints: 0,
                    lifetimeEarned: 0,
                    lifetimeSpent: 0,
                    currentLevel: 1,
                    levelProgress: 0,
                    streakMultiplier: 1.0,
                    dailyEffortUsed: 0,
                    dailyEffortLastReset: new Date().toDateString(),
                    customRewards: [],
                    transactions: []
                };
            }
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!parsed.challenges) {
                parsed.challenges = {
                    daily: null,
                    weekly: null,
                    completedToday: [],
                    completedThisWeek: [],
                    lastDailyReset: new Date().toDateString(),
                    lastWeeklyReset: new Date().toISOString(),
                    history: [],
                    streak: 0,
                    lastStreakDate: null,
                    totalCompleted: 0,
                    customChallenges: []
                };
            }
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸å±¥æ­´ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!parsed.challenges.history) parsed.challenges.history = [];
            if (parsed.challenges.streak === undefined) parsed.challenges.streak = 0;
            if (!parsed.challenges.lastStreakDate) parsed.challenges.lastStreakDate = null;
            if (parsed.challenges.totalCompleted === undefined) parsed.challenges.totalCompleted = 0;
            if (!parsed.challenges.customChallenges) parsed.challenges.customChallenges = [];
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!parsed.events) {
                parsed.events = {
                    activeBoosts: [],
                    lastEventCheck: new Date().toISOString(),
                    milestoneNotifications: {},
                    eventHistory: [],
                    boostEnabled: true
                };
            }
            // ã‚«ãƒ¼ãƒ‰å›³é‘‘ãŒãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!parsed.cardAlbum) {
                parsed.cardAlbum = {
                    collection: {},
                    totalCardsObtained: 0,
                    firstObtainedDates: {},
                    viewHistory: []
                };
            }
            
            // æ—§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ–°ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ãƒãƒƒãƒ”ãƒ³ã‚°
            const categoryMapping = {
                'reading': 'hobby',    // èª­æ›¸ â†’ è¶£å‘³
                'wellness': 'health'   // é¤Šç”Ÿ â†’ å¥åº·
            };
            
            // ç¾åœ¨ã®ç¿’æ…£ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ›´æ–°
            if (parsed.currentHypotheses) {
                parsed.currentHypotheses.forEach(h => {
                    if (categoryMapping[h.category]) {
                        h.category = categoryMapping[h.category];
                    }
                });
            }
            
            // å®Œäº†æ¸ˆã¿ç¿’æ…£ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚‚æ›´æ–°
            if (parsed.completedHypotheses) {
                parsed.completedHypotheses.forEach(h => {
                    if (categoryMapping[h.category]) {
                        h.category = categoryMapping[h.category];
                    }
                });
            }
            
            // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰åŠªåŠ›ãƒã‚¤ãƒ³ãƒˆã¨ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
            const today = new Date().toDateString();
            if (parsed.pointSystem && parsed.pointSystem.dailyEffortLastReset !== today) {
                parsed.pointSystem.dailyEffortUsed = 0;
                parsed.pointSystem.dailyEffortLastReset = today;
            }
            if (parsed.challenges && parsed.challenges.lastDailyReset !== today) {
                parsed.challenges.daily = null;
                parsed.challenges.completedToday = [];
                parsed.challenges.lastDailyReset = today;
            }
            // é€±ãŒå¤‰ã‚ã£ãŸã‚‰ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            weekStart.setHours(0, 0, 0, 0);
            if (parsed.challenges && new Date(parsed.challenges.lastWeeklyReset) < weekStart) {
                parsed.challenges.weekly = null;
                parsed.challenges.completedThisWeek = [];
                parsed.challenges.lastWeeklyReset = weekStart.toISOString();
            }
            return parsed;
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ========== ãƒ‡ã‚¤ãƒªãƒ¼ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«é–¢é€£ã®é–¢æ•° ==========
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        function updateJournalStatus() {
            const data = loadData();
            const todayKey = getJournalDateKey(); // æ·±å¤œå¯¾å¿Œã®æ—¥ä»˜ã‚­ãƒ¼
            const statusContainer = document.getElementById('journal-status');
            
            if (!statusContainer) return;
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆæœŸåŒ–
            if (!data.dailyJournal) {
                data.dailyJournal = {
                    entries: {},
                    stats: {
                        currentStreak: 0,
                        longestStreak: 0,
                        totalEntries: 0,
                        lastEntry: null
                    },
                    settings: {
                        morningReminderTime: "06:00",
                        eveningReminderTime: "21:00",
                        remindersEnabled: true
                    }
                };
                saveData(data);
            }
            
            const todayEntry = data.dailyJournal.entries[todayKey] || {};
            const hasMorning = todayEntry.morning && todayEntry.morning.timestamp;
            const hasEvening = todayEntry.evening && todayEntry.evening.timestamp;
            
            const morningTime = hasMorning ? new Date(todayEntry.morning.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '';
            const eveningTime = hasEvening ? new Date(todayEntry.evening.timestamp).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '';
            
            // éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å–å¾—ï¼ˆæœ€å¤§5æ—¥åˆ†ï¼‰
            const pastJournals = [];
            const dates = Object.keys(data.dailyJournal.entries || {})
                .sort((a, b) => b.localeCompare(a))
                .slice(0, 5);
            
            dates.forEach(dateKey => {
                const entry = data.dailyJournal.entries[dateKey];
                if (entry && (entry.morning || entry.evening)) {
                    pastJournals.push({ dateKey, entry });
                }
            });
            
            statusContainer.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- ä»Šæ—¥ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ« -->
                    <div class="journal-entry-item ${hasMorning ? 'expandable' : ''}" data-type="morning" data-date="${todayKey}" 
                        style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden; transition: all 0.3s;"
                        ${hasMorning ? 'oncontextmenu="showJournalContextMenu(event, \'morning\'); return false;"' : ''}>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: ${hasMorning ? 'pointer' : 'default'};" 
                            ${hasMorning ? 'onclick="toggleJournalExpand(this.parentElement, \'morning\', \'' + todayKey + '\')"}' : ''}>
                            <span style="font-size: 14px;">ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</span>
                            ${hasMorning 
                                ? `<div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #10b981; font-size: 12px;">âœ… ${morningTime}</span>
                                    <span class="expand-icon" style="font-size: 12px; transition: transform 0.3s;">â–¼</span>
                                  </div>`
                                : `<span style="color: #f59e0b; font-size: 12px;">â³ ã¾ã è¨˜éŒ²ã—ã¦ã„ã¾ã›ã‚“</span>`
                            }
                        </div>
                        ${hasMorning ? `
                            <div class="journal-content" style="display: none; padding: 0 12px 12px; border-top: 1px solid var(--border);">
                                <div style="margin-top: 12px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ä½“èª¿: ${['ğŸ˜«', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][todayEntry.morning.condition - 1]} (${todayEntry.morning.condition}/5)</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ°—åˆ†: ${['ğŸ˜”', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Œ', 'ğŸ˜„'][todayEntry.morning.mood - 1]} (${todayEntry.morning.mood}/5)</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æœ€å„ªå…ˆäº‹é …:</div>
                                    <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px; margin-top: 4px;">${todayEntry.morning.priority || 'ãªã—'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="journal-entry-item ${hasEvening ? 'expandable' : ''}" data-type="evening" data-date="${todayKey}"
                        style="background: rgba(255, 255, 255, 0.05); border-radius: 8px; overflow: hidden; transition: all 0.3s;"
                        ${hasEvening ? 'oncontextmenu="showJournalContextMenu(event, \'evening\'); return false;"' : ''}>
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; cursor: ${hasEvening ? 'pointer' : 'default'};" 
                            ${hasEvening ? 'onclick="toggleJournalExpand(this.parentElement, \'evening\', \'' + todayKey + '\')"}' : ''}>
                            <span style="font-size: 14px;">ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</span>
                            ${hasEvening 
                                ? `<div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #10b981; font-size: 12px;">âœ… ${eveningTime}</span>
                                    <span class="expand-icon" style="font-size: 12px; transition: transform 0.3s;">â–¼</span>
                                  </div>`
                                : `<span style="color: #f59e0b; font-size: 12px;">â³ ã¾ã è¨˜éŒ²ã—ã¦ã„ã¾ã›ã‚“</span>`
                            }
                        </div>
                        ${hasEvening ? `
                            <div class="journal-content" style="display: none; padding: 0 12px 12px; border-top: 1px solid var(--border);">
                                <div style="margin-top: 12px;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ã†ã¾ãã„ã£ãŸã“ã¨:</div>
                                    <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px; margin-bottom: 8px;">${todayEntry.evening.success || 'ãªã—'}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ”¹å–„ç‚¹:</div>
                                    <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px;">${todayEntry.evening.improvement || 'ãªã—'}</div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${data.dailyJournal.stats.currentStreak > 0 ? `
                        <div style="text-align: center; padding: 4px; background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1)); border-radius: 8px; margin-top: 4px;">
                            <span style="font-size: 12px; color: #fbbf24;">ğŸ”¥ ${data.dailyJournal.stats.currentStreak}æ—¥é€£ç¶šè¨˜éŒ²ä¸­ï¼</span>
                        </div>
                    ` : ''}
                    
                    <!-- éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å±¥æ­´ãƒœã‚¿ãƒ³ -->
                    ${pastJournals.length > 1 ? `
                        <button onclick="showJournalHistory()" style="
                            margin-top: 8px;
                            padding: 10px;
                            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
                            border: 1px solid rgba(59, 130, 246, 0.3);
                            border-radius: 8px;
                            color: var(--text-primary);
                            cursor: pointer;
                            font-size: 13px;
                            transition: all 0.3s;
                        " onmouseover="this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2))'" 
                           onmouseout="this.style.background='linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1))'">
                            ğŸ“š éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’è¦‹ã‚‹
                        </button>
                    ` : ''}
                </div>
            `;
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”¨ã®æ—¥ä»˜ã‚­ãƒ¼ã‚’å–å¾—ï¼ˆgetActivityDateKeyã‚’ä½¿ç”¨ï¼‰
        function getJournalDateKey() {
            return getActivityDateKey();
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¨ãƒ³ãƒˆãƒªã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
        function toggleJournalExpand(element, type, dateKey) {
            const content = element.querySelector('.journal-content');
            const icon = element.querySelector('.expand-icon');
            
            if (content) {
                if (content.style.display === 'none') {
                    content.style.display = 'block';
                    if (icon) icon.style.transform = 'rotate(180deg)';
                } else {
                    content.style.display = 'none';
                    if (icon) icon.style.transform = 'rotate(0deg)';
                }
            }
        }
        window.toggleJournalExpand = toggleJournalExpand;
        
        // éå»ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å±¥æ­´ã‚’è¡¨ç¤º
        function showJournalHistory() {
            const data = loadData();
            const entries = data.dailyJournal.entries || {};
            
            // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            const sortedDates = Object.keys(entries)
                .filter(key => entries[key].morning || entries[key].evening)
                .sort((a, b) => b.localeCompare(a))
                .slice(0, 30); // æœ€å¤§30æ—¥åˆ†
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '600px';
            modal.style.maxHeight = '80vh';
            modal.style.overflow = 'auto';
            modal.style.padding = '24px';
            
            let historyHTML = `
                <div class="modal-header" style="margin-bottom: 20px; position: sticky; top: -24px; background: var(--surface); padding: 24px 0 12px; margin-top: -24px; z-index: 10;">
                    <h3 style="font-size: 20px; margin-bottom: 8px;">ğŸ“š ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å±¥æ­´</h3>
                    <p style="color: var(--text-secondary); font-size: 14px;">éå»30æ—¥é–“ã®è¨˜éŒ²</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
            `;
            
            sortedDates.forEach(dateKey => {
                const entry = entries[dateKey];
                const date = new Date(dateKey);
                const dateStr = date.toLocaleDateString('ja-JP', { 
                    month: 'numeric', 
                    day: 'numeric', 
                    weekday: 'short' 
                });
                
                historyHTML += `
                    <div style="border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: rgba(255, 255, 255, 0.02);">
                        <div style="padding: 12px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid var(--border);">
                            <strong style="font-size: 14px;">ğŸ“… ${dateStr}</strong>
                        </div>
                `;
                
                if (entry.morning) {
                    const morningTime = new Date(entry.morning.timestamp).toLocaleTimeString('ja-JP', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    historyHTML += `
                        <div class="history-journal-item" style="padding: 12px; border-bottom: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600;">ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</span>
                                <span style="font-size: 11px; color: var(--text-secondary);">${morningTime}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); display: flex; gap: 12px; margin-bottom: 6px;">
                                <span>ä½“èª¿: ${['ğŸ˜«', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][entry.morning.condition - 1]} ${entry.morning.condition}/5</span>
                                <span>æ°—åˆ†: ${['ğŸ˜”', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Œ', 'ğŸ˜„'][entry.morning.mood - 1]} ${entry.morning.mood}/5</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æœ€å„ªå…ˆäº‹é …:</div>
                            <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px;">
                                ${entry.morning.priority || 'ãªã—'}
                            </div>
                        </div>
                    `;
                }
                
                if (entry.evening) {
                    const eveningTime = new Date(entry.evening.timestamp).toLocaleTimeString('ja-JP', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    historyHTML += `
                        <div class="history-journal-item" style="padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 14px; font-weight: 600;">ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</span>
                                <span style="font-size: 11px; color: var(--text-secondary);">${eveningTime}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">ã†ã¾ãã„ã£ãŸã“ã¨:</div>
                                <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px;">
                                    ${entry.evening.success || 'ãªã—'}
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">æ”¹å–„ç‚¹:</div>
                                <div style="font-size: 13px; background: var(--surface); padding: 8px; border-radius: 6px;">
                                    ${entry.evening.improvement || 'ãªã—'}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                historyHTML += `</div>`;
            });
            
            historyHTML += `
                </div>
                <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; position: sticky; bottom: -24px; background: var(--surface); padding: 12px 0 0; margin-bottom: -24px;">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">é–‰ã˜ã‚‹</button>
                </div>
            `;
            
            modal.innerHTML = historyHTML;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };
        }
        window.showJournalHistory = showJournalHistory;
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openJournalModal() {
            const data = loadData();
            const todayKey = getJournalDateKey(); // æ·±å¤œå¯¾å¿œã®æ—¥ä»˜ã‚­ãƒ¼
            const todayEntry = data.dailyJournal.entries[todayKey] || {};
            const currentHour = new Date().getHours();
            
            // æœã‹å¤œã‹ã‚’åˆ¤å®šï¼ˆ12æ™‚ã‚’å¢ƒã«ã€ãŸã ã—æ·±å¤œ2æ™‚ã¾ã§å¤œæ‰±ã„ï¼‰
            const isMorning = currentHour >= 2 && currentHour < 12;
            const showMorning = isMorning || !todayEntry.morning;
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '520px';
            modal.style.padding = '24px';
            
            if (showMorning) {
                // æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
                modal.innerHTML = `
                    <div class="modal-header" style="margin-bottom: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 8px;">ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">ä»Šæ—¥ã®ã‚¹ã‚¿ãƒ¼ãƒˆã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">ä½“èª¿ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</label>
                        <div id="condition-selector" style="display: flex; gap: 12px; justify-content: space-between;">
                            ${[1,2,3,4,5].map(i => `
                                <button class="mood-btn" data-value="${i}" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: 2px solid var(--border);
                                    border-radius: 12px;
                                    background: var(--surface);
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    text-align: center;
                                ">
                                    <div style="font-size: 24px; margin-bottom: 4px;">${['ğŸ˜«', 'ğŸ˜Ÿ', 'ğŸ˜', 'ğŸ™‚', 'ğŸ˜Š'][i-1]}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${i}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">æ°—åˆ†ã¯ã©ã†ã§ã™ã‹ï¼Ÿ</label>
                        <div id="mood-selector" style="display: flex; gap: 12px; justify-content: space-between;">
                            ${[1,2,3,4,5].map(i => `
                                <button class="mood-btn" data-value="${i}" style="
                                    flex: 1;
                                    padding: 12px;
                                    border: 2px solid var(--border);
                                    border-radius: 12px;
                                    background: var(--surface);
                                    cursor: pointer;
                                    transition: all 0.3s;
                                    text-align: center;
                                ">
                                    <div style="font-size: 24px; margin-bottom: 4px;">${['ğŸ˜”', 'ğŸ˜•', 'ğŸ˜', 'ğŸ˜Œ', 'ğŸ˜„'][i-1]}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${i}</div>
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">ä»Šæ—¥ã®æœ€å„ªå…ˆäº‹é …ã¯ï¼Ÿ</label>
                        <textarea id="priority-input" placeholder="ä¾‹: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆXã®ä¼ç”»æ›¸ã‚’å®Œæˆã•ã›ã‚‹" 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
                            background: var(--surface); color: var(--text-primary); min-height: 80px; resize: vertical;"
                            maxlength="200">${todayEntry.morning?.priority || ''}</textarea>
                        <div style="text-align: right; margin-top: 4px;">
                            <span id="priority-count" style="font-size: 12px; color: var(--text-secondary);">0/200</span>
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="button primary" onclick="saveMorningJournal()" style="background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);">
                            ğŸ“ ä¿å­˜ã—ã¦+1ptç²å¾—
                        </button>
                    </div>
                `;
            } else {
                // å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
                modal.innerHTML = `
                    <div class="modal-header" style="margin-bottom: 20px;">
                        <h3 style="font-size: 20px; margin-bottom: 8px;">ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">ä»Šæ—¥ã‚’æŒ¯ã‚Šè¿”ã£ã¦ã¿ã¾ã—ã‚‡ã†</p>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">ä»Šæ—¥ã†ã¾ãã„ã£ãŸã“ã¨ã¯ï¼Ÿ</label>
                        <textarea id="success-input" placeholder="ä¾‹: ä¼ç”»æ›¸ã‚’äºˆå®šé€šã‚Šå®Œæˆã§ããŸã€‚ãƒãƒ¼ãƒ ã¨ã®é€£æºã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã ã£ãŸ" 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
                            background: var(--surface); color: var(--text-primary); min-height: 100px; resize: vertical;"
                            maxlength="300">${todayEntry.evening?.success || ''}</textarea>
                        <div style="text-align: right; margin-top: 4px;">
                            <span id="success-count" style="font-size: 12px; color: var(--text-secondary);">0/300</span>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 24px;">
                        <label style="display: block; margin-bottom: 12px; font-weight: 600;">æ”¹å–„ç‚¹ã¯ï¼Ÿ</label>
                        <textarea id="improvement-input" placeholder="ä¾‹: æ™‚é–“é…åˆ†ã‚’ã‚‚ã£ã¨è¨ˆç”»çš„ã«ã™ã¹ãã ã£ãŸ" 
                            style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; 
                            background: var(--surface); color: var(--text-primary); min-height: 100px; resize: vertical;"
                            maxlength="300">${todayEntry.evening?.improvement || ''}</textarea>
                        <div style="text-align: right; margin-top: 4px;">
                            <span id="improvement-count" style="font-size: 12px; color: var(--text-secondary);">0/300</span>
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button class="button primary" onclick="saveEveningJournal()" style="background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);">
                            ğŸ“ ä¿å­˜ã—ã¦+1ptç²å¾—
                        </button>
                    </div>
                `;
            }
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setTimeout(() => {
                if (showMorning) {
                    // ä½“èª¿ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                    document.querySelectorAll('#condition-selector .mood-btn').forEach(btn => {
                        btn.onclick = () => {
                            document.querySelectorAll('#condition-selector .mood-btn').forEach(b => {
                                b.style.border = '2px solid var(--border)';
                                b.style.background = 'var(--surface)';
                            });
                            btn.style.border = '2px solid #10b981';
                            btn.style.background = 'rgba(16, 185, 129, 0.1)';
                            btn.dataset.selected = 'true';
                        };
                        // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã°é¸æŠ
                        if (todayEntry.morning?.condition == btn.dataset.value) {
                            btn.click();
                        }
                    });
                    
                    // æ°—åˆ†ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
                    document.querySelectorAll('#mood-selector .mood-btn').forEach(btn => {
                        btn.onclick = () => {
                            document.querySelectorAll('#mood-selector .mood-btn').forEach(b => {
                                b.style.border = '2px solid var(--border)';
                                b.style.background = 'var(--surface)';
                            });
                            btn.style.border = '2px solid #3b82f6';
                            btn.style.background = 'rgba(59, 130, 246, 0.1)';
                            btn.dataset.selected = 'true';
                        };
                        // æ—¢å­˜ã®å€¤ãŒã‚ã‚Œã°é¸æŠ
                        if (todayEntry.morning?.mood == btn.dataset.value) {
                            btn.click();
                        }
                    });
                    
                    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
                    const priorityInput = document.getElementById('priority-input');
                    const priorityCount = document.getElementById('priority-count');
                    priorityInput.oninput = () => {
                        priorityCount.textContent = `${priorityInput.value.length}/200`;
                    };
                    priorityInput.oninput();
                } else {
                    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
                    const successInput = document.getElementById('success-input');
                    const successCount = document.getElementById('success-count');
                    const improvementInput = document.getElementById('improvement-input');
                    const improvementCount = document.getElementById('improvement-count');
                    
                    successInput.oninput = () => {
                        successCount.textContent = `${successInput.value.length}/300`;
                    };
                    improvementInput.oninput = () => {
                        improvementCount.textContent = `${improvementInput.value.length}/300`;
                    };
                    successInput.oninput();
                    improvementInput.oninput();
                }
            }, 100);
        }
        
        // æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜
        function saveMorningJournal() {
            let data = loadData();
            const todayKey = getJournalDateKey(); // æ·±å¤œå¯¾å¿œã®æ—¥ä»˜ã‚­ãƒ¼
            
            // é¸æŠã•ã‚ŒãŸå€¤ã‚’å–å¾—
            const conditionBtn = document.querySelector('#condition-selector .mood-btn[data-selected="true"]');
            const moodBtn = document.querySelector('#mood-selector .mood-btn[data-selected="true"]');
            const priority = document.getElementById('priority-input').value.trim();
            
            if (!conditionBtn || !moodBtn || !priority) {
                showNotification('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            if (!data.dailyJournal.entries[todayKey]) {
                data.dailyJournal.entries[todayKey] = {};
            }
            
            console.log('æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ =', data.dailyJournal.entries[todayKey].morning);
            const isFirstTime = !data.dailyJournal.entries[todayKey].morning;
            console.log('æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šåˆå›åˆ¤å®š =', isFirstTime);
            
            data.dailyJournal.entries[todayKey].morning = {
                condition: parseInt(conditionBtn.dataset.value),
                mood: parseInt(moodBtn.dataset.value),
                priority: priority,
                timestamp: new Date().toISOString(),
                pointsEarned: isFirstTime ? 1 : 0
            };
            
            // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
            updateJournalStreak(data);
            
            // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(data);
            
            // ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ï¼ˆåˆå›ã®ã¿ï¼‰
            if (isFirstTime) {
                console.log('æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šåˆå›è¨˜éŒ²ãªã®ã§ãƒã‚¤ãƒ³ãƒˆä»˜ä¸');
                earnPoints(1, 'journal', 'ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¨˜éŒ²');
            }
            
            // UIã‚’æ›´æ–°
            updateJournalStatus();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelector('.overlay').remove();
            
            showNotification('ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼', 'success');
        }
        
        // å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ä¿å­˜
        function saveEveningJournal() {
            let data = loadData();
            const todayKey = getJournalDateKey(); // æ·±å¤œå¯¾å¿œã®æ—¥ä»˜ã‚­ãƒ¼
            
            const success = document.getElementById('success-input').value.trim();
            const improvement = document.getElementById('improvement-input').value.trim();
            
            if (!success || !improvement) {
                showNotification('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            if (!data.dailyJournal.entries[todayKey]) {
                data.dailyJournal.entries[todayKey] = {};
            }
            
            console.log('å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ =', data.dailyJournal.entries[todayKey].evening);
            const isFirstTime = !data.dailyJournal.entries[todayKey].evening;
            console.log('å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šåˆå›åˆ¤å®š =', isFirstTime);
            
            data.dailyJournal.entries[todayKey].evening = {
                success: success,
                improvement: improvement,
                timestamp: new Date().toISOString(),
                pointsEarned: isFirstTime ? 1 : 0
            };
            
            // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
            updateJournalStreak(data);
            
            // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(data);
            
            // ãƒã‚¤ãƒ³ãƒˆã‚’ä»˜ä¸ï¼ˆåˆå›ã®ã¿ï¼‰
            if (isFirstTime) {
                console.log('å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼šåˆå›è¨˜éŒ²ãªã®ã§ãƒã‚¤ãƒ³ãƒˆä»˜ä¸');
                earnPoints(1, 'journal', 'ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«è¨˜éŒ²');
            }
            
            // UIã‚’æ›´æ–°
            updateJournalStatus();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            document.querySelector('.overlay').remove();
            
            showNotification('ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’è¨˜éŒ²ã—ã¾ã—ãŸï¼', 'success');
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«çµ±è¨ˆã‚’æ›´æ–°
        function updateJournalStats() {
            const data = loadData();
            const container = document.getElementById('journal-stats-content');
            
            if (!container || !data.dailyJournal) return;
            
            const entries = data.dailyJournal.entries || {};
            const entryDates = Object.keys(entries).sort();
            
            // åŸºæœ¬çµ±è¨ˆ
            const totalEntries = entryDates.length;
            const morningEntries = entryDates.filter(date => entries[date].morning).length;
            const eveningEntries = entryDates.filter(date => entries[date].evening).length;
            const completeEntries = entryDates.filter(date => entries[date].morning && entries[date].evening).length;
            
            // æœ€è¿‘7æ—¥é–“ã®ä½“èª¿ãƒ»æ°—åˆ†ã‚’è¨ˆç®—
            const last7Days = entryDates.slice(-7);
            let avgCondition = 0;
            let avgMood = 0;
            let conditionCount = 0;
            let moodCount = 0;
            
            last7Days.forEach(date => {
                if (entries[date].morning) {
                    if (entries[date].morning.condition) {
                        avgCondition += entries[date].morning.condition;
                        conditionCount++;
                    }
                    if (entries[date].morning.mood) {
                        avgMood += entries[date].morning.mood;
                        moodCount++;
                    }
                }
            });
            
            if (conditionCount > 0) avgCondition = (avgCondition / conditionCount).toFixed(1);
            if (moodCount > 0) avgMood = (avgMood / moodCount).toFixed(1);
            
            // ã‚ˆãã§ããŸã“ã¨TOP3ã‚’æŠ½å‡º
            const successWords = {};
            const improvementWords = {};
            
            entryDates.forEach(date => {
                if (entries[date].evening) {
                    // ç°¡å˜ãªå˜èªæŠ½å‡ºï¼ˆåè©ã£ã½ã„ã‚‚ã®ï¼‰
                    if (entries[date].evening.success) {
                        const words = entries[date].evening.success.match(/[ä¸€-é¾¥]{2,}/g) || [];
                        words.forEach(word => {
                            successWords[word] = (successWords[word] || 0) + 1;
                        });
                    }
                    if (entries[date].evening.improvement) {
                        const words = entries[date].evening.improvement.match(/[ä¸€-é¾¥]{2,}/g) || [];
                        words.forEach(word => {
                            improvementWords[word] = (improvementWords[word] || 0) + 1;
                        });
                    }
                }
            });
            
            const topSuccess = Object.entries(successWords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([word, count]) => `${word} (${count}å›)`);
            
            const topImprovement = Object.entries(improvementWords)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([word, count]) => `${word} (${count}å›)`);
            
            // éå»30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ„Ÿæƒ…æ¨ç§»ã‚°ãƒ©ãƒ•ç”¨ï¼‰
            const last30Days = [];
            const today = new Date();
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = dateKeyLocal(date);
                const entry = entries[dateKey];
                
                last30Days.push({
                    date: (date.getMonth() + 1) + '/' + date.getDate(),
                    condition: entry?.morning?.condition || null,
                    mood: entry?.morning?.mood || null,
                    hasData: !!(entry?.morning)
                });
            }
            
            // æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
            const weekdayStats = {
                0: { name: 'æ—¥', condition: [], mood: [], records: 0 },
                1: { name: 'æœˆ', condition: [], mood: [], records: 0 },
                2: { name: 'ç«', condition: [], mood: [], records: 0 },
                3: { name: 'æ°´', condition: [], mood: [], records: 0 },
                4: { name: 'æœ¨', condition: [], mood: [], records: 0 },
                5: { name: 'é‡‘', condition: [], mood: [], records: 0 },
                6: { name: 'åœŸ', condition: [], mood: [], records: 0 }
            };
            
            entryDates.forEach(dateStr => {
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const weekday = date.getDay();
                const entry = entries[dateStr];
                
                if (entry.morning) {
                    weekdayStats[weekday].records++;
                    if (entry.morning.condition) {
                        weekdayStats[weekday].condition.push(entry.morning.condition);
                    }
                    if (entry.morning.mood) {
                        weekdayStats[weekday].mood.push(entry.morning.mood);
                    }
                }
            });
            
            // æ›œæ—¥åˆ¥å¹³å‡ã‚’è¨ˆç®—
            const weekdayAverages = Object.entries(weekdayStats).map(([day, stats]) => {
                const avgCondition = stats.condition.length > 0 
                    ? (stats.condition.reduce((a, b) => a + b, 0) / stats.condition.length).toFixed(1)
                    : null;
                const avgMood = stats.mood.length > 0
                    ? (stats.mood.reduce((a, b) => a + b, 0) / stats.mood.length).toFixed(1)
                    : null;
                
                return {
                    day: parseInt(day),
                    name: stats.name,
                    avgCondition,
                    avgMood,
                    records: stats.records
                };
            });
            
            // ãƒ™ã‚¹ãƒˆï¼†ãƒ¯ãƒ¼ã‚¹ãƒˆæ›œæ—¥ã‚’ç‰¹å®š
            const validWeekdays = weekdayAverages.filter(d => d.avgCondition && d.avgMood);
            const bestDay = validWeekdays.length > 0 
                ? validWeekdays.reduce((best, current) => {
                    const bestScore = parseFloat(best.avgCondition) + parseFloat(best.avgMood);
                    const currentScore = parseFloat(current.avgCondition) + parseFloat(current.avgMood);
                    return currentScore > bestScore ? current : best;
                })
                : null;
            
            const worstDay = validWeekdays.length > 0
                ? validWeekdays.reduce((worst, current) => {
                    const worstScore = parseFloat(worst.avgCondition) + parseFloat(worst.avgMood);
                    const currentScore = parseFloat(current.avgCondition) + parseFloat(current.avgMood);
                    return currentScore < worstScore ? current : worst;
                })
                : null;
            
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 16px;">
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #a855f7;">${data.dailyJournal.stats.currentStreak}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯</div>
                    </div>
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #3b82f6;">${completeEntries}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">å®Œå…¨è¨˜éŒ²æ—¥æ•°</div>
                    </div>
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #10b981;">${avgCondition || '-'}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">å¹³å‡ä½“èª¿ (7æ—¥)</div>
                    </div>
                    <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${avgMood || '-'}</div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">å¹³å‡æ°—åˆ† (7æ—¥)</div>
                    </div>
                </div>
                
                ${
                    // æ„Ÿæƒ…æ¨ç§»ã‚°ãƒ©ãƒ•
                    last30Days.some(d => d.hasData) ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">ğŸ“ˆ æ„Ÿæƒ…æ¨ç§»ï¼ˆ30æ—¥é–“ï¼‰</h4>
                        <div style="position: relative; height: 120px; border-left: 2px solid var(--border); border-bottom: 2px solid var(--border);">
                            <div style="position: absolute; left: -20px; top: 0; font-size: 10px; color: var(--text-secondary);">5</div>
                            <div style="position: absolute; left: -20px; top: 50%; transform: translateY(-50%); font-size: 10px; color: var(--text-secondary);">3</div>
                            <div style="position: absolute; left: -20px; bottom: 0; font-size: 10px; color: var(--text-secondary);">1</div>
                            
                            <!-- ä½“èª¿ã®ç·š -->
                            <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" viewBox="0 0 100 100" preserveAspectRatio="none">
                                <polyline
                                    points="${last30Days.map((d, i) => {
                                        if (!d.condition) return null;
                                        const x = (i / 29) * 100;
                                        const y = 100 - ((d.condition - 1) / 4) * 100;
                                        return `${x},${y}`;
                                    }).filter(p => p).join(' ')}"
                                    fill="none"
                                    stroke="#10b981"
                                    stroke-width="2"
                                    opacity="0.8"
                                />
                                <!-- æ°—åˆ†ã®ç·š -->
                                <polyline
                                    points="${last30Days.map((d, i) => {
                                        if (!d.mood) return null;
                                        const x = (i / 29) * 100;
                                        const y = 100 - ((d.mood - 1) / 4) * 100;
                                        return `${x},${y}`;
                                    }).filter(p => p).join(' ')}"
                                    fill="none"
                                    stroke="#f59e0b"
                                    stroke-width="2"
                                    opacity="0.8"
                                />
                            </svg>
                            
                            <!-- æ—¥ä»˜ãƒ©ãƒ™ãƒ« -->
                            <div style="display: flex; justify-content: space-between; position: absolute; bottom: -20px; left: 0; right: 0; font-size: 10px; color: var(--text-secondary);">
                                <span>${last30Days[0].date}</span>
                                <span>${last30Days[14].date}</span>
                                <span>${last30Days[29].date}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 16px; margin-top: 24px; font-size: 11px;">
                            <span style="color: #10b981;">â— ä½“èª¿</span>
                            <span style="color: #f59e0b;">â— æ°—åˆ†</span>
                        </div>
                    </div>
                ` : ''
                }
                
                ${
                    // æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³
                    validWeekdays.length > 0 ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">ğŸ—“ï¸ æ›œæ—¥åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³</h4>
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 12px;">
                            ${weekdayAverages.map(day => `
                                <div style="text-align: center; padding: 8px 4px; background: ${
                                    bestDay && day.day === bestDay.day ? 'rgba(16, 185, 129, 0.2)' :
                                    worstDay && day.day === worstDay.day ? 'rgba(239, 68, 68, 0.2)' :
                                    'rgba(255,255,255,0.05)'
                                }; border-radius: 6px; border: 1px solid ${
                                    bestDay && day.day === bestDay.day ? 'rgba(16, 185, 129, 0.5)' :
                                    worstDay && day.day === worstDay.day ? 'rgba(239, 68, 68, 0.5)' :
                                    'transparent'
                                };">
                                    <div style="font-size: 12px; font-weight: bold; margin-bottom: 4px;">${day.name}</div>
                                    <div style="font-size: 10px; color: #10b981;">ğŸ˜Š ${day.avgCondition || '-'}</div>
                                    <div style="font-size: 10px; color: #f59e0b;">ğŸ’­ ${day.avgMood || '-'}</div>
                                    <div style="font-size: 9px; color: var(--text-secondary); margin-top: 2px;">${day.records}å›</div>
                                </div>
                            `).join('')}
                        </div>
                        ${bestDay ? `
                            <div style="display: flex; gap: 12px; font-size: 11px;">
                                <span style="color: #10b981;">âœ¨ æœ€ã‚‚èª¿å­ãŒè‰¯ã„: ${bestDay.name}æ›œæ—¥</span>
                                ${worstDay ? `<span style="color: #ef4444;">ğŸ“Š èª¿å­ãŒä½ã„: ${worstDay.name}æ›œæ—¥</span>` : ''}
                            </div>
                        ` : ''}
                    </div>
                ` : ''
                }
                
                ${topSuccess.length > 0 ? `
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                        <h4 style="font-size: 14px; margin-bottom: 8px; color: #10b981;">ğŸ† ã‚ˆãã§ããŸã“ã¨ TOP3</h4>
                        <ol style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-secondary);">
                            ${topSuccess.map(item => `<li>${item}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
                
                ${topImprovement.length > 0 ? `
                    <div style="background: rgba(245, 158, 11, 0.1); padding: 12px; border-radius: 8px;">
                        <h4 style="font-size: 14px; margin-bottom: 8px; color: #f59e0b;">ğŸ’¡ æ”¹å–„ãƒ†ãƒ¼ãƒ TOP3</h4>
                        <ol style="margin: 0; padding-left: 20px; font-size: 12px; color: var(--text-secondary);">
                            ${topImprovement.map(item => `<li>${item}</li>`).join('')}
                        </ol>
                    </div>
                ` : ''}
                
                ${totalEntries === 0 ? `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 14px;">
                        ã¾ã ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                ` : ''}
                
                ${
                    // æœˆåˆ¥è¨˜éŒ²ç‡ã¨æ„Ÿæƒ…æ¨ç§»
                    totalEntries > 0 ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">ğŸ“… æœˆåˆ¥è¨˜éŒ²çŠ¶æ³</h4>
                        ${generateMonthlyStats(entries)}
                    </div>
                ` : ''
                }
                
                ${
                    // æ™‚é–“å¸¯åˆ¥è¨˜éŒ²ãƒ‘ã‚¿ãƒ¼ãƒ³
                    totalEntries > 0 ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">â° è¨˜éŒ²æ™‚é–“å¸¯åˆ†æ</h4>
                        ${generateTimePatternAnalysis(entries)}
                    </div>
                ` : ''
                }
                
                ${
                    // æ„Ÿæƒ…ã¨ç¿’æ…£é”æˆç‡ã®ç›¸é–¢
                    totalEntries > 0 && data.currentHypotheses && data.currentHypotheses.length > 0 ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">ğŸ”— æ„Ÿæƒ…ã¨ç¿’æ…£ã®ç›¸é–¢</h4>
                        ${generateEmotionHabitCorrelation(entries, data.currentHypotheses)}
                    </div>
                ` : ''
                }
                
                ${
                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰
                    totalEntries > 10 ? `
                    <div style="background: rgba(0,0,0,0.2); padding: 16px; border-radius: 8px; margin-top: 16px;">
                        <h4 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">â˜ï¸ ã‚ˆãä½¿ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>
                        ${generateWordCloud(entries)}
                    </div>
                ` : ''
                }
            `;
        }
        
        // æœˆåˆ¥çµ±è¨ˆã‚’ç”Ÿæˆ
        function generateMonthlyStats(entries) {
            const monthlyData = {};
            
            // ã‚¨ãƒ³ãƒˆãƒªã‚’æœˆåˆ¥ã«é›†è¨ˆ
            Object.entries(entries).forEach(([dateStr, entry]) => {
                const [year, month] = dateStr.split('-');
                const monthKey = `${year}-${month}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        total: 0,
                        morning: 0,
                        evening: 0,
                        complete: 0,
                        conditions: [],
                        moods: []
                    };
                }
                
                monthlyData[monthKey].total++;
                if (entry.morning) {
                    monthlyData[monthKey].morning++;
                    if (entry.morning.condition) monthlyData[monthKey].conditions.push(entry.morning.condition);
                    if (entry.morning.mood) monthlyData[monthKey].moods.push(entry.morning.mood);
                }
                if (entry.evening) monthlyData[monthKey].evening++;
                if (entry.morning && entry.evening) monthlyData[monthKey].complete++;
            });
            
            // æœ€æ–°6ãƒ¶æœˆåˆ†ã‚’è¡¨ç¤º
            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 8px;">
                    ${sortedMonths.map(monthKey => {
                        const data = monthlyData[monthKey];
                        const [year, month] = monthKey.split('-');
                        const daysInMonth = new Date(year, month, 0).getDate();
                        const recordRate = Math.round((data.complete / daysInMonth) * 100);
                        const avgCondition = data.conditions.length > 0 
                            ? (data.conditions.reduce((a, b) => a + b, 0) / data.conditions.length).toFixed(1)
                            : '-';
                        const avgMood = data.moods.length > 0
                            ? (data.moods.reduce((a, b) => a + b, 0) / data.moods.length).toFixed(1)
                            : '-';
                        
                        return `
                            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div style="font-size: 11px; font-weight: bold; margin-bottom: 4px;">${parseInt(month)}æœˆ</div>
                                <div style="font-size: 18px; font-weight: bold; color: ${
                                    recordRate >= 80 ? '#10b981' :
                                    recordRate >= 50 ? '#f59e0b' :
                                    '#ef4444'
                                };">${recordRate}%</div>
                                <div style="font-size: 9px; color: var(--text-secondary); margin-top: 2px;">
                                    ğŸ˜Š${avgCondition} ğŸ’­${avgMood}
                                </div>
                                <div style="font-size: 9px; color: var(--text-secondary);">
                                    ${data.complete}/${daysInMonth}æ—¥
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // æ™‚é–“å¸¯åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã‚’ç”Ÿæˆ
        function generateTimePatternAnalysis(entries) {
            const timePatterns = {
                morning: { early: 0, normal: 0, late: 0 },  // æ—©æœ(~7æ™‚)ã€é€šå¸¸(7-9æ™‚)ã€é…ã‚(9æ™‚~)
                evening: { early: 0, normal: 0, late: 0 }   // æ—©ã‚(~20æ™‚)ã€é€šå¸¸(20-22æ™‚)ã€æ·±å¤œ(22æ™‚~)
            };
            
            Object.entries(entries).forEach(([dateStr, entry]) => {
                if (entry.morning && entry.morning.timestamp) {
                    const hour = new Date(entry.morning.timestamp).getHours();
                    if (hour < 7) timePatterns.morning.early++;
                    else if (hour < 9) timePatterns.morning.normal++;
                    else timePatterns.morning.late++;
                }
                if (entry.evening && entry.evening.timestamp) {
                    const hour = new Date(entry.evening.timestamp).getHours();
                    if (hour < 20) timePatterns.evening.early++;
                    else if (hour < 22) timePatterns.evening.normal++;
                    else timePatterns.evening.late++;
                }
            });
            
            const totalMorning = timePatterns.morning.early + timePatterns.morning.normal + timePatterns.morning.late;
            const totalEvening = timePatterns.evening.early + timePatterns.evening.normal + timePatterns.evening.late;
            
            return `
                <div style="display: grid; gap: 12px;">
                    <div>
                        <div style="font-size: 12px; margin-bottom: 8px; color: var(--text-secondary);">ğŸŒ… æœã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">æ—©æœ(~7æ™‚)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalMorning > 0 ? (timePatterns.morning.early / totalMorning * 100) : 0}%; height: 100%; background: #3b82f6;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.morning.early}</span>
                        </div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">é€šå¸¸(7-9æ™‚)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalMorning > 0 ? (timePatterns.morning.normal / totalMorning * 100) : 0}%; height: 100%; background: #10b981;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.morning.normal}</span>
                        </div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">é…ã‚(9æ™‚~)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalMorning > 0 ? (timePatterns.morning.late / totalMorning * 100) : 0}%; height: 100%; background: #f59e0b;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.morning.late}</span>
                        </div>
                    </div>
                    
                    <div>
                        <div style="font-size: 12px; margin-bottom: 8px; color: var(--text-secondary);">ğŸŒ™ å¤œã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«</div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">æ—©ã‚(~20æ™‚)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalEvening > 0 ? (timePatterns.evening.early / totalEvening * 100) : 0}%; height: 100%; background: #3b82f6;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.evening.early}</span>
                        </div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">é€šå¸¸(20-22æ™‚)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalEvening > 0 ? (timePatterns.evening.normal / totalEvening * 100) : 0}%; height: 100%; background: #10b981;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.evening.normal}</span>
                        </div>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="font-size: 10px; width: 60px;">æ·±å¤œ(22æ™‚~)</span>
                            <div style="flex: 1; height: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                <div style="width: ${totalEvening > 0 ? (timePatterns.evening.late / totalEvening * 100) : 0}%; height: 100%; background: #f59e0b;"></div>
                            </div>
                            <span style="font-size: 10px; width: 30px; text-align: right;">${timePatterns.evening.late}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ„Ÿæƒ…ã¨ç¿’æ…£é”æˆç‡ã®ç›¸é–¢ã‚’ç”Ÿæˆ
        function generateEmotionHabitCorrelation(entries, hypotheses) {
            const correlationData = {
                highMood: { achieved: 0, total: 0 },  // æ°—åˆ†4-5ã®æ™‚
                midMood: { achieved: 0, total: 0 },   // æ°—åˆ†3ã®æ™‚
                lowMood: { achieved: 0, total: 0 }    // æ°—åˆ†1-2ã®æ™‚
            };
            
            Object.entries(entries).forEach(([dateStr, entry]) => {
                if (!entry.morning || !entry.morning.mood) return;
                
                const mood = entry.morning.mood;
                let dayAchieved = 0;
                let dayTotal = 0;
                
                // ãã®æ—¥ã®ç¿’æ…£é”æˆçŠ¶æ³ã‚’é›†è¨ˆ
                hypotheses.forEach(hyp => {
                    if (hyp.achievements && hyp.achievements[dateStr]) {
                        dayAchieved++;
                    }
                    dayTotal++;
                });
                
                if (dayTotal > 0) {
                    if (mood >= 4) {
                        correlationData.highMood.achieved += dayAchieved;
                        correlationData.highMood.total += dayTotal;
                    } else if (mood === 3) {
                        correlationData.midMood.achieved += dayAchieved;
                        correlationData.midMood.total += dayTotal;
                    } else {
                        correlationData.lowMood.achieved += dayAchieved;
                        correlationData.lowMood.total += dayTotal;
                    }
                }
            });
            
            const highRate = correlationData.highMood.total > 0 
                ? Math.round((correlationData.highMood.achieved / correlationData.highMood.total) * 100)
                : 0;
            const midRate = correlationData.midMood.total > 0
                ? Math.round((correlationData.midMood.achieved / correlationData.midMood.total) * 100)
                : 0;
            const lowRate = correlationData.lowMood.total > 0
                ? Math.round((correlationData.lowMood.achieved / correlationData.lowMood.total) * 100)
                : 0;
            
            return `
                <div style="display: grid; gap: 8px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; width: 80px;">ğŸ˜„ æ°—åˆ†è‰¯å¥½æ™‚</span>
                        <div style="flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative;">
                            <div style="width: ${highRate}%; height: 100%; background: linear-gradient(90deg, #10b981, #3b82f6);"></div>
                            <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">${highRate}%</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; width: 80px;">ğŸ˜ æ°—åˆ†æ™®é€šæ™‚</span>
                        <div style="flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative;">
                            <div style="width: ${midRate}%; height: 100%; background: linear-gradient(90deg, #f59e0b, #eab308);"></div>
                            <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">${midRate}%</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span style="font-size: 12px; width: 80px;">ğŸ˜” æ°—åˆ†ä½èª¿æ™‚</span>
                        <div style="flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative;">
                            <div style="width: ${lowRate}%; height: 100%; background: linear-gradient(90deg, #ef4444, #dc2626);"></div>
                            <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: bold;">${lowRate}%</span>
                        </div>
                    </div>
                    <div style="margin-top: 8px; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 6px;">
                        <p style="font-size: 11px; color: var(--text-secondary); margin: 0;">
                            ${highRate > lowRate + 10 ? 'ğŸ’¡ æ°—åˆ†ãŒè‰¯ã„æ—¥ã¯ç¿’æ…£é”æˆç‡ã‚‚é«˜ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ï¼' :
                              lowRate > highRate + 10 ? 'ğŸ’ª æ°—åˆ†ãŒä½ã„æ—¥ã§ã‚‚é ‘å¼µã£ã¦ç¿’æ…£ã‚’ç¶šã‘ã¦ã„ã¾ã™ï¼' :
                              'ğŸ“Š æ°—åˆ†ã«é–¢ã‚ã‚‰ãšå®‰å®šã—ã¦ç¿’æ…£ã‚’ç¶šã‘ã¦ã„ã¾ã™ï¼'}
                        </p>
                    </div>
                </div>
            `;
        }
        
        // ãƒ¯ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’ç”Ÿæˆ
        function generateWordCloud(entries) {
            const words = {};
            
            // ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å˜èªã‚’æŠ½å‡º
            Object.values(entries).forEach(entry => {
                const texts = [];
                if (entry.morning) {
                    if (entry.morning.priority) texts.push(entry.morning.priority);
                }
                if (entry.evening) {
                    if (entry.evening.success) texts.push(entry.evening.success);
                    if (entry.evening.improvement) texts.push(entry.evening.improvement);
                }
                
                // 2æ–‡å­—ä»¥ä¸Šã®æ¼¢å­—ãƒ»ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã‚’æŠ½å‡º
                texts.forEach(text => {
                    const matches = text.match(/[ä¸€-é¾¥ã-ã‚“ã‚¡-ãƒ¶ãƒ¼]{2,}/g) || [];
                    matches.forEach(word => {
                        // ã‚ˆãã‚ã‚‹åŠ©è©ã‚„æ¥ç¶šè©ã‚’é™¤å¤–
                        if (!['ã§ã™', 'ã¾ã™', 'ã—ãŸ', 'ã“ã¨', 'ã‚‚ã®', 'ãŸã‚', 'ã‹ã‚‰', 'ã¾ã§', 'ãªã©', 'ã‚ˆã‚Š'].includes(word)) {
                            words[word] = (words[word] || 0) + 1;
                        }
                    });
                });
            });
            
            // é »åº¦é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½20å€‹ã‚’å–å¾—
            const sortedWords = Object.entries(words)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            if (sortedWords.length === 0) {
                return '<div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px;">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºä¸­...</div>';
            }
            
            // æœ€å¤§é »åº¦ã‚’å–å¾—ã—ã¦ã‚µã‚¤ã‚ºã‚’æ­£è¦åŒ–
            const maxCount = sortedWords[0][1];
            
            return `
                <div style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; padding: 12px;">
                    ${sortedWords.map(([word, count]) => {
                        const size = 12 + (count / maxCount) * 16; // 12pxã€œ28pxã®ç¯„å›²
                        const opacity = 0.5 + (count / maxCount) * 0.5; // 0.5ã€œ1.0ã®ç¯„å›²
                        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        
                        return `
                            <span style="
                                font-size: ${size}px;
                                color: ${color};
                                opacity: ${opacity};
                                padding: 4px 8px;
                                background: rgba(255,255,255,0.05);
                                border-radius: 4px;
                                cursor: default;
                                transition: all 0.2s;
                            " title="${count}å›ä½¿ç”¨">
                                ${word}
                            </span>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
        function updateJournalStreak(data) {
            const today = new Date();
            const todayKey = dateKeyLocal(today);
            
            // ä»Šæ—¥ã®ã‚¨ãƒ³ãƒˆãƒªãŒå®Œå…¨ã‹ãƒã‚§ãƒƒã‚¯
            const todayEntry = data.dailyJournal.entries[todayKey];
            const isComplete = todayEntry && todayEntry.morning && todayEntry.evening;
            
            if (isComplete) {
                // æ˜¨æ—¥ã®ã‚¨ãƒ³ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayKey = dateKeyLocal(yesterday);
                const yesterdayEntry = data.dailyJournal.entries[yesterdayKey];
                
                if (yesterdayEntry && yesterdayEntry.morning && yesterdayEntry.evening) {
                    // é€£ç¶šã‚’ç¶™ç¶š
                    data.dailyJournal.stats.currentStreak++;
                } else {
                    // æ–°ã—ã„ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’é–‹å§‹
                    data.dailyJournal.stats.currentStreak = 1;
                }
                
                // æœ€é•·ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
                if (data.dailyJournal.stats.currentStreak > data.dailyJournal.stats.longestStreak) {
                    data.dailyJournal.stats.longestStreak = data.dailyJournal.stats.currentStreak;
                }
                
                // çµ±è¨ˆã‚’æ›´æ–°
                data.dailyJournal.stats.lastEntry = todayKey;
                data.dailyJournal.stats.totalEntries++;
                
                // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãƒœãƒ¼ãƒŠã‚¹
                if (data.dailyJournal.stats.currentStreak === 7) {
                    earnPoints(5, 'journal', 'ğŸ”¥ ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«7æ—¥é€£ç¶šãƒœãƒ¼ãƒŠã‚¹');
                    showNotification('ğŸ† 7æ—¥é€£ç¶šé”æˆï¼+5ptãƒœãƒ¼ãƒŠã‚¹ï¼', 'success');
                } else if (data.dailyJournal.stats.currentStreak === 30) {
                    earnPoints(20, 'journal', 'ğŸ† ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«30æ—¥é€£ç¶šãƒœãƒ¼ãƒŠã‚¹');
                    showNotification('ğŸ‰ 30æ—¥é€£ç¶šé”æˆï¼+20ptãƒœãƒ¼ãƒŠã‚¹ï¼', 'success');
                }
            }
        }
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showJournalContextMenu(event, type) {
            event.preventDefault();
            
            // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingMenu = document.querySelector('.context-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const menu = document.createElement('div');
            menu.className = 'context-menu';
            menu.style.cssText = `
                position: fixed;
                left: ${event.clientX}px;
                top: ${event.clientY}px;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 8px;
                padding: 4px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                min-width: 120px;
            `;
            
            menu.innerHTML = `
                <div onclick="deleteJournalEntry('${type}'); this.parentElement.remove();" style="
                    padding: 8px 12px;
                    cursor: pointer;
                    border-radius: 4px;
                    color: #ef4444;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: background 0.2s;
                " onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'" onmouseout="this.style.background='transparent'">
                    ğŸ—‘ï¸ å‰Šé™¤
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
        function deleteJournalEntry(type) {
            if (!confirm(`${type === 'morning' ? 'æœ' : 'å¤œ'}ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚‚æ¸›ç®—ã•ã‚Œã¾ã™ã€‚`)) {
                return;
            }
            
            let data = loadData();
            const todayKey = getJournalDateKey(); // æ·±å¤œå¯¾å¿œã®æ—¥ä»˜ã‚­ãƒ¼
            
            if (!data.dailyJournal || !data.dailyJournal.entries[todayKey]) {
                showNotification('å‰Šé™¤ã™ã‚‹ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const entry = data.dailyJournal.entries[todayKey][type];
            if (!entry) {
                showNotification('å‰Šé™¤ã™ã‚‹ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯æ¸›ç®—
            if (entry.pointsEarned && entry.pointsEarned > 0) {
                console.log(`ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å‰Šé™¤ï¼š${entry.pointsEarned}ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—`);
                
                // ç¾åœ¨ã®ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœã‚’è€ƒæ…®ã—ã¦å…ƒã®ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
                const basePoints = 1; // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆ
                const boostedPoints = calculatePointsWithBoosts(basePoints, 'journal', null);
                const actualPointsToDeduct = Math.round(boostedPoints);
                
                console.log(`åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆ: ${basePoints}, ãƒ–ãƒ¼ã‚¹ãƒˆå¾Œ: ${boostedPoints}, æ¸›ç®—é¡: ${actualPointsToDeduct}`);
                
                // ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—
                data.pointSystem.currentPoints = Math.max(0, data.pointSystem.currentPoints - actualPointsToDeduct);
                
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
                data.pointSystem.transactions.unshift({
                    timestamp: new Date().toISOString(),
                    type: 'spend',
                    amount: actualPointsToDeduct,
                    source: 'journal_delete',
                    description: `${type === 'morning' ? 'ğŸŒ… æœ' : 'ğŸŒ™ å¤œ'}ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«å‰Šé™¤ã«ã‚ˆã‚‹æ¸›ç®—`,
                    multiplier: 1.0,
                    finalAmount: -actualPointsToDeduct
                });
                
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
                if (data.pointSystem.transactions.length > 100) {
                    data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
                }
            }
            
            // ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
            delete data.dailyJournal.entries[todayKey][type];
            
            // ä¸¡æ–¹ã®ã‚¨ãƒ³ãƒˆãƒªãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯ãã®æ—¥ã®ãƒ‡ãƒ¼ã‚¿è‡ªä½“ã‚’å‰Šé™¤
            if (!data.dailyJournal.entries[todayKey].morning && !data.dailyJournal.entries[todayKey].evening) {
                delete data.dailyJournal.entries[todayKey];
                
                // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’å†è¨ˆç®—
                recalculateJournalStreak(data);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(data);
            
            // UIæ›´æ–°
            updateJournalStatus();
            updatePointDisplay();
            
            showNotification(`${type === 'morning' ? 'ğŸŒ… æœ' : 'ğŸŒ™ å¤œ'}ã®ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'info');
        }
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’å†è¨ˆç®—
        function recalculateJournalStreak(data) {
            // ç¾åœ¨ã®ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’ãƒªã‚»ãƒƒãƒˆ
            data.dailyJournal.stats.currentStreak = 0;
            
            // ä»Šæ—¥ã‹ã‚‰é¡ã£ã¦é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
            const today = new Date();
            let checkDate = new Date(today);
            let consecutiveDays = 0;
            
            while (true) {
                const dateKey = dateKeyLocal(checkDate);
                const entry = data.dailyJournal.entries[dateKey];
                
                // ãã®æ—¥ã®ã‚¨ãƒ³ãƒˆãƒªãŒå®Œå…¨ã§ãªã„å ´åˆã¯çµ‚äº†
                if (!entry || !entry.morning || !entry.evening) {
                    break;
                }
                
                consecutiveDays++;
                
                // å‰æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            data.dailyJournal.stats.currentStreak = consecutiveDays;
            
            // æœ€é•·ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
            if (consecutiveDays > data.dailyJournal.stats.longestStreak) {
                data.dailyJournal.stats.longestStreak = consecutiveDays;
            }
        }
        
        // ========== ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®é–¢æ•° ==========
        
        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’æ›´æ–°
        function updateChallenges() {
            const data = loadData();
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å–å¾—
            const customDailyChallenges = (data.challenges.customChallenges || [])
                .filter(c => c.type === 'daily');
            const customWeeklyChallenges = (data.challenges.customChallenges || [])
                .filter(c => c.type === 'weekly');
            
            // ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆï¼ˆæ—¢å®š + ã‚«ã‚¹ã‚¿ãƒ ï¼‰
            const allDailyChallenges = [...DAILY_CHALLENGES, ...customDailyChallenges];
            
            // ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
            const dailyContainer = document.getElementById('daily-challenge-container');
            if (!data.challenges.daily) {
                // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ
                const randomDaily = allDailyChallenges[Math.floor(Math.random() * allDailyChallenges.length)];
                data.challenges.daily = randomDaily;
                saveData(data);
            }
            
            if (dailyContainer) {
                const daily = data.challenges.daily;
                const isCompleted = data.challenges.completedToday.includes(daily.id);
                
                // ãƒã‚§ãƒƒã‚¯é–¢æ•°ã¯ç„¡åŠ¹åŒ–ï¼ˆæ‰‹å‹•ãƒˆã‚°ãƒ«ã®ã¿ï¼‰
                let isAutoCheckable = false;
                let isAutoCompleted = false;
                
                dailyContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${daily.icon}</span>
                            <div>
                                <div style="font-weight: bold; ${isCompleted ? 'text-decoration: line-through; color: var(--text-secondary);' : ''}">${daily.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    å ±é…¬: ${daily.points}pt
                                    ${daily.id.startsWith('custom_') ? ' (ã‚«ã‚¹ã‚¿ãƒ )' : ''}
                                </div>
                            </div>
                        </div>
                        ${!isCompleted ? `
                            <button class="btn btn-primary" 
                                onclick="completeChallenge('daily', '${daily.id}')" 
                                style="padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: 600;">
                                å®Œäº†ã«ã™ã‚‹
                            </button>
                        ` : `
                            <button class="btn btn-secondary" 
                                onclick="completeChallenge('daily', '${daily.id}')" 
                                style="padding: 8px 16px; font-size: 14px; background: #10b981; border: none; color: white; font-weight: 600;">
                                âœ… å®Œäº†æ¸ˆã¿
                            </button>
                        `}
                    </div>
                `;
            }
            
            // ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆï¼ˆæ—¢å®š + ã‚«ã‚¹ã‚¿ãƒ ï¼‰
            const allWeeklyChallenges = [...WEEKLY_CHALLENGES, ...customWeeklyChallenges];
            
            // ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸
            const weeklyContainer = document.getElementById('weekly-challenge-container');
            if (!data.challenges.weekly) {
                // ãƒ©ãƒ³ãƒ€ãƒ ã«ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é¸æŠ
                const randomWeekly = allWeeklyChallenges[Math.floor(Math.random() * allWeeklyChallenges.length)];
                data.challenges.weekly = randomWeekly;
                saveData(data);
            }
            
            if (weeklyContainer) {
                const weekly = data.challenges.weekly;
                const isCompleted = data.challenges.completedThisWeek.includes(weekly.id);
                
                weeklyContainer.innerHTML = `
                    <h4 style="margin-bottom: 8px; font-size: 14px; color: var(--text-secondary);">ğŸ“… ä»Šé€±ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</h4>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">${weekly.icon}</span>
                            <div>
                                <div style="font-weight: bold; ${isCompleted ? 'text-decoration: line-through; color: var(--text-secondary);' : ''}">${weekly.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">å ±é…¬: ${weekly.points}pt${weekly.id.startsWith('custom_') ? ' (ã‚«ã‚¹ã‚¿ãƒ )' : ''}</div>
                            </div>
                        </div>
                        ${!isCompleted ? `
                            <button class="btn btn-primary" 
                                onclick="completeChallenge('weekly', '${weekly.id}')" 
                                style="padding: 8px 16px; font-size: 14px; background: linear-gradient(135deg, #667eea, #764ba2); border: none; color: white; font-weight: 600;">
                                å®Œäº†ã«ã™ã‚‹
                            </button>
                        ` : `
                            <button class="btn btn-secondary" 
                                onclick="completeChallenge('weekly', '${weekly.id}')" 
                                style="padding: 8px 16px; font-size: 14px; background: #10b981; border: none; color: white; font-weight: 600;">
                                âœ… å®Œäº†æ¸ˆã¿
                            </button>
                        `}
                    </div>
                `;
            }
        }
        
        // ç¾åœ¨ã®ãƒ–ãƒ¼ã‚¹ãƒˆå€ç‡ã‚’å–å¾—
        function getBoostMultiplier() {
            const data = loadData();
            let multiplier = 1.0;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’ç¢ºèª
            if (data.cards && data.cards.activeEffects) {
                data.cards.activeEffects.forEach(effect => {
                    if (effect.cardId === 'double_points') {
                        multiplier = Math.max(multiplier, 2.0);
                    } else if (effect.cardId === 'triple_points') {
                        multiplier = Math.max(multiplier, 3.0);
                    } else if (effect.cardId === 'power_boost') {
                        multiplier = Math.max(multiplier, 1.5);
                    }
                });
            }
            
            // é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹ï¼ˆ7æ—¥ä»¥ä¸Šã§+10%ï¼‰
            if (data.challenges && data.challenges.streak >= 7) {
                multiplier *= 1.1;
            }
            
            // å®Œç’§ãªé€±ãƒœãƒ¼ãƒŠã‚¹ï¼ˆé€±ã«7æ—¥ã™ã¹ã¦é”æˆã§+20%ï¼‰
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            let perfectWeek = true;
            for (let i = 0; i < 7; i++) {
                const checkDate = new Date(weekStart);
                checkDate.setDate(checkDate.getDate() + i);
                if (checkDate > new Date()) break;
                
                // ãã®æ—¥ã«ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå®Œäº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const dateStr = checkDate.toDateString();
                const hasCompletion = data.challenges.history.some(h => {
                    const completedDate = new Date(h.completedAt).toDateString();
                    return completedDate === dateStr;
                });
                
                if (!hasCompletion && checkDate.toDateString() !== new Date().toDateString()) {
                    perfectWeek = false;
                    break;
                }
            }
            
            if (perfectWeek && new Date().getDay() === 6) { // åœŸæ›œæ—¥ã«ãƒœãƒ¼ãƒŠã‚¹
                multiplier *= 1.2;
            }
            
            return multiplier;
        }
        
        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å®Œäº†ï¼ˆãƒˆã‚°ãƒ«æ©Ÿèƒ½ä»˜ãï¼‰
        function completeChallenge(type, challengeId) {
            const data = loadData();
            const today = new Date().toDateString();
            
            if (type === 'daily') {
                // æ—¢å®šã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‹ã‚‰æ¤œç´¢
                let challenge = DAILY_CHALLENGES.find(c => c.id === challengeId);
                if (!challenge && data.challenges.customChallenges) {
                    challenge = data.challenges.customChallenges.find(c => c.id === challengeId && c.type === 'daily');
                }
                
                if (challenge) {
                    // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å–ã‚Šæ¶ˆã—
                    if (data.challenges.completedToday.includes(challengeId)) {
                        undoChallenge(type, challengeId);
                        return;
                    }
                    
                    // å®Œäº†å‡¦ç†
                    data.challenges.completedToday.push(challengeId);
                    
                    // å±¥æ­´ã«è¿½åŠ 
                    data.challenges.history.unshift({
                        id: challengeId,
                        name: challenge.name,
                        type: 'daily',
                        points: challenge.points,
                        completedAt: new Date().toISOString(),
                        isCustom: challengeId.startsWith('custom_')
                    });
                    
                    // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã‚’æ›´æ–°
                    if (data.challenges.lastStreakDate !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = yesterday.toDateString();
                        
                        if (data.challenges.lastStreakDate === yesterdayStr) {
                            data.challenges.streak++;
                        } else {
                            data.challenges.streak = 1;
                        }
                        data.challenges.lastStreakDate = today;
                    }
                    
                    data.challenges.totalCompleted++;
                    
                    // å±¥æ­´ã¯æœ€æ–°100ä»¶ã®ã¿ä¿å­˜
                    if (data.challenges.history.length > 100) {
                        data.challenges.history = data.challenges.history.slice(0, 100);
                    }
                    
                    saveData(data);
                    
                    // ãƒœãƒ¼ãƒŠã‚¹ã‚’è€ƒæ…®ã—ã¦ãƒã‚¤ãƒ³ãƒˆç²å¾—
                    const boostMultiplier = getBoostMultiplier();
                    const earnedPoints = Math.floor(challenge.points * boostMultiplier);
                    earnPoints(earnedPoints, 'daily_challenge', `ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${challenge.name}`);
                    
                    if (boostMultiplier > 1) {
                        showNotification(`ğŸ‰ ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†ï¼ +${earnedPoints}pt (ãƒ–ãƒ¼ã‚¹ãƒˆ${boostMultiplier}x)`, 'success');
                    } else {
                        showNotification(`ğŸ‰ ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†ï¼ +${earnedPoints}pt`, 'success');
                    }
                }
            } else if (type === 'weekly') {
                // æ—¢å®šã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‹ã‚‰æ¤œç´¢
                let challenge = WEEKLY_CHALLENGES.find(c => c.id === challengeId);
                if (!challenge && data.challenges.customChallenges) {
                    challenge = data.challenges.customChallenges.find(c => c.id === challengeId && c.type === 'weekly');
                }
                
                if (challenge) {
                    // æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã¯å–ã‚Šæ¶ˆã—
                    if (data.challenges.completedThisWeek.includes(challengeId)) {
                        undoChallenge(type, challengeId);
                        return;
                    }
                    
                    // å®Œäº†å‡¦ç†
                    data.challenges.completedThisWeek.push(challengeId);
                    
                    // å±¥æ­´ã«è¿½åŠ 
                    data.challenges.history.unshift({
                        id: challengeId,
                        name: challenge.name,
                        type: 'weekly',
                        points: challenge.points,
                        completedAt: new Date().toISOString(),
                        isCustom: challengeId.startsWith('custom_')
                    });
                    
                    data.challenges.totalCompleted++;
                    
                    // å±¥æ­´ã¯æœ€æ–°100ä»¶ã®ã¿ä¿å­˜
                    if (data.challenges.history.length > 100) {
                        data.challenges.history = data.challenges.history.slice(0, 100);
                    }
                    
                    saveData(data);
                    
                    // ãƒœãƒ¼ãƒŠã‚¹ã‚’è€ƒæ…®ã—ã¦ãƒã‚¤ãƒ³ãƒˆç²å¾—
                    const boostMultiplier = getBoostMultiplier();
                    const earnedPoints = Math.floor(challenge.points * boostMultiplier);
                    earnPoints(earnedPoints, 'weekly_challenge', `ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${challenge.name}`);
                    
                    if (boostMultiplier > 1) {
                        showNotification(`ğŸ‰ ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†ï¼ +${earnedPoints}pt (ãƒ–ãƒ¼ã‚¹ãƒˆ${boostMultiplier}x)`, 'success');
                    } else {
                        showNotification(`ğŸ‰ ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸å®Œäº†ï¼ +${earnedPoints}pt`, 'success');
                    }
                }
            }
            updateChallenges();
            updatePointDisplay();
            updatePointsView();
            updateChallengeStats();
        }
        
        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆã‚’å–ã‚Šæ¶ˆã™ï¼ˆç¢ºèªãªã—ã§å³åº§ã«å®Ÿè¡Œï¼‰
        function undoChallenge(type, challengeId) {
            const data = loadData();
            
            if (type === 'daily') {
                // æ—¢å®šã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‹ã‚‰æ¤œç´¢
                let challenge = DAILY_CHALLENGES.find(c => c.id === challengeId);
                if (!challenge && data.challenges.customChallenges) {
                    challenge = data.challenges.customChallenges.find(c => c.id === challengeId && c.type === 'daily');
                }
                
                if (challenge && data.challenges.completedToday.includes(challengeId)) {
                    // å®Œäº†ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    const index = data.challenges.completedToday.indexOf(challengeId);
                    if (index > -1) {
                        data.challenges.completedToday.splice(index, 1);
                    }
                    
                    // æœ€æ–°ã®å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’æ¢ã™
                    const historyEntry = data.challenges.history.find(h => h.id === challengeId && h.type === 'daily');
                    let pointsToDeduct = challenge.points;
                    
                    // å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰å®Ÿéš›ã«ç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆè€ƒæ…®ï¼‰
                    if (historyEntry) {
                        const historyIndex = data.challenges.history.indexOf(historyEntry);
                        if (historyIndex > -1) {
                            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‹ã‚‰å®Ÿéš›ã®ç²å¾—ãƒã‚¤ãƒ³ãƒˆã‚’æ¢ã™
                            const recentTransaction = data.pointSystem.transactions.find(t => 
                                t.source === 'daily_challenge' && 
                                t.description === `ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${challenge.name}` &&
                                Math.abs(new Date(t.timestamp).getTime() - new Date(historyEntry.completedAt).getTime()) < 1000
                            );
                            
                            if (recentTransaction) {
                                pointsToDeduct = recentTransaction.amount;
                            }
                            
                            data.challenges.history.splice(historyIndex, 1);
                        }
                    }
                    
                    // ç·é”æˆæ•°ã‚’æ¸›ã‚‰ã™
                    data.challenges.totalCompleted = Math.max(0, data.challenges.totalCompleted - 1);
                    
                    // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã®å†è¨ˆç®—ï¼ˆä»Šæ—¥ã®ä»–ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆï¼‰
                    const today = new Date().toDateString();
                    if (data.challenges.completedToday.length === 0 && data.challenges.lastStreakDate === today) {
                        data.challenges.streak = Math.max(0, data.challenges.streak - 1);
                        // å‰æ—¥ã®æ—¥ä»˜ã«æˆ»ã™
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        data.challenges.lastStreakDate = yesterday.toDateString();
                    }
                    
                    // ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—ï¼ˆå®Ÿéš›ã«ç²å¾—ã—ãŸåˆ†ã ã‘ï¼‰
                    data.pointSystem.currentPoints = Math.max(0, data.pointSystem.currentPoints - pointsToDeduct);
                    data.pointSystem.lifetimeEarned = Math.max(0, data.pointSystem.lifetimeEarned - pointsToDeduct);
                    data.pointSystem.levelProgress = data.pointSystem.lifetimeEarned;
                    
                    // ãƒ¬ãƒ™ãƒ«æ›´æ–°
                    const newLevel = calculateLevel(data.pointSystem.lifetimeEarned);
                    data.pointSystem.currentLevel = newLevel.level;
                    
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
                    data.pointSystem.transactions.unshift({
                        timestamp: new Date().toISOString(),
                        type: 'spend',
                        amount: pointsToDeduct,
                        source: 'challenge_undo',
                        description: `ãƒãƒ£ãƒ¬ãƒ³ã‚¸å–æ¶ˆ: ${challenge.name}`
                    });
                    
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’åˆ¶é™
                    if (data.pointSystem.transactions.length > 100) {
                        data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
                    }
                    
                    saveData(data);
                    showNotification(`å–ã‚Šæ¶ˆã—ã¾ã—ãŸ (-${pointsToDeduct}pt)`, 'info');
                }
            } else if (type === 'weekly') {
                // æ—¢å®šã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã¾ãŸã¯ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‹ã‚‰æ¤œç´¢
                let challenge = WEEKLY_CHALLENGES.find(c => c.id === challengeId);
                if (!challenge && data.challenges.customChallenges) {
                    challenge = data.challenges.customChallenges.find(c => c.id === challengeId && c.type === 'weekly');
                }
                
                if (challenge && data.challenges.completedThisWeek.includes(challengeId)) {
                    // å®Œäº†ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    const index = data.challenges.completedThisWeek.indexOf(challengeId);
                    if (index > -1) {
                        data.challenges.completedThisWeek.splice(index, 1);
                    }
                    
                    // æœ€æ–°ã®å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‚’æ¢ã™
                    const historyEntry = data.challenges.history.find(h => h.id === challengeId && h.type === 'weekly');
                    let pointsToDeduct = challenge.points;
                    
                    // å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã‹ã‚‰å®Ÿéš›ã«ç²å¾—ã—ãŸãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ï¼ˆãƒ–ãƒ¼ã‚¹ãƒˆè€ƒæ…®ï¼‰
                    if (historyEntry) {
                        const historyIndex = data.challenges.history.indexOf(historyEntry);
                        if (historyIndex > -1) {
                            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‹ã‚‰å®Ÿéš›ã®ç²å¾—ãƒã‚¤ãƒ³ãƒˆã‚’æ¢ã™
                            const recentTransaction = data.pointSystem.transactions.find(t => 
                                t.source === 'weekly_challenge' && 
                                t.description === `ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸: ${challenge.name}` &&
                                Math.abs(new Date(t.timestamp).getTime() - new Date(historyEntry.completedAt).getTime()) < 1000
                            );
                            
                            if (recentTransaction) {
                                pointsToDeduct = recentTransaction.amount;
                            }
                            
                            data.challenges.history.splice(historyIndex, 1);
                        }
                    }
                    
                    // ç·é”æˆæ•°ã‚’æ¸›ã‚‰ã™
                    data.challenges.totalCompleted = Math.max(0, data.challenges.totalCompleted - 1);
                    
                    // ãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—ï¼ˆå®Ÿéš›ã«ç²å¾—ã—ãŸåˆ†ã ã‘ï¼‰
                    data.pointSystem.currentPoints = Math.max(0, data.pointSystem.currentPoints - pointsToDeduct);
                    data.pointSystem.lifetimeEarned = Math.max(0, data.pointSystem.lifetimeEarned - pointsToDeduct);
                    data.pointSystem.levelProgress = data.pointSystem.lifetimeEarned;
                    
                    // ãƒ¬ãƒ™ãƒ«æ›´æ–°
                    const newLevel = calculateLevel(data.pointSystem.lifetimeEarned);
                    data.pointSystem.currentLevel = newLevel.level;
                    
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
                    data.pointSystem.transactions.unshift({
                        timestamp: new Date().toISOString(),
                        type: 'spend',
                        amount: pointsToDeduct,
                        source: 'challenge_undo',
                        description: `ãƒãƒ£ãƒ¬ãƒ³ã‚¸å–æ¶ˆ: ${challenge.name}`
                    });
                    
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’åˆ¶é™
                    if (data.pointSystem.transactions.length > 100) {
                        data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
                    }
                    
                    saveData(data);
                    showNotification(`å–ã‚Šæ¶ˆã—ã¾ã—ãŸ (-${pointsToDeduct}pt)`, 'info');
                }
            }
            
            updateChallenges();
            updatePointDisplay();
            updatePointsView();
            updateChallengeStats();
        }


        // ãƒã‚¤ãƒ³ãƒˆã‚’ã™ã¹ã¦ãƒªã‚»ãƒƒãƒˆï¼ˆç·Šæ€¥æ™‚ç”¨ãƒ»é€šå¸¸ã¯éè¡¨ç¤ºï¼‰
        // function resetAllPoints() {
        //     if (!confirm('âš ï¸ è­¦å‘Š\n\nã™ã¹ã¦ã®ãƒã‚¤ãƒ³ãƒˆã¨å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\næœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
        //         return;
        //     }
        //     
        //     if (!confirm('âš ï¸ æœ€çµ‚ç¢ºèª\n\næœ¬å½“ã«ã™ã¹ã¦ã®ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        //         return;
        //     }
        //     
        //     const data = loadData();
        //     
        //     // ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
        //     data.pointSystem.currentPoints = 0;
        //     data.pointSystem.lifetimeEarned = 0;
        //     data.pointSystem.lifetimeSpent = 0;
        //     data.pointSystem.currentLevel = 1;
        //     data.pointSystem.levelProgress = 0;
        //     data.pointSystem.transactions = [];
        //     
        //     saveData(data);
        //     
        //     // UIæ›´æ–°
        //     updatePointDisplay();
        //     updatePointsView();
        //     showNotification('ãƒã‚¤ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
        // }

        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµ±è¨ˆã‚’æ›´æ–°
        function updateChallengeStats() {
            const data = loadData();
            const challenges = data.challenges;
            
            // é€£ç¶šé”æˆæ—¥æ•°
            const streakEl = document.getElementById('challenge-streak');
            if (streakEl) {
                streakEl.textContent = challenges.streak || 0;
            }
            
            // ç´¯è¨ˆå®Œäº†æ•°
            const totalEl = document.getElementById('total-challenges-completed');
            if (totalEl) {
                totalEl.textContent = challenges.totalCompleted || 0;
            }
            
            // ãƒ‡ã‚¤ãƒªãƒ¼é”æˆç‡ã‚’è¨ˆç®—
            const dailyHistory = challenges.history.filter(h => h.type === 'daily');
            const last30Days = dailyHistory.filter(h => {
                const date = new Date(h.completedAt);
                const daysDiff = (new Date() - date) / (1000 * 60 * 60 * 24);
                return daysDiff <= 30;
            });
            const dailyRate = last30Days.length > 0 ? Math.round((last30Days.length / 30) * 100) : 0;
            const dailyRateEl = document.getElementById('daily-completion-rate');
            if (dailyRateEl) {
                dailyRateEl.textContent = `${dailyRate}%`;
            }
            
            // ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼é”æˆç‡ã‚’è¨ˆç®—
            const weeklyHistory = challenges.history.filter(h => h.type === 'weekly');
            const last8Weeks = weeklyHistory.filter(h => {
                const date = new Date(h.completedAt);
                const weeksDiff = (new Date() - date) / (1000 * 60 * 60 * 24 * 7);
                return weeksDiff <= 8;
            });
            const weeklyRate = last8Weeks.length > 0 ? Math.round((last8Weeks.length / 8) * 100) : 0;
            const weeklyRateEl = document.getElementById('weekly-completion-rate');
            if (weeklyRateEl) {
                weeklyRateEl.textContent = `${weeklyRate}%`;
            }
            
            // ãŠæ°—ã«å…¥ã‚Šãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼ˆã‚ˆãé”æˆã™ã‚‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼‰
            const favoriteContainer = document.getElementById('favorite-challenges');
            if (favoriteContainer) {
                const challengeCounts = {};
                challenges.history.forEach(h => {
                    if (!challengeCounts[h.id]) {
                        challengeCounts[h.id] = { name: h.name, count: 0, type: h.type };
                    }
                    challengeCounts[h.id].count++;
                });
                
                const sortedChallenges = Object.entries(challengeCounts)
                    .sort((a, b) => b[1].count - a[1].count)
                    .slice(0, 5);
                
                if (sortedChallenges.length > 0) {
                    favoriteContainer.innerHTML = sortedChallenges.map(([id, data]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <span style="font-size: 12px;">${data.name}</span>
                            <span style="font-size: 12px; color: var(--text-secondary);">${data.count}å›</span>
                        </div>
                    `).join('');
                } else {
                    favoriteContainer.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
            }
            
            // æœ€è¿‘ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸é”æˆ
            const recentContainer = document.getElementById('recent-challenges');
            if (recentContainer) {
                const recent = challenges.history.slice(0, 10);
                if (recent.length > 0) {
                    recentContainer.innerHTML = recent.map(h => {
                        const date = new Date(h.completedAt);
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        const typeIcon = h.type === 'daily' ? 'ğŸ“…' : 'ğŸ“†';
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 6px; background: rgba(0, 0, 0, 0.1); border-radius: 6px;">
                                <span>${typeIcon} ${h.name}</span>
                                <span style="color: var(--text-secondary);">${dateStr}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    recentContainer.innerHTML = '<p style="color: var(--text-secondary);">ã¾ã ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’é”æˆã—ã¦ã„ã¾ã›ã‚“</p>';
                }
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showChallengeCreation() {
            document.getElementById('reward-creation-form').style.display = 'none';
            document.getElementById('challenge-creation-form').style.display = 'block';
            document.getElementById('reward-creation-btn').style.background = '';
            document.getElementById('reward-creation-btn').style.color = '';
            document.getElementById('challenge-creation-btn').style.background = 'var(--primary)';
            document.getElementById('challenge-creation-btn').style.color = 'white';
            updateCustomChallengesList();
        }
        
        // å ±é…¬ä½œæˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        function showRewardCreation() {
            document.getElementById('reward-creation-form').style.display = 'block';
            document.getElementById('challenge-creation-form').style.display = 'none';
            document.getElementById('reward-creation-btn').style.background = 'var(--primary)';
            document.getElementById('reward-creation-btn').style.color = 'white';
            document.getElementById('challenge-creation-btn').style.background = '';
            document.getElementById('challenge-creation-btn').style.color = '';
        }
        
        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
        function updateChallengePoints(value) {
            document.getElementById('challenge-points-display').textContent = `${value}pt`;
            document.getElementById('challenge-points').value = value;
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä½œæˆ
        function createCustomChallenge(event) {
            event.preventDefault();
            const data = loadData();
            
            const challenge = {
                id: `custom_${Date.now()}`,
                name: document.getElementById('challenge-name').value,
                type: document.getElementById('challenge-type').value,
                points: parseInt(document.getElementById('challenge-points').value),
                icon: document.getElementById('challenge-emoji').value || 'ğŸ¯',
                category: document.getElementById('challenge-category').value,
                isCustom: true,
                createdAt: new Date().toISOString()
            };
            
            data.challenges.customChallenges.push(challenge);
            saveData(data);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('challenge-name').value = '';
            document.getElementById('challenge-emoji').value = '';
            document.getElementById('challenge-points-slider').value = 5;
            updateChallengePoints(5);
            
            showNotification('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
            updateCustomChallengesList();
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateCustomChallengesList() {
            const data = loadData();
            const container = document.getElementById('custom-challenges-list');
            
            if (container) {
                if (data.challenges.customChallenges.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-size: 12px;">ã¾ã ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ä½œæˆã—ã¦ã„ã¾ã›ã‚“</p>';
                } else {
                    container.innerHTML = data.challenges.customChallenges.map(challenge => `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${challenge.icon}</span>
                                <div>
                                    <div style="font-size: 12px; font-weight: bold;">${challenge.name}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary);">${challenge.type === 'daily' ? 'ãƒ‡ã‚¤ãƒªãƒ¼' : 'ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼'} / ${challenge.points}pt</div>
                                </div>
                            </div>
                            <button class="btn btn-secondary" onclick="deleteCustomChallenge('${challenge.id}')" style="padding: 4px 8px; font-size: 10px;">
                                å‰Šé™¤
                            </button>
                        </div>
                    `).join('');
                }
            }
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å‰Šé™¤
        function deleteCustomChallenge(challengeId) {
            if (confirm('ã“ã®ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const data = loadData();
                data.challenges.customChallenges = data.challenges.customChallenges.filter(c => c.id !== challengeId);
                saveData(data);
                updateCustomChallengesList();
                showNotification('ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            }
        }

        // ========== ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®é–¢æ•° ==========
        
        // ãƒ¬ãƒ™ãƒ«è¨­å®šï¼ˆã‚ˆã‚Šé•·æœŸçš„ãªç›®æ¨™è¨­å®šï¼‰
        const LEVEL_THRESHOLDS = [
            { level: 1, name: 'åˆå¿ƒè€…', min: 0, max: 75 },           // 50 â†’ 75 (1.5å€)
            { level: 2, name: 'è¦‹ç¿’ã„', min: 76, max: 225 },         // 150 â†’ 225 (1.5å€)
            { level: 3, name: 'ç¿’æ…£å®¶', min: 226, max: 450 },        // 300 â†’ 450 (1.5å€)
            { level: 4, name: 'å®Ÿè·µè€…', min: 451, max: 750 },        // 500 â†’ 750 (1.5å€)
            { level: 5, name: 'é”äºº', min: 751, max: 1125 },         // 750 â†’ 1125 (1.5å€)
            { level: 6, name: 'ãƒã‚¹ã‚¿ãƒ¼', min: 1126, max: 1650 },    // 1100 â†’ 1650 (1.5å€)
            { level: 7, name: 'ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼', min: 1651, max: 2250 }, // 1500 â†’ 2250 (1.5å€)
            { level: 8, name: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰', min: 2251, max: 3000 },  // 2000 â†’ 3000 (1.5å€)
            { level: 9, name: 'ç¥', min: 3001, max: 3900 },          // 2600 â†’ 3900 (1.5å€)
            { level: 10, name: 'è¶…è¶Šè€…', min: 3901, max: Infinity }
        ];

        // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
        function calculateLevel(lifetimeEarned) {
            for (const threshold of LEVEL_THRESHOLDS) {
                if (lifetimeEarned <= threshold.max) {
                    return threshold;
                }
            }
            // ãƒ¬ãƒ™ãƒ«10ä»¥ä¸Šã®è¨ˆç®—
            const extraPoints = lifetimeEarned - 2601;
            const extraLevels = Math.floor(extraPoints / 700);
            return {
                level: 10 + extraLevels,
                name: 'è¶…è¶Šè€…',
                min: 2601 + (extraLevels * 700),
                max: 2601 + ((extraLevels + 1) * 700)
            };
        }

        // ãƒã‚¤ãƒ³ãƒˆç²å¾—å‡¦ç†ï¼ˆhabitIdãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼‰
        function earnPoints(amount, source, description, multiplier = 1.0, category = null, habitId = null) {
            console.log('earnPointså‘¼ã³å‡ºã—:', {amount, source, description, habitId});
            const data = loadData();
            
            // ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœã‚’é©ç”¨
            const boostedAmount = calculatePointsWithBoosts(amount, source, category);
            const finalAmount = Math.round(boostedAmount * multiplier);
            console.log('è¨ˆç®—å¾Œã®ãƒã‚¤ãƒ³ãƒˆ:', finalAmount);
            
            // ãƒã‚¤ãƒ³ãƒˆè¿½åŠ 
            const beforePoints = data.pointSystem.currentPoints;
            data.pointSystem.currentPoints += finalAmount;
            data.pointSystem.lifetimeEarned += finalAmount;
            data.pointSystem.levelProgress = data.pointSystem.lifetimeEarned;
            console.log('ãƒã‚¤ãƒ³ãƒˆæ›´æ–°:', beforePoints, 'â†’', data.pointSystem.currentPoints);
            
            // ãƒ¬ãƒ™ãƒ«æ›´æ–°
            const newLevel = calculateLevel(data.pointSystem.lifetimeEarned);
            const oldLevel = data.pointSystem.currentLevel;
            data.pointSystem.currentLevel = newLevel.level;
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²ï¼ˆhabitIdã‚’å«ã‚ã‚‹ï¼‰
            const transaction = {
                timestamp: new Date().toISOString(),
                type: 'earn',
                amount: amount,
                source: source,
                description: description,
                multiplier: multiplier,
                finalAmount: finalAmount
            };
            
            // habitIdãŒã‚ã‚‹å ´åˆã¯è¿½åŠ 
            if (habitId) {
                transaction.habitId = habitId;
            }
            
            data.pointSystem.transactions.unshift(transaction);
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
            if (data.pointSystem.transactions.length > 100) {
                data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
            }
            
            saveData(data);
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
            if (newLevel.level > oldLevel) {
                showLevelUpNotification(oldLevel, newLevel);
            }
            
            // ãƒã‚¤ãƒ³ãƒˆç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            showPointAnimation(finalAmount);
            
            // UIæ›´æ–°
            updatePointDisplay();
            
            return finalAmount;
        }

        // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»å‡¦ç†
        function spendPoints(amount, rewardName) {
            const data = loadData();
            
            if (data.pointSystem.currentPoints < amount) {
                return false; // ãƒã‚¤ãƒ³ãƒˆä¸è¶³
            }
            
            // ãƒã‚¤ãƒ³ãƒˆæ¶ˆè²»
            data.pointSystem.currentPoints -= amount;
            data.pointSystem.lifetimeSpent += amount;
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
            data.pointSystem.transactions.unshift({
                timestamp: new Date().toISOString(),
                type: 'spend',
                amount: amount,
                source: 'reward',
                description: rewardName
            });
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’åˆ¶é™
            if (data.pointSystem.transactions.length > 100) {
                data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
            }
            
            saveData(data);
            
            // UIæ›´æ–°
            updatePointDisplay();
            
            return true;
        }

        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼ˆæ”¹å–„ç‰ˆï¼šä½•åº¦ã§ã‚‚ä½¿ç”¨å¯èƒ½ã€1-3pté¸æŠï¼‰
        function addEffortBonus(points, reason = '') {
            // ãƒã‚¤ãƒ³ãƒˆæ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (points < 1 || points > 3) {
                return false;
            }
            
            const data = loadData();
            
            // ä½¿ç”¨å›æ•°ã‚’è¨˜éŒ²ï¼ˆä¸Šé™ãªã—ï¼‰
            data.pointSystem.dailyEffortUsed = (data.pointSystem.dailyEffortUsed || 0) + 1;
            
            // ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ï¼ˆç›´æ¥å‡¦ç†ï¼‰
            data.pointSystem.currentPoints += points;
            data.pointSystem.lifetimeEarned += points;
            data.pointSystem.levelProgress = data.pointSystem.lifetimeEarned;
            
            // ãƒ¬ãƒ™ãƒ«æ›´æ–°
            const newLevel = calculateLevel(data.pointSystem.lifetimeEarned);
            const oldLevel = data.pointSystem.currentLevel;
            data.pointSystem.currentLevel = newLevel.level;
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
            data.pointSystem.transactions.unshift({
                timestamp: new Date().toISOString(),
                type: 'earn',
                amount: points,
                source: 'effort_bonus',
                description: reason || `åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ (${points}pt)`,
                finalAmount: points
            });
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
            if (data.pointSystem.transactions.length > 100) {
                data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
            }
            
            saveData(data);
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
            if (newLevel.level > oldLevel) {
                showLevelUpNotification(oldLevel, newLevel);
            }
            
            // ãƒã‚¤ãƒ³ãƒˆç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            showPointAnimation(points);
            
            // UIæ›´æ–°
            updatePointDisplay();
            updatePointsView();
            updateStatistics();
            
            return true;
        }

        // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
        function updatePointDisplay() {
            const data = loadData();
            const pointDisplay = document.getElementById('point-display');
            const levelInfo = calculateLevel(data.pointSystem.lifetimeEarned);
            console.log('updatePointDisplay: ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ =', data.pointSystem.currentPoints);
            
            if (pointDisplay) {
                const multiplier = data.pointSystem.streakMultiplier || 1.0;
                pointDisplay.innerHTML = `
                    <span class="point-amount">ğŸ’° ${data.pointSystem.currentPoints}pt</span>
                    <span class="level-info">Lv.${levelInfo.level} ${levelInfo.name}</span>
                    ${multiplier > 1 ? `<span class="multiplier">ğŸ”¥Ã—${multiplier.toFixed(1)}</span>` : ''}
                `;
            }
            
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºã‚‚æ›´æ–°
            updateEffortBonusArea();
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæ”¹å–„ç‰ˆï¼šä½¿ç”¨å›æ•°è¡¨ç¤ºï¼‰
        function updateEffortBonusDisplay() {
            const data = loadData();
            const usedToday = data.pointSystem.dailyEffortUsed || 0;
            const effortStars = document.getElementById('effort-stars');
            const effortCount = document.getElementById('effort-count');
            
            if (effortStars) {
                // ä»Šæ—¥ã®ä½¿ç”¨å›æ•°ã‚’æ˜Ÿã§è¡¨ç¤ºï¼ˆæœ€å¤§10å€‹ã¾ã§è¡¨ç¤ºï¼‰
                let stars = '';
                const displayCount = Math.min(usedToday, 10);
                for (let i = 0; i < displayCount; i++) {
                    stars += 'â­';
                }
                if (usedToday > 10) {
                    stars += `+${usedToday - 10}`;
                }
                if (usedToday === 0) {
                    stars = 'ğŸ’ª ã¾ã ä½¿ã£ã¦ã„ã¾ã›ã‚“';
                }
                effortStars.textContent = stars;
            }
            
            if (effortCount) {
                effortCount.textContent = `ä»Šæ—¥${usedToday}å›ä½¿ç”¨`;
            }
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        function handleEffortBonusClick(event) {
            const button = event.currentTarget;
            
            // ãƒœã‚¿ãƒ³ã«ãƒ‘ãƒ«ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ 
            button.classList.add('effort-click-effect');
            setTimeout(() => {
                button.classList.remove('effort-click-effect');
            }, 400);
            
            // æ˜Ÿã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚’ç”Ÿæˆ
            const buttonRect = button.getBoundingClientRect();
            const particles = ['â­', 'âœ¨', 'ğŸ’«', 'ğŸŒŸ'];
            
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    particle.className = 'effort-star-particle';
                    particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                    
                    // ãƒœã‚¿ãƒ³ã®ä¸­å¿ƒã‹ã‚‰å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
                    const offsetX = (Math.random() - 0.5) * 40;
                    const offsetY = (Math.random() - 0.5) * 20;
                    
                    particle.style.left = (buttonRect.left + buttonRect.width / 2 + offsetX) + 'px';
                    particle.style.top = (buttonRect.top + buttonRect.height / 2 + offsetY) + 'px';
                    
                    document.body.appendChild(particle);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å‰Šé™¤
                    setTimeout(() => {
                        particle.remove();
                    }, 800);
                }, i * 50); // å°‘ã—ãšã¤é…ã‚‰ã›ã¦ç”Ÿæˆ
            }
            
            // ã‚¯ãƒªãƒƒã‚¯éŸ³ï¼ˆéŸ³ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnQFAABXQVZFZm10IBAAAAABAAEAJxAAAEwgAAACABAA');
                audio.volume = 0.3;
                audio.play().catch(() => {}); // ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–
            } catch (e) {
                // éŸ³å£°å†ç”Ÿã«å¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œ
            }
        }

        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼š1-3pté¸æŠå¯èƒ½ï¼‰
        function showEffortBonusDialog() {
            // ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°HTMLã‚’ä½œæˆ
            const dialogHTML = `
                <div id="effort-dialog" style="
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: var(--surface);
                    border: 2px solid var(--primary);
                    border-radius: 16px;
                    padding: 24px;
                    z-index: 10000;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                    max-width: 90%;
                    width: 320px;
                ">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">ğŸ’ª ä»Šæ—¥ã®ç›®æ¨™</h3>
                    <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">é”æˆã—ãŸã„ç›®æ¨™ã‚’è¨­å®šã—ã€å®Œäº†ã—ãŸã‚‰ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã™</p>
                    <div style="margin-bottom: 12px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">ç¨®é¡ã‚’é¸æŠ</label>
                        <select id="effort-type" style="
                            width: 100%;
                            padding: 8px;
                            background: var(--background);
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            color: var(--text-primary);
                            margin-bottom: 12px;
                        ">
                            <option value="morning">ğŸŒ… æ—©èµ·ããƒ»æœæ´»</option>
                            <option value="exercise">ğŸ’ª é‹å‹•ãƒ»ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</option>
                            <option value="study">ğŸ“š å‹‰å¼·ãƒ»å­¦ç¿’</option>
                            <option value="work">ğŸ’¼ ä»•äº‹ãƒ»ä½œæ¥­</option>
                            <option value="health">ğŸ¥— å¥åº·ãƒ»é£Ÿäº‹</option>
                            <option value="cleaning">ğŸ§¹ æƒé™¤ãƒ»æ•´ç†æ•´é “</option>
                            <option value="mindfulness">ğŸ§˜ ç‘æƒ³ãƒ»ãƒªãƒ©ãƒƒã‚¯ã‚¹</option>
                            <option value="social">ğŸ‘¥ äººé–“é–¢ä¿‚ãƒ»äº¤æµ</option>
                            <option value="creative">ğŸ¨ å‰µé€ ãƒ»è¶£å‘³</option>
                            <option value="challenge">ğŸ¯ æ–°ã—ã„æŒ‘æˆ¦</option>
                            <option value="other">âœ¨ ãã®ä»–</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);">è©³ç´°ï¼ˆä»»æ„ï¼‰</label>
                        <input type="text" id="effort-reason" placeholder="ä¾‹: 6æ™‚ã«èµ·ãã¦æœæ´»ã—ãŸ" style="
                            width: 100%;
                            padding: 8px;
                            background: var(--background);
                            border: 1px solid var(--border);
                            border-radius: 8px;
                            color: var(--text-primary);
                        ">
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 12px; color: var(--text-secondary);">ç²å¾—ãƒã‚¤ãƒ³ãƒˆ</label>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="selectEffortPoints(1)" id="effort-1pt" class="effort-point-btn" style="
                                flex: 1;
                                padding: 12px;
                                background: var(--surface-light);
                                border: 2px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                            ">1pt<br><small style="font-size: 11px; opacity: 0.8;">è»½ã„åŠªåŠ›</small></button>
                            <button onclick="selectEffortPoints(2)" id="effort-2pt" class="effort-point-btn" style="
                                flex: 1;
                                padding: 12px;
                                background: var(--primary);
                                border: 2px solid var(--primary);
                                border-radius: 8px;
                                color: white;
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                            ">2pt<br><small style="font-size: 11px; opacity: 0.8;">æ™®é€šã®åŠªåŠ›</small></button>
                            <button onclick="selectEffortPoints(3)" id="effort-3pt" class="effort-point-btn" style="
                                flex: 1;
                                padding: 12px;
                                background: var(--surface-light);
                                border: 2px solid var(--border);
                                border-radius: 8px;
                                color: var(--text-primary);
                                cursor: pointer;
                                font-size: 16px;
                                font-weight: bold;
                            ">3pt<br><small style="font-size: 11px; opacity: 0.8;">å¤§ããªåŠªåŠ›</small></button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="confirmEffortBonus()" style="
                            flex: 1;
                            padding: 12px;
                            background: var(--primary);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            cursor: pointer;
                            font-weight: bold;
                        ">ç›®æ¨™ã‚’è¨­å®š</button>
                        <button onclick="closeEffortDialog()" style="
                            flex: 1;
                            padding: 12px;
                            background: var(--surface-light);
                            border: none;
                            border-radius: 8px;
                            color: var(--text-primary);
                            cursor: pointer;
                        ">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                </div>
                <div id="effort-overlay" onclick="closeEffortDialog()" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                "></div>
            `;
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
            const dialogContainer = document.createElement('div');
            dialogContainer.innerHTML = dialogHTML;
            document.body.appendChild(dialogContainer);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§2ptã‚’é¸æŠ
            window.selectedEffortPoints = 2;
        }
        
        // åŠªåŠ›ãƒã‚¤ãƒ³ãƒˆã‚’é¸æŠ
        function selectEffortPoints(points) {
            window.selectedEffortPoints = points;
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            document.querySelectorAll('.effort-point-btn').forEach(btn => {
                btn.style.background = 'var(--surface-light)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-primary)';
            });
            const selectedBtn = document.getElementById(`effort-${points}pt`);
            if (selectedBtn) {
                selectedBtn.style.background = 'var(--primary)';
                selectedBtn.style.borderColor = 'var(--primary)';
                selectedBtn.style.color = 'white';
            }
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚’ç¢ºå®š
        function confirmEffortBonus() {
            const typeSelect = document.getElementById('effort-type');
            const typeText = typeSelect.options[typeSelect.selectedIndex].text;
            const detail = document.getElementById('effort-reason').value;
            const points = window.selectedEffortPoints || 2;
            
            // äºˆå®šã¨ã—ã¦è¿½åŠ 
            addEffortBonusPlan(points, typeText, detail);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--primary);
                color: white;
                padding: 20px 40px;
                border-radius: 20px;
                font-size: 18px;
                font-weight: 600;
                z-index: 10001;
                animation: fadeInOut 2s ease-out;
            `;
            message.textContent = `ğŸ“‹ ç›®æ¨™ã‚’è¨­å®šã—ã¾ã—ãŸ`;
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 2000);
            
            closeEffortDialog();
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã®ç›®æ¨™ã‚’è¿½åŠ 
        function addEffortBonusPlan(points, type, reason = '') {
            // ãƒã‚¤ãƒ³ãƒˆæ•°ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!points || points < 1 || points > 3) {
                return;
            }
            
            const data = loadData();
            const today = dateKeyLocal(new Date());
            
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã®äºˆå®šãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
            if (!data.effortBonusPlans) data.effortBonusPlans = {};
            if (!data.effortBonusPlans[today]) data.effortBonusPlans[today] = [];
            
            // æ–°ã—ã„äºˆå®šã‚’è¿½åŠ 
            const plan = {
                id: 'effort_' + Date.now(),
                points: points,
                type: type,
                reason: reason,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            data.effortBonusPlans[today].push(plan);
            saveData(data);
            
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒªã‚¢ã‚’æ›´æ–°
            updateEffortBonusArea();
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã®ç›®æ¨™ã‚’å®Œäº†
        function completeEffortBonusPlan(planId) {
            const data = loadData();
            const today = dateKeyLocal(new Date());
            
            if (!data.effortBonusPlans || !data.effortBonusPlans[today]) return;
            
            const plan = data.effortBonusPlans[today].find(p => p.id === planId);
            if (!plan || plan.completed) return;
            
            // å®Œäº†çŠ¶æ…‹ã«å¤‰æ›´
            plan.completed = true;
            plan.completedAt = new Date().toISOString();
            
            // ä½¿ç”¨å›æ•°ã‚’è¨˜éŒ²
            data.pointSystem.dailyEffortUsed = (data.pointSystem.dailyEffortUsed || 0) + 1;
            
            // ãƒã‚¤ãƒ³ãƒˆè¿½åŠ ï¼ˆç›´æ¥å‡¦ç†ï¼‰
            data.pointSystem.currentPoints += plan.points;
            data.pointSystem.lifetimeEarned += plan.points;
            data.pointSystem.levelProgress = data.pointSystem.lifetimeEarned;
            
            // ãƒ¬ãƒ™ãƒ«æ›´æ–°
            const newLevel = calculateLevel(data.pointSystem.lifetimeEarned);
            const oldLevel = data.pointSystem.currentLevel;
            data.pointSystem.currentLevel = newLevel.level;
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²
            data.pointSystem.transactions.unshift({
                timestamp: new Date().toISOString(),
                type: 'earn',
                amount: plan.points,
                source: 'effort_bonus',
                description: plan.reason || `åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹: ${plan.type} (${plan.points}pt)`,
                finalAmount: plan.points
            });
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’æœ€æ–°100ä»¶ã«åˆ¶é™
            if (data.pointSystem.transactions.length > 100) {
                data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
            }
            
            saveData(data);
            updatePointDisplay();
            updateEffortBonusArea();
            
            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
            const button = document.getElementById('effort-plan-' + planId);
            if (button) {
                showFloatingPoints(plan.points, button);
            }
            playPointSound();
            
            // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
            if (newLevel.level > oldLevel) {
                showLevelUpNotification(oldLevel, newLevel);
            }
        }
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã®ç›®æ¨™ã‚’å‰Šé™¤
        function deleteEffortBonusPlan(planId) {
            const data = loadData();
            const today = dateKeyLocal(new Date());
            
            if (!data.effortBonusPlans || !data.effortBonusPlans[today]) return;
            
            // äºˆå®šã‚’å‰Šé™¤
            data.effortBonusPlans[today] = data.effortBonusPlans[today].filter(p => p.id !== planId);
            
            saveData(data);
            updateEffortBonusArea();
        }
        
        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function toggleTheme() {
            const root = document.documentElement;
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            if (newTheme === 'light') {
                root.classList.add('light-theme');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                root.classList.remove('light-theme');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
            }
            
            localStorage.setItem('theme', newTheme);
        }
        
        // ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const root = document.documentElement;
            
            if (savedTheme === 'light') {
                root.classList.add('light-theme');
                document.getElementById('theme-icon').textContent = 'â˜€ï¸';
            } else {
                root.classList.remove('light-theme');
                document.getElementById('theme-icon').textContent = 'ğŸŒ™';
            }
        }
        
        // windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç™»éŒ²
        window.toggleTheme = toggleTheme;
        window.initializeTheme = initializeTheme;
        
        // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒªã‚¢ã‚’æ›´æ–°
        function updateEffortBonusArea() {
            const data = loadData();
            const today = dateKeyLocal(new Date());
            const plans = data.effortBonusPlans && data.effortBonusPlans[today] ? data.effortBonusPlans[today] : [];
            
            const container = document.getElementById('effort-bonus-plans');
            if (!container) return;
            
            if (plans.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 14px; margin: 8px 0;">è¨­å®šã•ã‚ŒãŸç›®æ¨™ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                container.innerHTML = '';
                plans.forEach(plan => {
                    const planDiv = document.createElement('div');
                    planDiv.style.cssText = `
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 8px;
                        margin-bottom: 8px;
                        background: ${plan.completed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255, 255, 255, 0.05)'};
                        border: 1px solid ${plan.completed ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
                        border-radius: 8px;
                        transition: all 0.3s ease;
                    `;
                    
                    const leftDiv = document.createElement('div');
                    leftDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; flex: 1;';
                    
                    const icon = document.createElement('span');
                    icon.style.fontSize = '20px';
                    icon.textContent = plan.completed ? 'âœ…' : 'ğŸ“‹';
                    leftDiv.appendChild(icon);
                    
                    const textDiv = document.createElement('div');
                    textDiv.style.cssText = 'flex: 1;';
                    
                    const typeText = document.createElement('div');
                    typeText.style.cssText = `
                        font-size: 14px;
                        font-weight: 500;
                        ${plan.completed ? 'text-decoration: line-through; opacity: 0.7;' : ''}
                    `;
                    typeText.textContent = `${plan.type} (+${plan.points}pt)`;
                    textDiv.appendChild(typeText);
                    
                    if (plan.reason) {
                        const reasonText = document.createElement('div');
                        reasonText.style.cssText = 'font-size: 12px; color: var(--text-secondary); margin-top: 2px;';
                        reasonText.textContent = plan.reason;
                        textDiv.appendChild(reasonText);
                    }
                    
                    leftDiv.appendChild(textDiv);
                    planDiv.appendChild(leftDiv);
                    
                    const buttonsDiv = document.createElement('div');
                    buttonsDiv.style.cssText = 'display: flex; gap: 4px;';
                    
                    if (!plan.completed) {
                        // å®Œäº†ãƒœã‚¿ãƒ³
                        const completeBtn = document.createElement('button');
                        completeBtn.id = 'effort-plan-' + plan.id;
                        completeBtn.className = 'btn btn-primary';
                        completeBtn.style.cssText = 'padding: 4px 8px; font-size: 12px;';
                        completeBtn.textContent = 'å®Œäº†';
                        completeBtn.onclick = () => completeEffortBonusPlan(plan.id);
                        buttonsDiv.appendChild(completeBtn);
                        
                        // å‰Šé™¤ãƒœã‚¿ãƒ³
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn btn-secondary';
                        deleteBtn.style.cssText = 'padding: 4px 8px; font-size: 12px; background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);';
                        deleteBtn.textContent = 'å‰Šé™¤';
                        deleteBtn.onclick = () => {
                            if (confirm('ã“ã®ç›®æ¨™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                deleteEffortBonusPlan(plan.id);
                            }
                        };
                        buttonsDiv.appendChild(deleteBtn);
                    }
                    
                    planDiv.appendChild(buttonsDiv);
                    container.appendChild(planDiv);
                });
            }
            
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚«ãƒ¼ãƒ‰ã®æ›´æ–°ã‚‚è¡Œã†
            const effortCard = document.getElementById('effort-bonus-card');
            if (effortCard) {
                const usedToday = data.pointSystem.dailyEffortUsed || 0;
                const pendingCount = plans.filter(p => !p.completed).length;
                const completedCount = plans.filter(p => p.completed).length;
                
                effortCard.innerHTML = `
                    <h3 class="card-title">ğŸ’ª åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹</h3>
                    <p style="margin-bottom: 12px;">ä»Šæ—¥é”æˆã—ãŸã„ç›®æ¨™ã‚’è¨­å®šã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’ç²å¾—ã—ã¾ã—ã‚‡ã†ï¼</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="color: var(--text-secondary); font-size: 14px;">
                            æœªå®Œäº†: ${pendingCount}ä»¶ | å®Œäº†: ${completedCount}ä»¶
                        </span>
                        <span style="font-size: 24px;">${completedCount > 0 ? 'â­'.repeat(Math.min(completedCount, 5)) : 'ğŸŒ±'}</span>
                    </div>
                    <button class="btn btn-secondary" onclick="handleEffortBonusClick(event); showEffortBonusDialog()" style="width: 100%; padding: 10px; font-size: 14px; position: relative; overflow: visible;">
                        ğŸ’ª ç›®æ¨™ã‚’è¿½åŠ ã™ã‚‹ (+1-3pt)
                    </button>
                `;
            }
        }
        
        // Window ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢æ•°ã‚’ç™»éŒ²
        window.addEffortBonusPlan = addEffortBonusPlan;
        window.completeEffortBonusPlan = completeEffortBonusPlan;
        window.deleteEffortBonusPlan = deleteEffortBonusPlan;
        window.updateEffortBonusArea = updateEffortBonusArea;
        
        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        function closeEffortDialog() {
            const dialog = document.getElementById('effort-dialog');
            const overlay = document.getElementById('effort-overlay');
            if (dialog && dialog.parentElement) {
                dialog.parentElement.remove();
            }
        }

        // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—é€šçŸ¥
        function showLevelUpNotification(oldLevel, newLevel) {
            // å„ªå…ˆåº¦10ã§æœ€å„ªå…ˆè¡¨ç¤º
            showNotification(
                `ğŸ‰ ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼\nLv.${oldLevel} â†’ Lv.${newLevel.level}\n${newLevel.name}`,
                'success',
                10
            );
        }

        // ãƒã‚¤ãƒ³ãƒˆç²å¾—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        function showPointAnimation(points) {
            // é‡è¤‡è¡¨ç¤ºã‚’é˜²ããŸã‚ã€ã“ã®é–¢æ•°ã§ã¯ä½•ã‚‚ã—ãªã„
            // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã¯earnPointså†…ã®descriptionã§è¡Œã†
        }

        // ãƒ¬ãƒ™ãƒ«é€²æ—ã‚’è¡¨ç¤º
        function showLevelProgress() {
            const data = loadData();
            const currentPoints = data.pointSystem.lifetimeEarned;
            const levelInfo = calculateLevel(currentPoints);
            
            // æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§ã®æƒ…å ±ã‚’è¨ˆç®—
            const nextLevelPoints = levelInfo.max + 1;
            const pointsNeeded = nextLevelPoints - currentPoints;
            const progressInLevel = currentPoints - levelInfo.min;
            const levelRange = levelInfo.max - levelInfo.min + 1;
            const progressPercent = Math.round((progressInLevel / levelRange) * 100);
            
            // æ¬¡ã®ãƒ¬ãƒ™ãƒ«åã‚’å–å¾—
            let nextLevelName = 'è¶…è¶Šè€…';
            if (levelInfo.level < 10) {
                nextLevelName = LEVEL_THRESHOLDS[levelInfo.level].name;
            }
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ä½œæˆ
            const popup = document.createElement('div');
            popup.id = 'level-progress-popup';
            popup.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 16px;
                z-index: 1000;
                min-width: 280px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                animation: slideIn 0.2s ease-out;
            `;
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0; font-size: 16px;">ğŸ“Š ãƒ¬ãƒ™ãƒ«é€²æ—</h3>
                    <button onclick="document.getElementById('level-progress-popup').remove()" style="
                        background: none;
                        border: none;
                        color: var(--text-secondary);
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">Ã—</button>
                </div>
                
                <div style="background: var(--background); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-size: 18px; font-weight: bold; color: var(--primary);">
                            Lv.${levelInfo.level} ${levelInfo.name}
                        </span>
                        <span style="font-size: 14px; color: var(--text-secondary);">
                            ${currentPoints}pt
                        </span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="
                            background: linear-gradient(90deg, #10b981, #3b82f6);
                            height: 100%;
                            width: ${progressPercent}%;
                            transition: width 0.3s;
                        "></div>
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px; text-align: center;">
                        ${progressPercent}% å®Œäº†
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1)); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 14px; margin-bottom: 8px;">
                        æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã¾ã§
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-size: 24px; font-weight: bold; color: #8b5cf6;">
                                ${pointsNeeded}pt
                            </span>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                Lv.${levelInfo.level + 1} ${nextLevelName}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 12px; color: var(--text-secondary);">
                                å¿…è¦åˆè¨ˆ
                            </div>
                            <div style="font-size: 16px; font-weight: bold; color: #ec4899;">
                                ${nextLevelPoints}pt
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
            const existingPopup = document.getElementById('level-progress-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
            document.body.appendChild(popup);
            
            // ã‚¯ãƒªãƒƒã‚¯å¤–ã§é–‰ã˜ã‚‹å‡¦ç†
            setTimeout(() => {
                const closeOnClickOutside = (e) => {
                    if (!popup.contains(e.target) && e.target.id !== 'point-display' && !document.getElementById('point-display').contains(e.target)) {
                        popup.remove();
                        document.removeEventListener('click', closeOnClickOutside);
                    }
                };
                document.addEventListener('click', closeOnClickOutside);
            }, 100);
        }

        // é€£ç¶šãƒœãƒ¼ãƒŠã‚¹ã®è¨ˆç®—
        function calculateStreakMultiplier(streakDays) {
            if (streakDays >= 21) return 2.0;
            if (streakDays >= 14) return 1.7;
            if (streakDays >= 7) return 1.5;
            if (streakDays >= 3) return 1.2;
            return 1.0;
        }

        // ç¾åœ¨ã®é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
        function calculateCurrentStreak(hypothesis) {
            if (!hypothesis.achievements) return 0;
            
            const today = new Date();
            let streak = 0;
            let checkDate = new Date(today);
            
            // ä»Šæ—¥ã‹ã‚‰é¡ã£ã¦é€£ç¶šé”æˆã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            while (true) {
                const dateKey = dateKeyLocal(checkDate);
                if (hypothesis.achievements[dateKey]) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // é–‹å§‹æ—¥ã®è¨­å®šé–¢æ•°
        function setStartDate(type) {
            const todayBtn = document.getElementById('start-today-btn');
            const laterBtn = document.getElementById('start-later-btn');
            const dateInput = document.getElementById('habit-start-date');
            const dateDisplay = document.getElementById('start-date-display');
            const selectedDateSpan = document.getElementById('selected-start-date');
            
            if (!todayBtn || !laterBtn || !dateInput || !dateDisplay || !selectedDateSpan) {
                // æ–°è¦ä½œæˆç”»é¢ã®è¦ç´ ãŒã¾ã å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒªã‚¿ãƒ¼ãƒ³
                return;
            }
            
            if (type === 'today') {
                // ä»Šæ—¥ã‹ã‚‰é–‹å§‹
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                
                // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
                todayBtn.style.background = 'var(--primary)';
                todayBtn.style.color = 'white';
                laterBtn.style.background = 'var(--surface-light)';
                laterBtn.style.color = 'var(--text-primary)';
                
                // æ—¥ä»˜å…¥åŠ›ã‚’éè¡¨ç¤º
                dateInput.style.display = 'none';
                dateInput.value = dateStr;
                
                // é–‹å§‹æ—¥è¡¨ç¤ºã‚’æ›´æ–°
                dateDisplay.style.display = 'block';
                selectedDateSpan.textContent = formatDateJapanese(today);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                window.selectedStartDate = dateStr;
            }
        }
        
        function showDatePicker() {
            const todayBtn = document.getElementById('start-today-btn');
            const laterBtn = document.getElementById('start-later-btn');
            const dateInput = document.getElementById('habit-start-date');
            const dateDisplay = document.getElementById('start-date-display');
            
            if (!todayBtn || !laterBtn || !dateInput || !dateDisplay) {
                return;
            }
            
            // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
            laterBtn.style.background = 'var(--primary)';
            laterBtn.style.color = 'white';
            todayBtn.style.background = 'var(--surface-light)';
            todayBtn.style.color = 'var(--text-primary)';
            
            // æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤º
            dateInput.style.display = 'block';
            
            // æœ€å°å€¤ã‚’ä»Šæ—¥ã«è¨­å®š
            const today = new Date();
            const minDate = today.toISOString().split('T')[0];
            dateInput.min = minDate;
            
            // æœ€å¤§å€¤ã‚’30æ—¥å¾Œã«è¨­å®š
            const maxDate = new Date();
            maxDate.setDate(maxDate.getDate() + 30);
            dateInput.max = maxDate.toISOString().split('T')[0];
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’æ˜æ—¥ã«è¨­å®š
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            dateInput.value = tomorrow.toISOString().split('T')[0];
            
            // é–‹å§‹æ—¥è¡¨ç¤ºã‚’æ›´æ–°
            updateStartDateDisplay();
        }
        
        function updateStartDateDisplay() {
            const dateInput = document.getElementById('habit-start-date');
            const dateDisplay = document.getElementById('start-date-display');
            const selectedDateSpan = document.getElementById('selected-start-date');
            
            if (dateInput && dateInput.value && dateDisplay && selectedDateSpan) {
                const selectedDate = new Date(dateInput.value);
                dateDisplay.style.display = 'block';
                selectedDateSpan.textContent = formatDateJapanese(selectedDate);
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
                window.selectedStartDate = dateInput.value;
            }
        }
        
        function formatDateJapanese(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weekday = weekdays[date.getDay()];
            
            return `${year}å¹´${month}æœˆ${day}æ—¥(${weekday})`;
        }
        
        // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã®ãƒã‚§ãƒƒã‚¯ã¨ä»˜ä¸
        function checkAndAwardComboBonus(dateKey) {
            const data = loadData();
            let achievedToday = 0;
            let totalHabits = 0;
            
            // ä»Šæ—¥é”æˆã—ãŸç¿’æ…£æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[dateKey]) {
                    achievedToday++;
                }
                totalHabits++;
            });
            
            // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ä»˜ä¸ï¼ˆå„ªå…ˆåº¦4ï¼‰
            if (achievedToday === 2) {
                earnPoints(1, 'combo', '2ç¿’æ…£åŒæ™‚é”æˆãƒœãƒ¼ãƒŠã‚¹');
                showNotification('ğŸ‰ 2ç¿’æ…£åŒæ™‚é”æˆãƒœãƒ¼ãƒŠã‚¹!\n+1pt', 'success', 4);
            } else if (achievedToday === 3) {
                earnPoints(3, 'combo', '3ç¿’æ…£åŒæ™‚é”æˆãƒœãƒ¼ãƒŠã‚¹');
                showNotification('ğŸ”¥ 3ç¿’æ…£åŒæ™‚é”æˆãƒœãƒ¼ãƒŠã‚¹!\n+3pt', 'success', 4);
            } else if (totalHabits >= 4 && achievedToday === totalHabits) {
                earnPoints(5, 'combo', 'å…¨ç¿’æ…£é”æˆãƒœãƒ¼ãƒŠã‚¹');
                showNotification('ğŸ† å…¨ç¿’æ…£é”æˆï¼ç´ æ™´ã‚‰ã—ã„ï¼\n+5pt', 'success', 4);
            }
        }
        
        // ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆã‚’æ›´æ–°ï¼ˆçµ±è¨ˆç”»é¢ç”¨ï¼‰
        function updatePointStatistics() {
            const data = loadData();
            const ps = data.pointSystem;
            
            // ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ
            const currentPointsEl = document.getElementById('current-points-stat');
            if (currentPointsEl) {
                currentPointsEl.textContent = ps.currentPoints.toLocaleString();
            }
            
            // ç´¯è¨ˆç²å¾—
            const lifetimeEarnedEl = document.getElementById('lifetime-earned-stat');
            if (lifetimeEarnedEl) {
                lifetimeEarnedEl.textContent = ps.lifetimeEarned.toLocaleString();
            }
            
            // ç´¯è¨ˆæ¶ˆè²»
            const lifetimeSpentEl = document.getElementById('lifetime-spent-stat');
            if (lifetimeSpentEl) {
                lifetimeSpentEl.textContent = ps.lifetimeSpent.toLocaleString();
            }
            
            // ç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«
            const levelInfo = calculateLevel(ps.lifetimeEarned);
            const currentLevelEl = document.getElementById('current-level-stat');
            if (currentLevelEl) {
                currentLevelEl.textContent = `Lv.${levelInfo.level}`;
                currentLevelEl.title = levelInfo.name; // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã§ãƒ¬ãƒ™ãƒ«åè¡¨ç¤º
            }
            
            // ãƒ¬ãƒ™ãƒ«é€²æ—ãƒãƒ¼
            const progressInLevel = ps.lifetimeEarned - levelInfo.min;
            const levelRange = levelInfo.max - levelInfo.min;
            const progressPercent = Math.min(100, (progressInLevel / levelRange) * 100);
            
            const levelProgressLabel = document.getElementById('level-progress-label');
            if (levelProgressLabel) {
                levelProgressLabel.textContent = `Lv.${levelInfo.level + 1} ${levelInfo.level < 10 ? LEVEL_THRESHOLDS[levelInfo.level].name : 'è¶…è¶Šè€…'} ã¾ã§`;
            }
            
            const levelProgressText = document.getElementById('level-progress-text');
            if (levelProgressText) {
                const remaining = levelInfo.max - ps.lifetimeEarned + 1;
                levelProgressText.textContent = `ã‚ã¨${remaining}pt`;
            }
            
            const levelProgressBar = document.getElementById('level-progress-bar');
            if (levelProgressBar) {
                levelProgressBar.style.width = `${progressPercent}%`;
            }
            
            // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆ30æ—¥é–“ï¼‰
            const pointTrendEl = document.getElementById('point-trend-graph');
            if (pointTrendEl && ps.transactions.length > 0) {
                const last30Days = generatePointTrendData(ps.transactions, 30);
                pointTrendEl.innerHTML = `
                    <h4 style="font-size: 14px; margin-bottom: 12px;">ğŸ“ˆ ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ï¼ˆ30æ—¥é–“ï¼‰</h4>
                    <div style="position: relative; height: 120px; border-left: 2px solid var(--border); border-bottom: 2px solid var(--border);">
                        ${generatePointTrendGraph(last30Days)}
                    </div>
                `;
            }
            
            // ã‚½ãƒ¼ã‚¹åˆ¥ç²å¾—çµ±è¨ˆï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰
            // ã“ã®æ©Ÿèƒ½ã¯ä¸è¦ãªãŸã‚å‰Šé™¤ã—ã¾ã—ãŸ
            
            // æ™‚é–“å¸¯åˆ¥ç²å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³
            const timePatternEl = document.getElementById('point-time-pattern');
            if (timePatternEl && ps.transactions.length > 0) {
                const timePattern = analyzeTimePattern(ps.transactions);
                timePatternEl.innerHTML = `
                    <h4 style="font-size: 14px; margin-bottom: 12px;">â° æ™‚é–“å¸¯åˆ¥ç²å¾—ãƒ‘ã‚¿ãƒ¼ãƒ³</h4>
                    <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px;">
                        ${generateTimePatternHTML(timePattern)}
                    </div>
                `;
            }
            
            // ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœåˆ†æ
            const boostAnalysisEl = document.getElementById('boost-effect-analysis');
            if (boostAnalysisEl && ps.transactions.length > 0) {
                const boostStats = analyzeBoostEffects(ps.transactions);
                boostAnalysisEl.innerHTML = `
                    <h4 style="font-size: 14px; margin-bottom: 12px;">ğŸš€ ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœåˆ†æ</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        ${generateBoostStatsHTML(boostStats)}
                    </div>
                `;
            }
            
            // æœ€è¿‘ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
            const recentTransEl = document.getElementById('recent-transactions');
            if (recentTransEl) {
                const recentTrans = ps.transactions.slice(0, 10); // æœ€æ–°10ä»¶
                
                if (recentTrans.length === 0) {
                    recentTransEl.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 8px;">ã¾ã å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                } else {
                    recentTransEl.innerHTML = recentTrans.map(t => {
                        const date = new Date(t.timestamp);
                        const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                        const icon = t.type === 'earn' ? 'â•' : 'â–';
                        const color = t.type === 'earn' ? '#10b981' : '#ef4444';
                        const amount = t.type === 'earn' ? 
                            (t.finalAmount || t.amount) : 
                            t.amount;
                        
                        return `
                            <div style="display: flex; justify-content: space-between; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                                <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${icon} ${escapeHTML(t.description)}
                                </span>
                                <span style="color: ${color}; font-weight: bold; margin-left: 8px;">
                                    ${t.type === 'earn' ? '+' : '-'}${amount}pt
                                </span>
                            </div>
                        `;
                    }).join('');
                }
            }
        }
        
        // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        function generatePointTrendData(transactions, days) {
            const today = new Date();
            const dailyPoints = {};
            let cumulativePoints = 0;
            
            // æ—¥ä»˜åˆ¥ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é›†è¨ˆ
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateKey = dateKeyLocal(date);
                dailyPoints[dateKey] = { earned: 0, spent: 0, cumulative: 0 };
            }
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †ï¼‰
            const sortedTrans = [...transactions].reverse();
            
            sortedTrans.forEach(t => {
                const date = new Date(t.timestamp);
                const dateKey = dateKeyLocal(date);
                
                if (dailyPoints[dateKey]) {
                    if (t.type === 'earn') {
                        dailyPoints[dateKey].earned += t.finalAmount || t.amount;
                        cumulativePoints += t.finalAmount || t.amount;
                    } else {
                        dailyPoints[dateKey].spent += t.amount;
                        cumulativePoints -= t.amount;
                    }
                    dailyPoints[dateKey].cumulative = cumulativePoints;
                }
            });
            
            return dailyPoints;
        }
        
        // ãƒã‚¤ãƒ³ãƒˆæ¨ç§»ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
        function generatePointTrendGraph(dailyPoints) {
            const dates = Object.keys(dailyPoints);
            const maxPoints = Math.max(...dates.map(d => dailyPoints[d].cumulative), 1);
            
            const points = dates.map((date, i) => {
                const x = (i / (dates.length - 1)) * 100;
                const y = 100 - (dailyPoints[date].cumulative / maxPoints) * 100;
                return `${x},${y}`;
            }).join(' ');
            
            return `
                <svg style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" viewBox="0 0 100 100" preserveAspectRatio="none">
                    <polyline
                        points="${points}"
                        fill="none"
                        stroke="#fbbf24"
                        stroke-width="2"
                        opacity="0.8"
                    />
                </svg>
                <div style="position: absolute; left: -30px; top: 0; font-size: 10px; color: var(--text-secondary);">${maxPoints}</div>
                <div style="position: absolute; left: -20px; bottom: 0; font-size: 10px; color: var(--text-secondary);">0</div>
            `;
        }
        
        // ã‚½ãƒ¼ã‚¹åˆ¥ãƒã‚¤ãƒ³ãƒˆåˆ†æ
        function analyzePointSources(transactions) {
            const sources = {};
            
            transactions.forEach(t => {
                if (t.type === 'earn') {
                    const source = t.source || 'ãã®ä»–';
                    if (!sources[source]) {
                        sources[source] = { count: 0, total: 0, average: 0 };
                    }
                    sources[source].count++;
                    sources[source].total += t.finalAmount || t.amount;
                }
            });
            
            // å¹³å‡ã‚’è¨ˆç®—
            Object.keys(sources).forEach(key => {
                sources[key].average = Math.round(sources[key].total / sources[key].count * 10) / 10;
            });
            
            return sources;
        }
        
        // ã‚½ãƒ¼ã‚¹çµ±è¨ˆHTMLã‚’ç”Ÿæˆ
        function generateSourceStatsHTML(sourceStats) {
            const sourceNames = {
                'habit': 'ğŸ¯ ç¿’æ…£é”æˆ',
                'journal': 'ğŸ“ ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«',
                'challenge': 'ğŸ† ãƒãƒ£ãƒ¬ãƒ³ã‚¸',
                'effort': 'ğŸ’ª åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹',
                'streak': 'ğŸ”¥ ã‚¹ãƒˆãƒªãƒ¼ã‚¯',
                'ãã®ä»–': 'âœ¨ ãã®ä»–'
            };
            
            return Object.entries(sourceStats)
                .sort((a, b) => b[1].total - a[1].total)
                .map(([source, stats]) => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 4px;">
                        <span>${sourceNames[source] || source}</span>
                        <div style="text-align: right;">
                            <span style="color: #fbbf24; font-weight: bold;">${stats.total}pt</span>
                            <span style="color: var(--text-secondary); font-size: 10px; margin-left: 8px;">
                                (${stats.count}å›, å¹³å‡${stats.average}pt)
                            </span>
                        </div>
                    </div>
                `).join('');
        }
        
        // æ™‚é–“å¸¯åˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
        function analyzeTimePattern(transactions) {
            const timeSlots = {
                'æ—©æœ': { hours: [4, 5, 6, 7], count: 0, total: 0 },
                'æœ': { hours: [8, 9, 10, 11], count: 0, total: 0 },
                'æ˜¼': { hours: [12, 13, 14, 15], count: 0, total: 0 },
                'å¤•æ–¹': { hours: [16, 17, 18, 19], count: 0, total: 0 },
                'å¤œ': { hours: [20, 21, 22, 23], count: 0, total: 0 },
                'æ·±å¤œ': { hours: [0, 1, 2, 3], count: 0, total: 0 }
            };
            
            transactions.forEach(t => {
                if (t.type === 'earn') {
                    const hour = new Date(t.timestamp).getHours();
                    Object.entries(timeSlots).forEach(([name, slot]) => {
                        if (slot.hours.includes(hour)) {
                            slot.count++;
                            slot.total += t.finalAmount || t.amount;
                        }
                    });
                }
            });
            
            return timeSlots;
        }
        
        // æ™‚é–“å¸¯ãƒ‘ã‚¿ãƒ¼ãƒ³HTMLã‚’ç”Ÿæˆ
        function generateTimePatternHTML(timePattern) {
            const maxTotal = Math.max(...Object.values(timePattern).map(s => s.total), 1);
            
            return Object.entries(timePattern).map(([name, stats]) => {
                const heightPercent = (stats.total / maxTotal) * 100;
                return `
                    <div style="text-align: center;">
                        <div style="position: relative; height: 60px; display: flex; align-items: flex-end;">
                            <div style="
                                width: 100%;
                                height: ${heightPercent}%;
                                background: linear-gradient(to top, #fbbf24, #f59e0b);
                                border-radius: 4px 4px 0 0;
                                opacity: ${stats.total > 0 ? 1 : 0.3};
                            "></div>
                        </div>
                        <div style="font-size: 10px; margin-top: 4px;">${name}</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">${stats.total}pt</div>
                    </div>
                `;
            }).join('');
        }
        
        // ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœåˆ†æ
        function analyzeBoostEffects(transactions) {
            const boostStats = {
                totalBoosted: 0,
                totalNormal: 0,
                countBoosted: 0,
                countNormal: 0,
                maxMultiplier: 1,
                averageMultiplier: 1
            };
            
            let multiplierSum = 0;
            let multiplierCount = 0;
            
            transactions.forEach(t => {
                if (t.type === 'earn') {
                    const multiplier = t.multiplier || 1;
                    if (multiplier > 1) {
                        boostStats.countBoosted++;
                        boostStats.totalBoosted += t.finalAmount || t.amount;
                        boostStats.maxMultiplier = Math.max(boostStats.maxMultiplier, multiplier);
                    } else {
                        boostStats.countNormal++;
                        boostStats.totalNormal += t.amount;
                    }
                    multiplierSum += multiplier;
                    multiplierCount++;
                }
            });
            
            if (multiplierCount > 0) {
                boostStats.averageMultiplier = Math.round(multiplierSum / multiplierCount * 10) / 10;
            }
            
            return boostStats;
        }
        
        // ãƒ–ãƒ¼ã‚¹ãƒˆçµ±è¨ˆHTMLã‚’ç”Ÿæˆ
        function generateBoostStatsHTML(boostStats) {
            const boostPercentage = boostStats.countBoosted + boostStats.countNormal > 0
                ? Math.round(boostStats.countBoosted / (boostStats.countBoosted + boostStats.countNormal) * 100)
                : 0;
            
            return `
                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 20px; font-weight: bold; color: #f59e0b;">${boostStats.totalBoosted}pt</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">ãƒ–ãƒ¼ã‚¹ãƒˆç²å¾—</div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">${boostPercentage}%ãŒãƒ–ãƒ¼ã‚¹ãƒˆ</div>
                </div>
                <div style="text-align: center; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                    <div style="font-size: 20px; font-weight: bold; color: #10b981;">Ã—${boostStats.averageMultiplier}</div>
                    <div style="font-size: 11px; color: var(--text-secondary);">å¹³å‡å€ç‡</div>
                    <div style="font-size: 10px; color: var(--text-secondary); margin-top: 4px;">æœ€å¤§ Ã—${boostStats.maxMultiplier}</div>
                </div>
            `;
        }

        // ãƒã‚¤ãƒ³ãƒˆç”»é¢ã‚’è¡¨ç¤º
        function showPointsView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('points-view').style.display = 'block';
            document.getElementById('cards-view').style.display = 'none';
            
            updateNavigation('points');
            updatePointsView();
            showRewardsTab(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å ±é…¬ã‚¿ãƒ–ã‚’è¡¨ç¤º
            
            // ãƒã‚¤ãƒ³ãƒˆç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’å†è¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'flex';
            }
        }
        
        // ãƒã‚¤ãƒ³ãƒˆç”»é¢ã®æ›´æ–°
        function updatePointsView() {
            const data = loadData();
            const ps = data.pointSystem;
            
            // ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆ
            const pointsCurrent = document.getElementById('points-current');
            if (pointsCurrent) {
                pointsCurrent.textContent = ps.currentPoints.toLocaleString();
            }
            
            // ç´¯è¨ˆãƒã‚¤ãƒ³ãƒˆ
            const pointsLifetime = document.getElementById('points-lifetime');
            if (pointsLifetime) {
                pointsLifetime.textContent = ps.lifetimeEarned.toLocaleString();
            }
            
            // ãƒ¬ãƒ™ãƒ«
            const levelInfo = calculateLevel(ps.lifetimeEarned);
            const pointsLevel = document.getElementById('points-level');
            const pointsLevelName = document.getElementById('points-level-name');
            if (pointsLevel) {
                pointsLevel.textContent = `Lv.${levelInfo.level}`;
            }
            if (pointsLevelName) {
                pointsLevelName.textContent = levelInfo.name;
            }
        }
        
        // å ±é…¬ã‚¿ãƒ–ã‚’è¡¨ç¤º
        function showRewardsTab() {
            document.getElementById('rewards-tab-content').style.display = 'block';
            document.getElementById('history-tab-content').style.display = 'none';
            document.getElementById('create-tab-content').style.display = 'none';
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('rewards-tab').style.background = 'var(--primary)';
            document.getElementById('rewards-tab').style.color = 'white';
            document.getElementById('history-tab').style.background = '';
            document.getElementById('history-tab').style.color = '';
            document.getElementById('create-tab').style.background = '';
            document.getElementById('create-tab').style.color = '';
            
            updateRewardsList();
        }
        
        // å±¥æ­´ã‚¿ãƒ–ã‚’è¡¨ç¤º
        function showHistoryTab() {
            document.getElementById('rewards-tab-content').style.display = 'none';
            document.getElementById('history-tab-content').style.display = 'block';
            document.getElementById('create-tab-content').style.display = 'none';
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('rewards-tab').style.background = '';
            document.getElementById('rewards-tab').style.color = '';
            document.getElementById('history-tab').style.background = 'var(--primary)';
            document.getElementById('history-tab').style.color = 'white';
            document.getElementById('create-tab').style.background = '';
            document.getElementById('create-tab').style.color = '';
            
            updatePointsHistory();
        }
        
        // ä½œæˆã‚¿ãƒ–ã‚’è¡¨ç¤º
        function showCreateTab() {
            document.getElementById('rewards-tab-content').style.display = 'none';
            document.getElementById('history-tab-content').style.display = 'none';
            document.getElementById('create-tab-content').style.display = 'block';
            
            // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('rewards-tab').style.background = '';
            document.getElementById('rewards-tab').style.color = '';
            document.getElementById('history-tab').style.background = '';
            document.getElementById('history-tab').style.color = '';
            document.getElementById('create-tab').style.background = 'var(--primary)';
            document.getElementById('create-tab').style.color = 'white';
        }
        
        // å ±é…¬ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateRewardsList() {
            const data = loadData();
            const rewardsList = document.getElementById('rewards-list');
            if (!rewardsList) return;
            
            // çµ±è¨ˆã‚’æ›´æ–°
            updateRewardsStatistics();
            
            if (!data.pointSystem.customRewards || data.pointSystem.customRewards.length === 0) {
                rewardsList.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); padding: 40px;">
                        å ±é…¬ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“<br>
                        ã€Œâ• ä½œæˆã€ã‚¿ãƒ–ã‹ã‚‰å ±é…¬ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
                    </div>
                `;
                return;
            }
            
            // å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
            rewardsList.innerHTML = data.pointSystem.customRewards
                .filter(r => !r.isArchived)
                .sort((a, b) => {
                    if (a.isFavorite && !b.isFavorite) return -1;
                    if (!a.isFavorite && b.isFavorite) return 1;
                    return a.cost - b.cost;
                })
                .map(reward => {
                    const canAfford = data.pointSystem.currentPoints >= reward.cost;
                    return `
                        <div style="
                            background: ${canAfford ? 'var(--surface)' : 'rgba(51, 65, 85, 0.3)'};
                            padding: 16px;
                            border-radius: 12px;
                            border: 1px solid ${canAfford ? 'var(--border)' : 'rgba(255,255,255,0.05)'};
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            opacity: ${canAfford ? '1' : '0.6'};
                        ">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-size: 24px;">${reward.emoji || 'ğŸ'}</span>
                                <div>
                                    <div style="font-weight: bold; font-size: 16px; margin-bottom: 4px;">${escapeHTML(reward.name)}</div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        ${escapeHTML(reward.category)} ${reward.memo ? 'â€¢ ' + escapeHTML(reward.memo) : ''}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 4px;">
                                        ä½¿ç”¨å›æ•°: ${reward.timesUsed || 0}å›
                                    </div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="font-size: 18px; font-weight: bold; color: ${canAfford ? '#fbbf24' : 'var(--text-secondary)'};">
                                        ${reward.cost}pt
                                    </div>
                                    ${canAfford ? `
                                        <button class="btn btn-secondary" onclick="useReward('${reward.id}')" style="padding: 8px 16px; font-size: 14px;">
                                            ä½¿ç”¨
                                        </button>
                                    ` : `
                                        <span style="font-size: 10px; color: var(--text-secondary);">ä¸è¶³</span>
                                    `}
                                </div>
                                <button onclick="showRewardMenu(event, '${reward.id}')" style="
                                    background: var(--surface-light);
                                    border: 1px solid var(--border);
                                    border-radius: 8px;
                                    color: var(--text);
                                    cursor: pointer;
                                    padding: 12px;
                                    font-size: 20px;
                                    width: 44px;
                                    height: 44px;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    transition: all 0.2s;
                                    flex-shrink: 0;
                                " onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background='var(--surface-light)'">
                                    â‹®
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
        }
        
        // å±¥æ­´ã‚’æ›´æ–°
        function updatePointsHistory() {
            const data = loadData();
            const historyEl = document.getElementById('points-history');
            if (!historyEl) return;
            
            if (!data.pointSystem.transactions || data.pointSystem.transactions.length === 0) {
                historyEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">å–å¼•å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            historyEl.innerHTML = data.pointSystem.transactions.map(t => {
                const date = new Date(t.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const icon = t.type === 'earn' ? 'â•' : 'â–';
                const color = t.type === 'earn' ? '#10b981' : '#ef4444';
                const amount = t.type === 'earn' ? (t.finalAmount || t.amount) : t.amount;
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        padding: 12px;
                        background: var(--surface);
                        border-radius: 8px;
                        border: 1px solid var(--border);
                    ">
                        <div>
                            <div style="font-weight: bold;">${icon} ${escapeHTML(t.description)}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${dateStr}</div>
                        </div>
                        <div style="font-size: 20px; font-weight: bold; color: ${color};">
                            ${t.type === 'earn' ? '+' : '-'}${amount}pt
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // å ±é…¬ã‚’ä½œæˆ
        function createReward(event) {
            event.preventDefault();
            
            const name = document.getElementById('reward-name').value;
            const cost = parseInt(document.getElementById('reward-cost').value);
            const emoji = document.getElementById('reward-emoji').value || 'ğŸ';
            const category = document.getElementById('reward-category').value;
            const memo = document.getElementById('reward-memo').value;
            
            const data = loadData();
            
            // æ–°ã—ã„å ±é…¬ã‚’è¿½åŠ 
            const newReward = {
                id: 'reward_' + Date.now(),
                name: name,
                cost: cost,
                emoji: emoji,
                category: category,
                memo: memo,
                timesUsed: 0,
                isFavorite: false,
                isArchived: false,
                createdAt: new Date().toISOString()
            };
            
            if (!data.pointSystem.customRewards) {
                data.pointSystem.customRewards = [];
            }
            data.pointSystem.customRewards.push(newReward);
            
            saveData(data);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('reward-name').value = '';
            document.getElementById('reward-cost').value = '';
            document.getElementById('reward-emoji').value = '';
            document.getElementById('reward-memo').value = '';
            
            // å ±é…¬ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
            showRewardsTab();
            
            showNotification('âœ¨ å ±é…¬ã‚’ä½œæˆã—ã¾ã—ãŸï¼', 'success');
        }
        
        // å ±é…¬çµ±è¨ˆã‚’æ›´æ–°
        function updateRewardsStatistics() {
            const data = loadData();
            const rewards = data.pointSystem.customRewards || [];
            
            // åŸºæœ¬çµ±è¨ˆ
            const totalCount = rewards.filter(r => !r.isArchived).length;
            const countEl = document.getElementById('total-rewards-count');
            if (countEl) countEl.textContent = totalCount;
            
            const totalUsed = rewards.reduce((sum, r) => sum + (r.timesUsed || 0), 0);
            const usedEl = document.getElementById('total-rewards-used');
            if (usedEl) usedEl.textContent = totalUsed;
            
            const totalSpent = rewards.reduce((sum, r) => sum + (r.cost * (r.timesUsed || 0)), 0);
            const spentEl = document.getElementById('total-rewards-spent');
            if (spentEl) spentEl.textContent = totalSpent + 'pt';
            
            // è©³ç´°çµ±è¨ˆã‚’æ›´æ–°
            updateDetailedRewardStatistics();
        }
        
        // è©³ç´°çµ±è¨ˆãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        window.toggleRewardStatistics = function() {
            const panel = document.getElementById('reward-statistics-panel');
            const btn = document.getElementById('toggle-reward-stats-btn');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.textContent = 'ğŸ“Š çµ±è¨ˆã‚’éš ã™';
                updateDetailedRewardStatistics();
            } else {
                panel.style.display = 'none';
                btn.textContent = 'ğŸ“Š è©³ç´°çµ±è¨ˆã‚’è¦‹ã‚‹';
            }
        }
        
        // çµ±è¨ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«é–¢æ•°
        window.toggleStatSection = function(sectionId) {
            const content = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId + '-arrow');
            
            if (!content) return;
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                if (arrow) arrow.textContent = 'â–¼';
            } else {
                content.style.display = 'none';
                if (arrow) arrow.textContent = 'â–¶';
            }
        }
        
        // è©³ç´°ãªå ±é…¬çµ±è¨ˆã‚’æ›´æ–°
        function updateDetailedRewardStatistics() {
            const data = loadData();
            const rewards = data.pointSystem.customRewards || [];
            const transactions = data.pointSystem.transactions || [];
            
            // äººæ°—å ±é…¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°
            updatePopularRewards(rewards);
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥çµ±è¨ˆ
            updateCategoryStatistics(rewards);
            
            // æ™‚é–“å¸¯åˆ¥ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
            updateRewardTimePattern(transactions.filter(t => t.type === 'spend'));
            
            // ã‚³ã‚¹ãƒˆåˆ†æ
            updateCostAnalysis(rewards);
            
            // æœ€è¿‘ä½¿ç”¨ã—ãŸå ±é…¬
            updateRecentUsedRewards(transactions.filter(t => t.type === 'spend'));
        }
        
        // äººæ°—å ±é…¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
        function updatePopularRewards(rewards) {
            const el = document.getElementById('popular-rewards');
            if (!el) return;
            
            const sortedRewards = rewards
                .filter(r => !r.isArchived && r.timesUsed > 0)
                .sort((a, b) => (b.timesUsed || 0) - (a.timesUsed || 0))
                .slice(0, 5);
            
            if (sortedRewards.length === 0) {
                el.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">ã¾ã ä½¿ç”¨ã•ã‚ŒãŸå ±é…¬ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            el.innerHTML = sortedRewards.map((reward, index) => {
                const rank = index + 1;
                const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : `${rank}.`;
                const usageRate = rewards.filter(r => !r.isArchived).length > 0 ? 
                    Math.round((reward.timesUsed || 0) / rewards.reduce((sum, r) => sum + (r.timesUsed || 0), 0) * 100) : 0;
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background: ${rank === 1 ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1))' : 'rgba(0,0,0,0.2)'};
                        border-radius: 8px;
                        ${rank === 1 ? 'border: 1px solid rgba(251, 191, 36, 0.3);' : ''}
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">${rankEmoji}</span>
                            <div>
                                <div style="font-weight: bold;">${reward.emoji} ${escapeHTML(reward.name)}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    ${reward.cost}pt â€¢ ${reward.timesUsed}å›ä½¿ç”¨ (${usageRate}%)
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: bold; color: #ef4444;">
                                ${reward.cost * (reward.timesUsed || 0)}pt
                            </div>
                            <div style="font-size: 10px; color: var(--text-secondary);">ç·æ¶ˆè²»</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥çµ±è¨ˆã‚’æ›´æ–°
        function updateCategoryStatistics(rewards) {
            const el = document.getElementById('category-statistics');
            if (!el) return;
            
            const categories = {};
            rewards.filter(r => !r.isArchived).forEach(reward => {
                const category = reward.category || 'ãã®ä»–';
                if (!categories[category]) {
                    categories[category] = {
                        count: 0,
                        timesUsed: 0,
                        totalSpent: 0,
                        avgCost: 0
                    };
                }
                categories[category].count++;
                categories[category].timesUsed += reward.timesUsed || 0;
                categories[category].totalSpent += (reward.timesUsed || 0) * reward.cost;
                categories[category].avgCost += reward.cost;
            });
            
            // å¹³å‡ã‚³ã‚¹ãƒˆã‚’è¨ˆç®—
            Object.keys(categories).forEach(cat => {
                if (categories[cat].count > 0) {
                    categories[cat].avgCost = Math.round(categories[cat].avgCost / categories[cat].count);
                }
            });
            
            const categoryEmojis = {
                'ä¼‘æ†©': 'ğŸµ',
                'å¨¯æ¥½': 'ğŸ®',
                'é£Ÿäº‹': 'ğŸ°',
                'è²·ã„ç‰©': 'ğŸ›ï¸',
                'ä½“é¨“': 'ğŸ­',
                'è‡ªç”±æ™‚é–“': 'â°',
                'ãã®ä»–': 'ğŸ“¦'
            };
            
            const sortedCategories = Object.entries(categories)
                .sort((a, b) => b[1].timesUsed - a[1].timesUsed);
            
            if (sortedCategories.length === 0) {
                el.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            el.innerHTML = sortedCategories.map(([category, stats]) => `
                <div style="
                    padding: 12px;
                    background: rgba(0,0,0,0.2);
                    border-radius: 8px;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="font-weight: bold; font-size: 16px;">
                            ${categoryEmojis[category] || 'ğŸ“¦'} ${category}
                        </span>
                        <span style="color: var(--text-secondary); font-size: 12px;">
                            ${stats.count}å€‹
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px;">
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #fbbf24;">${stats.timesUsed}</div>
                            <div style="color: var(--text-secondary);">ä½¿ç”¨å›æ•°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #ef4444;">${stats.totalSpent}pt</div>
                            <div style="color: var(--text-secondary);">ç·æ¶ˆè²»</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-weight: bold; color: #10b981;">${stats.avgCost}pt</div>
                            <div style="color: var(--text-secondary);">å¹³å‡ã‚³ã‚¹ãƒˆ</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // æ™‚é–“å¸¯åˆ¥ä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ›´æ–°
        function updateRewardTimePattern(spendTransactions) {
            const el = document.getElementById('reward-time-pattern');
            if (!el) return;
            
            const timeSlots = {
                'æ—©æœ': { hours: [4, 5, 6, 7], count: 0, emoji: 'ğŸŒ…' },
                'æœ': { hours: [8, 9, 10, 11], count: 0, emoji: 'â˜€ï¸' },
                'æ˜¼': { hours: [12, 13, 14, 15], count: 0, emoji: 'ğŸŒ' },
                'å¤•æ–¹': { hours: [16, 17, 18, 19], count: 0, emoji: 'ğŸŒ†' },
                'å¤œ': { hours: [20, 21, 22, 23], count: 0, emoji: 'ğŸŒ™' },
                'æ·±å¤œ': { hours: [0, 1, 2, 3], count: 0, emoji: 'ğŸŒ›' }
            };
            
            spendTransactions.forEach(t => {
                const hour = new Date(t.timestamp).getHours();
                Object.entries(timeSlots).forEach(([name, slot]) => {
                    if (slot.hours.includes(hour)) {
                        slot.count++;
                    }
                });
            });
            
            const maxCount = Math.max(...Object.values(timeSlots).map(s => s.count), 1);
            
            el.innerHTML = Object.entries(timeSlots).map(([name, stats]) => {
                const heightPercent = (stats.count / maxCount) * 100;
                const isActive = stats.count > 0;
                
                return `
                    <div style="text-align: center;">
                        <div style="font-size: 20px; margin-bottom: 4px;">${stats.emoji}</div>
                        <div style="
                            position: relative;
                            height: 60px;
                            display: flex;
                            align-items: flex-end;
                            margin-bottom: 4px;
                        ">
                            <div style="
                                width: 100%;
                                height: ${heightPercent}%;
                                background: ${isActive ? 'linear-gradient(to top, #8b5cf6, #ec4899)' : 'rgba(0,0,0,0.2)'};
                                border-radius: 4px 4px 0 0;
                                transition: all 0.3s;
                            "></div>
                        </div>
                        <div style="font-size: 10px; font-weight: bold;">${name}</div>
                        <div style="font-size: 9px; color: var(--text-secondary);">${stats.count}å›</div>
                    </div>
                `;
            }).join('');
        }
        
        // ã‚³ã‚¹ãƒˆåˆ†æã‚’æ›´æ–°
        function updateCostAnalysis(rewards) {
            const el = document.getElementById('cost-analysis');
            if (!el) return;
            
            const activeRewards = rewards.filter(r => !r.isArchived);
            if (activeRewards.length === 0) {
                el.innerHTML = '<div style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1;">å ±é…¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            const costs = activeRewards.map(r => r.cost);
            const avgCost = Math.round(costs.reduce((a, b) => a + b, 0) / costs.length);
            const minCost = Math.min(...costs);
            const maxCost = Math.max(...costs);
            const medianCost = costs.sort((a, b) => a - b)[Math.floor(costs.length / 2)];
            
            // ã‚³ã‚¹ãƒˆåŠ¹ç‡ï¼ˆä½¿ç”¨å›æ•°/ã‚³ã‚¹ãƒˆï¼‰
            const efficiency = activeRewards
                .filter(r => r.timesUsed > 0)
                .map(r => ({
                    name: r.name,
                    emoji: r.emoji,
                    efficiency: (r.timesUsed || 0) / r.cost,
                    cost: r.cost,
                    timesUsed: r.timesUsed
                }))
                .sort((a, b) => b.efficiency - a.efficiency)
                .slice(0, 3);
            
            el.innerHTML = `
                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #fbbf24;">${avgCost}pt</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">å¹³å‡ã‚³ã‚¹ãƒˆ</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${medianCost}pt</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">ä¸­å¤®å€¤</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #10b981;">${minCost}pt</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">æœ€å°</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 20px; font-weight: bold; color: #ef4444;">${maxCost}pt</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">æœ€å¤§</div>
                        </div>
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px;">
                    <div style="font-weight: bold; margin-bottom: 8px; font-size: 14px;">ğŸ’ ã‚³ã‚¹ãƒ‘æœ€å¼·TOP3</div>
                    ${efficiency.length > 0 ? efficiency.map((r, i) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; ${i < efficiency.length - 1 ? 'border-bottom: 1px solid rgba(255,255,255,0.1);' : ''}">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span>${r.emoji}</span>
                                <span style="font-size: 12px;">${escapeHTML(r.name)}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 12px; font-weight: bold; color: #10b981;">
                                    ${(r.efficiency * 100).toFixed(1)}%
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ${r.timesUsed}å›/${r.cost}pt
                                </div>
                            </div>
                        </div>
                    `).join('') : '<div style="color: var(--text-secondary); text-align: center; font-size: 12px;">ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
                </div>
            `;
        }
        
        // æœ€è¿‘ä½¿ç”¨ã—ãŸå ±é…¬ã‚’æ›´æ–°
        function updateRecentUsedRewards(spendTransactions) {
            const el = document.getElementById('recent-used-rewards');
            if (!el) return;
            
            const recent = spendTransactions
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            if (recent.length === 0) {
                el.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">ã¾ã å ±é…¬ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            el.innerHTML = recent.map(t => {
                const date = new Date(t.timestamp);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const timeDiff = Date.now() - date.getTime();
                const hoursAgo = Math.floor(timeDiff / (1000 * 60 * 60));
                const daysAgo = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                const timeAgo = daysAgo > 0 ? `${daysAgo}æ—¥å‰` : hoursAgo > 0 ? `${hoursAgo}æ™‚é–“å‰` : 'ä»Šæ—¥';
                
                return `
                    <div style="
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 8px;
                        background: rgba(0,0,0,0.2);
                        border-radius: 8px;
                    ">
                        <div>
                            <div style="font-weight: bold; font-size: 14px;">${escapeHTML(t.description)}</div>
                            <div style="font-size: 11px; color: var(--text-secondary);">${dateStr} (${timeAgo})</div>
                        </div>
                        <div style="font-size: 16px; font-weight: bold; color: #ef4444;">-${t.amount}pt</div>
                    </div>
                `;
            }).join('');
        }
        
        // å ±é…¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showRewardMenu(event, rewardId) {
            event.stopPropagation();
            event.preventDefault();
            
            // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å‰Šé™¤
            const existingMenu = document.querySelector('.reward-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä½œæˆ
            const menu = document.createElement('div');
            menu.className = 'reward-menu';
            
            // ãƒœã‚¿ãƒ³ã®ä½ç½®ã‚’å–å¾—
            const button = event.currentTarget;
            const rect = button.getBoundingClientRect();
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆãƒœã‚¿ãƒ³ã®ä¸‹ã«è¡¨ç¤ºï¼‰
            const menuTop = rect.bottom + 8;
            const menuLeft = Math.max(8, rect.right - 180); // å³å¯„ã›ã§è¡¨ç¤º
            
            menu.style.cssText = `
                position: fixed;
                left: ${menuLeft}px;
                top: ${menuTop}px;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: 12px;
                padding: 8px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.4);
                z-index: 10000;
                min-width: 160px;
            `;
            
            menu.innerHTML = `
                <div onclick="window.editReward('${rewardId}'); this.parentElement.remove();" style="
                    padding: 12px 16px;
                    cursor: pointer;
                    border-radius: 8px;
                    transition: background 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 16px;
                " onmouseover="this.style.background='var(--surface-hover)'" onmouseout="this.style.background='transparent'">
                    âœï¸ ç·¨é›†
                </div>
                <div onclick="window.deleteReward('${rewardId}'); this.parentElement.remove();" style="
                    padding: 12px 16px;
                    cursor: pointer;
                    border-radius: 8px;
                    color: #ef4444;
                    transition: background 0.2s;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 16px;
                " onmouseover="this.style.background='rgba(239, 68, 68, 0.1)'" onmouseout="this.style.background='transparent'">
                    ğŸ—‘ï¸ å‰Šé™¤
                </div>
            `;
            
            document.body.appendChild(menu);
            
            // ç”»é¢å¤–ã«ã¯ã¿å‡ºã™å ´åˆã¯ä½ç½®ã‚’èª¿æ•´
            const menuRect = menu.getBoundingClientRect();
            if (menuRect.bottom > window.innerHeight) {
                menu.style.top = (rect.top - menuRect.height - 8) + 'px';
            }
            if (menuRect.right > window.innerWidth) {
                menu.style.left = (window.innerWidth - menuRect.width - 8) + 'px';
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 100);
        }
        
        // å ±é…¬ã‚’ç·¨é›†
        window.editReward = function(rewardId) {
            const data = loadData();
            const reward = data.pointSystem.customRewards.find(r => r.id === rewardId);
            if (!reward) return;
            
            // å€¤ã‚’äº‹å‰ã«ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
            const escapedName = escapeHTML(reward.name);
            const escapedEmoji = reward.emoji || '';
            const escapedMemo = escapeHTML(reward.memo || '');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const modal = document.createElement('div');
            modal.className = 'overlay active';
            modal.innerHTML = `
                <div style="
                        background: var(--surface);
                        border-radius: 24px;
                        padding: 32px;
                        max-width: 400px;
                        width: 100%;
                        max-height: 90vh;
                        overflow-y: auto;
                        border: 1px solid var(--border);
                        position: relative;
                    ">
                    <div class="modal-header">
                        <h2>å ±é…¬ã‚’ç·¨é›†</h2>
                        <button class="close-btn" onclick="this.closest('.overlay').remove()">Ã—</button>
                    </div>
                    <div class="modal-body">
                        <form onsubmit="window.saveEditedReward(event, '${rewardId}'); return false;" style="display: grid; gap: 16px;">
                            <div class="form-group">
                                <label for="edit-reward-name">å ±é…¬ã®åå‰</label>
                                <input type="text" id="edit-reward-name" value="${escapedName}" required autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-reward-cost">å¿…è¦ãƒã‚¤ãƒ³ãƒˆ</label>
                                <input type="number" id="edit-reward-cost" value="${reward.cost}" required min="1" max="999" autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-reward-emoji">ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰</label>
                                <input type="text" id="edit-reward-emoji" value="${escapedEmoji}" maxlength="2" autocomplete="off">
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-reward-category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
                                <select id="edit-reward-category">
                                    <option value="ä¼‘æ†©" ${reward.category === 'ä¼‘æ†©' ? 'selected' : ''}>ğŸµ ä¼‘æ†©</option>
                                    <option value="å¨¯æ¥½" ${reward.category === 'å¨¯æ¥½' ? 'selected' : ''}>ğŸ® å¨¯æ¥½</option>
                                    <option value="é£Ÿäº‹" ${reward.category === 'é£Ÿäº‹' ? 'selected' : ''}>ğŸ° é£Ÿäº‹</option>
                                    <option value="è²·ã„ç‰©" ${reward.category === 'è²·ã„ç‰©' ? 'selected' : ''}>ğŸ›ï¸ è²·ã„ç‰©</option>
                                    <option value="ä½“é¨“" ${reward.category === 'ä½“é¨“' ? 'selected' : ''}>ğŸ­ ä½“é¨“</option>
                                    <option value="è‡ªç”±æ™‚é–“" ${reward.category === 'è‡ªç”±æ™‚é–“' ? 'selected' : ''}>â° è‡ªç”±æ™‚é–“</option>
                                    <option value="ãã®ä»–" ${reward.category === 'ãã®ä»–' ? 'selected' : ''}>ğŸ“¦ ãã®ä»–</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-reward-memo">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
                                <textarea id="edit-reward-memo" autocomplete="off">${escapedMemo}</textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" style="width: 100%;">
                                ğŸ’¾ ä¿å­˜
                            </button>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ç·¨é›†ã—ãŸå ±é…¬ã‚’ä¿å­˜
        window.saveEditedReward = function(event, rewardId) {
            event.preventDefault();
            
            const data = loadData();
            const rewardIndex = data.pointSystem.customRewards.findIndex(r => r.id === rewardId);
            if (rewardIndex === -1) return;
            
            const reward = data.pointSystem.customRewards[rewardIndex];
            
            // æ›´æ–°
            reward.name = document.getElementById('edit-reward-name').value.trim();
            reward.cost = parseInt(document.getElementById('edit-reward-cost').value);
            reward.emoji = document.getElementById('edit-reward-emoji').value.trim() || 'ğŸ';
            reward.category = document.getElementById('edit-reward-category').value;
            reward.memo = document.getElementById('edit-reward-memo').value.trim();
            
            saveData(data);
            updateRewardsList();
            updateRewardsStatistics();
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const overlay = event.target.closest('.overlay');
            if (overlay) {
                overlay.remove();
            }
            
            showNotification('âœ… å ±é…¬ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }
        
        // å ±é…¬ã‚’å‰Šé™¤
        window.deleteReward = function(rewardId) {
            if (!confirm('ã“ã®å ±é…¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            const data = loadData();
            const rewardIndex = data.pointSystem.customRewards.findIndex(r => r.id === rewardId);
            if (rewardIndex === -1) return;
            
            // å‰Šé™¤
            data.pointSystem.customRewards.splice(rewardIndex, 1);
            
            saveData(data);
            updateRewardsList();
            
            showNotification('ğŸ—‘ï¸ å ±é…¬ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        }
        
        // å ±é…¬ã‚’ä½¿ç”¨
        function useReward(rewardId) {
            const data = loadData();
            const reward = data.pointSystem.customRewards.find(r => r.id === rewardId);
            
            if (!reward) return;
            
            if (data.pointSystem.currentPoints < reward.cost) {
                showNotification('ãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
                return;
            }
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`ã€Œ${reward.name}ã€ã‚’ ${reward.cost}pt ã§ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            // ãƒã‚¤ãƒ³ãƒˆã‚’æ¶ˆè²»
            if (spendPoints(reward.cost, reward.name)) {
                // ä½¿ç”¨å›æ•°ã‚’å¢—ã‚„ã™
                reward.timesUsed = (reward.timesUsed || 0) + 1;
                
                const updatedData = loadData();
                const rewardIndex = updatedData.pointSystem.customRewards.findIndex(r => r.id === rewardId);
                if (rewardIndex !== -1) {
                    updatedData.pointSystem.customRewards[rewardIndex] = reward;
                    saveData(updatedData);
                }
                
                showNotification(`ğŸ‰ ã€Œ${reward.name}ã€ã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼`, 'success');
                updatePointsView();
                updateRewardsList();
            }
        }
        
        // å ±é…¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒˆã‚°ãƒ«ï¼ˆãŠæ°—ã«å…¥ã‚Šã€ç·¨é›†ã€å‰Šé™¤ãªã©ï¼‰
        function toggleRewardMenu(rewardId) {
            // ç°¡å˜ãªå®Ÿè£…ã¨ã—ã¦å‰Šé™¤ã®ã¿
            if (confirm('ã“ã®å ±é…¬ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const data = loadData();
                data.pointSystem.customRewards = data.pointSystem.customRewards.filter(r => r.id !== rewardId);
                saveData(data);
                updateRewardsList();
                showNotification('å ±é…¬ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
            }
        }

        // ========== ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ é–¢é€£ã®é–¢æ•°ã“ã“ã¾ã§ ==========

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        function updateNavigation(activeView) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeBtn = document.querySelector(`[data-view="${activeView}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // ãƒšãƒ¼ã‚¸ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
            const viewIndex = views.indexOf(activeView);
            if (viewIndex !== -1) {
                document.querySelectorAll('.dot').forEach((dot, index) => {
                    if (index === viewIndex) {
                        dot.style.background = 'var(--primary)';
                        dot.style.width = '8px';
                        dot.style.height = '8px';
                    } else {
                        dot.style.background = 'var(--surface-light)';
                        dot.style.width = '6px';
                        dot.style.height = '6px';
                    }
                });
            }
        }

        // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤º
        function showHomeView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'block';
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('points-view').style.display = 'none';
            document.getElementById('cards-view').style.display = 'none';
            
            updateNavigation('home');
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateCategoryDropdowns();
            
            // ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å¾©å…ƒ
            const savedCategory = localStorage.getItem('selectedCategory') || 'all';
            const categoryFilter = document.getElementById('category-filter');
            if (categoryFilter) {
                categoryFilter.value = savedCategory;
            }
            
            updateCurrentHypothesisList();
            updatePerfectBonusIndicator();
            updatePenaltyIndicators();
            updateChallenges();
            updateJournalStatus();  // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            
            // ãƒ›ãƒ¼ãƒ ç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’å†è¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'flex';
            }

            // å‰å›ãƒ‡ãƒ–ãƒªãƒ¼ãƒ•ã®ãƒŸãƒ‹ãƒãƒŠãƒ¼
            const data = loadData();
            const home = document.getElementById('home-view');
            let banner = document.getElementById('last-debrief-banner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'last-debrief-banner';
                banner.style.cssText = 'margin:12px 0;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);color:var(--text-secondary);';
                home.insertBefore(banner, home.firstChild);
            }
            if (data.meta && data.meta.lastDebrief) {
                const d = data.meta.lastDebrief;
                const dt = new Date(d.at).toLocaleDateString('ja-JP');
                banner.innerHTML = `ğŸ“ å‰å›ã®æ°—ã¥ãï¼ˆ${dt} / æº€è¶³åº¦${d.score}/5ï¼‰: <span style=\"color:var(--text-primary)\">${(d.note||'').replace(/</g,'&lt;')}</span>`;
                banner.style.display = 'block';
            } else {
                banner.style.display = 'none';
            }
        }
        
        // ç¿’æ…£ã®ä¼‘çœ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function toggleSleepMode() {
            const data = loadData();
            const hyp = data.currentHypotheses.find(h => h.id === window.currentHypothesis.id);
            
            if (!hyp) return;
            
            if (hyp.isSleeping) {
                // ä¼‘çœ è§£é™¤
                hyp.isSleeping = false;
                hyp.sleepEndDate = new Date().toISOString();
                
                // ä¼‘çœ æœŸé–“ã‚’è¨˜éŒ²ï¼ˆçµ±è¨ˆç”¨ï¼‰
                if (!hyp.sleepHistory) hyp.sleepHistory = [];
                hyp.sleepHistory.push({
                    startDate: hyp.sleepStartDate,
                    endDate: hyp.sleepEndDate,
                    duration: Math.floor((new Date(hyp.sleepEndDate) - new Date(hyp.sleepStartDate)) / (1000 * 60 * 60 * 24))
                });
                
                delete hyp.sleepStartDate;
                delete hyp.sleepEndDate;
                
                showNotification('ğŸŒ… ç¿’æ…£ã‚’å†é–‹ã—ã¾ã—ãŸï¼', 'success');
            } else {
                // ä¼‘çœ é–‹å§‹
                if (confirm('ã“ã®ç¿’æ…£ã‚’ä¼‘çœ ã•ã›ã¾ã™ã‹ï¼Ÿ\n\nä¼‘çœ ä¸­ã¯ï¼š\nâ€¢ é”æˆç‡ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¯ä¿æŒã•ã‚Œã¾ã™\nâ€¢ ã„ã¤ã§ã‚‚å†é–‹ã§ãã¾ã™')) {
                    hyp.isSleeping = true;
                    hyp.sleepStartDate = new Date().toISOString();
                    
                    showNotification('ğŸ˜´ ç¿’æ…£ã‚’ä¼‘çœ ã•ã›ã¾ã—ãŸ', 'info');
                }
            }
            
            saveData(data);
            window.currentHypothesis = hyp;
            showProgressView(hyp.id);
        }

        // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updatePenaltyIndicators() {
            // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
            document.querySelectorAll('.penalty-indicator').forEach(el => el.remove());
            
            let indicatorTop = 130; // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã®ä¸‹ã‹ã‚‰é–‹å§‹
            
            // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰
            if (window.currentHypothesis && window.currentHypothesis.hardMode) {
                const indicator = document.createElement('div');
                indicator.className = 'penalty-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: ${indicatorTop}px;
                    right: 20px;
                    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 16px;
                    font-weight: 600;
                    font-size: 14px;
                    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
                    animation: pulse 2s infinite;
                    z-index: 100;
                `;
                indicator.innerHTML = 'âš¡ ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼ˆ90%ä»¥ä¸Šå¿…è¦ï¼‰';
                document.body.appendChild(indicator);
                indicatorTop += 50;
            }
            
            // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯
            if (window.currentHypothesis && window.currentHypothesis.resetRisk) {
                const indicator = document.createElement('div');
                indicator.className = 'penalty-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: ${indicatorTop}px;
                    right: 20px;
                    background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 16px;
                    font-weight: 600;
                    font-size: 14px;
                    box-shadow: 0 4px 20px rgba(220, 38, 38, 0.3);
                    animation: pulse 2s infinite;
                    z-index: 100;
                `;
                indicator.innerHTML = 'ğŸ”„ ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯é©ç”¨ä¸­';
                document.body.appendChild(indicator);
                indicatorTop += 50;
            }
            
            // é”æˆç‡æ¸›å°‘
            if (window.currentHypothesis && window.currentHypothesis.achievementDecrease) {
                const indicator = document.createElement('div');
                indicator.className = 'penalty-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: ${indicatorTop}px;
                    right: 20px;
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                    color: white;
                    padding: 8px 16px;
                    border-radius: 16px;
                    font-weight: 600;
                    font-size: 14px;
                    box-shadow: 0 4px 20px rgba(239, 68, 68, 0.3);
                    animation: pulse 2s infinite;
                    z-index: 100;
                `;
                indicator.innerHTML = `ğŸ“‰ é”æˆç‡-${window.currentHypothesis.achievementDecrease}%`;
                document.body.appendChild(indicator);
            }
        }
        
        // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
        function updatePerfectBonusIndicator() {
            const data = loadData();
            const hasActiveBonus = data.cards && data.cards.activeEffects && 
                data.cards.activeEffects.some(effect => effect.cardId === 'perfect_bonus');
            
            // æ—¢å­˜ã®ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’å‰Šé™¤
            const existingIndicator = document.getElementById('perfect-bonus-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }
            
            if (hasActiveBonus) {
                const indicator = document.createElement('div');
                indicator.id = 'perfect-bonus-indicator';
                indicator.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 20px;
                    font-weight: 600;
                    box-shadow: 0 4px 20px rgba(245, 158, 11, 0.3);
                    animation: pulse 2s infinite;
                    z-index: 100;
                `;
                indicator.innerHTML = 'ğŸ¯ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹é©ç”¨ä¸­';
                document.body.appendChild(indicator);
            }
        }

        // ã‚«ãƒ†ã‚´ãƒªã§ç¿’æ…£ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterHabitsByCategory() {
            const filter = document.getElementById('category-filter');
            if (filter) {
                // é¸æŠä¸­ã®ã‚«ãƒ†ã‚´ãƒªã‚’ä¿å­˜
                localStorage.setItem('selectedCategory', filter.value);
                // ç¿’æ…£ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                updateCurrentHypothesisList();
            }
        }
        window.filterHabitsByCategory = filterHabitsByCategory;
        
        // æ–°è¦ç¿’æ…£ä½œæˆç”»é¢ã‚’è¡¨ç¤º
        function showNewHypothesisView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('new-hypothesis-view').style.display = 'block';
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateCategoryDropdowns();
            
            // ãƒ›ãƒ¼ãƒ ç”»é¢ã§é¸æŠã—ã¦ã„ãŸã‚«ãƒ†ã‚´ãƒªã‚’è‡ªå‹•è¨­å®š
            const selectedCategory = localStorage.getItem('selectedCategory');
            const categorySelect = document.getElementById('hypothesis-category');
            if (selectedCategory && selectedCategory !== 'all' && categorySelect) {
                categorySelect.value = selectedCategory;
            }
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('points-view').style.display = 'none';
            document.getElementById('cards-view').style.display = 'none';
            
            updateNavigation('new');
            
            // æ–°è¦ä½œæˆç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’å†è¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'flex';
            }
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('hypothesis-title').value = '';
            document.getElementById('hypothesis-description').value = '';
            const benefitEl = document.getElementById('hypothesis-benefit');
            if (benefitEl) benefitEl.value = '';
            // å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            const titleInput = document.getElementById('hypothesis-title');
            if (titleInput) {
                setTimeout(() => titleInput.focus(), 0);
            }
            // IF-THENåˆæœŸè¡Œ
            const list = document.getElementById('ifthen-list');
            if (list) { list.innerHTML = ''; addIfThenRow(); }
            selectedDuration = null;
            document.querySelectorAll('.duration-option').forEach(opt => {
                opt.classList.remove('selected');
                opt.classList.remove('disabled');
                opt.style.opacity = '1';
                opt.onclick = function() { selectDuration(this.dataset.duration); };
            });
            
            // é–‹å§‹æ—¥ã‚’ä»Šæ—¥ã«ãƒªã‚»ãƒƒãƒˆ
            window.selectedStartDate = null;
            setStartDate('today');
            
            // çŸ­æœŸé›†ä¸­ãƒšãƒŠãƒ«ãƒ†ã‚£ãŒæœ‰åŠ¹ãªå ´åˆ
            if (window.shortTermOnly) {
                // ä¸­æœŸé–“ã¨é•·æœŸé–“ã‚’ç„¡åŠ¹åŒ–
                ['medium', 'long'].forEach(duration => {
                    const opt = document.querySelector(`[data-duration="${duration}"]`);
                    if (opt) {
                        opt.classList.add('disabled');
                        opt.style.opacity = '0.5';
                        opt.onclick = null;
                    }
                });
                
                // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showCardEffect('çŸ­æœŸé›†ä¸­ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨ä¸­ï¼', 'çŸ­æœŸé–“ï¼ˆ3-7æ—¥ï¼‰ã®ã¿é¸æŠå¯èƒ½ã§ã™', '#ef4444');
            }
            
            // é »åº¦è¨­å®šUIã®åˆæœŸåŒ–
            document.querySelectorAll('input[name="frequency"]').forEach(radio => {
                radio.checked = radio.value === 'daily';
            });
            document.getElementById('weekly-count').disabled = true;
            document.getElementById('weekdays-selector').style.display = 'none';
            document.querySelectorAll('input[name="weekday"]').forEach(cb => {
                cb.checked = false;
            });
            
            // é »åº¦è¨­å®šã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const freqRadios = document.querySelectorAll('input[name="frequency"]');
            freqRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const weeklyCount = document.getElementById('weekly-count');
                    const weekdaysSelector = document.getElementById('weekdays-selector');
                    
                    // ã™ã¹ã¦ç„¡åŠ¹åŒ–
                    weeklyCount.disabled = true;
                    weekdaysSelector.style.display = 'none';
                    
                    // é¸æŠã•ã‚ŒãŸã‚‚ã®ã ã‘æœ‰åŠ¹åŒ–
                    if (this.value === 'weekly') {
                        weeklyCount.disabled = false;
                        weeklyCount.focus();
                    } else if (this.value === 'weekdays') {
                        weekdaysSelector.style.display = 'block';
                    }
                    
                    // æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
                    updateDurationDisplay(this.value);
                });
            });
            
            // åˆæœŸçŠ¶æ…‹è¨­å®š
            document.getElementById('freq-daily').checked = true;
        }

        // é »åº¦ã«å¿œã˜ã¦æœŸé–“è¡¨ç¤ºã‚’æ›´æ–°
        function updateDurationDisplay(frequencyType) {
            const shortText = document.getElementById('duration-short-text');
            const mediumText = document.getElementById('duration-medium-text');
            const longText = document.getElementById('duration-long-text');
            
            if (!shortText || !mediumText || !longText) return;
            
            if (frequencyType === 'weekly' || frequencyType === 'weekdays') {
                // é€±å˜ä½ã§è¡¨ç¤º
                shortText.textContent = '2ã€œ4é€±é–“';
                mediumText.textContent = '5ã€œ7é€±é–“';
                longText.textContent = '8ã€œ10é€±é–“';
            } else {
                // æ—¥å˜ä½ã§è¡¨ç¤ºï¼ˆæ¯æ—¥ã®å ´åˆï¼‰
                shortText.textContent = '3ã€œ7æ—¥';
                mediumText.textContent = '8ã€œ14æ—¥';
                longText.textContent = '15ã€œ30æ—¥';
            }
        }
        
        // æ¤œè¨¼æœŸé–“ã‚’é¸æŠ
        function selectDuration(duration) {
            selectedDuration = duration;
            document.querySelectorAll('.duration-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-duration="${duration}"]`).classList.add('selected');
        }

        // æ–°è¦ä½œæˆãƒ•ã‚©ãƒ¼ãƒ : IF-THENè¡Œè¿½åŠ 
        function addIfThenRow() {
            const list = document.getElementById('ifthen-list');
            if (!list) return;
            const row = document.createElement('div');
            row.className = 'ifthen-row';
            row.style.cssText = 'display:flex; gap:8px; align-items:center;';
            row.innerHTML = `
                <input type="text" class="if-input" placeholder="ã‚‚ã—ï¼ˆä¾‹: æœã‚¢ãƒ©ãƒ¼ãƒ ãŒé³´ã£ãŸã‚‰ï¼‰" style="flex:1;" />
                <span style="color: var(--text-secondary);">â†’</span>
                <input type="text" class="then-input" placeholder="ãªã‚‰ï¼ˆä¾‹: 1åˆ†ã ã‘åº§ã‚‹ï¼‰" style="flex:1;" />
                <button type="button" class="btn btn-secondary" onclick="this.parentElement.remove()">å‰Šé™¤</button>
            `;
            list.appendChild(row);
        }

        // ç¿’æ…£ã‚’ä½œæˆ
        function createHypothesis(event) {
            event.preventDefault();
            
            // çŸ­æœŸé›†ä¸­ãƒšãƒŠãƒ«ãƒ†ã‚£ã®ãƒã‚§ãƒƒã‚¯
            if (window.shortTermOnly) {
                selectedDuration = 'short';
                window.shortTermOnly = false; // åŠ¹æœã‚’æ¶ˆè²»
            }
            
            if (!selectedDuration) {
                alert('æ¤œè¨¼æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            const title = document.getElementById('hypothesis-title').value.trim();
            const description = document.getElementById('hypothesis-description').value.trim();
            const category = document.getElementById('hypothesis-category').value;
            const benefit = (document.getElementById('hypothesis-benefit')?.value || '').trim();

            if (!title || !description) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨è©³ç´°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (title.length > 100) {
                alert('ã‚¿ã‚¤ãƒˆãƒ«ã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (description.length > 1000) {
                alert('è©³ç´°ã¯1000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (!benefit) {
                alert('æœã®1è¡Œå®£è¨€ï¼ˆæœŸå¾…ã™ã‚‹å¤‰åŒ–ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            // IF-THENåé›†
            const ifThen = [];
            document.querySelectorAll('#ifthen-list .ifthen-row').forEach(row => {
                const ifv = row.querySelector('.if-input')?.value.trim() || '';
                const thenv = row.querySelector('.then-input')?.value.trim() || '';
                if (ifv && thenv) {
                    ifThen.push({ id: Date.now().toString() + Math.random(), if: ifv, then: thenv });
                }
            });

            // é »åº¦è¨­å®šã‚’å–å¾—
            const frequencyType = document.querySelector('input[name="frequency"]:checked').value;
            let frequencyData = { type: frequencyType };
            
            if (frequencyType === 'weekly') {
                frequencyData.count = parseInt(document.getElementById('weekly-count').value);
            } else if (frequencyType === 'weekdays') {
                const selectedDays = [];
                document.querySelectorAll('input[name="weekday"]:checked').forEach(cb => {
                    selectedDays.push(parseInt(cb.value));
                });
                if (selectedDays.length === 0) {
                    alert('å°‘ãªãã¨ã‚‚1ã¤ã®æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                frequencyData.weekdays = selectedDays;
            }

            // é–‹å§‹æ—¥ã‚’å–å¾—ï¼ˆæœªé¸æŠã®å ´åˆã¯ä»Šæ—¥ï¼‰
            let startDate = window.selectedStartDate || new Date().toISOString().split('T')[0];
            
            currentHypothesis = {
                id: Date.now(),
                title: title,
                description: description,
                category: category,  // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ 
                duration: selectedDuration,
                startDate: startDate + 'T00:00:00.000Z',
                achievements: {},
                // ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœã‚’è¨˜éŒ²
                hardMode: window.hardModeActive || false,
                resetRisk: window.resetRiskActive || false,
                achievementDecrease: window.achievementDecrease || 0,
                shortTermOnly: window.shortTermOnly || false,
                benefit: benefit,
                ifThen: ifThen,
                frequency: frequencyData  // é »åº¦è¨­å®šã‚’è¿½åŠ 
            };
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆä¸€åº¦ä½¿ç”¨ã—ãŸã‚‰æ¶ˆãˆã‚‹ï¼‰
            window.hardModeActive = false;
            window.resetRiskActive = false;
            window.achievementDecrease = 0;
            // shortTermOnly ã¯ç¾ç¿’æ…£ã«å¼•ãç¶™ã„ã ãŸã‚ãƒªã‚»ãƒƒãƒˆ
            window.shortTermOnly = false;
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
            const data = loadData();
            if (data.cards.pendingPenalties.length > 0) {
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’é©ç”¨
                applyPenaltyCards();
            } else {
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”»é¢ã‚’è¡¨ç¤º
                showShuffleView();
            }
        }

        // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’é©ç”¨
        function applyPenaltyCards() {
            const data = loadData();
            
            // ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            let hasProtectShield = false;
            if (data.cards && data.cards.activeEffects) {
                const protectIndex = data.cards.activeEffects.findIndex(effect => 
                    effect.cardId === 'protect_shield'
                );
                if (protectIndex !== -1) {
                    hasProtectShield = true;
                    // ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ã‚’æ¶ˆè²»
                    data.cards.activeEffects.splice(protectIndex, 1);
                    saveData(data);
                    
                    showCardEffect('ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ç™ºå‹•ï¼', 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', '#10b981');
                    
                    // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                    data.cards.pendingPenalties = [];
                    saveData(data);
                    
                    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”»é¢ã‚’è¡¨ç¤º
                    setTimeout(() => showShuffleView(), 2000);
                    return;
                }
            }
            
            const penalties = [];
            
            // ã™ã¹ã¦ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’åé›†
            data.cards.pendingPenalties.forEach(penalty => {
                penalties.push(penalty.cardId);
            });
            
            if (penalties.length > 0) {
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content penalty-effect" style="text-align: center; max-width: 400px;">
                        <h2 style="color: #ef4444; margin-bottom: 24px;">âš ï¸ ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ç™ºå‹•ï¼</h2>
                        <div id="penalty-cards-display" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                        </div>
                        <button class="btn" onclick="continuePenaltyApply()">ç¢ºèª</button>
                    </div>
                `;
                document.body.appendChild(modal);
                
                const penaltyDisplay = document.getElementById('penalty-cards-display');
                
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã®åŠ¹æœã‚’è¨­å®š
                penalties.forEach(penaltyId => {
                    const card = CARD_MASTER[penaltyId];
                    if (card) {
                        const cardDiv = document.createElement('div');
                        cardDiv.className = 'card-item penalty';
                        cardDiv.style.margin = '0 auto';
                        cardDiv.style.maxWidth = '250px';
                        cardDiv.innerHTML = `
                            <div class="card-icon">${card.icon}</div>
                            <div class="card-name">${card.name}</div>
                            <div class="card-description">${card.description}</div>
                        `;
                        penaltyDisplay.appendChild(cardDiv);
                        
                        // ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœã‚’é©ç”¨
                        switch(penaltyId) {
                            case 'extension_card':
                                window.pendingExtension = 3;
                                break;
                            case 'hard_mode':
                                window.hardModeActive = true;
                                break;
                            case 'reset_risk':
                                window.resetRiskActive = true;
                                break;
                            case 'short_term':
                                window.shortTermOnly = true;
                                break;
                            case 'achievement_decrease':
                                window.achievementDecrease = 10;
                                break;
                            case 'event_seal':
                                // ã‚¤ãƒ™ãƒ³ãƒˆå°å°åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                                const sealStart = new Date();
                                const sealEnd = new Date();
                                sealEnd.setDate(sealEnd.getDate() + 3);
                                if (!data.cards.activeEffects) data.cards.activeEffects = [];
                                data.cards.activeEffects.push({
                                    type: 'event_seal',
                                    startDate: sealStart.toISOString(),
                                    endDate: sealEnd.toISOString()
                                });
                                saveData(data);
                                break;
                            case 'mission_overload':
                                // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã«2ã¤è¿½åŠ ï¼‰
                                window.additionalMissions = 2;
                                break;
                            case 'slowdown':
                                // ãƒã‚¤ãƒ³ãƒˆ0.5å€åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                                const slowStart = new Date();
                                const slowEnd = new Date();
                                slowEnd.setDate(slowEnd.getDate() + 3);
                                if (!data.cards.activeEffects) data.cards.activeEffects = [];
                                data.cards.activeEffects.push({
                                    type: 'slowdown',
                                    startDate: slowStart.toISOString(),
                                    endDate: slowEnd.toISOString()
                                });
                                saveData(data);
                                break;
                            case 'reverse_curse':
                                // é€†è»¢ã®å‘ªã„åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                                const curseStart = new Date();
                                const curseEnd = new Date();
                                curseEnd.setDate(curseEnd.getDate() + 3);
                                if (!data.cards.activeEffects) data.cards.activeEffects = [];
                                data.cards.activeEffects.push({
                                    type: 'reverse_curse',
                                    startDate: curseStart.toISOString(),
                                    endDate: curseEnd.toISOString()
                                });
                                saveData(data);
                                break;
                        }
                    }
                });
                
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
                data.cards.pendingPenalties = [];
                saveData(data);
            }
        }

        // ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨å¾Œã®å‡¦ç†
        window.continuePenaltyApply = function() {
            document.querySelector('.modal:last-child').remove();
            showShuffleView();
        };

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”»é¢ã‚’è¡¨ç¤º
        function showShuffleView() {
            resetScrollToTop();
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'block';
            
            const shuffleContainer = document.querySelector('.shuffle-container');
            const shuffleResult = document.getElementById('shuffle-result');
            
            shuffleContainer.style.display = 'block';
            shuffleResult.style.display = 'none';
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            // é »åº¦è¨­å®šã«å¿œã˜ã¦æ—¥æ•°ã‹é€±æ•°ã‹ã‚’æ±ºå®š
            let durationRanges;
            let isWeekMode = false;
            
            if (currentHypothesis.frequency && 
                (currentHypothesis.frequency.type === 'weekly' || currentHypothesis.frequency.type === 'weekdays')) {
                // é€±å˜ä½ãƒ¢ãƒ¼ãƒ‰ï¼ˆé€±â—å›ã¾ãŸã¯ç‰¹å®šæ›œæ—¥ã®å ´åˆï¼‰
                isWeekMode = true;
                durationRanges = {
                    short: { min: 2, max: 4 },   // 2ã€œ4é€±é–“ï¼ˆ14ã€œ28æ—¥ï¼‰
                    medium: { min: 5, max: 7 },   // 5ã€œ7é€±é–“ï¼ˆ35ã€œ49æ—¥ï¼‰
                    long: { min: 8, max: 10 }     // 8ã€œ10é€±é–“ï¼ˆ56ã€œ70æ—¥ï¼‰
                };
            } else {
                // æ—¥å˜ä½ãƒ¢ãƒ¼ãƒ‰ï¼ˆæ¯æ—¥ã®å ´åˆï¼‰
                durationRanges = {
                    short: { min: 3, max: 7 },
                    medium: { min: 8, max: 14 },
                    long: { min: 15, max: 30 }
                };
            }
            
            // çŸ­æœŸé›†ä¸­ãƒšãƒŠãƒ«ãƒ†ã‚£é©ç”¨æ™‚ã¯çŸ­æœŸãƒ¬ãƒ³ã‚¸ã‚’èª¿æ•´
            let range = durationRanges[currentHypothesis.duration];
            if (currentHypothesis.duration === 'short' && currentHypothesis.shortTermOnly) {
                if (isWeekMode) {
                    range = { min: 2, max: 2 };  // 2é€±é–“å›ºå®š
                } else {
                    range = { min: 3, max: 5 };  // 3-5æ—¥
                }
            }
            let shuffleCount = 0;
            const maxShuffles = 20;
            
            const shuffleInterval = setInterval(() => {
                const randomValue = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
                const shuffleNumber = document.getElementById('shuffle-number');
                
                // é€±ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é€±æ•°ã¨æ—¥æ•°ã‚’ä¸¡æ–¹è¡¨ç¤º
                if (isWeekMode) {
                    const days = randomValue * 7;
                    shuffleNumber.innerHTML = `<span style="font-size: 48px;">${randomValue}</span><span style="font-size: 24px;">é€±é–“</span><br><span style="font-size: 18px; color: var(--text-secondary);">(${days}æ—¥é–“)</span>`;
                } else {
                    shuffleNumber.textContent = randomValue;
                }
                shuffleNumber.classList.add('shuffling');
                
                setTimeout(() => {
                    shuffleNumber.classList.remove('shuffling');
                }, 250);
                
                shuffleCount++;
                
                if (shuffleCount >= maxShuffles) {
                    clearInterval(shuffleInterval);
                    
                    // æœ€çµ‚çš„ãªå€¤ã‚’æ±ºå®š
                    let finalValue = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
                    let finalDays;
                    
                    if (isWeekMode) {
                        // é€±ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é€±æ•°ã‚’æ—¥æ•°ã«å¤‰æ›
                        finalDays = finalValue * 7;
                        const shuffleNumber = document.getElementById('shuffle-number');
                        shuffleNumber.innerHTML = `<span style="font-size: 48px;">${finalValue}</span><span style="font-size: 24px;">é€±é–“</span><br><span style="font-size: 18px; color: var(--text-secondary);">(${finalDays}æ—¥é–“)</span>`;
                    } else {
                        finalDays = finalValue;
                    }
                    
                    // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å»¶é•·ã‚’é©ç”¨
                    if (window.pendingExtension) {
                        finalDays += window.pendingExtension;
                        window.pendingExtension = 0;
                    }
                    
                    currentHypothesis.totalDays = finalDays;
                    
                    setTimeout(() => {
                        shuffleContainer.style.display = 'none';
                        shuffleResult.style.display = 'block';
                        document.getElementById('final-days').textContent = finalDays;
                    }, 500);
                }
            }, 150);
        }

        // ç¿’æ…£ã‚’é–‹å§‹
        function startHypothesis() {
            const data = loadData();
            data.currentHypotheses.push(currentHypothesis);
            saveData(data);
            
            showProgressView(currentHypothesis.id);
        }

        // é€²æ—ç”»é¢ã‚’è¡¨ç¤º
        function showProgressView(hypothesisId) {
            resetScrollToTop();
            // ãƒ¢ãƒã‚¤ãƒ«ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³å¯¾ç­–: é€²æ—ãƒ“ãƒ¥ãƒ¼ã«å…¥ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å±¥æ­´ã‚’ç©ã‚€
            try {
                history.pushState({ view: 'progress', hypothesisId }, '');
            } catch (e) { /* noop */ }
            const data = loadData();
            const hypothesis = data.currentHypotheses.find(h => h.id === hypothesisId);
            
            if (!hypothesis) return;
            
            window.currentHypothesis = hypothesis;
            
            // intensityãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!window.currentHypothesis.intensity) {
                window.currentHypothesis.intensity = {};
            }
            
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'block';
            
            // ç¿’æ…£æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('progress-hypothesis-title').textContent = hypothesis.title;
            document.getElementById('progress-hypothesis-description').textContent = hypothesis.description;
            
            // é »åº¦æƒ…å ±ã‚’è¡¨ç¤º
            const daysInfo = document.getElementById('progress-days-info');
            let frequencyText = '';
            if (hypothesis.frequency) {
                if (hypothesis.frequency.type === 'daily') {
                    frequencyText = 'æ¯æ—¥å®Ÿæ–½';
                } else if (hypothesis.frequency.type === 'weekly') {
                    frequencyText = `é€±${hypothesis.frequency.count}å›å®Ÿæ–½`;
                } else if (hypothesis.frequency.type === 'weekdays') {
                    const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                    const days = hypothesis.frequency.weekdays.map(d => dayNames[d]).join('ãƒ»');
                    frequencyText = `${days}æ›œæ—¥ã«å®Ÿæ–½`;
                }
            } else {
                frequencyText = 'æ¯æ—¥å®Ÿæ–½';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            }
            
            const startDate = new Date(hypothesis.startDate);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + hypothesis.totalDays - 1);
            
            // ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯
            const habitModeLabel = hypothesis.habitMode ? ' | ğŸŒŸ ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰' : '';
            const unlimitedLabel = hypothesis.isUnlimited ? ' | â™¾ï¸ ç„¡æœŸé™' : '';
            const sleepingLabel = hypothesis.isSleeping ? ' | ğŸ˜´ ä¼‘çœ ä¸­' : '';
            
            // ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã‚’å–å¾—
            const categoryInfo = data.categoryMaster && data.categoryMaster[hypothesis.category] 
                ? data.categoryMaster[hypothesis.category] 
                : { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' };
            
            daysInfo.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                    <span>ğŸ“… ${startDate.toLocaleDateString('ja-JP')} ã€œ ${hypothesis.isUnlimited ? 'ç„¡æœŸé™' : endDate.toLocaleDateString('ja-JP')} | ${frequencyText}${habitModeLabel}${unlimitedLabel}${sleepingLabel}</span>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-secondary" onclick="editFrequencyType()" style="padding: 6px 12px; font-size: 12px; border-radius: 6px;">
                            ğŸ”„ é »åº¦å¤‰æ›´
                        </button>
                        <button class="btn btn-secondary" onclick="editHypothesisCategory()" style="padding: 6px 12px; font-size: 12px; border-radius: 6px;">
                            ${categoryInfo.icon} ${categoryInfo.name} å¤‰æ›´
                        </button>
                    </div>
                </div>
            `;
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼/é€²æ— è¡¨ç¤ºã‚’æ›´æ–°
            updateCalendar();
            updateProgress();
            
            // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            updateCardUseButton();
            
            // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯
            if (hypothesis.resetRisk) {
                checkResetRisk();
            }
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’æ›´æ–°
            updatePenaltyIndicators();

            // ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¨å¼·åº¦ï¼ˆIntensityï¼‰UIã‚’æ›´æ–°
            renderIntensityPanel();

            // IF-THENãƒ‘ãƒãƒ«
            renderIfThenPanel();
            
            // è¿½åŠ ã®UIæ›´æ–°ãŒã‚ã‚Œã°ã“ã“ã§å®Ÿè¡Œ
        }

        // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒœã‚¿ãƒ³ã®æ›´æ–°
        function updateCardUseButton() {
            const data = loadData();
            const hasSkipTicket = data.cards.inventory.some(card => card.cardId === 'skip_ticket' && !card.used);
            
            const cardUseSection = document.getElementById('card-use-section');
            if (hasSkipTicket) {
                cardUseSection.style.display = 'block';
            } else {
                cardUseSection.style.display = 'none';
            }
        }

        // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showCardUseMenu() {
            const modal = document.getElementById('card-use-modal');
            const container = document.getElementById('usable-cards-container');
            const data = loadData();
            
            container.innerHTML = '';
            
            // ä½¿ç”¨å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ã‚’é›†è¨ˆ
            const usableCards = {};
            data.cards.inventory.forEach(card => {
                if (!card.used && CARD_MASTER[card.cardId] && CARD_MASTER[card.cardId].type === 'reward') {
                    usableCards[card.cardId] = (usableCards[card.cardId] || 0) + 1;
                }
            });
            
            if (Object.keys(usableCards).length > 0) {
                Object.entries(usableCards).forEach(([cardId, count]) => {
                    const card = CARD_MASTER[cardId];
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card-item reward';
                    cardDiv.style.cursor = 'pointer';
                    cardDiv.innerHTML = `
                        <div class="card-icon">${card.icon}</div>
                        <div class="card-name">${card.name}</div>
                        <div class="card-description">${card.description}</div>
                        <div class="card-count">Ã—${count}</div>
                    `;
                    
                    // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ä½¿ç”¨é–¢æ•°ã‚’åˆ†ã‘ã‚‹
                    if (cardId === 'skip_ticket') {
                        cardDiv.onclick = () => useSkipTicket();
                    } else if (cardId === 'achievement_boost') {
                        cardDiv.onclick = () => useAchievementBoost();
                    } else if (cardId === 'perfect_bonus') {
                        cardDiv.onclick = () => usePerfectBonus();
                    } else if (cardId === 'protect_shield') {
                        cardDiv.onclick = () => useProtectShield();
                    } else if (cardId === 'achievement_booster') {
                        cardDiv.onclick = () => useAchievementBooster();
                    } else if (cardId === 'second_chance') {
                        cardDiv.onclick = () => useSecondChance();
                    } else if (cardId === 'event_trigger') {
                        cardDiv.onclick = () => useEventTrigger();
                    } else if (cardId === 'event_combo') {
                        cardDiv.onclick = () => useEventCombo();
                    } else if (cardId === 'point_gem') {
                        cardDiv.onclick = () => usePointGem();
                    } else if (cardId === 'mission_master') {
                        cardDiv.onclick = () => useMissionMaster();
                    } else if (cardId === 'rainbow_boost') {
                        cardDiv.onclick = () => useRainbowBoost();
                    } else if (cardId === 'quick_start') {
                        cardDiv.onclick = () => useQuickStart();
                    } else if (cardId === 'streak_bonus') {
                        cardDiv.onclick = () => useStreakBonus();
                    } else if (cardId === 'lucky_seven') {
                        cardDiv.onclick = () => useLuckySeven();
                    } else if (cardId === 'conversion_magic') {
                        cardDiv.onclick = () => useConversionMagic();
                    } else if (cardId === 'fate_dice') {
                        cardDiv.onclick = () => useFateDice();
                    }
                    
                    container.appendChild(cardDiv);
                });
            } else {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">ä½¿ç”¨å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            modal.style.display = 'flex';
        }

        // ã‚«ãƒ¼ãƒ‰ä½¿ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        function closeCardUseMenu() {
            document.getElementById('card-use-modal').style.display = 'none';
        }

        // ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨
        function useSkipTicket() {
            closeCardUseMenu();
            
            // ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
            window.skipTicketMode = true;
            
            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const message = document.createElement('div');
            message.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--gradient-1);
                color: white;
                padding: 20px 40px;
                border-radius: 20px;
                font-size: 18px;
                font-weight: 600;
                z-index: 2000;
                animation: fadeInOut 2s ease-out;
            `;
            message.textContent = 'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆä½¿ç”¨ä¸­ï¼é”æˆã—ãŸã„æ—¥ã‚’ã‚¿ãƒƒãƒ—';
            document.body.appendChild(message);
            
            setTimeout(() => message.remove(), 2000);
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ã—ã¦ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã‚’åæ˜ 
            updateCalendar();
        }
        
        // é”æˆãƒ–ãƒ¼ã‚¹ãƒˆã‚’ä½¿ç”¨
        function useAchievementBoost() {
            closeCardUseMenu();
            
            if (!window.currentHypothesis || window.currentHypothesis.completed) {
                alert('é€²è¡Œä¸­ã®ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const card = findAndRemoveCard('achievement_boost');
            if (!card) {
                alert('é”æˆãƒ–ãƒ¼ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã¾ã›ã‚“');
                return;
            }
            
            // é”æˆãƒ–ãƒ¼ã‚¹ãƒˆé¸æŠç”»é¢ã‚’è¡¨ç¤º
            showAchievementBoostSelection();
            
            saveData();
            displayUserCards();
        }
        
        function findAndRemoveCard(cardId) {
            const data = loadData();
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === cardId && !card.used
            );
            
            if (cardIndex === -1) {
                return null;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            saveData(data);
            
            return data.cards.inventory[cardIndex];
        }
        
        function showAchievementBoostSelection() {
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸŒŸ é”æˆãƒ–ãƒ¼ã‚¹ãƒˆ</h3>
                    <p>é”æˆæ¸ˆã¿ã«ã™ã‚‹æ—¥ã‚’2æ—¥é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                <div class="skip-dates" id="boost-dates">
                    <!-- æ—¥ä»˜ãƒœã‚¿ãƒ³ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" id="apply-boost" disabled>é©ç”¨ã™ã‚‹</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // é¸æŠå¯èƒ½ãªæ—¥ä»˜ã‚’è¡¨ç¤º
            const datesContainer = document.getElementById('boost-dates');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(window.currentHypothesis.startDate);
            const endDate = new Date(window.currentHypothesis.endDate);
            
            const selectedDates = new Set();
            
            // æ—¥ä»˜ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
            for (let d = new Date(startDate); d <= endDate && d <= today; d.setDate(d.getDate() + 1)) {
                const dateStr = dateKeyLocal(d);
                const achievements = window.currentHypothesis.achievements || {};
                
                // ã™ã§ã«é”æˆæ¸ˆã¿ã®æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—
                if (achievements[dateStr]) continue;
                
                const dateButton = document.createElement('button');
                dateButton.className = 'date-button';
                dateButton.textContent = `${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`;
                dateButton.dataset.date = dateStr;
                
                dateButton.onclick = function() {
                    if (selectedDates.has(dateStr)) {
                        selectedDates.delete(dateStr);
                        this.classList.remove('selected');
                    } else if (selectedDates.size < 2) {
                        selectedDates.add(dateStr);
                        this.classList.add('selected');
                    }
                    
                    // é©ç”¨ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    document.getElementById('apply-boost').disabled = selectedDates.size !== 2;
                };
                
                datesContainer.appendChild(dateButton);
            }
            
            // é¸æŠå¯èƒ½ãªæ—¥ãŒãªã„å ´åˆ
            if (datesContainer.children.length === 0) {
                datesContainer.innerHTML = '<p style="text-align: center; color: #94a3b8;">é”æˆå¯èƒ½ãªæ—¥ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            }
            
            // é©ç”¨ãƒœã‚¿ãƒ³ã®å‡¦ç†
            document.getElementById('apply-boost').onclick = function() {
                applyAchievementBoost(Array.from(selectedDates));
                overlay.remove();
            };
        }
        
        function applyAchievementBoost(dates) {
            if (!window.currentHypothesis || dates.length !== 2) return;
            
            // é¸æŠã•ã‚ŒãŸ2æ—¥ã‚’é”æˆæ¸ˆã¿ã«ã™ã‚‹
            if (!window.currentHypothesis.achievements) {
                window.currentHypothesis.achievements = {};
            }
            
            dates.forEach(dateStr => {
                window.currentHypothesis.achievements[dateStr] = true;
            });
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();
            
            // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
            showCardEffect('é”æˆãƒ–ãƒ¼ã‚¹ãƒˆç™ºå‹•ï¼', 'é¸æŠã—ãŸ2æ—¥ãŒé”æˆæ¸ˆã¿ã«ãªã‚Šã¾ã—ãŸ', '#10b981');
        }
        
        // ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
        function showCardEffect(title, message, color) {
            const effectDiv = document.createElement('div');
            effectDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${color};
                color: white;
                padding: 24px 48px;
                border-radius: 20px;
                font-size: 20px;
                font-weight: 700;
                z-index: 3000;
                animation: cardEffectAnimation 3s ease-out;
                text-align: center;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            `;
            effectDiv.innerHTML = `
                <h3 style="margin: 0 0 12px 0; font-size: 24px;">${title}</h3>
                <p style="margin: 0; font-size: 16px; font-weight: 400;">${message}</p>
            `;
            
            document.body.appendChild(effectDiv);
            
            setTimeout(() => effectDiv.remove(), 3000);
        }
        
        // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã‚’ä½¿ç”¨
        function usePerfectBonus() {
            closeCardUseMenu();
            
            if (!confirm('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ\næ¬¡ã®ç¿’æ…£ã§100%é”æˆæ™‚ã€å ±é…¬ã‚«ãƒ¼ãƒ‰2æšã‚’ç²å¾—ã§ãã¾ã™ã€‚')) {
                return;
            }
            
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'perfect_bonus' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«è¿½åŠ 
            if (!data.cards.activeEffects) {
                data.cards.activeEffects = [];
            }
            
            data.cards.activeEffects.push({
                cardId: 'perfect_bonus',
                activatedDate: new Date().toISOString(),
                targetHypothesisId: null // æ¬¡ã®ç¿’æ…£ã«é©ç”¨
            });
            
            saveData(data);
            
            showNotification('ğŸ¯ ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼\næ¬¡ã®ç¿’æ…£ã§100%é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼', 'success');
        }
        
        // ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆã‚’é©ç”¨
        function applySkipTicket(dateKey, dayCell) {
            if (!window.skipTicketMode) return;
            
            // æ—¢ã«é”æˆæ¸ˆã¿ã®æ—¥ã¯é¸æŠä¸å¯
            if (window.currentHypothesis.achievements[dateKey]) {
                showNotification('âš ï¸ ã™ã§ã«é”æˆæ¸ˆã¿ã®æ—¥ã§ã™', 'error');
                return;
            }
            // æœªæ¥æ—¥ã¯ä¸å¯
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(dateKey);
            if (target > today) {
                showNotification('âš ï¸ æœªæ¥æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã§ãã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆã‚’æ¶ˆè²»
            const data = loadData();
            const skipTicketIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'skip_ticket' && !card.used
            );
            
            if (skipTicketIndex === -1) {
                showNotification('âš ï¸ ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                window.skipTicketMode = false;
                updateCalendar();
                return;
            }
            
            // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
            if (!confirm(`ã“ã®æ—¥ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é”æˆæ¸ˆã¿ã«ã—ã¾ã™ã‹ï¼Ÿ\næ—¥ä»˜: ${dateKey}`)) {
                return;
            }
            
            // achievementsãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!window.currentHypothesis.achievements) {
                window.currentHypothesis.achievements = {};
            }
            
            // é”æˆçŠ¶æ…‹ã«ã™ã‚‹
            window.currentHypothesis.achievements[dateKey] = true;
            
            // ã‚¹ã‚­ãƒƒãƒ—é©ç”¨ãƒ­ã‚°ï¼ˆé–‹ç™ºç”¨ï¼‰
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            data.cards.inventory[skipTicketIndex].used = true;
            data.cards.inventory[skipTicketIndex].usedDate = new Date().toISOString();
            
            // ç¾åœ¨ã®ç¿’æ…£ã‚’æ›´æ–°
            const hypothesisIndex = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (hypothesisIndex !== -1) {
                if (!data.currentHypotheses[hypothesisIndex].achievements) {
                    data.currentHypotheses[hypothesisIndex].achievements = {};
                }
                data.currentHypotheses[hypothesisIndex].achievements[dateKey] = true;
            }
            
            saveData(data);
            
            // ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
            window.skipTicketMode = false;
            
            // æˆåŠŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
            dayCell.classList.remove('not-achieved');
            dayCell.classList.add('achieved');
            dayCell.style.transition = 'all 0.5s ease';
            dayCell.style.transform = 'scale(1.2)';
            dayCell.style.boxShadow = '0 0 20px var(--primary)';
            
            setTimeout(() => {
                dayCell.style.transform = 'scale(1)';
                dayCell.style.boxShadow = '';
            }, 500);
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showNotification('âœ… ã‚¹ã‚­ãƒƒãƒ—ãƒã‚±ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼', 'success');
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
            updateCalendar();
            updateProgress();
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        function updateCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';
            
            const startDate = new Date(window.currentHypothesis.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // é–‹å§‹æ—¥ã‚’0æ™‚0åˆ†0ç§’ã«è¨­å®š
            startDate.setHours(0, 0, 0, 0);
            
            // çµŒéæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆé–‹å§‹æ—¥ã‚’1æ—¥ç›®ã¨ã—ã¦è¨ˆç®—ï¼‰
            const timeDiff = today.getTime() - startDate.getTime();
            // ç„¡æœŸé™ã®å ´åˆã¯å®Ÿéš›ã®çµŒéæ—¥æ•°ã‚’ä½¿ç”¨
            const daysPassed = window.currentHypothesis.isUnlimited 
                ? Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1)
                : Math.min(
                    Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1),
                    window.currentHypothesis.totalDays
                );
            
            // é€±ã”ã¨ã®é”æˆçŠ¶æ³ã‚’è¿½è·¡ï¼ˆé€±â—å›ã®å ´åˆï¼‰
            const weeklyAchievements = new Map(); // weekNumber -> {achieved: count, required: count, canAchieve: count}
            const frequency = window.currentHypothesis.frequency;
            
            // æ¤œè¨¼é–‹å§‹æ—¥ã‹ã‚‰ã®é€±ç•ªå·ã‚’å–å¾—ï¼ˆé–‹å§‹æ—¥ã‹ã‚‰7æ—¥ã”ã¨ã«1é€±é–“ï¼‰
            function getWeekNumber(date) {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const start = new Date(startDate);
                start.setHours(0, 0, 0, 0);
                const days = Math.floor((d - start) / (24 * 60 * 60 * 1000));
                return Math.floor(days / 7) + 1;  // 1é€±ç›®ã‹ã‚‰é–‹å§‹
            }
            
            // é€±â—å›ã®å ´åˆã€å…ˆã«å„é€±ã®é”æˆçŠ¶æ³ã‚’è¨ˆç®—
            if (frequency && frequency.type === 'weekly') {
                for (let i = 0; i < window.currentHypothesis.totalDays; i++) {
                    const cellDate = new Date(startDate);
                    cellDate.setDate(startDate.getDate() + i);
                    const weekNum = getWeekNumber(cellDate);
                    const dateKey = dateKeyLocal(cellDate);
                    
                    if (!weeklyAchievements.has(weekNum)) {
                        weeklyAchievements.set(weekNum, {
                            achieved: 0,
                            required: frequency.count || 3,
                            canAchieve: 0,
                            dates: []
                        });
                    }
                    
                    const weekData = weeklyAchievements.get(weekNum);
                    weekData.dates.push(cellDate);
                    
                    if (window.currentHypothesis.achievements && window.currentHypothesis.achievements[dateKey]) {
                        weekData.achieved++;
                    }
                    
                    // ä»Šæ—¥ä»¥å‰ã®æ—¥æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    if (cellDate <= today) {
                        weekData.canAchieve++;
                    }
                }
            }
            
            let lastWeekNum = -1;
            
            for (let i = 0; i < window.currentHypothesis.totalDays; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                const weekNum = getWeekNumber(cellDate);
                
                // æ–°ã—ã„é€±ãŒå§‹ã¾ã£ãŸã‚‰é€±æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆé€±â—å›ã®å ´åˆã®ã¿ï¼‰
                if (frequency && frequency.type === 'weekly' && weekNum !== lastWeekNum) {
                    const weekData = weeklyAchievements.get(weekNum);
                    if (weekData) {
                        const weekInfo = document.createElement('div');
                        weekInfo.className = 'week-info';
                        const progressPercent = Math.min(100, (weekData.achieved / weekData.required) * 100);
                        
                        weekInfo.innerHTML = `
                            <span>ç¬¬${weekNum}é€±</span>
                            <div class="progress">
                                <span>${weekData.achieved}/${weekData.required}å›${weekData.achieved > weekData.required ? ' âœ¨' : ''}</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progressPercent}%; ${weekData.achieved > weekData.required ? 'background: linear-gradient(90deg, #10b981, #3b82f6);' : ''}"></div>
                                </div>
                            </div>
                        `;
                        calendarGrid.appendChild(weekInfo);
                    }
                    lastWeekNum = weekNum;
                }
                
                // é »åº¦ã«å¿œã˜ã¦å¯¾è±¡æ—¥ã‹ã©ã†ã‹ã‚’åˆ¤å®š
                let isTargetDay = true;
                let canClickToday = true;
                
                if (frequency) {
                    if (frequency.type === 'weekdays') {
                        // ç‰¹å®šæ›œæ—¥ã®å ´åˆï¼šè©²å½“ã™ã‚‹æ›œæ—¥ã®ã¿å¯¾è±¡
                        isTargetDay = frequency.weekdays.includes(cellDate.getDay());
                    } else if (frequency.type === 'weekly') {
                        // é€±â—å›ã®å ´åˆï¼šä¸Šé™ã‚’è¶…ãˆã¦ã‚‚è¨˜éŒ²å¯èƒ½ã«ã™ã‚‹
                        // ã™ã¹ã¦ã®æ—¥ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹
                        const weekData = weeklyAchievements.get(weekNum);
                        // åˆ¶é™ã‚’å‰Šé™¤ï¼šå¸¸ã«ã‚¯ãƒªãƒƒã‚¯å¯èƒ½
                    }
                    // daily ã®å ´åˆã¯ã™ã¹ã¦å¯¾è±¡
                }
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                dayCell.style.position = 'relative';
                
                // å¯¾è±¡å¤–ã®æ—¥ã¯è–„ãè¡¨ç¤º
                if (!isTargetDay || !canClickToday) {
                    dayCell.style.opacity = '0.3';
                    dayCell.style.background = 'var(--surface-dark)';
                }
                
                // å®Ÿéš›ã®æ—¥ä»˜ã‚’è¡¨ç¤ºï¼ˆæœˆ/æ—¥å½¢å¼ï¼‰
                const displayMonth = cellDate.getMonth() + 1;
                const displayDate = cellDate.getDate();
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][cellDate.getDay()];
                dayCell.innerHTML = `<small style="font-size: 10px;">${displayMonth}/${displayDate}(${dayOfWeek})</small><br><span style="font-size: 18px; font-weight: bold;">${i + 1}</span>`;
                dayCell.dataset.day = i + 1;
                
                // ç‰¹å®šæ›œæ—¥ã®å ´åˆã€å¯¾è±¡æ›œæ—¥ã‚’å¼·èª¿è¡¨ç¤º
                if (frequency && frequency.type === 'weekdays') {
                    if (isTargetDay) {
                        dayCell.style.border = '2px solid var(--primary)';
                        dayCell.style.boxShadow = '0 0 8px rgba(59, 130, 246, 0.2)';
                    }
                }
                
                const dateKey = dateKeyLocal(cellDate);
                // å¼·åº¦ãƒãƒƒã‚¸ï¼ˆè¨­å®šæ™‚ï¼‰
                const mult = Number((window.currentHypothesis.intensity || {})[dateKey] ?? 1.0);
                const multBadge = document.createElement('div');
                multBadge.style.cssText = 'position:absolute;bottom:6px;right:6px;font-size:10px;color:#94a3b8;';
                multBadge.textContent = `Ã—${mult.toFixed(1)}`;
                dayCell.appendChild(multBadge);
                
                // å¯¾è±¡å¤–ã®æ—¥ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯
                if (!isTargetDay || !canClickToday) {
                    dayCell.classList.add('not-target');
                    dayCell.style.cursor = 'not-allowed';
                    
                    // é€±â—å›ã§ç›®æ¨™é”æˆæ¸ˆã¿ã§ã‚‚è¿½åŠ è¨˜éŒ²å¯èƒ½ãªã®ã§ãƒãƒƒã‚¸è¡¨ç¤ºã‚’å‰Šé™¤
                } else if (cellDate > today && !window.skipTicketMode) {
                    dayCell.classList.add('future');
                } else if (window.currentHypothesis.achievements[dateKey]) {
                    dayCell.classList.add('achieved');
                    // é”æˆæ¸ˆã¿ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼ˆå–ã‚Šæ¶ˆã—ã§ãã‚‹ã‚ˆã†ã«ï¼‰
                    dayCell.style.cursor = 'pointer';
                    dayCell.onclick = () => toggleDayStatus(dateKey, dayCell);
                } else {
                    dayCell.classList.add('not-achieved');
                    if (window.skipTicketMode) {
                        // ã‚¹ã‚­ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã§ã‚‚éå»ã¨ä»Šæ—¥ã®ã¿é¸æŠå¯èƒ½
                        if (cellDate <= today && isTargetDay && canClickToday) {
                            dayCell.style.cursor = 'pointer';
                            dayCell.style.border = '2px dashed var(--primary)';
                            dayCell.onclick = () => applySkipTicket(dateKey, dayCell);
                        } else {
                            dayCell.classList.add('future');
                        }
                    } else {
                        if (isTargetDay && canClickToday) {
                            dayCell.onclick = () => toggleDayStatus(dateKey, dayCell);
                        }
                    }
                }
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã®å ´åˆã€å¯¾è±¡æ—¥ãªã‚‰ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼ˆæ·±å¤œå¯¾å¿œï¼‰
                // æ·±å¤œ2æ™‚ã¾ã§ã¯å‰æ—¥ã®ã‚»ãƒ«ã‚‚ã‚¯ãƒªãƒƒã‚¯å¯èƒ½
                const currentActivityKey = getActivityDateKey();
                const isClickableToday = (dateKey === currentActivityKey) && isTargetDay && canClickToday;
                if (isClickableToday) {
                    if (!window.currentHypothesis.achievements[dateKey]) {
                        dayCell.classList.remove('future');
                        dayCell.classList.add('not-achieved');
                        dayCell.onclick = window.skipTicketMode ? 
                            () => applySkipTicket(dateKey, dayCell) : 
                            () => toggleDayStatus(dateKey, dayCell);
                    }
                }
                
                // é•·æŠ¼ã—ï¼ˆã¾ãŸã¯å³ã‚¯ãƒªãƒƒã‚¯ï¼‰ã§ãã®æ—¥ã®å¼·åº¦ã‚’ç·¨é›†
                if (cellDate <= today) {
                    attachLongPress(dayCell, () => openIntensityPicker(dateKey));
                    dayCell.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        openIntensityPicker(dateKey);
                    });
                }
                calendarGrid.appendChild(dayCell);
            }
            
            // æœŸé–“æƒ…å ±ã¨é »åº¦æƒ…å ±ã‚’æ›´æ–°
            let frequencyInfo = '';
            if (frequency) {
                if (frequency.type === 'daily') {
                    frequencyInfo = ' (æ¯æ—¥)';
                } else if (frequency.type === 'weekly') {
                    frequencyInfo = ` (é€±${frequency.count}å›)`;
                } else if (frequency.type === 'weekdays') {
                    const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                    const days = frequency.weekdays.map(d => dayNames[d]).join('ãƒ»');
                    frequencyInfo = ` (${days})`;
                }
            }
            document.getElementById('progress-days-info').textContent = 
                `æ¤œè¨¼æœŸé–“: ${daysPassed}æ—¥ç›® / ${window.currentHypothesis.totalDays}æ—¥é–“${frequencyInfo}`;
        }

        // é•·æŠ¼ã—æ¤œå‡ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function attachLongPress(element, onLongPress, delay = 500) {
            let timer = null;
            let longPressed = false;
            const start = (e) => {
                longPressed = false;
                timer = setTimeout(() => { longPressed = true; onLongPress(); }, delay);
            };
            const cancel = () => { if (timer) clearTimeout(timer); };
            element.addEventListener('touchstart', start, { passive: true });
            element.addEventListener('touchend', cancel, { passive: true });
            element.addEventListener('touchmove', cancel, { passive: true });
            element.addEventListener('mousedown', start);
            element.addEventListener('mouseup', cancel);
            element.addEventListener('mouseleave', cancel);
        }
        
        // é•·æŠ¼ã—ã§å‰Šé™¤ç”¨ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        function attachLongPressToDelete(element, hypothesisId, delay = 500) {
            let timer = null;
            let longPressed = false;
            
            const start = (e) => {
                longPressed = false;
                element.classList.add('deleting');
                timer = setTimeout(() => { 
                    longPressed = true; 
                    element.classList.remove('deleting');
                    confirmDeleteHypothesis(hypothesisId);
                }, delay);
            };
            
            const cancel = (e) => { 
                if (timer) clearTimeout(timer);
                element.classList.remove('deleting');
                // é•·æŠ¼ã—ãŒæˆåŠŸã—ãŸå ´åˆã¯é€šå¸¸ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                if (longPressed) {
                    e.preventDefault();
                    e.stopPropagation();
                }
            };
            
            element.addEventListener('touchstart', start, { passive: true });
            element.addEventListener('touchend', cancel, { passive: true });
            element.addEventListener('touchmove', cancel, { passive: true });
            element.addEventListener('mousedown', start);
            element.addEventListener('mouseup', cancel);
            element.addEventListener('mouseleave', cancel);
        }
        
        // ç¿’æ…£ã®å‰Šé™¤ç¢ºèª
        function confirmDeleteHypothesis(hypothesisId) {
            const data = loadData();
            const hypothesis = data.currentHypotheses.find(h => h.id === hypothesisId);
            
            if (!hypothesis) return;
            
            const message = `ã€Œ${hypothesis.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
            
            if (confirm(message)) {
                deleteHypothesis(hypothesisId);
            }
        }
        
        // ç¿’æ…£ã‚’å‰Šé™¤
        function deleteHypothesis(hypothesisId) {
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === hypothesisId);
            
            if (index === -1) return;
            
            // å‰Šé™¤ã•ã‚Œã‚‹ç¿’æ…£ã‚’è¨˜éŒ²ï¼ˆå¿…è¦ã«å¿œã˜ã¦å±¥æ­´ã«è¿½åŠ ï¼‰
            const deletedHypothesis = data.currentHypotheses[index];
            
            // ç¿’æ…£ã‚’å‰Šé™¤
            data.currentHypotheses.splice(index, 1);
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            saveData(data);
            
            // é€šçŸ¥ã‚’è¡¨ç¤º
            showNotification(`âœ… ã€Œ${deletedHypothesis.title}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'success');
            
            // ç¾åœ¨ã®ç¿’æ…£ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯ãƒ›ãƒ¼ãƒ ç”»é¢ã«æˆ»ã‚‹
            if (window.currentHypothesis && window.currentHypothesis.id === hypothesisId) {
                window.currentHypothesis = null;
                showHomeView();
            } else {
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’æ›´æ–°
                updateCurrentHypothesisList();
            }
        }

        // å¼·åº¦é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆéå»æ—¥/å½“æ—¥ç”¨ï¼‰
        function openIntensityPicker(dateKey) {
            if (!window.currentHypothesis) return;
            const hyp = window.currentHypothesis;
            hyp.intensity = hyp.intensity || {};
            hyp.intensityOptions = hyp.intensityOptions || [
                { label: 'è»½ã‚', mult: 0.8 },
                { label: 'åŸºæœ¬', mult: 1.0 },
                { label: 'é«˜å¼·åº¦', mult: 1.2 },
            ];
            const opts = hyp.intensityOptions;
            const current = Number(hyp.intensity[dateKey] ?? 1.0);

            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '480px';
            modal.style.padding = '20px';
            const title = new Date(dateKey).toLocaleDateString('ja-JP');
            const esc = (s) => (typeof escapeHTML === 'function' ? escapeHTML(String(s)) : String(s));
            const isAchieved = !!((hyp.achievements || {})[dateKey]);
            const btnCss = (active) => `padding:10px 12px;border-radius:10px;border:2px solid ${active ? '#10b981' : '#334155'};background:${active ? 'rgba(16,185,129,0.15)' : 'rgba(30,41,59,0.5)'};color:#e2e8f0;${isAchieved ? 'cursor:pointer;' : 'opacity:0.6;cursor:not-allowed;'}`;
            modal.innerHTML = `
                <div class="modal-header" style="margin-bottom:16px;">
                    <h3>ğŸ’ª å¼·åº¦ã‚’é¸æŠ (${esc(title)})</h3>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    ${opts.map((o, idx) => `
                        <button data-idx="${idx}" style="${btnCss(current===Number(o.mult))}">${esc(o.label)} (Ã—${Number(o.mult).toFixed(1)})</button>
                    `).join('')}
                </div>
                <div class="modal-footer" style="margin-top:16px;display:flex;gap:8px;justify-content:flex-end;">
                    <button class="button secondary" id="intensity-cancel">é–‰ã˜ã‚‹</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            if (isAchieved) {
                modal.querySelectorAll('button[data-idx]').forEach(btn => {
                    btn.onclick = () => {
                        const idx = Number(btn.getAttribute('data-idx'));
                        const mult = Number(opts[idx].mult);
                        hyp.intensity[dateKey] = mult;
                        const data = loadData();
                        const i = data.currentHypotheses.findIndex(h => h.id === hyp.id);
                        if (i !== -1) data.currentHypotheses[i] = hyp;
                        saveData(data);
                        document.body.removeChild(overlay);
                        updateCalendar();
                        updateProgress();
                    };
                });
            } else {
                const info = document.createElement('div');
                info.style.cssText = 'margin-top:12px;color:#94a3b8;font-size:12px;';
                info.textContent = 'æœªé”æˆæ—¥ã®å¼·åº¦ã¯å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚å…ˆã«é”æˆã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„ã€‚';
                modal.appendChild(info);
            }
            document.getElementById('intensity-cancel').onclick = () => {
                document.body.removeChild(overlay);
            };
        }

        // å¼·åº¦é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ–°è¦é”æˆæ™‚ï¼‰
        function showIntensitySelectionModal(dateKey, dayCell) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '400px';
            
            const dateObj = new Date(dateKey);
            const dateStr = dateObj.toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' });
            
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸ’ª å¼·åº¦ã‚’é¸æŠ</h3>
                    <p>${dateStr}ã®ç¿’æ…£é”æˆ</p>
                </div>
                <div style="display: flex; gap: 10px; margin: 20px 0;">
                    <button class="intensity-btn" data-intensity="0.8" style="flex: 1; padding: 15px; border-radius: 10px; border: 2px solid var(--surface-light); background: var(--surface); color: var(--text-primary); cursor: pointer;">
                        <div style="font-size: 20px;">ğŸŸ¢</div>
                        <div style="margin-top: 5px;">è»½ã‚</div>
                        <div style="font-size: 18px; font-weight: bold;">1pt</div>
                    </button>
                    <button class="intensity-btn" data-intensity="1.0" style="flex: 1; padding: 15px; border-radius: 10px; border: 2px solid var(--primary); background: var(--surface); color: var(--text-primary); cursor: pointer;">
                        <div style="font-size: 20px;">ğŸŸ¡</div>
                        <div style="margin-top: 5px;">åŸºæœ¬</div>
                        <div style="font-size: 18px; font-weight: bold;">2pt</div>
                    </button>
                    <button class="intensity-btn" data-intensity="1.2" style="flex: 1; padding: 15px; border-radius: 10px; border: 2px solid var(--surface-light); background: var(--surface); color: var(--text-primary); cursor: pointer;">
                        <div style="font-size: 20px;">ğŸ”´</div>
                        <div style="margin-top: 5px;">é«˜å¼·åº¦</div>
                        <div style="font-size: 18px; font-weight: bold;">3pt</div>
                    </button>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // å¼·åº¦ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            modal.querySelectorAll('.intensity-btn').forEach(btn => {
                btn.onclick = () => {
                    const intensity = parseFloat(btn.dataset.intensity);
                    applyAchievementWithIntensity(dateKey, dayCell, intensity);
                    overlay.remove();
                };
            });
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            overlay.onclick = (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            };
        }
        
        // å¼·åº¦ã‚’é©ç”¨ã—ã¦é”æˆçŠ¶æ…‹ã«ã™ã‚‹
        function applyAchievementWithIntensity(dateKey, dayCell, intensityValue) {
            // å¼·åº¦ã‚’ä¿å­˜
            if (!window.currentHypothesis.intensity) {
                window.currentHypothesis.intensity = {};
            }
            window.currentHypothesis.intensity[dateKey] = intensityValue;
            
            // é”æˆçŠ¶æ…‹ã«ã™ã‚‹
            window.currentHypothesis.achievements[dateKey] = true;
            dayCell.classList.remove('not-achieved');
            dayCell.classList.add('achieved');
            
            // ãƒã‚¤ãƒ³ãƒˆç²å¾—å‡¦ç†
            // å¼·åº¦ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šï¼ˆ0.8â†’1ptã€1.0â†’2ptã€1.2â†’3ptï¼‰
            let actualPoints = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åŸºæœ¬ã®2pt
            if (intensityValue === 0.8) {
                actualPoints = 1; // è»½ã‚
            } else if (intensityValue === 1.0) {
                actualPoints = 2; // åŸºæœ¬
            } else if (intensityValue === 1.2) {
                actualPoints = 3; // é«˜å¼·åº¦
            }
            
            // é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
            const streakDays = calculateCurrentStreak(window.currentHypothesis);
            const multiplier = calculateStreakMultiplier(streakDays);
            
            // ãƒã‚¤ãƒ³ãƒˆä»˜ä¸ï¼ˆå¼·åº¦ã‚’è€ƒæ…®ã—ãŸå®Ÿéš›ã®ãƒã‚¤ãƒ³ãƒˆï¼‰
            const basePoints = actualPoints;
            const bonusPoints = Math.round(actualPoints * (multiplier - 1));
            earnPoints(actualPoints, 'habit', `${window.currentHypothesis.title} é”æˆ`, multiplier, null, window.currentHypothesis.id);
            
            // åŸºæœ¬ã®é”æˆé€šçŸ¥ï¼ˆå„ªå…ˆåº¦2ï¼‰
            showNotification(`âœ… ${window.currentHypothesis.title} é”æˆï¼\n+${basePoints}pt`, 'success', 2);
            
            // é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹ã®è¡¨ç¤ºï¼ˆå„ªå…ˆåº¦5ï¼‰
            if (multiplier > 1.0) {
                let streakMessage = '';
                if (streakDays >= 21) {
                    streakMessage = `ğŸŒŸ 21æ—¥ä»¥ä¸Šé€£ç¶šé”æˆï¼\nãƒœãƒ¼ãƒŠã‚¹+${bonusPoints}pt (Ã—2.0)`;
                } else if (streakDays >= 14) {
                    streakMessage = `â­ 14æ—¥é€£ç¶šé”æˆï¼\nãƒœãƒ¼ãƒŠã‚¹+${bonusPoints}pt (Ã—1.7)`;
                } else if (streakDays >= 7) {
                    streakMessage = `ğŸ”¥ 7æ—¥é€£ç¶šé”æˆï¼\nãƒœãƒ¼ãƒŠã‚¹+${bonusPoints}pt (Ã—1.5)`;
                } else if (streakDays >= 3) {
                    streakMessage = `âœ¨ 3æ—¥é€£ç¶šé”æˆï¼\nãƒœãƒ¼ãƒŠã‚¹+${bonusPoints}pt (Ã—1.2)`;
                }
                if (streakMessage) {
                    showNotification(streakMessage, 'success', 5);
                }
            }
            
            // åŒæ—¥ã®ä»–ã®ç¿’æ…£é”æˆã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹
            checkAndAwardComboBonus(dateKey);
            
            // é”æˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            showAchievementAnimation();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateProgress();
            updateCalendar(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†æç”»ã—ã¦é€±ã®çŠ¶æ³ã‚’æ›´æ–°
            
            // ãƒãƒƒã‚¸ç²å¾—ãƒã‚§ãƒƒã‚¯
            checkAndAwardBadges();
            
            // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯ï¼ˆç¿Œæ—¥ã«å®Ÿè¡Œï¼‰
            if (window.currentHypothesis.resetRisk) {
                setTimeout(() => checkResetRisk(), 100);
            }
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
            checkStageProgress();
        }
        
        // æ—¥ã®é”æˆçŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
        function toggleDayStatus(dateKey, dayCell) {
            // é€±â—å›ã®åˆ¶é™ãƒã‚§ãƒƒã‚¯
            const frequency = window.currentHypothesis.frequency;
            if (frequency && frequency.type === 'weekly') {
                // æ—¥ä»˜ã‹ã‚‰é€±ç•ªå·ã‚’å–å¾—
                const [year, month, day] = dateKey.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const weekNum = getWeekNumber(date, window.currentHypothesis.startDate);
                
                // ã“ã®é€±ã®é”æˆçŠ¶æ³ã‚’ç¢ºèª
                let weekAchieved = 0;
                const startOfWeek = new Date(date);
                startOfWeek.setDate(date.getDate() - date.getDay() + 1); // æœˆæ›œæ—¥
                
                for (let i = 0; i < 7; i++) {
                    const checkDate = new Date(startOfWeek);
                    checkDate.setDate(startOfWeek.getDate() + i);
                    const checkKey = dateKeyLocal(checkDate);
                    if (window.currentHypothesis.achievements && window.currentHypothesis.achievements[checkKey]) {
                        weekAchieved++;
                    }
                }
                
                // é€±â—å›ã®åˆ¶é™ã‚’å‰Šé™¤ï¼šç›®æ¨™å›æ•°ã«é”æˆã—ã¦ã‚‚ãã‚Œä»¥ä¸Šè¨˜éŒ²å¯èƒ½
                // é”æˆæ¸ˆã¿ã‹ã©ã†ã‹ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼ˆãƒˆã‚°ãƒ«å‡¦ç†ã®ãŸã‚ï¼‰
            }
            
            if (!window.currentHypothesis.achievements[dateKey]) {
                // é”æˆçŠ¶æ…‹ã«ã™ã‚‹å‰ã«å¼·åº¦é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showIntensitySelectionModal(dateKey, dayCell);
            } else {
                // é”æˆã‚’å–ã‚Šæ¶ˆã™ï¼ˆãƒã‚¤ãƒ³ãƒˆã‚’æ¸›ç®—ã™ã‚‹ï¼‰
                delete window.currentHypothesis.achievements[dateKey];
                dayCell.classList.remove('achieved');
                dayCell.classList.add('not-achieved');
                
                // ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—å‡¦ç†
                const data = loadData();
                // æ—¥ä»˜ã”ã¨ã®å¼·åº¦ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1.0ï¼‰
                const intensityValue = window.currentHypothesis.intensity?.[dateKey] || 1.0;
                // å¼·åº¦ã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šï¼ˆ0.8â†’1ptã€1.0â†’2ptã€1.2â†’3ptï¼‰
                let actualPoints = 2; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åŸºæœ¬ã®2pt
                if (intensityValue === 0.8) {
                    actualPoints = 1; // è»½ã‚
                } else if (intensityValue === 1.0) {
                    actualPoints = 2; // åŸºæœ¬
                } else if (intensityValue === 1.2) {
                    actualPoints = 3; // é«˜å¼·åº¦
                }
                
                // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã®ãƒã‚§ãƒƒã‚¯ã¨æ¸›ç®—
                let comboDeduction = 0;
                let totalAchievedBefore = 0;
                let totalAchievedAfter = 0;
                
                // å–ã‚Šæ¶ˆã—å‰ã®åŒæ—¥é”æˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                // æ³¨æ„ï¼šç¾åœ¨ã®ç¿’æ…£ã®é”æˆçŠ¶æ…‹ã¯ã¾ã trueãªã®ã§ã€ãã‚Œã‚‚å«ã‚ã¦ã‚«ã‚¦ãƒ³ãƒˆ
                data.currentHypotheses.forEach(h => {
                    if (h.id === window.currentHypothesis.id) {
                        // ç¾åœ¨ã®ç¿’æ…£ã¯å–ã‚Šæ¶ˆã—å‰ãªã®ã§trueã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
                        if (window.currentHypothesis.achievements[dateKey]) {
                            totalAchievedBefore++;
                        }
                    } else if (h.achievements && h.achievements[dateKey]) {
                        totalAchievedBefore++;
                    }
                });
                
                // å–ã‚Šæ¶ˆã—å¾Œã®åŒæ—¥é”æˆæ•°ï¼ˆã“ã®ç¿’æ…£ã‚’é™¤ãï¼‰
                totalAchievedAfter = totalAchievedBefore - 1;
                
                // ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã®å·®åˆ†ã‚’è¨ˆç®—
                // æ³¨æ„ï¼šã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã¯ç´¯ç©ã§ã¯ãªãã€è©²å½“ã™ã‚‹æœ€é«˜ã®ãƒœãƒ¼ãƒŠã‚¹ã®ã¿ãŒä»˜ä¸ã•ã‚Œã‚‹
                let bonusBefore = 0;
                let bonusAfter = 0;
                
                // å…¨ç¿’æ…£æ•°ã‚’å–å¾—
                const totalHabits = data.currentHypotheses.length;
                
                // å–ã‚Šæ¶ˆã—å‰ã®ãƒœãƒ¼ãƒŠã‚¹
                if (totalHabits >= 4 && totalAchievedBefore === totalHabits) {
                    bonusBefore = 5; // å…¨ç¿’æ…£é”æˆãƒœãƒ¼ãƒŠã‚¹
                } else if (totalAchievedBefore === 3) {
                    bonusBefore = 3; // 3ç¿’æ…£ãƒœãƒ¼ãƒŠã‚¹
                } else if (totalAchievedBefore === 2) {
                    bonusBefore = 1; // 2ç¿’æ…£ãƒœãƒ¼ãƒŠã‚¹
                }
                
                // å–ã‚Šæ¶ˆã—å¾Œã®ãƒœãƒ¼ãƒŠã‚¹
                if (totalHabits >= 4 && totalAchievedAfter === totalHabits) {
                    bonusAfter = 5; // å…¨ç¿’æ…£é”æˆãƒœãƒ¼ãƒŠã‚¹ï¼ˆã‚ã‚Šãˆãªã„ãŒå¿µã®ãŸã‚ï¼‰
                } else if (totalAchievedAfter === 3) {
                    bonusAfter = 3; // 3ç¿’æ…£ãƒœãƒ¼ãƒŠã‚¹
                } else if (totalAchievedAfter === 2) {
                    bonusAfter = 1; // 2ç¿’æ…£ãƒœãƒ¼ãƒŠã‚¹
                }
                
                // å·®åˆ†ã‚’è¨ˆç®—ï¼ˆå¤±ã‚ã‚Œã‚‹ãƒœãƒ¼ãƒŠã‚¹ï¼‰
                comboDeduction = bonusBefore - bonusAfter;
                
                // ãƒã‚¤ãƒ³ãƒˆæ¸›ç®—ï¼ˆåŸºæœ¬ãƒã‚¤ãƒ³ãƒˆ + ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼‰
                const totalDeduction = actualPoints + comboDeduction;
                data.pointSystem.currentPoints = Math.max(0, data.pointSystem.currentPoints - totalDeduction);
                
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²ï¼ˆhabitIdã‚’å«ã‚ã‚‹ï¼‰
                data.pointSystem.transactions.unshift({
                    type: 'deduct',
                    amount: totalDeduction,
                    source: 'habit_cancel',
                    description: `${window.currentHypothesis.title} å–ã‚Šæ¶ˆã—${comboDeduction > 0 ? ' (ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹å«ã‚€)' : ''}`,
                    timestamp: new Date().toISOString(),
                    habitId: window.currentHypothesis.id
                });
                
                // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’100ä»¶ã«åˆ¶é™
                if (data.pointSystem.transactions.length > 100) {
                    data.pointSystem.transactions = data.pointSystem.transactions.slice(0, 100);
                }
                
                // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index] = window.currentHypothesis;
                }
                
                saveData(data);
                updatePointDisplay();
                updateProgress();
                updateCalendar();
                let message = `ç¿’æ…£ã®é”æˆã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ (-${actualPoints}pt)`;
                if (comboDeduction > 0) {
                    message += `\nã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ã‚‚æ¸›ç®— (-${comboDeduction}pt)`;
                }
                showNotification(message, 'info');
            }
        }
        
        // é€±ç•ªå·ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ï¼‰ - æ¤œè¨¼é–‹å§‹æ—¥åŸºæº–
        function getWeekNumber(date, startDate) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            const start = new Date(startDate || window.currentHypothesis.startDate);
            start.setHours(0, 0, 0, 0);
            const days = Math.floor((d - start) / (24 * 60 * 60 * 1000));
            return Math.floor(days / 7) + 1;  // 1é€±ç›®ã‹ã‚‰é–‹å§‹
        }
        
        // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯
        function checkResetRisk() {
            if (!window.currentHypothesis || !window.currentHypothesis.resetRisk) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // éå»3æ—¥é–“ã®é”æˆçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
            let consecutiveFailures = 0;
            for (let i = 1; i <= 3; i++) {
                const checkDate = new Date(today);
                checkDate.setDate(checkDate.getDate() - i);
                const dateKey = dateKeyLocal(checkDate);
                
                // ãã®æ—¥ãŒç¿’æ…£æœŸé–“å†…ã‹ãƒã‚§ãƒƒã‚¯
                const startDate = new Date(window.currentHypothesis.startDate);
                startDate.setHours(0, 0, 0, 0);
                
                if (checkDate >= startDate && !window.currentHypothesis.achievements[dateKey]) {
                    consecutiveFailures++;
                } else {
                    break; // é”æˆã—ã¦ã„ã‚Œã°é€£ç¶šå¤±æ•—ã§ã¯ãªã„
                }
            }
            
            // 3æ—¥é€£ç¶šã§æœªé”æˆã®å ´åˆã€å…¨ã¦ã®é”æˆã‚’ãƒªã‚»ãƒƒãƒˆ
            if (consecutiveFailures >= 3) {
                window.currentHypothesis.achievements = {};
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                const data = loadData();
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index] = window.currentHypothesis;
                    saveData(data);
                }
                
                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                showCardEffect('ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ç™ºå‹•ï¼', '3æ—¥é€£ç¶šæœªé”æˆã«ã‚ˆã‚Šã€å…¨ã¦ã®é”æˆãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ', '#dc2626');
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨é€²æ—ã‚’æ›´æ–°
                updateCalendar();
                updateProgress();
            }
        }

        // é”æˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
        function showAchievementAnimation() {
            // è¤‡æ•°ã®çµµæ–‡å­—ã‚’åŒæ™‚ã«è¡¨ç¤º
            const emojis = ['ğŸ‰', 'âœ¨', 'ğŸŒŸ', 'â­', 'ğŸŠ', 'ğŸ’«', 'ğŸ†', 'ğŸ”¥', 'ğŸ’ª', 'ğŸš€', 'ğŸ¯', 'ğŸ¥³', 'ğŸ‘', 'ğŸ’¯'];
            const numberOfEmojis = 8;
            
            for (let i = 0; i < numberOfEmojis; i++) {
                setTimeout(() => {
                    const emoji = emojis[Math.floor(Math.random() * emojis.length)];
                    const animation = document.createElement('div');
                    animation.className = 'achievement-animation';
                    animation.textContent = emoji;
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‹ã‚‰é–‹å§‹
                    const startX = Math.random() * window.innerWidth;
                    const startY = window.innerHeight / 2 + (Math.random() - 0.5) * 200;
                    
                    animation.style.left = startX + 'px';
                    animation.style.top = startY + 'px';
                    
                    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–¹å‘ã«é£›ã°ã™
                    const angle = Math.random() * Math.PI * 2;
                    const distance = 200 + Math.random() * 300;
                    const endX = startX + Math.cos(angle) * distance;
                    const endY = startY + Math.sin(angle) * distance - 200; // ä¸Šæ–¹å‘ã«åã‚‰ã›ã‚‹
                    
                    animation.style.setProperty('--startX', startX + 'px');
                    animation.style.setProperty('--startY', startY + 'px');
                    animation.style.setProperty('--endX', endX + 'px');
                    animation.style.setProperty('--endY', endY + 'px');
                    
                    document.body.appendChild(animation);
                    
                    setTimeout(() => {
                        animation.remove();
                    }, 2000);
                }, i * 100); // å°‘ã—ãšã¤é…ã‚‰ã›ã¦è¡¨ç¤º
            }
        }

        // é€²æ—ã‚’æ›´æ–°
        function updateProgress() {
            const startDate = new Date(window.currentHypothesis.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // é–‹å§‹æ—¥ã‚’0æ™‚0åˆ†0ç§’ã«è¨­å®š
            startDate.setHours(0, 0, 0, 0);
            
            // çµŒéæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆé–‹å§‹æ—¥ã‚’1æ—¥ç›®ã¨ã—ã¦è¨ˆç®—ï¼‰
            const timeDiff = today.getTime() - startDate.getTime();
            // ç„¡æœŸé™ã®å ´åˆã¯å®Ÿéš›ã®çµŒéæ—¥æ•°ã‚’ä½¿ç”¨
            const daysPassed = window.currentHypothesis.isUnlimited 
                ? Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1)
                : Math.min(
                    Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1),
                    window.currentHypothesis.totalDays
                );
            
            // é »åº¦ã«å¿œã˜ã¦ç›®æ¨™æ—¥æ•°ã‚’è¨ˆç®—
            let targetDays = daysPassed;
            const frequency = window.currentHypothesis.frequency;
            
            if (frequency) {
                if (frequency.type === 'weekly') {
                    // é€±å˜ä½ã®å ´åˆï¼šçµŒéé€±æ•° Ã— é€±ã‚ãŸã‚Šã®å›æ•°
                    const weeks = Math.ceil(daysPassed / 7);
                    targetDays = Math.min(weeks * frequency.count, daysPassed);
                } else if (frequency.type === 'weekdays') {
                    // ç‰¹å®šæ›œæ—¥ã®å ´åˆï¼šè©²å½“ã™ã‚‹æ›œæ—¥ã®æ•°ã‚’æ•°ãˆã‚‹
                    targetDays = 0;
                    for (let i = 0; i < daysPassed; i++) {
                        const checkDate = new Date(startDate);
                        checkDate.setDate(startDate.getDate() + i);
                        if (frequency.weekdays.includes(checkDate.getDay())) {
                            targetDays++;
                        }
                    }
                }
            }
            
            const achievedDays = Object.keys(window.currentHypothesis.achievements).length;
            const achievementRate = targetDays > 0 ? Math.round((achievedDays / targetDays) * 100) : 0;
            
            // è¡¨ç¤ºç”¨ã®é”æˆç‡: å…¨æ—¥æ•°ã‚’åˆ†æ¯ã«ã€å„é”æˆæ—¥ã®å¼·åº¦å€ç‡ã‚’é©ç”¨ã—ãŸåˆè¨ˆã‚’åˆ†å­ã«
            const todayKey = dateKeyLocal(new Date());
            const intensity = window.currentHypothesis.intensity || {};
            let weightedAchieved = 0;
            for (let i = 0; i < window.currentHypothesis.totalDays; i++) {
                const d = new Date(startDate);
                d.setDate(startDate.getDate() + i);
                const key = dateKeyLocal(d);
                const isAchieved = !!(window.currentHypothesis.achievements || {})[key];
                if (!isAchieved) continue;
                const mult = Number(intensity[key] ?? 1.0);
                weightedAchieved += mult;
            }
            const displayRate = Math.min(100, Math.floor((weightedAchieved / window.currentHypothesis.totalDays) * 100));
            const rateEl = document.getElementById('achievement-rate');
            rateEl.textContent = displayRate + '%';
            document.getElementById('progress-fill').style.width = Math.min(100, Math.floor(achievementRate)) + '%';
            document.getElementById('achieved-days').textContent = `é”æˆ: ${achievedDays}æ—¥`;
            // ç„¡æœŸé™ã®å ´åˆã¯æ®‹ã‚Šæ—¥æ•°ã‚’è¡¨ç¤ºã—ãªã„
            const remainingText = window.currentHypothesis.isUnlimited 
                ? 'ç¶™ç¶šä¸­' 
                : `æ®‹ã‚Š: ${window.currentHypothesis.totalDays - daysPassed}æ—¥`;
            document.getElementById('remaining-days').textContent = remainingText;
            
            // é”æˆç‡ã«å¿œã˜ã¦ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´
            const progressFill = document.getElementById('progress-fill');
            if (achievementRate >= 80) {
                progressFill.style.background = 'var(--gradient-1)';
            } else if (achievementRate >= 50) {
                progressFill.style.background = 'var(--gradient-2)';
            } else {
                progressFill.style.background = 'var(--gradient-3)';
            }

            // ã‚µãƒ—ãƒ©ã‚¤ã‚ºæ¼”å‡ºï¼ˆ7/14/21æ—¥ç›®ï¼‰
            triggerSurpriseIfNeeded(window.currentHypothesis, daysPassed);
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåŠ¹æœã‚’è¡¨ç¤º
            const data = loadData();
            const activeEffectsDisplay = document.getElementById('active-effects-display');
            const activeEffectsList = document.getElementById('active-effects-list');
            
            activeEffectsList.innerHTML = '';
            let hasActiveEffects = false;
            
            // é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã®ãƒã‚§ãƒƒã‚¯
            if (data.cards && data.cards.activeEffects) {
                const achievementBooster = data.cards.activeEffects.find(effect => 
                    effect.cardId === 'achievement_booster' && 
                    (!effect.targetHypothesisId || effect.targetHypothesisId === window.currentHypothesis.id)
                );
                
                if (achievementBooster) {
                    hasActiveEffects = true;
                    const effectElement = document.createElement('div');
                    effectElement.style.cssText = 'background: rgba(16, 185, 129, 0.2); color: #10b981; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #10b981;';
                    effectElement.textContent = 'ğŸš€ é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ (+15%)';
                    activeEffectsList.appendChild(effectElement);
                }
            }

            // ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆã®è¡¨ç¤º
            if (data.cards && data.cards.activeEffects) {
                const surprise = data.cards.activeEffects.find(effect => 
                    effect.cardId === 'surprise_boost' && 
                    (!effect.targetHypothesisId || effect.targetHypothesisId === window.currentHypothesis.id)
                );
                if (surprise) {
                    hasActiveEffects = true;
                    const effectElement = document.createElement('div');
                    effectElement.style.cssText = 'background: rgba(59, 130, 246, 0.2); color: #3b82f6; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #3b82f6;';
                    effectElement.textContent = 'ğŸ ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆï¼ˆæ¬¡ã®çµæœã§ãƒ¬ã‚¢ç‡UPï¼‰';
                    activeEffectsList.appendChild(effectElement);
                }
            }
            
            // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
            if (window.currentHypothesis.hardMode) {
                hasActiveEffects = true;
                const effectElement = document.createElement('div');
                effectElement.style.cssText = 'background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #ef4444;';
                effectElement.textContent = 'ğŸ’€ ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰';
                activeEffectsList.appendChild(effectElement);
            }
            
            // çŸ­æœŸé–“ç¸›ã‚Šã®ãƒã‚§ãƒƒã‚¯
            if (window.currentHypothesis.shortTermOnly) {
                hasActiveEffects = true;
                const effectElement = document.createElement('div');
                effectElement.style.cssText = 'background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #ef4444;';
                effectElement.textContent = 'â±ï¸ çŸ­æœŸé–“ç¸›ã‚Š';
                activeEffectsList.appendChild(effectElement);
            }
            
            // é”æˆç‡æ¸›å°‘ã®ãƒã‚§ãƒƒã‚¯
            if (window.currentHypothesis.achievementDecrease) {
                hasActiveEffects = true;
                const effectElement = document.createElement('div');
                effectElement.style.cssText = 'background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #ef4444;';
                effectElement.textContent = `ğŸ“‰ é”æˆç‡æ¸›å°‘ (-${window.currentHypothesis.achievementDecrease}%)`;
                activeEffectsList.appendChild(effectElement);
            }
            
            // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ã®ãƒã‚§ãƒƒã‚¯
            if (window.currentHypothesis.resetRisk) {
                hasActiveEffects = true;
                const effectElement = document.createElement('div');
                effectElement.style.cssText = 'background: rgba(239, 68, 68, 0.2); color: #ef4444; padding: 4px 12px; border-radius: 16px; font-size: 12px; border: 1px solid #ef4444;';
                effectElement.textContent = 'ğŸ”„ ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯';
                activeEffectsList.appendChild(effectElement);
            }
            
            activeEffectsDisplay.style.display = hasActiveEffects ? 'block' : 'none';
            
            // æœŸé–“ãŒçµ‚äº†ã—ãŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€çµ‚æ—¥ä»¥é™ï¼‰
            // ç„¡æœŸé™ã®å ´åˆã¯å®Œäº†å ±å‘Šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
            if (!window.currentHypothesis.isUnlimited && daysPassed >= window.currentHypothesis.totalDays && !window.currentHypothesis.completed) {
                // å®Œäº†å ±å‘Šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                document.getElementById('completion-report-section').style.display = 'block';
                // è‡ªå‹•çš„ã«å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯è¡¨ç¤ºã—ãªã„
                document.getElementById('completion-options').style.display = 'none';
            } else {
                document.getElementById('completion-report-section').style.display = 'none';
                document.getElementById('completion-options').style.display = 'none';
            }

            // é€²æ—ç”»é¢ã«ã‚¹ãƒˆãƒªãƒ¼ã‚¯è¡¨ç¤ºã‚’åæ˜ 
            const streak = computeStreak(window.currentHypothesis);
            let streakEl = document.getElementById('streak-indicator');
            if (!streakEl) {
                streakEl = document.createElement('div');
                streakEl.id = 'streak-indicator';
                streakEl.style.cssText = 'margin-top:8px;color:#f59e0b;font-weight:700;';
                const stats = document.querySelector('#progress-view .stats');
                const container = stats || document.getElementById('progress-view');
                container.appendChild(streakEl);
            }
            streakEl.textContent = `ğŸ”¥ é€£ç¶šé”æˆæ—¥æ•°: ${streak}æ—¥`;

            
            // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
            renderCategoryPanel();
        }

        // ã‚«ãƒ†ã‚´ãƒªå¤‰æ›´ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function renderCategoryPanel() {
            if (!window.currentHypothesis) return;
            const hyp = window.currentHypothesis;
            const data = loadData();
            
            // ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ãƒ¼ã®åˆæœŸåŒ–
            if (!data.categoryMaster) {
                data.categoryMaster = {
                    study: { name: 'å‹‰å¼·', icon: 'ğŸ“š', color: '#3b82f6' },
                    exercise: { name: 'é‹å‹•', icon: 'ğŸ’ª', color: '#ef4444' },
                    health: { name: 'å¥åº·', icon: 'ğŸ§˜', color: '#10b981' },
                    work: { name: 'ä»•äº‹', icon: 'ğŸ’¼', color: '#f59e0b' },
                    hobby: { name: 'è¶£å‘³', icon: 'ğŸ¨', color: '#8b5cf6' },
                    other: { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' }
                };
                saveData(data);
            }
            
            const categoryInfo = data.categoryMaster[hyp.category] || 
                                { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' };
            
            let panel = document.getElementById('category-change-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'category-change-panel';
                panel.style.cssText = 'margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);';
                
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å¾Œã€å¼·åº¦ãƒ‘ãƒãƒ«ã®å‰ã«æŒ¿å…¥
                const parent = document.getElementById('progress-view');
                const intensityPanel = document.getElementById('intensity-panel');
                if (intensityPanel) {
                    parent.insertBefore(panel, intensityPanel);
                } else {
                    parent.appendChild(panel);
                }
            }
            
            panel.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
                    <div style="display:flex;flex-direction:column;gap:4px;">
                        <div style="font-weight:700;">ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒª</div>
                        <div style="color: var(--text-secondary);font-size:12px;">ç¿’æ…£ã®ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã§ãã¾ã™</div>
                    </div>
                    <button class="btn btn-secondary" onclick="editHypothesisCategory()" style="padding:8px 16px;border-radius:10px;display:flex;align-items:center;gap:8px;">
                        <span style="font-size:20px;">${categoryInfo.icon}</span>
                        <span>${categoryInfo.name}</span>
                        <span>å¤‰æ›´</span>
                    </button>
                </div>
            `;
        }

        // å¼·åº¦ï¼ˆIntensityï¼‰ãƒ‘ãƒãƒ«ï¼ˆå„ç¿’æ…£ã”ã¨ã«ãƒ©ãƒ™ãƒ«3ç¨®ã‚’ç·¨é›†å¯èƒ½ï¼‰
        function renderIntensityPanel() {
            if (!window.currentHypothesis) return;
            const hyp = window.currentHypothesis;
            hyp.intensity = hyp.intensity || {};
            const todayKey = dateKeyLocal(new Date());
            const selected = Number(hyp.intensity[todayKey] ?? 1.0);
            const todayAchieved = !!(hyp.achievements || {})[todayKey];
            // å¼·åº¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ©ãƒ™ãƒ«ï¼‹å€ç‡ï¼‰ã‚’ç¿’æ…£ã”ã¨ã«ä¿æŒ
            if (!hyp.intensityOptions || !Array.isArray(hyp.intensityOptions) || hyp.intensityOptions.length !== 3) {
                hyp.intensityOptions = [
                    { label: 'è»½ã‚', mult: 0.8 },
                    { label: 'åŸºæœ¬', mult: 1.0 },
                    { label: 'é«˜å¼·åº¦', mult: 1.2 },
                ];
                const data0 = loadData();
                const idx0 = data0.currentHypotheses.findIndex(h => h.id === hyp.id);
                if (idx0 !== -1) { data0.currentHypotheses[idx0] = hyp; saveData(data0); }
            }

            let panel = document.getElementById('intensity-panel');
            if (!panel) {
                panel = document.createElement('div');
                panel.id = 'intensity-panel';
                panel.style.cssText = 'margin-top:12px;padding:12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);';
                const parent = document.getElementById('progress-view');
                parent.appendChild(panel);
            }

            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸æŠã§ããªã„ã‚ˆã†ã«ï¼‰ã€é¸æŠçŠ¶æ…‹ã‚‚è¡¨ç¤ºã—ãªã„
            const btnStyle = (active) => `
                padding:8px 12px;border-radius:10px;border:1px solid var(--border);
                background:transparent;color:var(--text-secondary);
                cursor:not-allowed;opacity:0.5;`

            const opt0 = hyp.intensityOptions[0];
            const opt1 = hyp.intensityOptions[1];
            const opt2 = hyp.intensityOptions[2];
            const label0 = (typeof escapeHTML === 'function') ? escapeHTML(opt0.label) : opt0.label;
            const label1 = (typeof escapeHTML === 'function') ? escapeHTML(opt1.label) : opt1.label;
            const label2 = (typeof escapeHTML === 'function') ? escapeHTML(opt2.label) : opt2.label;

            panel.innerHTML = `
                <div style=\"display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;\">
                    <div style=\"display:flex;flex-direction:column;gap:4px;\">
                        <div style=\"font-weight:700;\">ğŸ’ª ä»Šæ—¥ã®å¼·åº¦</div>
                        <div style=\"color: var(--text-secondary);font-size:12px;\">å„ç¿’æ…£ã”ã¨ã«3ã¤ã®å¼·åº¦ãƒ©ãƒ™ãƒ«ã‚’ç·¨é›†ã§ãã¾ã™</div>
                    </div>
                    <div style=\"display:flex;gap:8px;align-items:center;\">
                        <button id=\"intensity-opt-0\" style=\"${btnStyle(selected===opt0.mult)}\">${label0} (Ã—${opt0.mult})</button>
                        <button id=\"intensity-opt-1\" style=\"${btnStyle(selected===opt1.mult)}\">${label1} (Ã—${opt1.mult})</button>
                        <button id=\"intensity-opt-2\" style=\"${btnStyle(selected===opt2.mult)}\">${label2} (Ã—${opt2.mult})</button>
                        <button id=\"intensity-edit\" class=\"btn btn-secondary\" style=\"margin-left:8px;padding:8px 12px;\">ç·¨é›†</button>
                    </div>
                </div>
                <div style=\"margin-top:8px;color:#94a3b8;font-size:12px;\">
                    é”æˆæ—¥ã«è¨­å®šã—ãŸå¼·åº¦å€ç‡ã‚’é‡ã¿ã¨ã—ã¦é©ç”¨ã—ã€è¡¨ç¤ºé”æˆç‡ã¯å…¨æ—¥æ•°ã‚’åˆ†æ¯ã«è¨ˆç®—ã—ã¾ã™ã€‚
                </div>
                
                <!-- ä¼‘çœ ãƒœã‚¿ãƒ³ -->
                <div style=\"margin-top:16px; padding-top:16px; border-top:1px solid var(--border);\">
                    <button onclick=\"toggleSleepMode()\" class=\"btn\" style=\"width:100%; padding:12px; font-size:14px; background: ${hyp.isSleeping ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)'}; color: white;\">
                        ${hyp.isSleeping ? 'ğŸŒ… ç¿’æ…£ã‚’å†é–‹ã™ã‚‹' : 'ğŸ˜´ ç¿’æ…£ã‚’ä¼‘çœ ã•ã›ã‚‹'}
                    </button>
                    ${hyp.isSleeping ? `
                        <div style=\"margin-top:8px; padding:8px; background: rgba(148, 163, 184, 0.1); border-radius:8px; font-size:12px; color: var(--text-secondary);\">
                            ğŸ“Œ ä¼‘çœ é–‹å§‹: ${new Date(hyp.sleepStartDate).toLocaleDateString('ja-JP')}
                        </div>
                    ` : `
                        <div style=\"margin-top:8px; font-size:11px; color: var(--text-secondary);\">
                            â€» ä¼‘çœ ä¸­ã¯é”æˆç‡ã®è¨ˆç®—ã‹ã‚‰é™¤å¤–ã•ã‚Œã€ã‚¹ãƒˆãƒªãƒ¼ã‚¯ã¯ä¿æŒã•ã‚Œã¾ã™
                        </div>
                    `}
                </div>
            `;

            const set = (m) => {
                hyp.intensity[todayKey] = m;
                const data = loadData();
                const idx = data.currentHypotheses.findIndex(h => h.id === hyp.id);
                if (idx !== -1) data.currentHypotheses[idx] = hyp;
                saveData(data);
                renderIntensityPanel();
                updateProgress();
            };
            const b0 = document.getElementById('intensity-opt-0');
            const b1 = document.getElementById('intensity-opt-1');
            const b2 = document.getElementById('intensity-opt-2');
            const be = document.getElementById('intensity-edit');
            if (be) be.onclick = () => editIntensityOptions();

            // å¼·åº¦é¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠã™ã‚‹ãŸã‚ï¼‰
            [b0, b1, b2].forEach(btn => {
                if (btn) {
                    btn.disabled = true;
                    btn.style.cursor = 'not-allowed';
                    btn.title = 'å¼·åº¦ã®é¸æŠã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„';
                }
            });
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç„¡åŠ¹åŒ–
            if (b0) b0.onclick = (e) => { e.preventDefault(); showNotification('å¼·åº¦ã®é¸æŠã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡Œã£ã¦ãã ã•ã„', 'info'); };
            if (b1) b1.onclick = (e) => { e.preventDefault(); showNotification('å¼·åº¦ã®é¸æŠã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡Œã£ã¦ãã ã•ã„', 'info'); };
            if (b2) b2.onclick = (e) => { e.preventDefault(); showNotification('å¼·åº¦ã®é¸æŠã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡Œã£ã¦ãã ã•ã„', 'info'); };
        }

        // å¼·åº¦ãƒ©ãƒ™ãƒ«/å€ç‡ã®ç·¨é›†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆUIï¼‰
        // ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ãƒ¼ã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
        function editCategoryMaster() {
            const data = loadData();
            if (!data.categoryMaster) {
                data.categoryMaster = {
                    study: { name: 'å‹‰å¼·', icon: 'ğŸ“š', color: '#3b82f6' },
                    exercise: { name: 'é‹å‹•', icon: 'ğŸ’ª', color: '#ef4444' },
                    health: { name: 'å¥åº·', icon: 'ğŸ§˜', color: '#10b981' },
                    work: { name: 'ä»•äº‹', icon: 'ğŸ’¼', color: '#f59e0b' },
                    hobby: { name: 'è¶£å‘³', icon: 'ğŸ¨', color: '#8b5cf6' },
                    other: { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' }
                };
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '600px';
            modal.style.padding = '20px';
            modal.style.maxHeight = '80vh';
            modal.style.overflowY = 'auto';
            
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>âš™ï¸ ã‚«ãƒ†ã‚´ãƒªã®ç·¨é›†</h3>
                    <p>ã‚«ãƒ†ã‚´ãƒªåã€ã‚¢ã‚¤ã‚³ãƒ³ã€è‰²ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™</p>
                </div>
                
                <div style="margin: 20px 0;">
                    ${Object.entries(data.categoryMaster).map(([key, cat]) => `
                        <div style="margin-bottom: 16px; padding: 12px; background: rgba(30, 41, 59, 0.5); border-radius: 8px; border: 1px solid var(--border);">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 24px;" id="icon-preview-${key}">${cat.icon}</span>
                                <span style="font-weight: 600; font-size: 16px;" id="name-preview-${key}">${cat.name}</span>
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: ${cat.color};" id="color-preview-${key}"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 80px 100px; gap: 8px;">
                                <input type="text" id="name-${key}" value="${cat.name}" placeholder="ã‚«ãƒ†ã‚´ãƒªå" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface);">
                                <input type="text" id="icon-${key}" value="${cat.icon}" placeholder="ğŸ“" style="padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--surface); text-align: center;">
                                <input type="color" id="color-${key}" value="${cat.color}" style="width: 100%; height: 32px; border-radius: 6px; border: 1px solid var(--border); cursor: pointer;">
                            </div>
                        </div>
                    `).join('')}
                    
                    <button class="btn btn-secondary" onclick="addNewCategory()" style="width: 100%; margin-top: 12px; padding: 10px;">
                        â• æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
                    </button>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="button secondary" id="cat-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" id="cat-save">ä¿å­˜</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            Object.keys(data.categoryMaster).forEach(key => {
                const nameInput = document.getElementById(`name-${key}`);
                const iconInput = document.getElementById(`icon-${key}`);
                const colorInput = document.getElementById(`color-${key}`);
                
                if (nameInput) nameInput.oninput = () => {
                    document.getElementById(`name-preview-${key}`).textContent = nameInput.value || 'ã‚«ãƒ†ã‚´ãƒª';
                };
                if (iconInput) iconInput.oninput = () => {
                    document.getElementById(`icon-preview-${key}`).textContent = iconInput.value || 'ğŸ“';
                };
                if (colorInput) colorInput.oninput = () => {
                    document.getElementById(`color-preview-${key}`).style.background = colorInput.value;
                };
            });
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            document.getElementById('cat-cancel').onclick = () => overlay.remove();
            
            // ä¿å­˜
            document.getElementById('cat-save').onclick = () => {
                Object.keys(data.categoryMaster).forEach(key => {
                    const name = document.getElementById(`name-${key}`).value.trim();
                    const icon = document.getElementById(`icon-${key}`).value.trim();
                    const color = document.getElementById(`color-${key}`).value;
                    
                    if (name) data.categoryMaster[key].name = name;
                    if (icon) data.categoryMaster[key].icon = icon;
                    if (color) data.categoryMaster[key].color = color;
                });
                
                saveData(data);
                overlay.remove();
                showNotification('ã‚«ãƒ†ã‚´ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
                updateCategoryDropdowns();  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                updateCurrentHypothesisList();
            };
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
        function initializeCategoryMaster() {
            const data = loadData();
            if (!data.categoryMaster) {
                data.categoryMaster = {
                    study: { name: 'å‹‰å¼·', icon: 'ğŸ“š', color: '#3b82f6' },
                    exercise: { name: 'é‹å‹•', icon: 'ğŸ’ª', color: '#ef4444' },
                    health: { name: 'å¥åº·', icon: 'ğŸ§˜', color: '#10b981' },
                    work: { name: 'ä»•äº‹', icon: 'ğŸ’¼', color: '#f59e0b' },
                    hobby: { name: 'è¶£å‘³', icon: 'ğŸ¨', color: '#8b5cf6' },
                    other: { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' }
                };
                saveData(data);
            }
            return data.categoryMaster;
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        function updateCategoryDropdowns() {
            try {
                const categoryMaster = initializeCategoryMaster();
                
                // ãƒ›ãƒ¼ãƒ ç”»é¢ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                const filterSelect = document.getElementById('category-filter');
                if (filterSelect) {
                    const currentValue = filterSelect.value || localStorage.getItem('selectedCategory') || 'all';
                    filterSelect.innerHTML = '<option value="all">ğŸ“‚ å…¨ã¦è¡¨ç¤º</option>';
                    Object.entries(categoryMaster).forEach(([key, cat]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        filterSelect.appendChild(option);
                    });
                    filterSelect.value = currentValue;
                }
                
                // æ–°è¦ç«‹æ¡ˆç”»é¢ã®ã‚«ãƒ†ã‚´ãƒªé¸æŠ
                const categorySelect = document.getElementById('hypothesis-category');
                if (categorySelect) {
                    const currentValue = categorySelect.value || localStorage.getItem('selectedCategory') || 'other';
                    categorySelect.innerHTML = '';
                    Object.entries(categoryMaster).forEach(([key, cat]) => {
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${cat.icon} ${cat.name}`;
                        categorySelect.appendChild(option);
                    });
                    // ãƒ›ãƒ¼ãƒ ç”»é¢ã§é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã‚’è¨­å®š
                    const selectedCategory = localStorage.getItem('selectedCategory');
                    if (selectedCategory && selectedCategory !== 'all') {
                        categorySelect.value = selectedCategory;
                    } else {
                        categorySelect.value = currentValue;
                    }
                }
            } catch (e) {
                console.error('ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®æ›´æ–°ã«å¤±æ•—:', e);
            }
        }
        
        // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
        function addNewCategory() {
            const data = loadData();
            const categoryMaster = data.categoryMaster || {};
            
            // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã®IDã‚’ç”Ÿæˆ
            let newKey = 'custom_' + Date.now();
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
            categoryMaster[newKey] = {
                name: 'æ–°ã‚«ãƒ†ã‚´ãƒª',
                icon: 'âœ¨',
                color: '#' + Math.floor(Math.random()*16777215).toString(16)
            };
            
            data.categoryMaster = categoryMaster;
            saveData(data);
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
            const modal = document.querySelector('.skip-modal');
            if (modal) {
                modal.remove();
            }
            const overlay = document.querySelector('.overlay');
            if (overlay) {
                overlay.remove();
            }
            
            editCategoryMaster();
            showNotification('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
        }
        
        // æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
        window.addNewCategory = function() {
            const categoryKey = prompt('ã‚«ãƒ†ã‚´ãƒªã®IDï¼ˆè‹±æ•°å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            if (!categoryKey || !/^[a-z0-9]+$/i.test(categoryKey)) {
                showNotification('ã‚«ãƒ†ã‚´ãƒªIDã¯è‹±æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const data = loadData();
            if (data.categoryMaster[categoryKey]) {
                showNotification('ãã®IDã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™', 'error');
                return;
            }
            
            data.categoryMaster[categoryKey] = {
                name: 'æ–°ã‚«ãƒ†ã‚´ãƒª',
                icon: 'âœ¨',
                color: '#' + Math.floor(Math.random()*16777215).toString(16)
            };
            
            saveData(data);
            editCategoryMaster(); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†è¡¨ç¤º
        }
        
        // é »åº¦ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´ã™ã‚‹é–¢æ•°
        function editFrequencyType() {
            if (!window.currentHypothesis) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '520px';
            modal.style.padding = '20px';
            
            const currentFreq = window.currentHypothesis.frequency || { type: 'daily' };
            
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸ”„ é »åº¦ã‚¿ã‚¤ãƒ—ã®å¤‰æ›´</h3>
                    <p>ç¿’æ…£ã®å®Ÿæ–½é »åº¦ã‚’å¤‰æ›´ã—ã¾ã™</p>
                </div>
                
                <div class="form-group" style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 12px; font-weight: 600;">é »åº¦ã‚¿ã‚¤ãƒ—</label>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid ${currentFreq.type === 'daily' ? '#10b981' : 'var(--border)'}; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="freq-type" value="daily" ${currentFreq.type === 'daily' ? 'checked' : ''} style="margin-right: 12px;">
                            <div>
                                <div style="font-weight: 600;">â˜€ï¸ æ¯æ—¥å®Ÿæ–½</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">æ¯æ—¥ç¿’æ…£ã‚’å®Ÿæ–½ã—ã¾ã™</div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid ${currentFreq.type === 'weekly' ? '#10b981' : 'var(--border)'}; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="freq-type" value="weekly" ${currentFreq.type === 'weekly' ? 'checked' : ''} style="margin-right: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">ğŸ“… é€±Nå›å®Ÿæ–½</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">é€±ã«æŒ‡å®šå›æ•°ã ã‘å®Ÿæ–½ã—ã¾ã™</div>
                                <div id="weekly-count-container" style="margin-top: 8px; display: ${currentFreq.type === 'weekly' ? 'block' : 'none'};">
                                    <label style="font-size: 12px;">é€±ã«<input type="number" id="weekly-count" min="1" max="7" value="${currentFreq.count || 3}" style="width: 50px; margin: 0 4px; padding: 4px; border-radius: 4px; border: 1px solid var(--border);"/>å›</label>
                                </div>
                            </div>
                        </label>
                        
                        <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid ${currentFreq.type === 'weekdays' ? '#10b981' : 'var(--border)'}; border-radius: 8px; cursor: pointer;">
                            <input type="radio" name="freq-type" value="weekdays" ${currentFreq.type === 'weekdays' ? 'checked' : ''} style="margin-right: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">ğŸ“† æ›œæ—¥æŒ‡å®š</div>
                                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">ç‰¹å®šã®æ›œæ—¥ã«ã®ã¿å®Ÿæ–½ã—ã¾ã™</div>
                                <div id="weekdays-container" style="margin-top: 8px; display: ${currentFreq.type === 'weekdays' ? 'flex' : 'none'}; gap: 6px; flex-wrap: wrap;">
                                    ${['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map((day, i) => `
                                        <label style="display: flex; align-items: center; padding: 4px 8px; background: ${(currentFreq.weekdays || []).includes(i) ? 'rgba(16, 185, 129, 0.2)' : 'transparent'}; border: 1px solid ${(currentFreq.weekdays || []).includes(i) ? '#10b981' : 'var(--border)'}; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            <input type="checkbox" name="weekday" value="${i}" ${(currentFreq.weekdays || []).includes(i) ? 'checked' : ''} style="margin-right: 4px;"/>
                                            ${day}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="button secondary" id="freq-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" id="freq-save">ä¿å­˜</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            modal.querySelectorAll('input[name="freq-type"]').forEach(radio => {
                radio.onchange = () => {
                    // ã™ã¹ã¦ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
                    modal.querySelectorAll('label').forEach(label => {
                        if (label.querySelector('input[type="radio"]')) {
                            label.style.border = '2px solid var(--border)';
                        }
                    });
                    
                    // é¸æŠã•ã‚ŒãŸãƒœãƒ¼ãƒ€ãƒ¼ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    radio.closest('label').style.border = '2px solid #10b981';
                    
                    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
                    document.getElementById('weekly-count-container').style.display = radio.value === 'weekly' ? 'block' : 'none';
                    document.getElementById('weekdays-container').style.display = radio.value === 'weekdays' ? 'flex' : 'none';
                };
            });
            
            // æ›œæ—¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            modal.querySelectorAll('input[name="weekday"]').forEach(checkbox => {
                checkbox.onchange = () => {
                    const label = checkbox.closest('label');
                    if (checkbox.checked) {
                        label.style.background = 'rgba(16, 185, 129, 0.2)';
                        label.style.border = '1px solid #10b981';
                    } else {
                        label.style.background = 'transparent';
                        label.style.border = '1px solid var(--border)';
                    }
                };
            });
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            document.getElementById('freq-cancel').onclick = () => {
                overlay.remove();
            };
            
            // ä¿å­˜ãƒœã‚¿ãƒ³
            document.getElementById('freq-save').onclick = () => {
                const selectedType = modal.querySelector('input[name="freq-type"]:checked').value;
                
                let newFrequency = { type: selectedType };
                
                if (selectedType === 'weekly') {
                    const count = parseInt(document.getElementById('weekly-count').value);
                    if (count < 1 || count > 7) {
                        showNotification('é€±ã®å›æ•°ã¯1ã€œ7ã®é–“ã§æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
                        return;
                    }
                    newFrequency.count = count;
                } else if (selectedType === 'weekdays') {
                    const checkedDays = Array.from(modal.querySelectorAll('input[name="weekday"]:checked')).map(cb => parseInt(cb.value));
                    if (checkedDays.length === 0) {
                        showNotification('å°‘ãªãã¨ã‚‚1ã¤ã®æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                        return;
                    }
                    newFrequency.weekdays = checkedDays;
                }
                
                // ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                window.currentHypothesis.frequency = newFrequency;
                const data = loadData();
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index].frequency = newFrequency;
                    saveData(data);
                }
                
                overlay.remove();
                showNotification('é »åº¦ã‚¿ã‚¤ãƒ—ã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
                
                // é€²æ—ç”»é¢ã‚’å†è¡¨ç¤º
                showProgressView(window.currentHypothesis.id);
            };
        }
        
        // ç¿’æ…£ã®ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´
        function editHypothesisCategory() {
            if (!window.currentHypothesis) return;
            
            const data = loadData();
            if (!data.categoryMaster) {
                data.categoryMaster = {
                    study: { name: 'å‹‰å¼·', icon: 'ğŸ“š', color: '#3b82f6' },
                    exercise: { name: 'é‹å‹•', icon: 'ğŸ’ª', color: '#ef4444' },
                    health: { name: 'å¥åº·', icon: 'ğŸ§˜', color: '#10b981' },
                    work: { name: 'ä»•äº‹', icon: 'ğŸ’¼', color: '#f59e0b' },
                    hobby: { name: 'è¶£å‘³', icon: 'ğŸ¨', color: '#8b5cf6' },
                    other: { name: 'ãã®ä»–', icon: 'ğŸ“', color: '#6b7280' }
                };
            }
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            overlay.style.backdropFilter = 'blur(6px)';
            
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.maxWidth = '480px';
            modal.style.padding = '20px';
            
            const currentCategory = window.currentHypothesis.category || 'other';
            
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªã®å¤‰æ›´</h3>
                    <p>ã“ã®ç¿’æ…£ã®ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</p>
                </div>
                
                <div style="margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    ${Object.entries(data.categoryMaster).map(([key, cat]) => `
                        <label style="display: flex; align-items: center; padding: 12px; background: rgba(30, 41, 59, 0.5); border: 2px solid ${currentCategory === key ? cat.color : 'var(--border)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="category" value="${key}" ${currentCategory === key ? 'checked' : ''} style="margin-right: 12px;">
                            <span style="font-size: 20px; margin-right: 8px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </label>
                    `).join('')}
                </div>
                
                <div class="modal-footer" style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button class="button secondary" id="cat-change-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" id="cat-change-save">å¤‰æ›´</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
            modal.querySelectorAll('input[name="category"]').forEach(radio => {
                radio.onchange = () => {
                    modal.querySelectorAll('label').forEach(label => {
                        if (label.querySelector('input[type="radio"]')) {
                            const catKey = label.querySelector('input').value;
                            const catInfo = data.categoryMaster[catKey];
                            label.style.border = radio.value === catKey ? `2px solid ${catInfo.color}` : '2px solid var(--border)';
                        }
                    });
                };
            });
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            document.getElementById('cat-change-cancel').onclick = () => overlay.remove();
            
            // ä¿å­˜
            document.getElementById('cat-change-save').onclick = () => {
                const selectedCategory = modal.querySelector('input[name="category"]:checked').value;
                
                window.currentHypothesis.category = selectedCategory;
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index].category = selectedCategory;
                    saveData(data);
                }
                
                overlay.remove();
                showNotification('ã‚«ãƒ†ã‚´ãƒªã‚’å¤‰æ›´ã—ã¾ã—ãŸ', 'success');
                // ã‚«ãƒ†ã‚´ãƒªãƒ‘ãƒãƒ«ã‚’æ›´æ–°
                renderCategoryPanel();
                // é€²æ—ã‚’æ›´æ–°
                updateProgress();
            };
        }
        
        function editIntensityOptions() {
            if (!window.currentHypothesis) return;
            const hyp = window.currentHypothesis;
            hyp.intensityOptions = hyp.intensityOptions || [
                { label: 'è»½ã‚', mult: 0.8 },
                { label: 'åŸºæœ¬', mult: 1.0 },
                { label: 'é«˜å¼·åº¦', mult: 1.2 },
            ];
            const askLabel = (idx, placeholder) => {
                const v = prompt(`å¼·åº¦${idx+1}ã®ãƒ©ãƒ™ãƒ«`, placeholder);
                return v == null ? null : (v || '').trim();
            };
            const askMult = (idx, placeholder) => {
                const v = prompt(`å¼·åº¦${idx+1}ã®å€ç‡ï¼ˆ0.1ã€œ3.0ï¼‰`, String(placeholder));
                if (v == null) return null;
                const num = parseFloat(v);
                if (!isFinite(num)) return null;
                const clamped = Math.max(0.1, Math.min(3.0, num));
                return Math.round(clamped * 10) / 10; // å°æ•°1æ¡
            };

            const l0 = askLabel(0, hyp.intensityOptions[0].label); if (l0 == null) return;
            const m0 = askMult(0, hyp.intensityOptions[0].mult); if (m0 == null) return;
            const l1 = askLabel(1, hyp.intensityOptions[1].label); if (l1 == null) return;
            const m1 = askMult(1, hyp.intensityOptions[1].mult); if (m1 == null) return;
            const l2 = askLabel(2, hyp.intensityOptions[2].label); if (l2 == null) return;
            const m2 = askMult(2, hyp.intensityOptions[2].mult); if (m2 == null) return;

            hyp.intensityOptions[0].label = l0 || hyp.intensityOptions[0].label;
            hyp.intensityOptions[0].mult  = m0;
            hyp.intensityOptions[1].label = l1 || hyp.intensityOptions[1].label;
            hyp.intensityOptions[1].mult  = m1;
            hyp.intensityOptions[2].label = l2 || hyp.intensityOptions[2].label;
            hyp.intensityOptions[2].mult  = m2;
            const data = loadData();
            const idx = data.currentHypotheses.findIndex(h => h.id === hyp.id);
            if (idx !== -1) data.currentHypotheses[idx] = hyp;
            saveData(data);
            renderIntensityPanel();
        }


        function renderIfThenPanel() {
            const panel = document.getElementById('ifthen-panel');
            if (!panel || !window.currentHypothesis) return;
            const list = window.currentHypothesis.ifThen || [];
            panel.style.display = 'block';
            const items = list.map((it, i) => `
                <div style="display:flex;align-items:center;justify-content:space-between;gap:12px; padding:8px 0; border-bottom:1px solid var(--border);">
                    <div style="flex:1;">
                        <div><strong>ã‚‚ã—</strong> ${escapeHTML(it.if)}</div>
                        <div><strong>ãªã‚‰</strong> ${escapeHTML(it.then)}</div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" onclick="editIfThen(${i})">ç·¨é›†</button>
                        <button class="btn btn-secondary" onclick="deleteIfThen(${i})" style="margin-left:6px;">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');
            panel.innerHTML = `
                <h3 style="margin-bottom:12px;">ğŸ§  IF-THEN ãƒ«ãƒ¼ãƒ«</h3>
                ${items || '<div style="color: var(--text-secondary);">ãƒ«ãƒ¼ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'}
                <div style="margin-top:12px;">
                    <button class="btn" onclick="addIfThenInProgress()">ï¼‹ ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ </button>
                </div>
            `;
        }

        window.addIfThenInProgress = function() {
            const iff = prompt('ã‚‚ã—ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ã‚’å…¥åŠ›');
            if (iff == null) return;
            const thenv = prompt('ãªã‚‰ï¼ˆè¡Œå‹•ï¼‰ã‚’å…¥åŠ›');
            if (thenv == null) return;
            const ifv = (iff||'').trim();
            const tv = (thenv||'').trim();
            if (!ifv || !tv) return;
            window.currentHypothesis.ifThen = window.currentHypothesis.ifThen || [];
            window.currentHypothesis.ifThen.push({ id: Date.now().toString()+Math.random(), if: ifv, then: tv });
            const data = loadData();
            const idx = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (idx !== -1) data.currentHypotheses[idx] = window.currentHypothesis;
            saveData(data);
            renderIfThenPanel();
        }

        // ç¿’æ…£åˆ¥è©³ç´°çµ±è¨ˆã‚’è¡¨ç¤º
        function showHabitDetailStats() {
            const data = loadData();
            
            let html = '<div style="padding: 10px; font-size: 14px;">';
            html += '<h3 style="margin: 0 0 15px 0; font-size: 16px; font-weight: 600;">ğŸ“Š ç¿’æ…£åˆ¥è©³ç´°çµ±è¨ˆ</h3>';
            
            // ç¿’æ…£é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
            html += '<select id="habit-detail-select" onchange="showSelectedHabitDetail()" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 6px;">';
            html += '<option value="">ç¿’æ…£ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            data.currentHypotheses.forEach(habit => {
                if (habit.type === 'daily') {
                    html += `<option value="${habit.id}">${habit.title}</option>`;
                }
            });
            
            html += '</select>';
            html += '<div id="habit-detail-content"></div>';
            html += '</div>';
            
            document.getElementById('ranking-container').innerHTML = html;
            
            // ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('ranking-detail-tab').style.background = '#6366f1';
            document.getElementById('ranking-detail-tab').style.color = '#fff';
            document.getElementById('ranking-achievement-tab').style.background = '#fff';
            document.getElementById('ranking-achievement-tab').style.color = '#666';
            document.getElementById('ranking-points-tab').style.background = '#fff';
            document.getElementById('ranking-points-tab').style.color = '#666';
            document.getElementById('ranking-streak-tab').style.background = '#fff';
            document.getElementById('ranking-streak-tab').style.color = '#666';
        }
        
        // é¸æŠã•ã‚ŒãŸç¿’æ…£ã®è©³ç´°ã‚’è¡¨ç¤º
        window.showSelectedHabitDetail = function() {
            const habitId = document.getElementById('habit-detail-select').value;
            if (!habitId) {
                document.getElementById('habit-detail-content').innerHTML = '';
                return;
            }
            
            const data = loadData();
            const habit = data.currentHypotheses.find(h => h.id === habitId);
            if (!habit) return;
            
            // çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
            const stats = calculateHabitStats(habit, data);
            
            let html = '<div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">';
            
            // åŸºæœ¬æƒ…å ±
            html += `<h4 style="margin: 0 0 10px 0; font-size: 15px; font-weight: 600;">ğŸ¯ ${habit.title}</h4>`;
            
            // é”æˆçµ±è¨ˆ
            html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">';
            html += `<div style="background: #fff; padding: 10px; border-radius: 6px;">
                <div style="color: #666; font-size: 12px;">é”æˆç‡</div>
                <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">${stats.achievementRate}%</div>
            </div>`;
            html += `<div style="background: #fff; padding: 10px; border-radius: 6px;">
                <div style="color: #666; font-size: 12px;">ç·é”æˆæ—¥æ•°</div>
                <div style="font-size: 20px; font-weight: bold; color: #2196F3;">${stats.totalAchievedDays}æ—¥</div>
            </div>`;
            html += '</div>';
            
            // ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ
            html += '<div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<h5 style="margin: 0 0 8px 0; font-size: 14px;">ğŸ’° ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆ</h5>';
            html += `<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 12px;">
                <div>
                    <span style="color: #666;">ç·ç²å¾—:</span>
                    <span style="font-weight: 600;">${stats.totalPoints}pt</span>
                </div>
                <div>
                    <span style="color: #666;">å¹³å‡:</span>
                    <span style="font-weight: 600;">${stats.averagePoints}pt</span>
                </div>
                <div>
                    <span style="color: #666;">ãƒ–ãƒ¼ã‚¹ãƒˆ:</span>
                    <span style="font-weight: 600;">+${stats.boostBonus}pt</span>
                </div>
            </div>`;
            html += '</div>';
            
            // é€£ç¶šè¨˜éŒ²
            html += '<div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<h5 style="margin: 0 0 8px 0; font-size: 14px;">ğŸ”¥ é€£ç¶šè¨˜éŒ²</h5>';
            html += `<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px;">
                <div>
                    <span style="color: #666;">ç¾åœ¨:</span>
                    <span style="font-weight: 600; color: #FF9800;">${stats.currentStreak}æ—¥</span>
                </div>
                <div>
                    <span style="color: #666;">æœ€é•·:</span>
                    <span style="font-weight: 600; color: #E91E63;">${stats.longestStreak}æ—¥</span>
                </div>
            </div>`;
            html += '</div>';
            
            // æ›œæ—¥åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            html += '<div style="background: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px;">';
            html += '<h5 style="margin: 0 0 8px 0; font-size: 14px;">ğŸ“… æ›œæ—¥åˆ¥é”æˆç‡</h5>';
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; font-size: 11px;">';
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            stats.weekdayPerformance.forEach((rate, index) => {
                const color = rate >= 80 ? '#4CAF50' : rate >= 60 ? '#FFC107' : rate >= 40 ? '#FF9800' : '#F44336';
                html += `<div>
                    <div style="color: #666;">${dayNames[index]}</div>
                    <div style="font-weight: 600; color: ${color};">${rate}%</div>
                </div>`;
            });
            html += '</div>';
            html += '</div>';
            
            // æœˆåˆ¥æ¨ç§»
            if (stats.monthlyTrend.length > 0) {
                html += '<div style="background: #fff; padding: 12px; border-radius: 6px;">';
                html += '<h5 style="margin: 0 0 8px 0; font-size: 14px;">ğŸ“ˆ æœˆåˆ¥é”æˆæ¨ç§»</h5>';
                html += '<div style="max-height: 150px; overflow-y: auto;">';
                stats.monthlyTrend.forEach(month => {
                    html += `<div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #f0f0f0; font-size: 12px;">
                        <span>${month.label}</span>
                        <span style="font-weight: 600;">${month.rate}%</span>
                    </div>`;
                });
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            document.getElementById('habit-detail-content').innerHTML = html;
        };
        
        // ç¿’æ…£ã®çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—
        function calculateHabitStats(habit, data) {
            const stats = {
                achievementRate: 0,
                totalAchievedDays: 0,
                totalPoints: 0,
                averagePoints: 0,
                boostBonus: 0,
                currentStreak: 0,
                longestStreak: 0,
                weekdayPerformance: [0, 0, 0, 0, 0, 0, 0],
                monthlyTrend: []
            };
            
            // é”æˆæ—¥æ•°ã¨ç‡ã‚’è¨ˆç®—
            const today = getToday();
            const createdDate = new Date(habit.createdAt || today);
            const totalDays = Math.floor((new Date(today) - createdDate) / (1000 * 60 * 60 * 24)) + 1;
            
            let achievedDays = 0;
            let currentStreak = 0;
            let longestStreak = 0;
            let tempStreak = 0;
            const weekdayCount = [0, 0, 0, 0, 0, 0, 0];
            const weekdayAchieved = [0, 0, 0, 0, 0, 0, 0];
            const monthlyData = {};
            
            // ãƒ­ã‚°ã‚’æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
            const sortedDates = Object.keys(habit.logs || {}).sort();
            
            sortedDates.forEach((dateKey, index) => {
                const log = habit.logs[dateKey];
                const date = new Date(dateKey);
                const dayOfWeek = date.getDay();
                
                weekdayCount[dayOfWeek]++;
                
                if (log.completed) {
                    achievedDays++;
                    weekdayAchieved[dayOfWeek]++;
                    
                    // æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { achieved: 0, total: 0 };
                    }
                    monthlyData[monthKey].achieved++;
                    
                    // é€£ç¶šè¨˜éŒ²è¨ˆç®—
                    if (index === 0 || !habit.logs[sortedDates[index - 1]]?.completed) {
                        tempStreak = 1;
                    } else {
                        const prevDate = new Date(sortedDates[index - 1]);
                        const dayDiff = Math.floor((date - prevDate) / (1000 * 60 * 60 * 24));
                        if (dayDiff === 1) {
                            tempStreak++;
                        } else {
                            tempStreak = 1;
                        }
                    }
                    
                    longestStreak = Math.max(longestStreak, tempStreak);
                    
                    // ç¾åœ¨ã®é€£ç¶šè¨˜éŒ²
                    if (dateKey === today || (index === sortedDates.length - 1 && new Date(today) - date < 2 * 24 * 60 * 60 * 1000)) {
                        currentStreak = tempStreak;
                    }
                } else {
                    tempStreak = 0;
                }
                
                // æœˆåˆ¥ç·æ—¥æ•°
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { achieved: 0, total: 0 };
                }
                monthlyData[monthKey].total++;
            });
            
            stats.achievementRate = totalDays > 0 ? Math.round((achievedDays / totalDays) * 100) : 0;
            stats.totalAchievedDays = achievedDays;
            stats.currentStreak = currentStreak;
            stats.longestStreak = longestStreak;
            
            // æ›œæ—¥åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            stats.weekdayPerformance = weekdayCount.map((count, index) => {
                return count > 0 ? Math.round((weekdayAchieved[index] / count) * 100) : 0;
            });
            
            // æœˆåˆ¥æ¨ç§»
            const sortedMonths = Object.keys(monthlyData).sort();
            stats.monthlyTrend = sortedMonths.map(monthKey => {
                const [year, month] = monthKey.split('-');
                const rate = monthlyData[monthKey].total > 0 
                    ? Math.round((monthlyData[monthKey].achieved / monthlyData[monthKey].total) * 100) 
                    : 0;
                return {
                    label: `${year}å¹´${parseInt(month)}æœˆ`,
                    rate: rate
                };
            });
            
            // ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆã‚’è¨ˆç®—
            let pointCount = 0;
            data.pointSystem.transactions.forEach(t => {
                if (t.source === 'habit') {
                    // habitIdã¾ãŸã¯èª¬æ˜æ–‡ã‹ã‚‰ç¿’æ…£ã‚’ç‰¹å®š
                    if (t.habitId === habit.id || t.description.includes(habit.title)) {
                        stats.totalPoints += t.points;
                        pointCount++;
                        const basePoints = Math.round(t.points / (t.boost || 1));
                        stats.boostBonus += (t.points - basePoints);
                    }
                }
            });
            
            stats.averagePoints = pointCount > 0 ? Math.round(stats.totalPoints / pointCount) : 0;
            
            return stats;
        }
        
        window.editIfThen = function(index) {
            const item = (window.currentHypothesis.ifThen || [])[index];
            if (!item) return;
            const iff = prompt('ã‚‚ã—ï¼ˆãƒˆãƒªã‚¬ãƒ¼ï¼‰ã‚’ä¿®æ­£', item.if);
            if (iff == null) return;
            const thenv = prompt('ãªã‚‰ï¼ˆè¡Œå‹•ï¼‰ã‚’ä¿®æ­£', item.then);
            if (thenv == null) return;
            const ifv = (iff||'').trim();
            const tv = (thenv||'').trim();
            if (!ifv || !tv) return;
            window.currentHypothesis.ifThen[index] = { ...item, if: ifv, then: tv };
            const data = loadData();
            const idx = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (idx !== -1) data.currentHypotheses[idx] = window.currentHypothesis;
            saveData(data);
            renderIfThenPanel();
        }

        window.deleteIfThen = function(index) {
            if (!confirm('ã“ã®ãƒ«ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            (window.currentHypothesis.ifThen || []).splice(index, 1);
            const data = loadData();
            const idx = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (idx !== -1) data.currentHypotheses[idx] = window.currentHypothesis;
            saveData(data);
            renderIfThenPanel();
        }

        // ãƒãƒƒã‚¸ã‚·ã‚¹ãƒ†ãƒ ã®å®šç¾©
        const BADGE_DEFINITIONS = {
            // é€£ç¶šé”æˆãƒãƒƒã‚¸
            streak_7: { name: 'ğŸ”¥ é€±é–“æˆ¦å£«', description: '7æ—¥é€£ç¶šé”æˆ', emoji: 'ğŸ”¥' },
            streak_14: { name: 'âš¡ 2é€±é–“ã®ç‚', description: '14æ—¥é€£ç¶šé”æˆ', emoji: 'âš¡' },
            streak_30: { name: 'ğŸŒŸ æœˆé–“ãƒã‚¹ã‚¿ãƒ¼', description: '30æ—¥é€£ç¶šé”æˆ', emoji: 'ğŸŒŸ' },
            streak_60: { name: 'ğŸ’ ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰', description: '60æ—¥é€£ç¶šé”æˆ', emoji: 'ğŸ’' },
            streak_90: { name: 'ğŸ‘‘ ç¿’æ…£ã®ç‹', description: '90æ—¥é€£ç¶šé”æˆ', emoji: 'ğŸ‘‘' },
            streak_365: { name: 'ğŸŒˆ å¹´é–“é”æˆè€…', description: '365æ—¥é€£ç¶šé”æˆ', emoji: 'ğŸŒˆ' },
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸é”æˆãƒãƒƒã‚¸
            stage_sprout: { name: 'ğŸŒ± æœ€åˆã®ä¸€æ­©', description: 'èŠ½å¹ãã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”', emoji: 'ğŸŒ±' },
            stage_growth: { name: 'ğŸŒ¿ æˆé•·ã®è¨¼', description: 'æˆé•·æœŸã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”', emoji: 'ğŸŒ¿' },
            stage_establishment: { name: 'ğŸŒ³ å®šç€ã®è¨¼', description: 'å®šç€æœŸã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”', emoji: 'ğŸŒ³' },
            stage_bloom: { name: 'ğŸŒ¸ é–‹èŠ±ã®è¨¼', description: 'é–‹èŠ±æœŸã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”', emoji: 'ğŸŒ¸' },
            stage_harvest: { name: 'ğŸ åç©«ã®è¨¼', description: 'åç©«æœŸã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”', emoji: 'ğŸ' },
            stage_golden: { name: 'ğŸ‘‘ é»„é‡‘é”æˆ', description: 'é»„é‡‘ã®ç¿’æ…£åˆ°é”', emoji: 'ğŸ‘‘' },
            
            // å°‚é–€å®¶ã‚·ãƒªãƒ¼ã‚ºï¼ˆ100æ—¥é”æˆï¼‰
            expert_study: { name: 'ğŸ“š å‹‰å¼·ã®è³¢è€…', description: 'å‹‰å¼·ã‚«ãƒ†ã‚´ãƒªãƒ¼100æ—¥é”æˆ', emoji: 'ğŸ“š' },
            expert_exercise: { name: 'ğŸ’ª é‰„äººã‚¢ã‚¹ãƒªãƒ¼ãƒˆ', description: 'é‹å‹•ã‚«ãƒ†ã‚´ãƒªãƒ¼100æ—¥é”æˆ', emoji: 'ğŸ’ª' },
            expert_health: { name: 'ğŸ§˜ ç‘æƒ³ãƒã‚¹ã‚¿ãƒ¼', description: 'é¤Šç”Ÿã‚«ãƒ†ã‚´ãƒªãƒ¼100æ—¥é”æˆ', emoji: 'ğŸ§˜' },
            expert_reading: { name: 'ğŸ“– èª­æ›¸ã®å“²å­¦è€…', description: 'èª­æ›¸ã‚«ãƒ†ã‚´ãƒªãƒ¼100æ—¥é”æˆ', emoji: 'ğŸ“–' },
            rainbow_master: { name: 'ğŸŒˆ ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒã‚¹ã‚¿ãƒ¼', description: 'å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’åŒæ™‚é€²è¡Œ', emoji: 'ğŸŒˆ' },
            balance_keeper: { name: 'âš–ï¸ ãƒãƒ©ãƒ³ã‚¹ã‚­ãƒ¼ãƒ‘ãƒ¼', description: '3ã‚«ãƒ†ã‚´ãƒªãƒ¼ä»¥ä¸Šã‚’å‡ç­‰ã«é”æˆ', emoji: 'âš–ï¸' },
            
            // å¼·åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç³»
            fire_challenger: { name: 'ğŸ”¥ ç‚ã®æŒ‘æˆ¦è€…', description: 'é«˜å¼·åº¦Ã—1.2ã‚’é€£ç¶š7æ—¥', emoji: 'ğŸ”¥' },
            precision_adjuster: { name: 'ğŸ¯ ç²¾å¯†èª¿æ•´è€…', description: 'ã‚«ã‚¹ã‚¿ãƒ å¼·åº¦ã‚’5ç¨®é¡ä»¥ä¸Šä½¿ç”¨', emoji: 'ğŸ¯' },
            growth_curve: { name: 'ğŸ“ˆ æˆé•·æ›²ç·š', description: 'å¾ã€…ã«å¼·åº¦ã‚’ä¸Šã’ã¦é”æˆ', emoji: 'ğŸ“ˆ' },
            intensity_surfer: { name: 'ğŸ¢ å¼·åº¦ã‚µãƒ¼ãƒ•ã‚¡ãƒ¼', description: '1é€±é–“ã§å…¨å¼·åº¦ã‚’ä½“é¨“', emoji: 'ğŸ¢' },
            
            // ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ é–¢é€£
            lucky_seven: { name: 'ğŸ° ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³', description: 'ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ã‚«ãƒ¼ãƒ‰7æšç²å¾—', emoji: 'ğŸ°' },
            shield_guardian: { name: 'ğŸ›¡ï¸ ä¸å±ˆã®å®ˆè­·è€…', description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰10æšã‚’ä¹—ã‚Šè¶Šãˆã‚‹', emoji: 'ğŸ›¡ï¸' },
            card_master: { name: 'â™ ï¸ ã‚«ãƒ¼ãƒ‰ãƒã‚¹ã‚¿ãƒ¼', description: 'å…¨ç¨®é¡ã®ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—', emoji: 'â™ ï¸' },
            reversal_magician: { name: 'ğŸ­ é€†è»¢ã®å¥‡è¡“å¸«', description: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ãƒãƒ£ãƒ³ã‚¹ã«å¤‰ãˆã‚‹', emoji: 'ğŸ­' },
            
            // é »åº¦ç®¡ç†ã®é”äºº
            weekly_architect: { name: 'ğŸ“… é€±é–“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ', description: 'é€±3å›ç¿’æ…£ã‚’å®Œç’§ã«ç®¡ç†', emoji: 'ğŸ“…' },
            weekday_ruler: { name: 'ğŸ¯ æ›œæ—¥ã®æ”¯é…è€…', description: 'ç‰¹å®šæ›œæ—¥100%é”æˆã‚’4é€±é€£ç¶š', emoji: 'ğŸ¯' },
            flex_master: { name: 'ğŸ”„ ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒã‚¹ã‚¿ãƒ¼', description: '3ç¨®é¡ã®é »åº¦ã‚¿ã‚¤ãƒ—ã‚’åŒæ™‚é‹ç”¨', emoji: 'ğŸ”„' },
            weekly_perfect: { name: 'ğŸ“Š é€±é–“ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆ', description: 'é€±ã®ç›®æ¨™ã‚’12é€±é€£ç¶šé”æˆ', emoji: 'ğŸ“Š' },
            
            // æˆé•·ãƒ»å¾©æ´»ç³»
            habit_gardener: { name: 'ğŸŒ³ ç¿’æ…£ã®åº­å¸«', description: '5ã¤ä»¥ä¸Šã®ç¿’æ…£ã‚’åŒæ™‚è‚²æˆ', emoji: 'ğŸŒ³' },
            phoenix: { name: 'ğŸ”¥ ä¸æ­»é³¥', description: 'é€£ç¶šå¤±æ•—ã‹ã‚‰å®Œå…¨å¾©æ´»', emoji: 'ğŸ”¥' },
            diamond_habit: { name: 'ğŸ’ ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ç¿’æ…£', description: '100æ—¥ç¶™ç¶šé”æˆ', emoji: 'ğŸ’' },
            restart_master: { name: 'ğŸ”„ å†èµ·å‹•ãƒã‚¹ã‚¿ãƒ¼', description: '3å›ãƒªã‚»ãƒƒãƒˆã—ã¦æœ€çµ‚çš„ã«æˆåŠŸ', emoji: 'ğŸ”„' },
            
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç³»
            grand_slam: { name: 'ğŸ–ï¸ ã‚°ãƒ©ãƒ³ãƒ‰ã‚¹ãƒ©ãƒ ', description: 'æœˆé–“ãƒãƒ£ãƒ¬ãƒ³ã‚¸å…¨åˆ¶è¦‡', emoji: 'ğŸ–ï¸' },
            speed_runner: { name: 'âš¡ ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ©ãƒ³ãƒŠãƒ¼', description: 'ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸30é€£ç¶š', emoji: 'âš¡' },
            challenge_hunter: { name: 'ğŸ”ï¸ é«˜é›£åº¦ãƒãƒ³ã‚¿ãƒ¼', description: 'æœ€é«˜é›£åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸10å›ã‚¯ãƒªã‚¢', emoji: 'ğŸ”ï¸' },
            challenge_circus: { name: 'ğŸª ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚µãƒ¼ã‚«ã‚¹', description: 'åŒæ™‚ã«5ã¤ä»¥ä¸Šã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸', emoji: 'ğŸª' },
            
            // å­£ç¯€ãƒ»ç‰¹åˆ¥ç³»
            spring_awakening: { name: 'ğŸŒ¸ æ˜¥ã®ç›®è¦šã‚', description: '3-5æœˆã«æ–°ç¿’æ…£3ã¤ç¢ºç«‹', emoji: 'ğŸŒ¸' },
            summer_passion: { name: 'â˜€ï¸ å¤ã®ç†±è¡€', description: '6-8æœˆã«é«˜å¼·åº¦ç¿’æ…£ã‚’ãƒã‚¹ã‚¿ãƒ¼', emoji: 'â˜€ï¸' },
            autumn_harvest: { name: 'ğŸ‚ ç§‹ã®åç©«', description: '9-11æœˆã«ç¿’æ…£ã‚’é»„é‡‘ãƒ¬ãƒ™ãƒ«ã¸', emoji: 'ğŸ‚' },
            winter_sage: { name: 'â„ï¸ å†¬ã®è³¢è€…', description: '12-2æœˆã‚‚ä¼‘ã¾ãšç¶™ç¶š', emoji: 'â„ï¸' },
            
            // ç‰¹æ®Šæ¡ä»¶ãƒ»éš ã—ç³»
            adversity_hero: { name: 'ğŸ­ é€†å¢ƒã®è‹±é›„', description: 'ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ä¸­ã«95%ä»¥ä¸Šé”æˆ', emoji: 'ğŸ­' },
            perfectionist: { name: 'ğŸ”® å®Œç’§ä¸»ç¾©è€…', description: '100%é”æˆã‚’5å›', emoji: 'ğŸ”®' },
            ghost_buster: { name: 'ğŸ‘» ã‚´ãƒ¼ã‚¹ãƒˆãƒã‚¹ã‚¿ãƒ¼', description: 'æ·±å¤œ0æ™‚ã‚’ã¾ãŸã„ã§é”æˆ', emoji: 'ğŸ‘»' },
            chaos_master: { name: 'ğŸŒ€ ã‚«ã‚ªã‚¹ãƒã‚¹ã‚¿ãƒ¼', description: '10å€‹ä»¥ä¸Šã®ç¿’æ…£ã‚’åŒæ™‚ç®¡ç†', emoji: 'ğŸŒ€' },
            legend_seeker: { name: 'ğŸ¦„ ä¼èª¬ã®æ¢æ±‚è€…', description: 'ã™ã¹ã¦ã®éš ã—è¦ç´ ã‚’ç™ºè¦‹', emoji: 'ğŸ¦„' },
            
            // ãƒ¡ã‚¿é”æˆç³»
            badge_hunter: { name: 'ğŸ… ãƒãƒƒã‚¸ãƒãƒ³ã‚¿ãƒ¼', description: '50å€‹ä»¥ä¸Šã®ãƒãƒƒã‚¸ç²å¾—', emoji: 'ğŸ…' },
            system_master: { name: 'ğŸ“± ã‚·ã‚¹ãƒ†ãƒ ãƒã‚¹ã‚¿ãƒ¼', description: 'å…¨æ©Ÿèƒ½ã‚’ä½¿ã„ã“ãªã™', emoji: 'ğŸ“±' },
            
            // å®Œç’§é”æˆãƒãƒƒã‚¸
            perfect_week: { name: 'âœ¨ å®Œç’§ãªé€±', description: '1é€±é–“100%é”æˆ', emoji: 'âœ¨' },
            perfect_month: { name: 'ğŸŒŸ å®Œç’§ãªæœˆ', description: '1ãƒ¶æœˆ100%é”æˆ', emoji: 'ğŸŒŸ' },
            
            // å¾©æ´»ãƒãƒƒã‚¸
            comeback: { name: 'ğŸ’ª å¾©æ´»ã®åŠ›', description: '3æ—¥ä»¥ä¸Šã®ä¸­æ–­ã‹ã‚‰å¾©å¸°', emoji: 'ğŸ’ª' },
            
            // ç¿’æ…£æ•°ãƒãƒƒã‚¸
            multi_habit_3: { name: 'ğŸ¯ ãƒãƒ«ãƒã‚¿ã‚¹ã‚«ãƒ¼', description: '3ã¤ã®ç¿’æ…£ã‚’åŒæ™‚é€²è¡Œ', emoji: 'ğŸ¯' },
            multi_habit_5: { name: 'ğŸš€ ç¿’æ…£ãƒã‚¹ã‚¿ãƒ¼', description: '5ã¤ã®ç¿’æ…£ã‚’åŒæ™‚é€²è¡Œ', emoji: 'ğŸš€' },
            multi_habit_10: { name: 'ğŸŒŸ ç¿’æ…£ã®ç¥', description: '10å€‹ä»¥ä¸Šã®ç¿’æ…£ã‚’åŒæ™‚é€²è¡Œ', emoji: 'ğŸŒŸ' },
            
            // ç‰¹åˆ¥ãƒãƒƒã‚¸
            weekend_warrior: { name: 'ğŸ® é€±æœ«æˆ¦å£«', description: 'åœŸæ—¥ã®é”æˆç‡90%ä»¥ä¸Š', emoji: 'ğŸ®' }
        };
        
        // ãƒãƒƒã‚¸ç²å¾—ãƒã‚§ãƒƒã‚¯
        function checkAndAwardBadges() {
            const data = loadData();
            if (!data.badges) data.badges = {};
            const newBadges = [];
            
            // é€£ç¶šé”æˆãƒãƒƒã‚¸ã®ãƒã‚§ãƒƒã‚¯
            const allHypotheses = data.currentHypotheses.concat(data.completedHypotheses || []);
            let maxStreak = 0;
            allHypotheses.forEach(h => {
                const streak = window.computeStreak(h);
                if (streak > maxStreak) maxStreak = streak;
            });
            
            const streakBadges = [
                { id: 'streak_7', days: 7 },
                { id: 'streak_14', days: 14 },
                { id: 'streak_30', days: 30 },
                { id: 'streak_60', days: 60 },
                { id: 'streak_90', days: 90 },
                { id: 'streak_365', days: 365 }
            ];
            
            streakBadges.forEach(sb => {
                if (maxStreak >= sb.days && !data.badges[sb.id]) {
                    data.badges[sb.id] = { earnedAt: new Date().toISOString() };
                    newBadges.push(sb.id);
                }
            });
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸ãƒãƒƒã‚¸ã®ãƒã‚§ãƒƒã‚¯
            const stageMap = {
                'èŠ½å¹ã': 'stage_sprout',
                'æˆé•·æœŸ': 'stage_growth',
                'å®šç€æœŸ': 'stage_establishment',
                'é–‹èŠ±æœŸ': 'stage_bloom',
                'åç©«æœŸ': 'stage_harvest',
                'é»„é‡‘ã®ç¿’æ…£': 'stage_golden'
            };
            
            allHypotheses.forEach(h => {
                const stage = window.calculateHabitStage(h);
                if (stage && stageMap[stage.name] && !data.badges[stageMap[stage.name]]) {
                    data.badges[stageMap[stage.name]] = { earnedAt: new Date().toISOString() };
                    newBadges.push(stageMap[stage.name]);
                }
            });
            
            // å®Œç’§ãªé€±ã®ãƒã‚§ãƒƒã‚¯
            allHypotheses.forEach(h => {
                if (!h.achievements) return;
                const dates = Object.keys(h.achievements).sort();
                for (let i = 0; i <= dates.length - 7; i++) {
                    const weekDates = dates.slice(i, i + 7);
                    if (weekDates.length === 7) {
                        const firstDate = new Date(weekDates[0]);
                        const lastDate = new Date(weekDates[6]);
                        const dayDiff = (lastDate - firstDate) / (1000 * 60 * 60 * 24);
                        if (dayDiff === 6 && !data.badges.perfect_week) {
                            data.badges.perfect_week = { earnedAt: new Date().toISOString() };
                            newBadges.push('perfect_week');
                        }
                    }
                }
            });
            
            // è¤‡æ•°ç¿’æ…£ãƒãƒƒã‚¸
            if (data.currentHypotheses.length >= 3 && !data.badges.multi_habit_3) {
                data.badges.multi_habit_3 = { earnedAt: new Date().toISOString() };
                newBadges.push('multi_habit_3');
            }
            if (data.currentHypotheses.length >= 5 && !data.badges.multi_habit_5) {
                data.badges.multi_habit_5 = { earnedAt: new Date().toISOString() };
                newBadges.push('multi_habit_5');
            }
            if (data.currentHypotheses.length >= 10 && !data.badges.multi_habit_10) {
                data.badges.multi_habit_10 = { earnedAt: new Date().toISOString() };
                newBadges.push('multi_habit_10');
            }
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼å°‚é–€å®¶ãƒãƒƒã‚¸ï¼ˆ100æ—¥é”æˆï¼‰
            const categoryAchievements = {
                study: 0,
                exercise: 0,
                health: 0,
                reading: 0,
                work: 0,
                hobby: 0,
                other: 0
            };
            
            allHypotheses.forEach(h => {
                const category = h.category || 'other';
                const achievedDays = Object.keys(h.achievements || {}).length;
                categoryAchievements[category] += achievedDays;
            });
            
            // å°‚é–€å®¶ã‚·ãƒªãƒ¼ã‚ºãƒãƒƒã‚¸åˆ¤å®š
            if (categoryAchievements.study >= 100 && !data.badges.expert_study) {
                data.badges.expert_study = { earnedAt: new Date().toISOString() };
                newBadges.push('expert_study');
            }
            if (categoryAchievements.exercise >= 100 && !data.badges.expert_exercise) {
                data.badges.expert_exercise = { earnedAt: new Date().toISOString() };
                newBadges.push('expert_exercise');
            }
            if (categoryAchievements.health >= 100 && !data.badges.expert_health) {
                data.badges.expert_health = { earnedAt: new Date().toISOString() };
                newBadges.push('expert_health');
            }
            if (categoryAchievements.reading >= 100 && !data.badges.expert_reading) {
                data.badges.expert_reading = { earnedAt: new Date().toISOString() };
                newBadges.push('expert_reading');
            }
            
            // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒã‚¹ã‚¿ãƒ¼ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼åŒæ™‚é€²è¡Œï¼‰
            const activeCategories = new Set();
            data.currentHypotheses.forEach(h => {
                activeCategories.add(h.category || 'other');
            });
            if (activeCategories.size >= 4 && !data.badges.rainbow_master) {
                data.badges.rainbow_master = { earnedAt: new Date().toISOString() };
                newBadges.push('rainbow_master');
            }
            
            // ãƒãƒ©ãƒ³ã‚¹ã‚­ãƒ¼ãƒ‘ãƒ¼ï¼ˆ3ã‚«ãƒ†ã‚´ãƒªãƒ¼å‡ç­‰é”æˆï¼‰
            const significantCategories = Object.values(categoryAchievements).filter(v => v >= 30);
            if (significantCategories.length >= 3) {
                const max = Math.max(...significantCategories);
                const min = Math.min(...significantCategories);
                if (max - min <= 10 && !data.badges.balance_keeper) {
                    data.badges.balance_keeper = { earnedAt: new Date().toISOString() };
                    newBadges.push('balance_keeper');
                }
            }
            
            // å¼·åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒãƒƒã‚¸
            let highIntensityStreak = 0;
            let customIntensityTypes = new Set();
            let hasGrowthCurve = false;
            let weeklyIntensityTypes = new Set();
            
            allHypotheses.forEach(h => {
                if (h.intensity) {
                    Object.values(h.intensity).forEach(mult => {
                        customIntensityTypes.add(mult.toFixed(1));
                    });
                }
                
                // é«˜å¼·åº¦é€£ç¶šãƒã‚§ãƒƒã‚¯
                const sortedDates = Object.keys(h.achievements || {}).sort();
                let currentStreak = 0;
                sortedDates.forEach(date => {
                    const intensity = h.intensity && h.intensity[date] || 1.0;
                    if (intensity >= 1.2) {
                        currentStreak++;
                        if (currentStreak > highIntensityStreak) {
                            highIntensityStreak = currentStreak;
                        }
                    } else {
                        currentStreak = 0;
                    }
                });
            });
            
            if (highIntensityStreak >= 7 && !data.badges.fire_challenger) {
                data.badges.fire_challenger = { earnedAt: new Date().toISOString() };
                newBadges.push('fire_challenger');
            }
            
            if (customIntensityTypes.size >= 5 && !data.badges.precision_adjuster) {
                data.badges.precision_adjuster = { earnedAt: new Date().toISOString() };
                newBadges.push('precision_adjuster');
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ãƒãƒƒã‚¸
            const cards = data.cards || {};
            const allCards = (cards.earned || []).concat(cards.used || []);
            const legendaryCards = allCards.filter(c => c.rarity === 'legendary');
            const penaltyCards = allCards.filter(c => c.type === 'penalty');
            const uniqueCardTypes = new Set(allCards.map(c => c.id));
            
            if (legendaryCards.length >= 7 && !data.badges.lucky_seven) {
                data.badges.lucky_seven = { earnedAt: new Date().toISOString() };
                newBadges.push('lucky_seven');
            }
            
            if (penaltyCards.length >= 10 && !data.badges.shield_guardian) {
                data.badges.shield_guardian = { earnedAt: new Date().toISOString() };
                newBadges.push('shield_guardian');
            }
            
            if (uniqueCardTypes.size >= 20 && !data.badges.card_master) {
                data.badges.card_master = { earnedAt: new Date().toISOString() };
                newBadges.push('card_master');
            }
            
            // é »åº¦ç®¡ç†ãƒãƒƒã‚¸
            let hasWeeklyPerfect = false;
            let hasFlexMaster = false;
            const frequencyTypes = new Set();
            
            data.currentHypotheses.forEach(h => {
                if (h.frequency) {
                    frequencyTypes.add(h.frequency.type);
                }
            });
            
            if (frequencyTypes.size >= 3 && !data.badges.flex_master) {
                data.badges.flex_master = { earnedAt: new Date().toISOString() };
                newBadges.push('flex_master');
            }
            
            // æˆé•·ãƒ»å¾©æ´»ç³»ãƒãƒƒã‚¸
            if (data.currentHypotheses.length >= 5 && !data.badges.habit_gardener) {
                data.badges.habit_gardener = { earnedAt: new Date().toISOString() };
                newBadges.push('habit_gardener');
            }
            
            // 100æ—¥ç¶™ç¶šé”æˆ
            allHypotheses.forEach(h => {
                const achievedDays = Object.keys(h.achievements || {}).length;
                if (achievedDays >= 100 && !data.badges.diamond_habit) {
                    data.badges.diamond_habit = { earnedAt: new Date().toISOString() };
                    newBadges.push('diamond_habit');
                }
            });
            
            // å­£ç¯€ãƒãƒƒã‚¸
            const now = new Date();
            const month = now.getMonth() + 1;
            
            if (month >= 3 && month <= 5) {
                const springNewHabits = data.currentHypotheses.filter(h => {
                    const startMonth = new Date(h.startDate).getMonth() + 1;
                    return startMonth >= 3 && startMonth <= 5;
                });
                if (springNewHabits.length >= 3 && !data.badges.spring_awakening) {
                    data.badges.spring_awakening = { earnedAt: new Date().toISOString() };
                    newBadges.push('spring_awakening');
                }
            }
            
            // ç‰¹æ®Šæ¡ä»¶ãƒãƒƒã‚¸
            if (data.currentHypotheses.length >= 10 && !data.badges.chaos_master) {
                data.badges.chaos_master = { earnedAt: new Date().toISOString() };
                newBadges.push('chaos_master');
            }
            
            // å®Œç’§ä¸»ç¾©è€…ãƒãƒƒã‚¸
            let perfectCount = 0;
            allHypotheses.forEach(h => {
                const achievedDays = Object.keys(h.achievements || {}).length;
                const totalDays = h.totalDays || 30;
                if (achievedDays === totalDays) {
                    perfectCount++;
                }
            });
            
            if (perfectCount >= 5 && !data.badges.perfectionist) {
                data.badges.perfectionist = { earnedAt: new Date().toISOString() };
                newBadges.push('perfectionist');
            }
            
            // ãƒ¡ã‚¿é”æˆç³»
            const earnedBadgesCount = Object.keys(data.badges).length;
            if (earnedBadgesCount >= 50 && !data.badges.badge_hunter) {
                data.badges.badge_hunter = { earnedAt: new Date().toISOString() };
                newBadges.push('badge_hunter');
            }
            
            // æ–°ã—ã„ãƒãƒƒã‚¸ã‚’é€šçŸ¥
            newBadges.forEach(badgeId => {
                const badge = BADGE_DEFINITIONS[badgeId];
                if (badge) {
                    setTimeout(() => {
                        showCardEffect(
                            'ğŸ† ãƒãƒƒã‚¸ç²å¾—ï¼',
                            `${badge.name}\n${badge.description}`,
                            '#fbbf24'
                        );
                    }, 500);
                }
            });
            
            if (newBadges.length > 0) {
                saveData(data);
            }
            
            return newBadges;
        }
        
        // é€£ç¶šé”æˆæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
        window.computeStreak = function(hyp) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const start = new Date(hyp.startDate);
            start.setHours(0,0,0,0);
            let streak = 0;
            const achievements = hyp.achievements || {};
            for (let d = new Date(today); d >= start; d.setDate(d.getDate()-1)) {
                const key = dateKeyLocal(d);
                if (achievements[key]) {
                    streak += 1;
                } else {
                    // ä»Šæ—¥ã‚ˆã‚Šæœªæ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã€æœªé”ã§æ‰“ã¡åˆ‡ã‚Š
                    if (d > today) continue;
                    break;
                }
            }
            return streak;
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—é€šçŸ¥
        function checkStageProgress() {
            const data = loadData();
            if (!data.stageNotifications) data.stageNotifications = {};
            
            data.currentHypotheses.forEach(h => {
                const stage = window.calculateHabitStage(h);
                if (!stage) return;
                
                const notifKey = `${h.id}_${stage.name}`;
                if (!data.stageNotifications[notifKey]) {
                    // æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸ã«åˆ°é”
                    data.stageNotifications[notifKey] = new Date().toISOString();
                    
                    // ç¨®ã¾ãä»¥å¤–ã¯é€šçŸ¥
                    if (stage.name !== 'ç¨®ã¾ã') {
                        showCardEffect(
                            'ğŸŒ± ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¢ãƒƒãƒ—ï¼',
                            `ã€Œ${h.title}ã€ãŒ${stage.name}ã‚¹ãƒ†ãƒ¼ã‚¸ã«åˆ°é”ï¼\n${stage.description}`,
                            stage.color
                        );
                    }
                }
            });
            
            saveData(data);
        }
        
        // ç¿’æ…£æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨ˆç®—é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
        window.calculateHabitStage = function(hypothesis) {
            if (!hypothesis || !hypothesis.achievements) return null;
            
            const start = new Date(hypothesis.startDate);
            start.setHours(0, 0, 0, 0);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // é”æˆæ—¥æ•°ã®è¨ˆç®—
            const achievedDays = Object.keys(hypothesis.achievements).length;
            
            // é€£ç¶šé”æˆæ—¥æ•°ã®è¨ˆç®—
            const streak = window.computeStreak(hypothesis);
            
            // é€±å˜ä½ã§ã®é”æˆæ•°ã‚’è¨ˆç®—ï¼ˆé€±â—¯å›ã‚„ç‰¹å®šæ›œæ—¥ã®å ´åˆï¼‰
            let achievedWeeks = 0;
            if (hypothesis.frequency && (hypothesis.frequency.type === 'weekly' || hypothesis.frequency.type === 'weekdays')) {
                const weeks = Math.ceil((today - start) / (7 * 24 * 60 * 60 * 1000));
                for (let w = 0; w < weeks; w++) {
                    const weekStart = new Date(start);
                    weekStart.setDate(start.getDate() + w * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    let weekAchievements = 0;
                    for (let d = new Date(weekStart); d <= weekEnd && d <= today; d.setDate(d.getDate() + 1)) {
                        const key = dateKeyLocal(d);
                        if (hypothesis.achievements[key]) weekAchievements++;
                    }
                    
                    if (hypothesis.frequency.type === 'weekly' && weekAchievements >= hypothesis.frequency.count) {
                        achievedWeeks++;
                    } else if (hypothesis.frequency.type === 'weekdays') {
                        const targetDaysInWeek = hypothesis.frequency.weekdays.filter(wd => {
                            for (let d = new Date(weekStart); d <= weekEnd && d <= today; d.setDate(d.getDate() + 1)) {
                                if (d.getDay() === wd) return true;
                            }
                            return false;
                        }).length;
                        if (targetDaysInWeek > 0 && weekAchievements >= targetDaysInWeek * 0.8) {
                            achievedWeeks++;
                        }
                    }
                }
            }
            
            // åŸºæœ¬ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
            let baseScore = achievedDays;
            if (hypothesis.frequency) {
                if (hypothesis.frequency.type === 'weekly' || hypothesis.frequency.type === 'weekdays') {
                    baseScore = achievedWeeks * 7; // é€±å˜ä½ã‚’æ—¥æ•°æ›ç®—
                }
            }
            
            // é€£ç¶šãƒœãƒ¼ãƒŠã‚¹ã®è¨ˆç®—ï¼ˆ1.0ï½2.0ï¼‰
            let continuityBonus = 1.0;
            if (streak >= 90) {
                continuityBonus = 2.0;
            } else if (streak >= 60) {
                continuityBonus = 1.7;
            } else if (streak >= 30) {
                continuityBonus = 1.5;
            } else if (streak >= 14) {
                continuityBonus = 1.3;
            } else if (streak >= 7) {
                continuityBonus = 1.1;
            }
            
            // é€”åˆ‡ã‚ŒãƒšãƒŠãƒ«ãƒ†ã‚£
            const totalDays = Math.floor((today - start) / (24 * 60 * 60 * 1000)) + 1;
            const achievementRate = achievedDays / totalDays;
            if (achievementRate < 0.5 && totalDays > 7) {
                continuityBonus *= 0.8;
            }
            
            // æœ€çµ‚ã‚¹ã‚³ã‚¢
            const finalScore = Math.floor(baseScore * continuityBonus);
            
            // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š
            const stages = [
                { name: 'ğŸŒ± ç¨®ã¾ãæœŸ', minScore: 0, maxScore: 7, color: '#6b7280', description: 'ç¿’æ…£ã®ç¨®ã‚’æ¤ãˆãŸæ®µéš' },
                { name: 'ğŸŒ¿ ç™ºèŠ½æœŸ', minScore: 8, maxScore: 14, color: '#10b981', description: 'å°ã•ãªèŠ½ãŒå‡ºã¦ããŸ' },
                { name: 'ğŸ€ æˆé•·æœŸ', minScore: 15, maxScore: 30, color: '#3b82f6', description: 'è‘‰ãŒå¢—ãˆã¦æˆé•·ä¸­' },
                { name: 'ğŸŒ³ å®šç€æœŸ', minScore: 31, maxScore: 60, color: '#8b5cf6', description: 'ã—ã£ã‹ã‚Šã¨ã—ãŸæœ¨ã«æˆé•·' },
                { name: 'ğŸŒ¸ é–‹èŠ±æœŸ', minScore: 61, maxScore: 90, color: '#f59e0b', description: 'èŠ±ãŒå’²ãå§‹ã‚ã‚‹' },
                { name: 'ğŸ åç©«æœŸ', minScore: 91, maxScore: 120, color: '#ef4444', description: 'å®ŸãŒãªã‚Šåç©«ã§ãã‚‹' },
                { name: 'ğŸ‘‘ é»„é‡‘ã®ç¿’æ…£', minScore: 121, maxScore: 999999, color: '#fbbf24', description: 'å®Œå…¨ã«èº«ã«ã¤ã„ãŸç¿’æ…£' }
            ];
            
            // ç‰¹åˆ¥æ¡ä»¶ï¼šé€£ç¶š90æ—¥ä»¥ä¸Šã‹ã¤é”æˆç‡90%ä»¥ä¸Šã§é»„é‡‘ã®ç¿’æ…£
            if (streak >= 90 && achievementRate >= 0.9) {
                return { ...stages[6], score: finalScore, streak, achievementRate: Math.round(achievementRate * 100) };
            }
            
            for (const stage of stages) {
                if (finalScore >= stage.minScore && finalScore <= stage.maxScore) {
                    return { ...stage, score: finalScore, streak, achievementRate: Math.round(achievementRate * 100) };
                }
            }
            
            return { ...stages[0], score: finalScore, streak, achievementRate: Math.round(achievementRate * 100) };
        }

        // ï¼ˆå‰Šé™¤ï¼‰æ—§ãƒ‡ã‚¤ãƒªãƒ¼ã‚¯ã‚¨ã‚¹ãƒˆæ©Ÿèƒ½ã¯å¼·åº¦ï¼ˆIntensityï¼‰ã¸ç½®æ›æ¸ˆã¿

        // å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function showCompletionOptions() {
            // ã‚«ãƒ¼ãƒ‰ç²å¾—å‡¦ç†ã‚’å…ˆã«å®Ÿè¡Œ
            const data = loadData();
            const hypothesis = window.currentHypothesis;
            
            if (!hypothesis.cardsAcquired) {
                // æœ€çµ‚çš„ãªé”æˆç‡ã‚’è¨ˆç®—
                const achievedDays = Object.keys(hypothesis.achievements || {}).length;
                let finalRate = Math.round((achievedDays / hypothesis.totalDays) * 100);
                
                // é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                let hasAchievementBooster = false;
                if (data.cards && data.cards.activeEffects) {
                    hasAchievementBooster = data.cards.activeEffects.some(effect => 
                        effect.cardId === 'achievement_booster' && 
                        (!effect.targetHypothesisId || effect.targetHypothesisId === hypothesis.id)
                    );
                }
                
                // é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã®åŠ¹æœã‚’é©ç”¨ï¼ˆ15%ãƒœãƒ¼ãƒŠã‚¹ï¼‰
                if (hasAchievementBooster) {
                    finalRate = Math.min(100, finalRate + 15);
                    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                    showCardEffect('é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ç™ºå‹•ï¼', 'æœ€çµ‚é”æˆç‡ã«+15%ã®ãƒœãƒ¼ãƒŠã‚¹ï¼', '#10b981');
                    
                    // é”æˆãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚’æ¶ˆè²»
                    data.cards.activeEffects = data.cards.activeEffects.filter(effect =>
                        !(effect.cardId === 'achievement_booster' && 
                          (!effect.targetHypothesisId || effect.targetHypothesisId === hypothesis.id))
                    );
                }
                
                // é”æˆç‡æ¸›å°‘ãƒšãƒŠãƒ«ãƒ†ã‚£ã®é©ç”¨
                if (hypothesis.achievementDecrease) {
                    finalRate = Math.max(0, finalRate - hypothesis.achievementDecrease);
                    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                    showCardEffect('é”æˆç‡æ¸›å°‘ç™ºå‹•ï¼', `æœ€çµ‚é”æˆç‡ã‹ã‚‰${hypothesis.achievementDecrease}%æ¸›å°‘ã—ã¾ã—ãŸ`, '#ef4444');
                }
                
                hypothesis.finalAchievementRate = finalRate;
                
                // ã‚«ãƒ¼ãƒ‰ç²å¾—å‡¦ç†
                const acquiredCards = getCardsBasedOnAchievement(finalRate, hypothesis);
                if (acquiredCards.length > 0) {
                    acquiredCards.forEach(cardId => {
                        const card = CARD_MASTER[cardId];
                        if (card) {
                            if (card.type === 'reward') {
                                data.cards.inventory.push({
                                    cardId: cardId,
                                    acquiredDate: new Date().toISOString(),
                                    used: false
                                });
                            } else if (card.type === 'penalty') {
                                data.cards.pendingPenalties.push({
                                    cardId: cardId,
                                    acquiredDate: new Date().toISOString()
                                });
                            }
                        }
                    });
                    
                    // ã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    hypothesis.cardsAcquired = true;
                    window.currentHypothesis.cardsAcquired = true;
                    
                    // ç¾åœ¨ã®ç¿’æ…£ã‚’æ›´æ–°ï¼ˆã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜ï¼‰
                    const index = data.currentHypotheses.findIndex(h => h.id === hypothesis.id);
                    if (index !== -1) {
                        data.currentHypotheses[index].cardsAcquired = true;
                        data.currentHypotheses[index].finalAchievementRate = finalRate;
                    }
                    
                    saveData(data);
                    
                    // ã‚«ãƒ¼ãƒ‰ç²å¾—æ¼”å‡ºã‚’è¡¨ç¤º
                    showCardAcquisition(acquiredCards, () => {
                        // ã‚«ãƒ¼ãƒ‰ç²å¾—æ¼”å‡ºå¾Œã«ãƒ‡ãƒ–ãƒªãƒ¼ãƒ•â†’å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                        requestDebriefThenShowOptions();
                    });
                } else {
                    // ã‚«ãƒ¼ãƒ‰ãªã—ã§ã‚‚ãƒ•ãƒ©ã‚°ã¯è¨­å®š
                    hypothesis.cardsAcquired = true;
                    window.currentHypothesis.cardsAcquired = true;
                    
                    // ç¾åœ¨ã®ç¿’æ…£ã‚’æ›´æ–°
                    const index = data.currentHypotheses.findIndex(h => h.id === hypothesis.id);
                    if (index !== -1) {
                        data.currentHypotheses[index].cardsAcquired = true;
                        data.currentHypotheses[index].finalAchievementRate = finalRate;
                    }
                    
                    saveData(data);
                    
                    // ã‚«ãƒ¼ãƒ‰ãªã—ã®å ´åˆã‚‚ãƒ‡ãƒ–ãƒªãƒ¼ãƒ•â†’å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³
                    requestDebriefThenShowOptions();
                }
            } else {
                // ã™ã§ã«ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã—ã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                requestDebriefThenShowOptions();
            }
        }

        // ãƒ‡ãƒ–ãƒªãƒ¼ãƒ•ã‚’ä¿ƒã—ã¦ã‹ã‚‰å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function requestDebriefThenShowOptions() {
            const showOptions = () => {
                document.getElementById('completion-report-section').style.display = 'none';
                document.getElementById('completion-options').style.display = 'block';
            };
            if (!window.currentHypothesis.debrief) {
                showDebriefModal(() => showOptions());
            } else {
                showOptions();
            }
        }

        // ãƒ‡ãƒ–ãƒªãƒ¼ãƒ•ï¼ˆæº€è¶³åº¦/ä¸€è¨€ï¼‰ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showDebriefModal(onDone) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸ“ æŒ¯ã‚Šè¿”ã‚Šï¼ˆ30ç§’ï¼‰</h3>
                    <p>ä»Šå›ã®æ¤œè¨¼ã‚’5æ®µéšã§è©•ä¾¡ã—ã€ä¸€è¨€ãƒ¡ãƒ¢ã‚’æ®‹ã—ã¾ã—ã‚‡ã†</p>
                </div>
                <div class="form-group" style="margin:12px 0;">
                    <label>æº€è¶³åº¦ï¼ˆ1-5ï¼‰</label>
                    <input id="debrief-score" type="number" min="1" max="5" value="4" style="width:80px;" />
                </div>
                <div class="form-group" style="margin:12px 0;">
                    <label>ä¸€è¨€ãƒ¡ãƒ¢</label>
                    <input id="debrief-note" type="text" placeholder="ä¾‹: æœã‚¤ãƒãŒã‚„ã‚Šã‚„ã™ã‹ã£ãŸ" />
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚¹ã‚­ãƒƒãƒ—</button>
                    <button id="debrief-save" class="button primary">ä¿å­˜ã—ã¦ç¶šè¡Œ</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            document.getElementById('debrief-save').onclick = () => {
                const score = Math.min(5, Math.max(1, parseInt(document.getElementById('debrief-score').value || '3', 10)));
                const note = (document.getElementById('debrief-note').value || '').slice(0, 140);
                const data = loadData();
                const idx = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                const payload = { score, note, at: new Date().toISOString() };
                if (idx !== -1) {
                    data.currentHypotheses[idx].debrief = payload;
                }
                if (!data.meta) data.meta = {};
                data.meta.lastDebrief = payload;
                saveData(data);
                overlay.remove();
                onDone && onDone();
            };
        }

        // ç¾åœ¨ã®ç¿’æ…£ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        function updateCurrentHypothesisList() {
            const data = loadData();
            const listContainer = document.getElementById('current-hypothesis-list');
            if (!listContainer) {
                return;
            }
            listContainer.innerHTML = '';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®çŠ¶æ…‹ã‚’å–å¾—
            const categoryFilter = document.getElementById('category-filter');
            const filterValue = categoryFilter ? categoryFilter.value : 'all';
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredHypotheses = data.currentHypotheses;
            if (filterValue !== 'all') {
                filteredHypotheses = data.currentHypotheses.filter(h => h.category === filterValue);
            }
            
            if (filteredHypotheses.length === 0) {
                if (filterValue !== 'all') {
                    listContainer.innerHTML = '<p style="color: var(--text-secondary);">ã“ã®ã‚«ãƒ†ã‚´ãƒªã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    listContainer.innerHTML = '<p style="color: var(--text-secondary);">ç¾åœ¨é€²è¡Œä¸­ã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                }
                return;
            }
            
            // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰å®£è¨€çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ·±å¤œå¯¾å¿œï¼‰
            const todayKey = getActivityDateKey();
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒã‚¹ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            const categoryMaster = initializeCategoryMaster();
            
            // é »åº¦ã‚¿ã‚¤ãƒ—åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åˆ†ã‘ï¼ˆå¤§åˆ†é¡ï¼‰
            const frequencyGroups = {
                daily: { 
                    title: 'æ¯æ—¥ã®ç¿’æ…£', 
                    icon: 'â˜€ï¸', 
                    color: '#10b981',
                    categories: {} // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã•ã‚‰ã«åˆ†é¡
                },
                weekly: { 
                    title: 'é€±Nå›ã®ç¿’æ…£', 
                    icon: 'ğŸ“…', 
                    color: '#3b82f6',
                    categories: {}
                },
                weekdays: { 
                    title: 'æ›œæ—¥æŒ‡å®šã®ç¿’æ…£', 
                    icon: 'ğŸ“†', 
                    color: '#8b5cf6',
                    categories: {}
                }
            };
            
            // ç¿’æ…£ã‚’é »åº¦ã‚¿ã‚¤ãƒ—åˆ¥ã€ã•ã‚‰ã«ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«åˆ†é¡
            filteredHypotheses.forEach(hypothesis => {
                // ä¼‘çœ ä¸­ã®ç¿’æ…£ã¯åˆ¥ã‚°ãƒ«ãƒ¼ãƒ—ã«
                if (hypothesis.isSleeping) {
                    const categoryInfo = data.categoryMaster[hypothesis.category || 'other'] || data.categoryMaster.other;
                    const categoryKey = hypothesis.category || 'other';
                    
                    if (!frequencyGroups.sleeping) {
                        frequencyGroups.sleeping = {
                            title: 'ä¼‘çœ ä¸­ã®ç¿’æ…£',
                            icon: 'ğŸ˜´',
                            color: '#94a3b8',
                            categories: {}
                        };
                    }
                    
                    if (!frequencyGroups.sleeping.categories[categoryKey]) {
                        frequencyGroups.sleeping.categories[categoryKey] = [];
                    }
                    frequencyGroups.sleeping.categories[categoryKey].push(hypothesis);
                    return;
                }
                
                let frequencyType = 'daily'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ¯æ—¥
                if (hypothesis.frequency) {
                    frequencyType = hypothesis.frequency.type || 'daily';
                }
                
                const category = hypothesis.category || 'other'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãã®ä»–
                
                if (frequencyGroups[frequencyType]) {
                    if (!frequencyGroups[frequencyType].categories[category]) {
                        frequencyGroups[frequencyType].categories[category] = [];
                    }
                    frequencyGroups[frequencyType].categories[category].push(hypothesis);
                }
            });
            
            // ãƒˆã‚°ãƒ«çŠ¶æ…‹ã‚’ç®¡ç†ï¼ˆLocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
            const toggleStates = JSON.parse(localStorage.getItem('categoryToggleStates') || '{}');
            
            // é »åº¦ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã«è¡¨ç¤ºï¼ˆå¤§åˆ†é¡ï¼‰
            const createFrequencySection = (frequencyKey, frequencyData) => {
                // ã“ã®é »åº¦ã‚¿ã‚¤ãƒ—ã«ç¿’æ…£ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                const hasHabits = Object.values(frequencyData.categories).some(habits => habits.length > 0);
                if (!hasHabits) return null;
                
                const section = document.createElement('div');
                section.style.cssText = 'margin-bottom: 24px;';
                
                // é »åº¦ã‚¿ã‚¤ãƒ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒˆã‚°ãƒ«ä¸å¯ã€å¸¸ã«è¡¨ç¤ºï¼‰
                const frequencyHeader = document.createElement('div');
                const totalCount = Object.values(frequencyData.categories).reduce((sum, habits) => sum + habits.length, 0);
                frequencyHeader.style.cssText = `display: flex; align-items: center; gap: 8px; padding: 14px 16px; background: linear-gradient(135deg, ${frequencyData.color}20, ${frequencyData.color}10); border-radius: 12px; border: 2px solid ${frequencyData.color}; margin-bottom: 12px;`;
                frequencyHeader.innerHTML = `
                    <span style="font-size: 24px;">${frequencyData.icon}</span>
                    <span style="font-weight: 700; font-size: 18px; color: var(--text-primary);">${frequencyData.title}</span>
                    <span style="font-size: 14px; color: var(--text-secondary); margin-left: 8px; background: ${frequencyData.color}30; padding: 4px 12px; border-radius: 999px; font-weight: 600;">åˆè¨ˆ ${totalCount}å€‹</span>
                `;
                section.appendChild(frequencyHeader);
                
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆå°åˆ†é¡ï¼‰
                const categoriesContainer = document.createElement('div');
                categoriesContainer.style.cssText = 'margin-left: 20px;';
                
                Object.entries(frequencyData.categories).forEach(([categoryKey, habits]) => {
                    if (habits.length === 0) return;
                    
                    const categoryInfo = data.categoryMaster[categoryKey] || { name: categoryKey, icon: 'ğŸ“', color: '#6b7280' };
                    const categorySection = document.createElement('div');
                    categorySection.style.cssText = 'margin-bottom: 12px;';
                    
                    // ã‚«ãƒ†ã‚´ãƒªãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆãƒˆã‚°ãƒ«å¯èƒ½ï¼‰
                    const categoryHeader = document.createElement('div');
                    const toggleKey = `${frequencyKey}-${categoryKey}`;
                    const isOpen = toggleStates[toggleKey] !== false;
                    
                    categoryHeader.style.cssText = `display: flex; align-items: center; gap: 8px; padding: 10px 14px; background: linear-gradient(135deg, ${categoryInfo.color}10, ${categoryInfo.color}05); border-radius: 10px; border-left: 3px solid ${categoryInfo.color}; cursor: pointer; user-select: none; transition: all 0.2s;`;
                    categoryHeader.innerHTML = `
                        <span style="font-size: 18px;">${categoryInfo.icon}</span>
                        <span style="font-weight: 600; font-size: 15px; color: var(--text-primary);">${categoryInfo.name}</span>
                        <span style="font-size: 12px; color: var(--text-secondary); margin-left: 6px; background: ${categoryInfo.color}20; padding: 2px 8px; border-radius: 999px;">${habits.length}å€‹</span>
                        <span style="margin-left: auto; font-size: 16px; transition: transform 0.3s;" id="toggle-${toggleKey}">${isOpen ? 'â–¼' : 'â–¶'}</span>
                    `;
                    
                    // ã‚«ãƒ†ã‚´ãƒªã‚³ãƒ³ãƒ†ãƒ³ãƒ„
                    const categoryContent = document.createElement('div');
                    categoryContent.style.cssText = `overflow: hidden; transition: max-height 0.3s ease-out; max-height: ${isOpen ? '2000px' : '0'};`;
                    categoryContent.id = `content-${toggleKey}`;
                    
                    const itemsWrapper = document.createElement('div');
                    itemsWrapper.style.cssText = 'padding: 8px 0 8px 12px;';
                    habits.forEach(hypothesis => {
                        itemsWrapper.appendChild(createHypothesisItem(hypothesis, todayKey));
                    });
                    categoryContent.appendChild(itemsWrapper);
                    
                    // ã‚«ãƒ†ã‚´ãƒªã®ãƒˆã‚°ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
                    categoryHeader.onclick = () => {
                        const content = document.getElementById(`content-${toggleKey}`);
                        const toggle = document.getElementById(`toggle-${toggleKey}`);
                        const isCurrentlyOpen = content.style.maxHeight !== '0px';
                        
                        if (isCurrentlyOpen) {
                            content.style.maxHeight = '0';
                            toggle.textContent = 'â–¶';
                            toggleStates[toggleKey] = false;
                        } else {
                            content.style.maxHeight = '2000px';
                            toggle.textContent = 'â–¼';
                            toggleStates[toggleKey] = true;
                        }
                        
                        localStorage.setItem('categoryToggleStates', JSON.stringify(toggleStates));
                    };
                    
                    categorySection.appendChild(categoryHeader);
                    categorySection.appendChild(categoryContent);
                    categoriesContainer.appendChild(categorySection);
                });
                
                section.appendChild(categoriesContainer);
                return section;
            };
            
            // å„ç¿’æ…£ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä½œæˆã™ã‚‹å…±é€šé–¢æ•°
            const createHypothesisItem = (hypothesis, todayKey) => {
                const item = document.createElement('div');
                item.className = 'hypothesis-item';
                item.style.position = 'relative'; // å®Œã®ãƒãƒ³ã‚³ç”¨ã«position:relativeã‚’è¿½åŠ 
                item.onclick = () => showProgressView(hypothesis.id);
                
                // é•·æŠ¼ã—/å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
                attachLongPressToDelete(item, hypothesis.id);
                item.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    confirmDeleteHypothesis(hypothesis.id);
                });
                
                // ç¿’æ…£æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
                const stage = window.calculateHabitStage(hypothesis);
                
                const startDate = new Date(hypothesis.startDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // é–‹å§‹æ—¥ã‚’0æ™‚0åˆ†0ç§’ã«è¨­å®š
                startDate.setHours(0, 0, 0, 0);
                
                // çµŒéæ—¥æ•°ã‚’è¨ˆç®—ï¼ˆé–‹å§‹æ—¥ã‚’1æ—¥ç›®ã¨ã—ã¦è¨ˆç®—ï¼‰
                const timeDiff = today.getTime() - startDate.getTime();
                const daysPassed = Math.min(
                    Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1),
                    hypothesis.totalDays
                );
                // è¡¨ç¤ºé”æˆç‡: é”æˆæ—¥ã®å¼·åº¦å€ç‡åˆè¨ˆ Ã· å…¨æ—¥æ•° Ã— 100ï¼ˆå°æ•°ç‚¹åˆ‡ã‚Šæ¨ã¦ï¼‰
                const intensity = hypothesis.intensity || {};
                let weightedAchieved = 0;
                for (let i = 0; i < hypothesis.totalDays; i++) {
                    const d = new Date(startDate);
                    d.setDate(startDate.getDate() + i);
                    const key = dateKeyLocal(d);
                    if (hypothesis.achievements && hypothesis.achievements[key]) {
                        const mult = Number(intensity[key] ?? 1.0);
                        weightedAchieved += mult;
                    }
                }
                const displayRate = Math.min(100, Math.floor((weightedAchieved / hypothesis.totalDays) * 100));

                // ç›´è¿‘æ—¥ã®å¼·åº¦ãƒãƒƒã‚¸ï¼ˆä»Šæ—¥ã‹ã‚‰æœ€å¤§3æ—¥åˆ†ã€æœŸé–“å†…ã®ã¿ï¼‰
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + hypothesis.totalDays - 1);
                const opts = hypothesis.intensityOptions || [
                    { label: 'è»½ã‚', mult: 0.8 },
                    { label: 'åŸºæœ¬', mult: 1.0 },
                    { label: 'é«˜å¼·åº¦', mult: 1.2 },
                ];
                const toFixed1 = (n) => (Math.round(Number(n) * 10) / 10).toFixed(1);
                const badges = [];
                for (let k = 0; k < 3; k++) {
                    const d = new Date(today);
                    d.setHours(0,0,0,0);
                    d.setDate(d.getDate() - k);
                    if (d < startDate || d > endDate) continue;
                    const key = dateKeyLocal(d);
                    const mult = Number((intensity || {})[key] ?? 1.0);
                    const ach = !!((hypothesis.achievements || {})[key]);
                    const opt = opts.find(o => toFixed1(o.mult) === toFixed1(mult));
                    const labelText = opt ? opt.label : `Ã—${toFixed1(mult)}`;
                    const style = ach
                        ? 'background: rgba(16,185,129,0.15); border:1px solid #10b981; color:#10b981;'
                        : 'background: rgba(148,163,184,0.15); border:1px solid #475569; color:#94a3b8;';
                    badges.push(`<span style="${style} padding:2px 8px; border-radius:999px; font-size:11px;">${escapeHTML(labelText)}</span>`);
                }
                
                // é »åº¦è¡¨ç¤ºã‚’è¿½åŠ 
                let frequencyBadge = '';
                if (hypothesis.frequency && hypothesis.frequency.type === 'weekly') {
                    frequencyBadge = `<span style="display: inline-block; padding: 2px 8px; background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 999px; font-size: 11px; font-weight: 600; margin-left: 8px;">é€±${hypothesis.frequency.count || 3}å›</span>`;
                } else if (hypothesis.frequency && hypothesis.frequency.type === 'weekdays') {
                    const weekdayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                    const days = (hypothesis.frequency.weekdays || []).map(d => weekdayNames[d]).join('ãƒ»');
                    frequencyBadge = `<span style="display: inline-block; padding: 2px 8px; background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 999px; font-size: 11px; font-weight: 600; margin-left: 8px;">${days}</span>`;
                }
                
                item.innerHTML = `
                    <h3 class="hypothesis-title">${escapeHTML(hypothesis.title)}${frequencyBadge}</h3>
                    <p class="hypothesis-description">${escapeHTML(hypothesis.description)}</p>
                    ${stage ? `
                        <div style="margin: 12px 0; padding: 10px; background: linear-gradient(135deg, ${stage.color}15, ${stage.color}08); border-radius: 8px; border-left: 3px solid ${stage.color};">
                            <div style="font-size: 14px; font-weight: 600; color: ${stage.color}; margin-bottom: 4px;">
                                ${stage.name}
                            </div>
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                ${stage.description} (ã‚¹ã‚³ã‚¢: ${stage.score}ç‚¹)
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 6px; font-size: 11px;">
                                <span style="color: #10b981;">ğŸ”¥ é€£ç¶š${stage.streak}æ—¥</span>
                                <span style="color: #3b82f6;">ğŸ“Š é”æˆç‡${stage.achievementRate}%</span>
                            </div>
                        </div>
                    ` : ''}
                    <div class="hypothesis-meta">
                        <div class="hypothesis-days">
                            ğŸ“… ${daysPassed}æ—¥ç›® / ${hypothesis.totalDays}æ—¥é–“
                        </div>
                        <div class="hypothesis-progress">
                            âœ¨ é”æˆç‡: ${displayRate}%
                        </div>
                    </div>
                    ${badges.length ? `<div class="hypothesis-intensity" style="margin-top:8px; color: var(--text-secondary); font-size:12px; display:flex; align-items:center; gap:6px;">
                        <span>ğŸ’ª ç›´è¿‘:</span> ${badges.join(' ')}
                    </div>` : ''}
                    ${(() => {
                        const todayKey = getActivityDateKey();
                        const isAchievedToday = hypothesis.achievements && hypothesis.achievements[todayKey];
                        
                        return isAchievedToday ? `
                            <div style="position: absolute; top: 10px; right: 10px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                                <div style="position: relative; width: 100%; height: 100%; transform: rotate(-10deg);">
                                    <div style="position: absolute; inset: 0; border: 3px solid #dc2626; border-radius: 50%; background: rgba(220, 38, 38, 0.05);"></div>
                                    <div style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: bold; color: #dc2626; font-family: serif;">å®Œ</div>
                                </div>
                            </div>
                        ` : '';
                    })()}
                `;
                
                return item;
            };
            
            // é »åº¦ã‚¿ã‚¤ãƒ—ã”ã¨ã«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦è¡¨ç¤ºï¼ˆé †åºã‚’ä¿æŒï¼‰
            ['daily', 'weekly', 'weekdays'].forEach(frequencyKey => {
                const frequencyData = frequencyGroups[frequencyKey];
                if (frequencyData) {
                    const section = createFrequencySection(frequencyKey, frequencyData);
                    if (section) listContainer.appendChild(section);
                }
            });
            
            // ã‚«ãƒ†ã‚´ãƒªç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
            const editButton = document.createElement('button');
            editButton.className = 'btn btn-secondary';
            editButton.style.cssText = 'width: 100%; margin-top: 16px; padding: 12px; font-size: 14px;';
            editButton.innerHTML = 'âš™ï¸ ã‚«ãƒ†ã‚´ãƒªã‚’ç·¨é›†';
            editButton.onclick = editCategoryMaster;
            listContainer.appendChild(editButton);
            
        }

        // ç¿’æ…£ã‚’ç¶™ç¶š
        function continueHypothesis() {
            // ç¶™ç¶šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>ğŸŒ± ç¿’æ…£ã¨ã—ã¦ç¶™ç¶š</h3>
                    <p>ã“ã®ç¿’æ…£ã‚’ç¶™ç¶šã—ã¾ã™ã‹ï¼Ÿ</p>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>ç¶™ç¶šæœŸé–“</label>
                    <select id="continue-duration" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="30">30æ—¥é–“</option>
                        <option value="60">60æ—¥é–“</option>
                        <option value="90" selected>90æ—¥é–“ï¼ˆé»„é‡‘ã®ç¿’æ…£ã¾ã§ï¼‰</option>
                        <option value="180">180æ—¥é–“ï¼ˆåŠå¹´ï¼‰</option>
                        <option value="365">365æ—¥é–“ï¼ˆ1å¹´ï¼‰</option>
                        <option value="unlimited">ç„¡æœŸé™</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>
                        <input type="checkbox" id="continue-keep-records" checked> 
                        ã“ã‚Œã¾ã§ã®è¨˜éŒ²ã‚’å¼•ãç¶™ã
                    </label>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>
                        <input type="checkbox" id="continue-as-habit" checked> 
                        ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ã§ç¶™ç¶šï¼ˆé»„é‡‘ã®ç¿’æ…£ã‚’ç›®æŒ‡ã™ï¼‰
                    </label>
                </div>
                <div style="padding: 12px; background: var(--surface); border-radius: 8px; margin: 16px 0;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">
                        ğŸ’¡ ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã€ç¶™ç¶šçš„ãªé”æˆã«ã‚ˆã‚Šã€Œé»„é‡‘ã®ç¿’æ…£ã€ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
                        è¨˜éŒ²ã‚’å¼•ãç¶™ãã¨ã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¨ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãŒä¿æŒã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" onclick="confirmContinueHypothesis()">ç¶™ç¶šã™ã‚‹</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        // ç¶™ç¶šã‚’ç¢ºå®š
        function confirmContinueHypothesis() {
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            
            if (index !== -1) {
                const durationSelect = document.getElementById('continue-duration');
                const keepRecords = document.getElementById('continue-keep-records').checked;
                const asHabit = document.getElementById('continue-as-habit').checked;
                const duration = durationSelect.value;
                
                // æœŸé–“ã‚’è¨­å®š
                if (duration === 'unlimited') {
                    // ç„¡æœŸé™ã®å ´åˆã¯å¤§ããªæ•°å€¤ã‚’è¨­å®šï¼ˆ10å¹´ï¼‰
                    data.currentHypotheses[index].totalDays = 3650;
                    data.currentHypotheses[index].isUnlimited = true;
                } else {
                    const additionalDays = parseInt(duration);
                    if (keepRecords) {
                        // è¨˜éŒ²ã‚’å¼•ãç¶™ãå ´åˆã¯ç¾åœ¨ã®æœŸé–“ã«è¿½åŠ 
                        data.currentHypotheses[index].totalDays += additionalDays;
                    } else {
                        // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å ´åˆ
                        data.currentHypotheses[index].totalDays = additionalDays;
                        data.currentHypotheses[index].achievements = {};
                        data.currentHypotheses[index].intensity = {};
                        data.currentHypotheses[index].startDate = new Date().toISOString();
                        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚‚ãƒªã‚»ãƒƒãƒˆ
                        delete data.currentHypotheses[index].currentStage;
                    }
                }
                
                // ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                data.currentHypotheses[index].habitMode = asHabit;
                data.currentHypotheses[index].continuedAt = new Date().toISOString();
                data.currentHypotheses[index].isContinuation = true;
                
                // ã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ–°ã—ã„æœŸé–“ã§ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã§ãã‚‹ã‚ˆã†ã«ï¼‰
                delete data.currentHypotheses[index].cardsAcquired;
                delete data.currentHypotheses[index].finalAchievementRate;
                
                saveData(data);
                
                window.currentHypothesis = data.currentHypotheses[index];
                updateCalendar();
                updateProgress();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                document.querySelector('.overlay').remove();
                
                // å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¦ã€é€šå¸¸ã®é€²æ—ç”»é¢ã«æˆ»ã‚‹
                document.getElementById('completion-options').style.display = 'none';
                document.getElementById('completion-report-section').style.display = 'none';
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                const message = duration === 'unlimited' 
                    ? 'âœ¨ ç¿’æ…£ã¨ã—ã¦ç„¡æœŸé™ã§ç¶™ç¶šã—ã¾ã™ï¼'
                    : `âœ¨ ç¿’æ…£ã¨ã—ã¦${duration}æ—¥é–“ç¶™ç¶šã—ã¾ã™ï¼`;
                showNotification(message, 'success');
                
                // ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (asHabit) {
                    const stage = window.calculateHabitStage(window.currentHypothesis);
                    if (stage) {
                        setTimeout(() => {
                            showCardEffect(
                                `ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸: ${stage.name}`,
                                stage.description,
                                stage.color
                            );
                        }, 1000);
                    }
                }
            }
        }

        // ä¿®æ­£ã—ã¦ç¶™ç¶š
        function modifyAndContinue() {
            // ä¿®æ­£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«
            const overlay = document.createElement('div');
            overlay.className = 'overlay active';
            const modal = document.createElement('div');
            modal.className = 'skip-modal active';
            modal.style.width = '90%';
            modal.style.maxWidth = '500px';
            modal.innerHTML = `
                <div class="modal-header">
                    <h3>âœï¸ ç¿’æ…£å†…å®¹ã‚’ä¿®æ­£ã—ã¦ç¶™ç¶š</h3>
                    <p>ç¿’æ…£ã®å†…å®¹ã‚’èª¿æ•´ã§ãã¾ã™</p>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>ç¿’æ…£å</label>
                    <input type="text" id="modify-title" value="${window.currentHypothesis.title}" 
                           style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>èª¬æ˜</label>
                    <textarea id="modify-description" rows="3" 
                              style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">${window.currentHypothesis.description}</textarea>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>ç¶™ç¶šæœŸé–“</label>
                    <select id="modify-duration" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border);">
                        <option value="30">30æ—¥é–“</option>
                        <option value="60">60æ—¥é–“</option>
                        <option value="90" selected>90æ—¥é–“ï¼ˆé»„é‡‘ã®ç¿’æ…£ã¾ã§ï¼‰</option>
                        <option value="180">180æ—¥é–“ï¼ˆåŠå¹´ï¼‰</option>
                        <option value="365">365æ—¥é–“ï¼ˆ1å¹´ï¼‰</option>
                        <option value="unlimited">ç„¡æœŸé™</option>
                    </select>
                </div>
                <div class="form-group" style="margin: 20px 0;">
                    <label>
                        <input type="checkbox" id="modify-keep-records" checked> 
                        ã“ã‚Œã¾ã§ã®è¨˜éŒ²ã‚’å¼•ãç¶™ã
                    </label>
                </div>
                <div style="padding: 12px; background: var(--surface); border-radius: 8px; margin: 16px 0;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin: 0;">
                        ğŸ’¡ ç¿’æ…£ã®å†…å®¹ã‚’å¤‰æ›´ã—ã¦ã‚‚ã€ã“ã‚Œã¾ã§ã®é”æˆè¨˜éŒ²ã¨ã‚¹ãƒ†ãƒ¼ã‚¸ã¯ä¿æŒã•ã‚Œã¾ã™ã€‚
                        æ–°ã—ã„ç›®æ¨™ã«å‘ã‘ã¦ã€ç¾åœ¨ã®é€²æ—ã‹ã‚‰ç¶™ç¶šã§ãã¾ã™ã€‚
                    </p>
                </div>
                <div class="modal-footer">
                    <button class="button secondary" onclick="this.closest('.overlay').remove()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="button primary" onclick="confirmModifyAndContinue()">å¤‰æ›´ã—ã¦ç¶™ç¶š</button>
                </div>
            `;
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }
        
        // ä¿®æ­£ã—ã¦ç¶™ç¶šã‚’ç¢ºå®š
        function confirmModifyAndContinue() {
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            
            if (index !== -1) {
                const newTitle = document.getElementById('modify-title').value.trim();
                const newDescription = document.getElementById('modify-description').value.trim();
                const duration = document.getElementById('modify-duration').value;
                const keepRecords = document.getElementById('modify-keep-records').checked;
                
                if (!newTitle) {
                    alert('ç¿’æ…£åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // ã‚¿ã‚¤ãƒˆãƒ«ã¨èª¬æ˜ã‚’æ›´æ–°
                data.currentHypotheses[index].title = newTitle;
                data.currentHypotheses[index].description = newDescription;
                
                // ä¿®æ­£å±¥æ­´ã‚’è¨˜éŒ²
                if (!data.currentHypotheses[index].modificationHistory) {
                    data.currentHypotheses[index].modificationHistory = [];
                }
                data.currentHypotheses[index].modificationHistory.push({
                    date: new Date().toISOString(),
                    previousTitle: window.currentHypothesis.title,
                    previousDescription: window.currentHypothesis.description,
                    newTitle: newTitle,
                    newDescription: newDescription
                });
                
                // æœŸé–“ã‚’è¨­å®š
                if (duration === 'unlimited') {
                    data.currentHypotheses[index].totalDays = 3650;
                    data.currentHypotheses[index].isUnlimited = true;
                } else {
                    const additionalDays = parseInt(duration);
                    if (keepRecords) {
                        // è¨˜éŒ²ã‚’å¼•ãç¶™ãå ´åˆã¯ç¾åœ¨ã®æœŸé–“ã«è¿½åŠ 
                        data.currentHypotheses[index].totalDays += additionalDays;
                    } else {
                        // è¨˜éŒ²ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹å ´åˆ
                        data.currentHypotheses[index].totalDays = additionalDays;
                        data.currentHypotheses[index].achievements = {};
                        data.currentHypotheses[index].intensity = {};
                        data.currentHypotheses[index].startDate = new Date().toISOString();
                        delete data.currentHypotheses[index].currentStage;
                    }
                }
                
                // ç¿’æ…£ãƒ¢ãƒ¼ãƒ‰ã¨ç¶™ç¶šãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                data.currentHypotheses[index].habitMode = true;
                data.currentHypotheses[index].modifiedAt = new Date().toISOString();
                data.currentHypotheses[index].isContinuation = true;
                
                // ã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                delete data.currentHypotheses[index].cardsAcquired;
                delete data.currentHypotheses[index].finalAchievementRate;
                
                saveData(data);
                
                window.currentHypothesis = data.currentHypotheses[index];
                updateCalendar();
                updateProgress();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                document.querySelector('.overlay').remove();
                
                // å®Œäº†ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã—ã¦ã€é€šå¸¸ã®é€²æ—ç”»é¢ã«æˆ»ã‚‹
                document.getElementById('completion-options').style.display = 'none';
                document.getElementById('completion-report-section').style.display = 'none';
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showNotification(`âœ¨ ã€Œ${newTitle}ã€ã¨ã—ã¦ç¶™ç¶šã—ã¾ã™ï¼`, 'success');
                
                // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const stage = window.calculateHabitStage(window.currentHypothesis);
                if (stage) {
                    setTimeout(() => {
                        showCardEffect(
                            `ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸: ${stage.name}`,
                            stage.description,
                            stage.color
                        );
                    }, 1000);
                }
            }
        }

        // ç¿’æ…£ã‚’å®Œäº†
        function completeHypothesis(showHome = true) {
            // completeHypothesis
            
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            
            // index for current hypothesis
            
            if (index !== -1) {
                const hypothesis = data.currentHypotheses[index];
                hypothesis.completedDate = new Date().toISOString();
                
                // finalAchievementRateãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¨ˆç®—ï¼ˆé€šå¸¸ã¯showCompletionOptionsã§è¨­å®šæ¸ˆã¿ï¼‰
                if (!hypothesis.finalAchievementRate && hypothesis.finalAchievementRate !== 0) {
                    const achievedDays = Object.keys(hypothesis.achievements || {}).length;
                    let finalRate = Math.round((achievedDays / hypothesis.totalDays) * 100);
                    
                    // é”æˆç‡æ¸›å°‘ãƒšãƒŠãƒ«ãƒ†ã‚£ã®é©ç”¨
                    if (hypothesis.achievementDecrease) {
                        finalRate = Math.max(0, finalRate - hypothesis.achievementDecrease);
                    }
                    
                    hypothesis.finalAchievementRate = finalRate;
                }
                
                // ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                let hasDoubleOrNothing = false;
                if (data.cards && data.cards.activeEffects) {
                    hasDoubleOrNothing = data.cards.activeEffects.some(effect => 
                        effect.cardId === 'double_or_nothing'
                    );
                }
                
                // ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ã®åŠ¹æœã‚’é©ç”¨
                if (hasDoubleOrNothing && hypothesis.finalAchievementRate < 100) {
                    // 100%æœªæº€ã®å ´åˆã¯ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’2æšä»˜ä¸
                    const penaltyCards = ['extension_card', 'short_term', 'achievement_decrease', 'hard_mode', 'reset_risk'];
                    
                    for (let i = 0; i < 2; i++) {
                        const randomCard = penaltyCards[Math.floor(Math.random() * penaltyCards.length)];
                        data.cards.pendingPenalties.push({
                            cardId: randomCard,
                            acquiredDate: new Date().toISOString()
                        });
                    }
                    
                    // ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ã‚’æ¶ˆè²»
                    data.cards.activeEffects = data.cards.activeEffects.filter(effect =>
                        effect.cardId !== 'double_or_nothing'
                    );
                    
                    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                    setTimeout(() => {
                        showCardEffect('ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ç™ºå‹•ï¼', '100%æœªæº€ã®ãŸã‚ã€ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’2æšç²å¾—...', '#ef4444');
                    }, 500);
                }
                
                // å®Œäº†ãƒªã‚¹ãƒˆã«è¿½åŠ 
                data.completedHypotheses.push(hypothesis);
                
                // ç¾åœ¨ã®ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                data.currentHypotheses.splice(index, 1);
                
                saveData(data);
                
                if (showHome) {
                    showNotification('âœ… ç¿’æ…£ã®æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
                    showHomeView();
                }
            }
        }

        // é”æˆç‡ã«åŸºã¥ã„ã¦ã‚«ãƒ¼ãƒ‰ã‚’å–å¾—
        function getCardsBasedOnAchievement(achievementRate, hypothesis) {
            const cards = [];
            const data = loadData();
            
            // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€90%æœªæº€ã¯ã‚«ãƒ¼ãƒ‰ãªã—
            if (hypothesis && hypothesis.hardMode && achievementRate < 90) {
                return cards; // ç©ºã®é…åˆ—ã‚’è¿”ã™
            }
            
            // ç¿’æ…£ã®æœŸé–“ã‹ã‚‰ãƒ¬ã‚¢ãƒªãƒ†ã‚£ãƒœãƒ¼ãƒŠã‚¹ã‚’è¨ˆç®—
            const getDurationBonus = (days) => {
                if (days >= 30) return 0.4;  // é•·æœŸï¼ˆ30æ—¥ä»¥ä¸Šï¼‰ï¼šãƒ¬ã‚¢ç‡+40%
                if (days >= 21) return 0.25; // ä¸­é•·æœŸï¼ˆ21-29æ—¥ï¼‰ï¼šãƒ¬ã‚¢ç‡+25%
                if (days >= 14) return 0.15; // ä¸­æœŸï¼ˆ14-20æ—¥ï¼‰ï¼šãƒ¬ã‚¢ç‡+15%
                if (days >= 7) return 0.05;  // çŸ­ä¸­æœŸï¼ˆ7-13æ—¥ï¼‰ï¼šãƒ¬ã‚¢ç‡+5%
                return 0;                     // çŸ­æœŸï¼ˆ6æ—¥ä»¥ä¸‹ï¼‰ï¼šãƒœãƒ¼ãƒŠã‚¹ãªã—
            };
            
            const durationBonus = hypothesis ? getDurationBonus(hypothesis.totalDays) : 0;
            
            // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            if (hypothesis) {
                console.log(`ç¿’æ…£æœŸé–“: ${hypothesis.totalDays}æ—¥, æœŸé–“ãƒœãƒ¼ãƒŠã‚¹: +${(durationBonus * 100).toFixed(0)}%`);
            }
            
            // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            let hasPerfectBonus = false;
            if (data.cards && data.cards.activeEffects) {
                hasPerfectBonus = data.cards.activeEffects.some(effect => 
                    effect.cardId === 'perfect_bonus' && !effect.targetHypothesisId
                );
            }
            // ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            let hasSurpriseBoost = false;
            if (data.cards && data.cards.activeEffects) {
                hasSurpriseBoost = data.cards.activeEffects.some(effect => 
                    effect.cardId === 'surprise_boost' && (!effect.targetHypothesisId || effect.targetHypothesisId === hypothesis.id)
                );
            }
            
            if (achievementRate === 100) {
                // 100%é”æˆ: æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã§ãƒ¬ã‚¢ç‡ä¸Šæ˜‡
                const rand = Math.random();
                
                // æ–°ã‚«ãƒ¼ãƒ‰ã‚’å«ã‚€å ±é…¬ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«
                const legendaryCards = [
                    'perfect_bonus', 'second_chance', 'achievement_booster',
                    'event_trigger', 'event_combo', 'point_gem', 
                    'mission_master', 'rainbow_boost', 'quick_start',
                    'streak_bonus', 'lucky_seven', 'conversion_magic'
                ];
                const rareCards = [
                    'achievement_boost', 'protect_shield', 'skip_ticket'
                ];
                const commonCards = [
                    'skip_ticket', 'destiny_dice'
                ];
                
                // æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã‚’åŠ å‘³ã—ãŸãƒ¬ã‚¢ãƒªãƒ†ã‚£åˆ¤å®š
                const baseLegendaryChance = hasSurpriseBoost ? 0.25 : 0.15;
                const legendaryChance = baseLegendaryChance + (durationBonus * 0.5); // æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã®åŠåˆ†ã‚’ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã«
                const rareChance = hasSurpriseBoost ? 0.45 : 0.35;
                const adjustedRareChance = rareChance + (durationBonus * 0.3); // æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã®30%ã‚’ãƒ¬ã‚¢ã«
                
                if (rand < legendaryChance) {
                    // ãƒ¬ã‚¸ã‚§ãƒ³ãƒ€ãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
                    const selectedCard = legendaryCards[Math.floor(Math.random() * legendaryCards.length)];
                    cards.push(selectedCard);
                } else if (rand < legendaryChance + adjustedRareChance) {
                    // ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰
                    const selectedCard = rareCards[Math.floor(Math.random() * rareCards.length)];
                    cards.push(selectedCard);
                } else {
                    // ã‚³ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰
                    const selectedCard = commonCards[Math.floor(Math.random() * commonCards.length)];
                    cards.push(selectedCard);
                }
                
                // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ãŒæœ‰åŠ¹ãªå ´åˆã€è¿½åŠ ã§1æšç²å¾—
                if (hasPerfectBonus) {
                    const rand2 = Math.random();
                    if (rand2 < 0.1) {
                        cards.push('perfect_bonus');
                    } else if (rand2 < 0.4) {
                        cards.push('achievement_boost');
                    } else {
                        cards.push('skip_ticket');
                    }
                    
                    // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã‚’æ¶ˆè²»
                    data.cards.activeEffects = data.cards.activeEffects.filter(effect =>
                        effect.cardId !== 'perfect_bonus'
                    );
                    saveData(data);
                    
                    // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                    setTimeout(() => {
                        showCardEffect('ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ç™ºå‹•ï¼', 'è¿½åŠ ã§å ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’1æšç²å¾—ï¼', '#f59e0b');
                    }, 1000);
                }
            } else if (achievementRate >= 80) {
                // 80-99%é”æˆ: æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã§ãƒ¬ã‚¢ç‡ä¸Šæ˜‡
                const rand = Math.random();
                
                const rareCards = [
                    'achievement_boost', 'protect_shield', 'skip_ticket'
                ];
                const commonCards = [
                    'skip_ticket', 'destiny_dice'
                ];
                
                // æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã‚’åŠ å‘³ã—ãŸãƒ¬ã‚¢ç‡
                const baseRareChance = hasSurpriseBoost ? 0.35 : 0.2;
                const rareChance = baseRareChance + durationBonus; // æœŸé–“ãƒœãƒ¼ãƒŠã‚¹ã‚’ãã®ã¾ã¾åŠ ç®—
                
                if (rand < rareChance) {
                    // ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰
                    const selectedCard = rareCards[Math.floor(Math.random() * rareCards.length)];
                    cards.push(selectedCard);
                } else {
                    // ã‚³ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰
                    const selectedCard = commonCards[Math.floor(Math.random() * commonCards.length)];
                    cards.push(selectedCard);
                }
            } else if (achievementRate < 60) {
                // 59%ä»¥ä¸‹: ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ï¼ˆæœŸé–“ãŒé•·ã„ã»ã©å¼·ã„ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰
                const rand = Math.random();
                
                // æ–°ã‚«ãƒ¼ãƒ‰ã‚’å«ã‚€ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«
                const commonPenalties = ['extension_card', 'short_term', 'achievement_decrease'];
                const rarePenalties = [
                    'hard_mode', 'reset_risk', 'event_seal', 
                    'mission_addition', 'slowdown', 'reverse_curse'
                ];
                
                // æœŸé–“ãŒé•·ã„ã»ã©ãƒ¬ã‚¢ãƒšãƒŠãƒ«ãƒ†ã‚£ç‡ä¸Šæ˜‡ï¼ˆé€†åŠ¹æœï¼‰
                const rarePenaltyChance = 0.6 + (durationBonus * 0.5);
                
                if (rand < rarePenaltyChance) {
                    // ãƒ¬ã‚¢ãƒšãƒŠãƒ«ãƒ†ã‚£
                    const selectedCard = rarePenalties[Math.floor(Math.random() * rarePenalties.length)];
                    cards.push(selectedCard);
                } else {
                    // ã‚³ãƒ¢ãƒ³ãƒšãƒŠãƒ«ãƒ†ã‚£
                    const selectedCard = commonPenalties[Math.floor(Math.random() * commonPenalties.length)];
                    cards.push(selectedCard);
                }
            }
            // 60-79%ã¯ä½•ã‚‚ç²å¾—ã—ãªã„
            // ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆã¯çµæœç¢ºå®šæ™‚ã«æ¶ˆè²»
            if (hasSurpriseBoost && data.cards && data.cards.activeEffects) {
                data.cards.activeEffects = data.cards.activeEffects.filter(effect =>
                    !(effect.cardId === 'surprise_boost' && (!effect.targetHypothesisId || effect.targetHypothesisId === hypothesis.id))
                );
                saveData(data);
                setTimeout(() => {
                    showCardEffect('ğŸ ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆæ¶ˆè²»', 'ä»Šå›ã®æŠ½é¸ã§ãƒ¬ã‚¢ç‡ãŒä¸ŠãŒã‚Šã¾ã—ãŸ', '#3b82f6');
                }, 500);
            }
            
            return cards;
        }

        // ã‚µãƒ—ãƒ©ã‚¤ã‚ºæ¼”å‡ºï¼ˆ7/14/21æ—¥ç›®ã§ä¸€åº¦ã ã‘ç™ºç«ï¼‰
        function triggerSurpriseIfNeeded(hyp, daysPassed) {
            if (!hyp) return;
            const milestones = [7, 14, 21];
            hyp.surpriseHits = hyp.surpriseHits || [];
            if (!milestones.includes(daysPassed)) return;
            if (hyp.surpriseHits.includes(daysPassed)) return;
            hyp.surpriseHits.push(daysPassed);
            const data = loadData();
            // åŠ¹æœã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–ï¼ˆã“ã®ç¿’æ…£ã«ç´ã¥ã‘ï¼‰
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            data.cards.activeEffects.push({
                cardId: 'surprise_boost',
                activatedDate: new Date().toISOString(),
                targetHypothesisId: hyp.id
            });
            // ä¿å­˜
            const idx = data.currentHypotheses.findIndex(h => h.id === hyp.id);
            if (idx !== -1) data.currentHypotheses[idx] = hyp;
            saveData(data);
            // æ¼”å‡º
            showCardEffect('ğŸ‰ ã‚µãƒ—ãƒ©ã‚¤ã‚ºï¼', 'æ¬¡ã®ã‚«ãƒ¼ãƒ‰æŠ½é¸ã§ãƒ¬ã‚¢ç‡UPï¼', '#3b82f6');
            if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
        }

        // å±¥æ­´ç”»é¢ã‚’è¡¨ç¤º
        function showHistoryView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'block';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('points-view').style.display = 'none';
            document.getElementById('cards-view').style.display = 'none';
            
            updateNavigation('history');
            
            // å±¥æ­´ç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’å†è¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'flex';
            }
            
            const data = loadData();
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (data.completedHypotheses.length === 0) {
                historyList.innerHTML = '<p style="color: var(--text-secondary);">å®Œäº†ã—ãŸç¿’æ…£ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            // æ–°ã—ã„é †ã«è¡¨ç¤º
            const sortedHistory = [...data.completedHypotheses].reverse();
            
            sortedHistory.forEach(hypothesis => {
                const item = document.createElement('div');
                item.className = 'history-item';
                
                const completedDate = new Date(hypothesis.completedDate);
                const dateStr = completedDate.toLocaleDateString('ja-JP');
                
                item.innerHTML = `
                    <div class="history-info">
                        <h4>${escapeHTML(hypothesis.title)}</h4>
                        <div class="history-meta">
                            å®Œäº†æ—¥: ${dateStr} | æœŸé–“: ${hypothesis.totalDays}æ—¥é–“
                        </div>
                    </div>
                    <div class="achievement-badge">
                        ${hypothesis.finalAchievementRate}%
                    </div>
                `;
                
                // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
                item.ondblclick = () => {
                    if (confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                        const newData = loadData();
                        newData.completedHypotheses = newData.completedHypotheses.filter(h => h.id !== hypothesis.id);
                        saveData(newData);
                        showHistoryView();
                    }
                };
                
                historyList.appendChild(item);
            });
        }

        // çµ±è¨ˆç”»é¢ã‚’è¡¨ç¤º
        function showStatsView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'block';
            document.getElementById('points-view').style.display = 'none';
            document.getElementById('cards-view').style.display = 'none';
            
            updateNavigation('stats');
            
            // çµ±è¨ˆç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’å†è¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'flex';
            }
            
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸çµ±è¨ˆã‚’æ›´æ–°
            updateChallengeStats();
            
            // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«çµ±è¨ˆã‚’æ›´æ–°
            updateJournalStats();
            
            const data = loadData();
            const totalHypotheses = data.currentHypotheses.length + data.completedHypotheses.length;
            let totalAchievement = 0; // ç¿’æ…£å¹³å‡ç”¨
            let uniqueDates = new Set();
            let weightedAchieved = 0; // å…¨ä½“é‡ã¿ä»˜ãé”æˆã®åˆè¨ˆ

            const today = new Date();
            today.setHours(0,0,0,0);

            const all = [...data.currentHypotheses, ...data.completedHypotheses];
            all.forEach(hypothesis => {
                const start = new Date(hypothesis.startDate);
                start.setHours(0,0,0,0);
                const theoreticalEnd = new Date(start);
                theoreticalEnd.setDate(start.getDate() + (hypothesis.totalDays || 0) - 1);
                const end = hypothesis.completedDate ? new Date(hypothesis.completedDate) : today;
                end.setHours(0,0,0,0);
                const last = theoreticalEnd < end ? theoreticalEnd : end;

                // ãƒ¦ãƒ‹ãƒ¼ã‚¯æ—¥ã‚’åé›†
                for (let d = new Date(start); d <= last; d.setDate(d.getDate() + 1)) {
                    uniqueDates.add(dateKeyLocal(d));
                }

                // é‡ã¿ä»˜ãé”æˆã®é›†è¨ˆ
                const intensity = hypothesis.intensity || {};
                const achievements = hypothesis.achievements || {};
                Object.keys(achievements).forEach(key => {
                    const kd = new Date(key);
                    kd.setHours(0,0,0,0);
                    if (kd >= start && kd <= last) {
                        const mult = Number(intensity[key] ?? 1.0);
                        weightedAchieved += mult;
                    }
                });

                // ç¿’æ…£ã”ã¨ã®å¹³å‡é”æˆç‡ï¼ˆè¡¨ç¤ºç”¨ã«ç¶™ç¶šï¼‰
                const timeDiff = Math.min(last.getTime(), today.getTime()) - start.getTime();
                const daysPassed = Math.min(
                    Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1),
                    hypothesis.totalDays || 0
                );
                const achievedDays = Object.keys(achievements).length;
                const achievementRate = daysPassed > 0 ? Math.round((achievedDays / daysPassed) * 100) : 0;
                totalAchievement += achievementRate;
            });

            const totalDaysUnique = uniqueDates.size;
            const avgAchievement = totalHypotheses > 0 ? Math.round(totalAchievement / totalHypotheses) : 0;
            document.getElementById('total-hypotheses').textContent = totalHypotheses;
            document.getElementById('avg-achievement').textContent = avgAchievement + '%';
            document.getElementById('total-days').textContent = totalDaysUnique;
            const wa = document.getElementById('weighted-achieved');
            if (wa) wa.textContent = (Math.round(weightedAchieved * 10) / 10).toString();

            // ç¿’æ…£æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸ã®è¨ˆç®—é–¢æ•°
            function calculateHabitStage(hypothesis) {
                if (!hypothesis || !hypothesis.achievements) return null;
                
                const start = new Date(hypothesis.startDate);
                start.setHours(0, 0, 0, 0);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // é”æˆæ—¥æ•°ã®è¨ˆç®—
                const achievedDays = Object.keys(hypothesis.achievements).length;
                
                // é€£ç¶šé”æˆæ—¥æ•°ã®è¨ˆç®—
                const streak = computeStreak(hypothesis);
                
                // é€±å˜ä½ã§ã®é”æˆæ•°ã‚’è¨ˆç®—ï¼ˆé€±â—¯å›ã‚„ç‰¹å®šæ›œæ—¥ã®å ´åˆï¼‰
                let achievedWeeks = 0;
                if (hypothesis.frequency && (hypothesis.frequency.type === 'weekly' || hypothesis.frequency.type === 'weekdays')) {
                    const weeks = Math.ceil((today - start) / (7 * 24 * 60 * 60 * 1000));
                    for (let w = 0; w < weeks; w++) {
                        const weekStart = new Date(start);
                        weekStart.setDate(start.getDate() + w * 7);
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        
                        let weekAchievements = 0;
                        for (let d = new Date(weekStart); d <= weekEnd && d <= today; d.setDate(d.getDate() + 1)) {
                            const key = dateKeyLocal(d);
                            if (hypothesis.achievements[key]) weekAchievements++;
                        }
                        
                        if (hypothesis.frequency.type === 'weekly' && weekAchievements >= hypothesis.frequency.count) {
                            achievedWeeks++;
                        } else if (hypothesis.frequency.type === 'weekdays') {
                            const targetDaysInWeek = hypothesis.frequency.weekdays.filter(wd => {
                                for (let d = new Date(weekStart); d <= weekEnd && d <= today; d.setDate(d.getDate() + 1)) {
                                    if (d.getDay() === wd) return true;
                                }
                                return false;
                            }).length;
                            if (targetDaysInWeek > 0 && weekAchievements >= targetDaysInWeek * 0.8) {
                                achievedWeeks++;
                            }
                        }
                    }
                }
                
                // åŸºæœ¬ã‚¹ã‚³ã‚¢ã®è¨ˆç®—
                let baseScore = achievedDays;
                if (hypothesis.frequency) {
                    if (hypothesis.frequency.type === 'weekly' || hypothesis.frequency.type === 'weekdays') {
                        baseScore = achievedWeeks * 7; // é€±å˜ä½ã‚’æ—¥æ•°æ›ç®—
                    }
                }
                
                // é€£ç¶šãƒœãƒ¼ãƒŠã‚¹ã®è¨ˆç®—ï¼ˆ1.0ï½2.0ï¼‰
                let continuityBonus = 1.0;
                if (streak >= 90) {
                    continuityBonus = 2.0;
                } else if (streak >= 60) {
                    continuityBonus = 1.7;
                } else if (streak >= 30) {
                    continuityBonus = 1.5;
                } else if (streak >= 14) {
                    continuityBonus = 1.3;
                } else if (streak >= 7) {
                    continuityBonus = 1.1;
                }
                
                // é€”åˆ‡ã‚ŒãƒšãƒŠãƒ«ãƒ†ã‚£
                const totalDays = Math.floor((today - start) / (24 * 60 * 60 * 1000)) + 1;
                const achievementRate = achievedDays / totalDays;
                if (achievementRate < 0.5 && totalDays > 7) {
                    continuityBonus *= 0.8;
                }
                
                // æœ€çµ‚ã‚¹ã‚³ã‚¢
                const finalScore = Math.floor(baseScore * continuityBonus);
                
                // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š
                const stages = [
                    { name: 'ğŸŒ± ç¨®ã¾ãæœŸ', minScore: 0, maxScore: 7, color: '#6b7280', description: 'ç¿’æ…£ã®ç¨®ã‚’æ¤ãˆãŸæ®µéš' },
                    { name: 'ğŸŒ¿ ç™ºèŠ½æœŸ', minScore: 8, maxScore: 14, color: '#10b981', description: 'å°ã•ãªèŠ½ãŒå‡ºã¦ããŸ' },
                    { name: 'ğŸ€ æˆé•·æœŸ', minScore: 15, maxScore: 30, color: '#3b82f6', description: 'è‘‰ãŒå¢—ãˆã¦æˆé•·ä¸­' },
                    { name: 'ğŸŒ³ å®šç€æœŸ', minScore: 31, maxScore: 60, color: '#8b5cf6', description: 'ã—ã£ã‹ã‚Šã¨ã—ãŸæœ¨ã«æˆé•·' },
                    { name: 'ğŸŒ¸ é–‹èŠ±æœŸ', minScore: 61, maxScore: 90, color: '#f59e0b', description: 'èŠ±ãŒå’²ãå§‹ã‚ã‚‹' },
                    { name: 'ğŸ åç©«æœŸ', minScore: 91, maxScore: 120, color: '#ef4444', description: 'å®ŸãŒãªã‚Šåç©«ã§ãã‚‹' },
                    { name: 'ğŸ‘‘ é»„é‡‘ã®ç¿’æ…£', minScore: 121, maxScore: 999999, color: '#fbbf24', description: 'å®Œå…¨ã«èº«ã«ã¤ã„ãŸç¿’æ…£' }
                ];
                
                // ç‰¹åˆ¥æ¡ä»¶ï¼šé€£ç¶š90æ—¥ä»¥ä¸Šã‹ã¤é”æˆç‡90%ä»¥ä¸Šã§é»„é‡‘ã®ç¿’æ…£
                if (streak >= 90 && achievementRate >= 0.9) {
                    return stages[6]; // é»„é‡‘ã®ç¿’æ…£
                }
                
                for (const stage of stages) {
                    if (finalScore >= stage.minScore && finalScore <= stage.maxScore) {
                        return { ...stage, score: finalScore, streak, achievementRate: Math.round(achievementRate * 100) };
                    }
                }
                
                return stages[0]; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç¨®ã¾ãæœŸ
            }
            
            // ç¿’æ…£æˆé•·ã‚¹ãƒ†ãƒ¼ã‚¸åˆ†å¸ƒ
            const stageDistribution = {};
            const stages = [
                'ğŸŒ± ç¨®ã¾ãæœŸ',
                'ğŸŒ¿ ç™ºèŠ½æœŸ',
                'ğŸ€ æˆé•·æœŸ',
                'ğŸŒ³ å®šç€æœŸ',
                'ğŸŒ¸ é–‹èŠ±æœŸ',
                'ğŸ åç©«æœŸ',
                'ğŸ‘‘ é»„é‡‘ã®ç¿’æ…£'
            ];
            
            stages.forEach(stage => {
                stageDistribution[stage] = 0;
            });
            
            // å„ç¿’æ…£ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
            all.forEach(h => {
                const stage = calculateHabitStage(h);
                if (stage) {
                    stageDistribution[stage.name]++;
                }
            });
            
            const levelDiv = document.getElementById('achievement-level-distribution');
            if (levelDiv) {
                levelDiv.innerHTML = '';
                const maxCount = Math.max(...Object.values(stageDistribution), 1);
                
                const stageConfigs = {
                    'ğŸŒ± ç¨®ã¾ãæœŸ': { color: '#6b7280', description: 'ç¿’æ…£ã®ç¨®ã‚’æ¤ãˆãŸæ®µéš' },
                    'ğŸŒ¿ ç™ºèŠ½æœŸ': { color: '#10b981', description: 'å°ã•ãªèŠ½ãŒå‡ºã¦ããŸ' },
                    'ğŸ€ æˆé•·æœŸ': { color: '#3b82f6', description: 'è‘‰ãŒå¢—ãˆã¦æˆé•·ä¸­' },
                    'ğŸŒ³ å®šç€æœŸ': { color: '#8b5cf6', description: 'ã—ã£ã‹ã‚Šã¨ã—ãŸæœ¨ã«æˆé•·' },
                    'ğŸŒ¸ é–‹èŠ±æœŸ': { color: '#f59e0b', description: 'èŠ±ãŒå’²ãå§‹ã‚ã‚‹' },
                    'ğŸ åç©«æœŸ': { color: '#ef4444', description: 'å®ŸãŒãªã‚Šåç©«ã§ãã‚‹' },
                    'ğŸ‘‘ é»„é‡‘ã®ç¿’æ…£': { color: '#fbbf24', description: 'å®Œå…¨ã«èº«ã«ã¤ã„ãŸç¿’æ…£' }
                };
                
                stages.forEach(stageName => {
                    const count = stageDistribution[stageName];
                    const config = stageConfigs[stageName];
                    const percentage = all.length > 0 ? Math.round((count / all.length) * 100) : 0;
                    const barWidth = maxCount > 0 ? (count / maxCount) * 100 : 0;
                    
                    const row = document.createElement('div');
                    row.innerHTML = `
                        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                            <div style="width:140px;">
                                <div style="font-size:13px; font-weight:600;">${stageName}</div>
                                <div style="font-size:10px; color:var(--text-secondary); margin-top:2px;">${config.description}</div>
                            </div>
                            <div style="flex:1; background:rgba(148,163,184,0.1); border-radius:4px; height:28px; position:relative;">
                                <div style="position:absolute; left:0; top:0; height:100%; background:${config.color}; border-radius:4px; width:${barWidth}%; transition:width 0.3s;"></div>
                                <div style="position:absolute; left:8px; top:50%; transform:translateY(-50%); font-size:11px; font-weight:600; color:white; text-shadow:0 1px 2px rgba(0,0,0,0.3);">
                                    ${count}å€‹ (${percentage}%)
                                </div>
                            </div>
                        </div>
                    `;
                    levelDiv.appendChild(row);
                });
            }

            // æ›œæ—¥åˆ¥é”æˆç‡ã®è¨ˆç®—ã¨è¡¨ç¤ºï¼ˆæ¯æ—¥ã®ç¿’æ…£ã®ã¿ï¼‰
            const weekdayStats = {};
            const weekdayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            for (let i = 0; i < 7; i++) {
                weekdayStats[i] = { achieved: 0, total: 0 };
            }
            
            all.forEach(h => {
                // æ¯æ—¥ã®ç¿’æ…£ã®ã¿ã‚’å¯¾è±¡ã«ã™ã‚‹
                // frequencyãŒãªã„å ´åˆã¯å¾“æ¥ã®ç¿’æ…£ãªã®ã§æ¯æ—¥ã®ç¿’æ…£ã¨ã—ã¦æ‰±ã†
                const isDailyHabit = !h.frequency || h.frequency.type === 'daily';
                
                if (!isDailyHabit) {
                    return; // æ¯æ—¥ã®ç¿’æ…£ã§ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }
                
                const start = new Date(h.startDate);
                start.setHours(0, 0, 0, 0);
                const endDate = h.completedDate ? new Date(h.completedDate) : new Date();
                endDate.setHours(0, 0, 0, 0);
                const periodEnd = new Date(start);
                periodEnd.setDate(start.getDate() + h.totalDays - 1);
                const actualEnd = endDate < periodEnd ? endDate : periodEnd;
                
                for (let d = new Date(start); d <= actualEnd && d <= today; d.setDate(d.getDate() + 1)) {
                    const weekday = d.getDay();
                    const key = dateKeyLocal(d);
                    weekdayStats[weekday].total++;
                    if (h.achievements && h.achievements[key]) {
                        weekdayStats[weekday].achieved++;
                    }
                }
            });
            
            const weekdayDiv = document.getElementById('weekday-stats');
            if (weekdayDiv) {
                weekdayDiv.innerHTML = '';
                for (let i = 0; i < 7; i++) {
                    const stats = weekdayStats[i];
                    const rate = stats.total > 0 ? Math.round((stats.achieved / stats.total) * 100) : 0;
                    const color = rate >= 80 ? '#10b981' : rate >= 50 ? '#3b82f6' : '#ef4444';
                    
                    const dayCard = document.createElement('div');
                    dayCard.style.cssText = 'text-align:center; padding:8px 4px; background:rgba(99,102,241,0.1); border-radius:8px; min-width: 40px;';
                    dayCard.innerHTML = `
                        <div style="font-size:12px; font-weight:600; margin-bottom:2px;">${weekdayNames[i]}</div>
                        <div style="font-size:18px; font-weight:800; color:${color};">${rate}%</div>
                        <div style="font-size:9px; color:var(--text-secondary);">${stats.achieved}/${stats.total}</div>
                    `;
                    weekdayDiv.appendChild(dayCard);
                }
            }

            // å¼·åº¦ãƒ©ãƒ™ãƒ«ä½¿ç”¨å‰²åˆã®ãƒ‰ãƒ¼ãƒŠãƒ„ï¼ˆA/B/Cåˆ†é¡ï¼‰
            const labelCounts = {};
            const toFixed1 = (n) => (Math.round(Number(n) * 10) / 10).toFixed(1);
            all.forEach(h => {
                Object.keys(h.achievements||{}).forEach(key => {
                    const m = Number((h.intensity||{})[key] ?? 1.0);
                    // å¼·åº¦å€¤ã«åŸºã¥ã„ã¦A/B/Cã«åˆ†é¡
                    const label = m === 0.8 ? 'A' : m === 1.2 ? 'C' : 'B';
                    labelCounts[label] = (labelCounts[label]||0) + 1;
                });
            });
            const donut = document.getElementById('donut-intensity');
            const legend = document.getElementById('donut-legend');
            if (donut && legend) {
                const total = Object.values(labelCounts).reduce((a,b)=>a+b,0) || 1;
                const entries = Object.entries(labelCounts);
                // SVGãƒ‰ãƒ¼ãƒŠãƒ„æç”»
                const cx=80, cy=80, r=60, sw=20;
                let acc=0;
                const colors = ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6'];
                donut.innerHTML='';
                legend.innerHTML='';
                entries.forEach(([label,count], idx)=>{
                    const frac = count/total;
                    const start = acc * 2*Math.PI - Math.PI/2;
                    const end = (acc+frac) * 2*Math.PI - Math.PI/2;
                    acc += frac;
                    const large = (end-start) > Math.PI ? 1 : 0;
                    const x1 = cx + r*Math.cos(start), y1 = cy + r*Math.sin(start);
                    const x2 = cx + r*Math.cos(end),   y2 = cy + r*Math.sin(end);
                    const path = document.createElementNS('http://www.w3.org/2000/svg','path');
                    const d = `M ${x1} ${y1} A ${r} ${r} 0 ${large} 1 ${x2} ${y2}`;
                    path.setAttribute('d', d);
                    path.setAttribute('fill','none');
                    path.setAttribute('stroke', colors[idx%colors.length]);
                    path.setAttribute('stroke-width', String(sw));
                    donut.appendChild(path);
                    // å‡¡ä¾‹
                    const row = document.createElement('div');
                    row.innerHTML = `<span style="display:inline-block;width:10px;height:10px;background:${colors[idx%colors.length]};border-radius:2px;margin-right:6px;"></span>${escapeHTML(label)}: ${(Math.round(frac*100))}% (${count})`;
                    legend.appendChild(row);
                });
                // ä¸­å¤®ç™½ãƒŒã‚­
                const hole = document.createElementNS('http://www.w3.org/2000/svg','circle');
                hole.setAttribute('cx', String(cx)); hole.setAttribute('cy', String(cy)); hole.setAttribute('r', String(r-sw/2));
                hole.setAttribute('fill', 'var(--background)');
                donut.appendChild(hole);
            }

            // å…¨ç¿’æ…£æ¨ªæ–­é€£ç¶šé”æˆæ—¥æ•°ï¼ˆä»»æ„ã®ç¿’æ…£ã§é”æˆãŒã‚ã‚Œã°é”æˆæ—¥ã¨ã¿ãªã™ï¼‰
            const dateMap = {};
            all.forEach(h => {
                Object.keys(h.achievements||{}).forEach(k => { dateMap[k] = true; });
            });
            const keys = Object.keys(dateMap).sort();
            let longest=0, current=0;
            // longest: é€£ç¶šæœ€å¤§
            let prev=null;
            keys.forEach(k=>{
                const d = new Date(k);
                d.setHours(0,0,0,0);
                if (prev){
                    const diff = (d - prev)/(1000*60*60*24);
                    current = (diff===1) ? (current+1) : 1;
                } else {
                    current = 1;
                }
                if (current>longest) longest=current;
                prev = d;
            });
            // current: ä»Šæ—¥ã‹ã‚‰é¡ã£ã¦
            let cur=0; const d0=new Date(today);
            for (let d=new Date(d0); ; d.setDate(d.getDate()-1)){
                const k=dateKeyLocal(d);
                if (dateMap[k]) cur+=1; else break;
                if (d < new Date(keys[0]||today)) break; // å®‰å…¨
            }
            const streakDiv = document.getElementById('streak-stats');
            if (streakDiv){
                streakDiv.innerHTML = `
                    <div>ç¾åœ¨ã®é€£ç¶š: <span style="color:#10b981;">${cur}æ—¥</span></div>
                    <div>æœ€é•·è¨˜éŒ²: <span style="color:#3b82f6;">${longest}æ—¥</span></div>
                `;
            }

            // ç¿’æ…£ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’åˆæœŸè¡¨ç¤º
            showAchievementRanking();
            
            // ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            displayBadgeCollection();
            
            // ãƒã‚¤ãƒ³ãƒˆçµ±è¨ˆã‚’è¡¨ç¤º
            updatePointStatistics();
        }
        
        // é”æˆç‡ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        function showAchievementRanking() {
            const data = loadData();
            const all = data.currentHypotheses.concat(data.completedHypotheses || []);
            
            // ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('ranking-achievement-tab').style.background = 'var(--primary)';
            document.getElementById('ranking-achievement-tab').style.color = 'white';
            document.getElementById('ranking-points-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-points-tab').style.color = 'var(--text-primary)';
            document.getElementById('ranking-streak-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-streak-tab').style.color = 'var(--text-primary)';
            
            const ranking = all.map(h=>{
                const s = new Date(h.startDate); s.setHours(0,0,0,0);
                const intensity = h.intensity||{};
                let weighted=0;
                for (let i=0;i<(h.totalDays||0);i++){
                    const d=new Date(s); d.setDate(s.getDate()+i);
                    const k=dateKeyLocal(d);
                    if ((h.achievements||{})[k]) weighted += Number(intensity[k] ?? 1.0);
                }
                const rate = (h.totalDays||0)>0 ? Math.floor(Math.min(100,(weighted/(h.totalDays))*100)) : 0;
                return { id:h.id, title:h.title, rate, totalDays:h.totalDays||0 };
            }).sort((a,b)=> b.rate - a.rate).slice(0,5);
            
            const rankDiv = document.getElementById('ranking-list');
            if (rankDiv){
                rankDiv.innerHTML = ranking.map((r,idx)=>`
                    <div class="ranking-item" style="display:flex;justify-content:space-between;gap:12px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background: ${
                        idx === 0 ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1))' :
                        idx === 1 ? 'linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(128, 128, 128, 0.1))' :
                        idx === 2 ? 'linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(165, 87, 10, 0.1))' :
                        'rgba(0,0,0,0.1)'
                    };">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `#${idx+1}`}</span>
                            <span>${escapeHTML(r.title||'Untitled')}</span>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 14px; font-weight: bold; color: #10b981;">${r.rate}%</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">${r.totalDays}æ—¥é–“</div>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        // ãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        function showPointsRanking() {
            const data = loadData();
            const all = data.currentHypotheses.concat(data.completedHypotheses || []);
            
            // ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('ranking-achievement-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-achievement-tab').style.color = 'var(--text-primary)';
            document.getElementById('ranking-points-tab').style.background = 'var(--primary)';
            document.getElementById('ranking-points-tab').style.color = 'white';
            document.getElementById('ranking-streak-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-streak-tab').style.color = 'var(--text-primary)';
            
            // ç¿’æ…£ã®ãƒã‚¤ãƒ³ãƒˆé›†è¨ˆç”¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
            const habitPoints = {};
            
            // å„ç¿’æ…£ã®åˆæœŸåŒ–ã¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ™ãƒ¼ã‚¹ã®ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—
            all.forEach(h => {
                habitPoints[h.id] = {
                    id: h.id,
                    title: h.title,
                    totalPoints: 0,
                    achievementCount: 0,
                    bonusPoints: 0,
                    averagePoints: 0,
                    recentHistory: []
                };
                
                // ã¾ãšã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆlogsï¼‰ã‹ã‚‰åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
                if (h.logs) {
                    Object.entries(h.logs).forEach(([dateKey, log]) => {
                        if (log.completed) {
                            // åŸºæœ¬ãƒã‚¤ãƒ³ãƒˆå€¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2ptï¼‰
                            const basePointValue = h.pointValue || 2;
                            // å¼·åº¦ã«ã‚ˆã‚‹èª¿æ•´
                            const intensity = log.intensity || 1.0;
                            const points = Math.round(basePointValue * intensity);
                            
                            habitPoints[h.id].totalPoints += points;
                            habitPoints[h.id].achievementCount++;
                        }
                    });
                }
                
                // æ—§å½¢å¼ã®achievementsã‹ã‚‰ã‚‚ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                if (h.achievements) {
                    Object.entries(h.achievements).forEach(([dateKey, achieved]) => {
                        // logsã«å­˜åœ¨ã—ãªã„å ´åˆã®ã¿åŠ ç®—ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
                        if (achieved && (!h.logs || !h.logs[dateKey])) {
                            const basePointValue = h.pointValue || 2;
                            habitPoints[h.id].totalPoints += basePointValue;
                            habitPoints[h.id].achievementCount++;
                        }
                    });
                }
            });
            
            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æœ€è¿‘ã®å±¥æ­´ã¨ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ï¼ˆè¿½åŠ åˆ†ã¨ã—ã¦ï¼‰
            if (data.pointSystem && data.pointSystem.transactions) {
                // æ—¥ä»˜ã¨ç¿’æ…£ã”ã¨ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ç®¡ç†
                const transactionHistory = {};
                
                data.pointSystem.transactions.forEach(t => {
                    if (t.source === 'habit' && t.type === 'earn') {
                        // habitIdãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°descriptionã‹ã‚‰ç¿’æ…£åã‚’æŠ½å‡º
                        let targetHabitId = t.habitId;
                        
                        if (!targetHabitId && t.description) {
                            // ã€Œç¿’æ…£å é”æˆã€ã¾ãŸã¯ã€Œç¿’æ…£å å–ã‚Šæ¶ˆã—ã€ã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŠ½å‡º
                            const match = t.description.match(/(.+?)\s+(é”æˆ|å–ã‚Šæ¶ˆã—)/);
                            if (match) {
                                const habitTitle = match[1].trim();
                                const habit = all.find(h => h.title === habitTitle);
                                if (habit) {
                                    targetHabitId = habit.id;
                                }
                            }
                        }
                        
                        if (targetHabitId && habitPoints[targetHabitId]) {
                            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‹ã‚‰æ—¥ä»˜ã‚­ãƒ¼ã‚’ç”Ÿæˆ
                            const date = new Date(t.timestamp);
                            const dateKey = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
                            const key = `${targetHabitId}_${dateKey}`;
                            
                            // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’è¨˜éŒ²
                            if (!transactionHistory[key]) {
                                transactionHistory[key] = [];
                            }
                            transactionHistory[key].push(t);
                        }
                    }
                });
                
                // å„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰æœ€è¿‘ã®å±¥æ­´ã¨ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã‚’æŠ½å‡º
                Object.entries(transactionHistory).forEach(([key, transactions]) => {
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ™‚ç³»åˆ—é †ã«ã‚½ãƒ¼ãƒˆ
                    transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // æœ€å¾Œã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
                    const lastTransaction = transactions[transactions.length - 1];
                    const [habitId] = key.split('_');
                    
                    // å–ã‚Šæ¶ˆã—ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿å±¥æ­´ã«è¿½åŠ 
                    if (!lastTransaction.description.includes('å–ã‚Šæ¶ˆã—') && habitPoints[habitId]) {
                        const points = lastTransaction.finalAmount || lastTransaction.amount || lastTransaction.points || 0;
                        
                        // æœ€è¿‘ã®å±¥æ­´ã«è¿½åŠ ï¼ˆè¡¨ç¤ºç”¨ï¼‰
                        if (points > 0) {
                            habitPoints[habitId].recentHistory.push({
                                timestamp: lastTransaction.timestamp,
                                amount: points,
                                description: lastTransaction.description,
                                multiplier: lastTransaction.multiplier || 1
                            });
                            
                            // ãƒœãƒ¼ãƒŠã‚¹ãƒã‚¤ãƒ³ãƒˆã®è¨ˆç®—ï¼ˆé€£ç¶šãƒœãƒ¼ãƒŠã‚¹ãªã©ï¼‰
                            if (lastTransaction.multiplier && lastTransaction.multiplier > 1) {
                                const baseAmount = lastTransaction.amount || Math.floor(points / lastTransaction.multiplier);
                                const bonus = points - baseAmount;
                                habitPoints[habitId].bonusPoints += bonus;
                                // ãƒœãƒ¼ãƒŠã‚¹åˆ†ã‚’åˆè¨ˆã«è¿½åŠ 
                                habitPoints[habitId].totalPoints += bonus;
                            }
                        }
                    }
                });
                
                // å„ç¿’æ…£ã®å±¥æ­´ã‚’æ™‚ç³»åˆ—é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
                Object.values(habitPoints).forEach(h => {
                    h.recentHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    // æœ€æ–°5ä»¶ã®ã¿ä¿æŒ
                    h.recentHistory = h.recentHistory.slice(0, 5);
                });
            }
            
            // å¹³å‡ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—ã—ã¦ã‚½ãƒ¼ãƒˆ
            const ranking = Object.values(habitPoints)
                .map(h => {
                    h.averagePoints = h.achievementCount > 0 ? 
                        Math.round(h.totalPoints / h.achievementCount * 10) / 10 : 0;
                    return h;
                })
                .filter(h => h.totalPoints > 0)
                .sort((a, b) => b.totalPoints - a.totalPoints)
                .slice(0, 5);
            
            const rankDiv = document.getElementById('ranking-list');
            if (rankDiv){
                if (ranking.length === 0) {
                    rankDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ã¾ã ãƒã‚¤ãƒ³ãƒˆç²å¾—å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                } else {
                    rankDiv.innerHTML = ranking.map((r,idx)=>{
                        // ã“ã®ç¿’æ…£ã®æœ€è¿‘ã®ãƒã‚¤ãƒ³ãƒˆå±¥æ­´ã‚’å–å¾—ï¼ˆæœ€æ–°3ä»¶ï¼‰
                        const recentPoints = r.recentHistory.slice(0, 3);
                        let historyHtml = '';
                        if (recentPoints.length > 0) {
                            historyHtml = `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); font-size: 10px;">
                                    <div style="color: var(--text-secondary); margin-bottom: 4px;">æœ€è¿‘ã®ç²å¾—:</div>
                                    ${recentPoints.map(p => {
                                        const date = new Date(p.timestamp);
                                        const dateStr = `${date.getMonth()+1}/${date.getDate()}`;
                                        return `<div style="display: flex; justify-content: space-between; padding: 2px 0;">
                                            <span style="color: var(--text-secondary);">${dateStr}</span>
                                            <span style="color: #10b981;">+${p.amount}pt</span>
                                        </div>`;
                                    }).join('')}
                                </div>
                            `;
                        }
                        
                        return `
                        <div class="ranking-item" style="padding:8px;border:1px solid var(--border);border-radius:10px;background: ${
                            idx === 0 ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1))' :
                            idx === 1 ? 'linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(128, 128, 128, 0.1))' :
                            idx === 2 ? 'linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(165, 87, 10, 0.1))' :
                            'rgba(0,0,0,0.1)'
                        };">
                            <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 20px;">${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `#${idx+1}`}</span>
                                    <div>
                                        <div>${escapeHTML(r.title||'Untitled')}</div>
                                        <div style="font-size: 10px; color: var(--text-secondary);">
                                            ${r.achievementCount}å›é”æˆ Â· å¹³å‡${r.averagePoints}pt
                                            ${r.bonusPoints > 0 ? ` Â· ğŸš€+${r.bonusPoints}pt` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: bold; color: #fbbf24;">${r.totalPoints}pt</div>
                                </div>
                            </div>
                            ${historyHtml}
                        </div>
                    `}).join('');
                }
            }
        }
        
        // é€£ç¶šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        function showStreakRanking() {
            const data = loadData();
            const all = data.currentHypotheses.concat(data.completedHypotheses || []);
            
            // ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
            document.getElementById('ranking-achievement-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-achievement-tab').style.color = 'var(--text-primary)';
            document.getElementById('ranking-points-tab').style.background = 'var(--surface)';
            document.getElementById('ranking-points-tab').style.color = 'var(--text-primary)';
            document.getElementById('ranking-streak-tab').style.background = 'var(--primary)';
            document.getElementById('ranking-streak-tab').style.color = 'white';
            
            // å„ç¿’æ…£ã®é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
            const ranking = all.map(h => {
                let currentStreak = 0;
                let longestStreak = 0;
                let tempStreak = 0;
                const today = new Date();
                
                // éå»60æ—¥é–“ã‚’ãƒã‚§ãƒƒã‚¯
                for (let i = 59; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateKey = dateKeyLocal(date);
                    
                    if ((h.achievements || {})[dateKey]) {
                        tempStreak++;
                        if (i === 0) currentStreak = tempStreak; // ä»Šæ—¥ã¾ã§ç¶šã„ã¦ã„ã‚‹
                    } else {
                        if (tempStreak > longestStreak) {
                            longestStreak = tempStreak;
                        }
                        if (i === 0) currentStreak = 0; // ä»Šæ—¥ã¯é”æˆã—ã¦ã„ãªã„
                        tempStreak = 0;
                    }
                }
                
                if (tempStreak > longestStreak) {
                    longestStreak = tempStreak;
                }
                
                // æ˜¨æ—¥ã¾ã§ã®é€£ç¶šã‚’ç¢ºèª
                if (currentStreak === 0) {
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayKey = dateKeyLocal(yesterday);
                    
                    if ((h.achievements || {})[yesterdayKey]) {
                        // æ˜¨æ—¥ã¾ã§ã®é€£ç¶šã‚’æ•°ãˆã‚‹
                        for (let i = 1; i <= 60; i++) {
                            const date = new Date(today);
                            date.setDate(date.getDate() - i);
                            const dateKey = dateKeyLocal(date);
                            
                            if ((h.achievements || {})[dateKey]) {
                                currentStreak++;
                            } else {
                                break;
                            }
                        }
                    }
                }
                
                return {
                    id: h.id,
                    title: h.title,
                    currentStreak,
                    longestStreak: Math.max(currentStreak, longestStreak),
                    totalDays: Object.keys(h.achievements || {}).length
                };
            })
            .filter(h => h.currentStreak > 0 || h.longestStreak > 0)
            .sort((a, b) => b.currentStreak - a.currentStreak || b.longestStreak - a.longestStreak)
            .slice(0, 5);
            
            const rankDiv = document.getElementById('ranking-list');
            if (rankDiv){
                if (ranking.length === 0) {
                    rankDiv.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">ã¾ã é€£ç¶šè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                } else {
                    rankDiv.innerHTML = ranking.map((r,idx)=>`
                        <div class="ranking-item" style="display:flex;justify-content:space-between;gap:12px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background: ${
                            idx === 0 ? 'linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1))' :
                            idx === 1 ? 'linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(128, 128, 128, 0.1))' :
                            idx === 2 ? 'linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(165, 87, 10, 0.1))' :
                            'rgba(0,0,0,0.1)'
                        };">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : `#${idx+1}`}</span>
                                <div>
                                    <div>${escapeHTML(r.title||'Untitled')}</div>
                                    <div style="font-size: 10px; color: var(--text-secondary);">
                                        æœ€é•·${r.longestStreak}æ—¥ Â· ç´¯è¨ˆ${r.totalDays}æ—¥
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 16px; font-weight: bold; color: ${r.currentStreak > 0 ? '#f59e0b' : '#6b7280'};">
                                    ${r.currentStreak > 0 ? 'ğŸ”¥' : ''} ${r.currentStreak}æ—¥
                                </div>
                                <div style="font-size: 10px; color: var(--text-secondary);">
                                    ${r.currentStreak > 0 ? 'é€£ç¶šä¸­' : 'ä¸­æ–­ä¸­'}
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }
        
        // ãƒãƒƒã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        function displayBadgeCollection() {
            const data = loadData();
            const container = document.getElementById('badge-collection');
            if (!container) return;
            
            container.innerHTML = '';
            
            // ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
            Object.entries(BADGE_DEFINITIONS).forEach(([id, badge]) => {
                const earned = data.badges && data.badges[id];
                const badgeEl = document.createElement('div');
                badgeEl.style.cssText = `
                    text-align: center;
                    padding: 12px;
                    background: ${earned ? 'var(--gradient-1)' : 'var(--surface)'};
                    border-radius: 12px;
                    opacity: ${earned ? '1' : '0.3'};
                    transition: all 0.3s;
                    cursor: pointer;
                `;
                
                badgeEl.innerHTML = `
                    <div style="font-size: 32px; margin-bottom: 4px;">${badge.emoji}</div>
                    <div style="font-size: 10px; font-weight: 600; color: ${earned ? 'white' : 'var(--text-secondary)'};">  
                        ${badge.name.split(' ')[1] || badge.name}
                    </div>
                `;
                
                badgeEl.title = `${badge.name}\n${badge.description}${earned ? '\nç²å¾—æ¸ˆã¿' : '\næœªç²å¾—'}`;
                
                if (earned) {
                    badgeEl.onclick = () => {
                        showNotification(`ğŸ† ${badge.name}\n${badge.description}`, 'success');
                    };
                }
                
                container.appendChild(badgeEl);
            });
        }
        
        // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
        function showMonthlyReport() {
            const data = loadData();
            const container = document.getElementById('report-container');
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let report = `<h4>ğŸ“… ${currentYear}å¹´${currentMonth + 1}æœˆã®ãƒ¬ãƒãƒ¼ãƒˆ</h4>`;
            
            // æœˆé–“çµ±è¨ˆ
            let monthlyAchievements = 0;
            let monthlyTotal = 0;
            let habitsActive = 0;
            
            data.currentHypotheses.concat(data.completedHypotheses || []).forEach(h => {
                const startDate = new Date(h.startDate);
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + h.totalDays);
                
                // ã“ã®æœˆã«æ´»å‹•ã—ãŸç¿’æ…£
                if (startDate <= now && endDate >= new Date(currentYear, currentMonth, 1)) {
                    habitsActive++;
                    
                    // ã“ã®æœˆã®é”æˆã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    for (let d = 1; d <= 31; d++) {
                        const checkDate = new Date(currentYear, currentMonth, d);
                        if (checkDate > now) break;
                        if (checkDate >= startDate && checkDate <= endDate) {
                            monthlyTotal++;
                            const key = dateKeyLocal(checkDate);
                            if (h.achievements && h.achievements[key]) {
                                monthlyAchievements++;
                            }
                        }
                    }
                }
            });
            
            const monthlyRate = monthlyTotal > 0 ? Math.round((monthlyAchievements / monthlyTotal) * 100) : 0;
            
            report += `
                <div style="display: grid; gap: 12px; margin-top: 16px;">
                    <div style="padding: 12px; background: var(--background); border-radius: 8px;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--primary);">${monthlyRate}%</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">æœˆé–“é”æˆç‡</div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <div style="padding: 8px; background: var(--background); border-radius: 8px; text-align: center;">
                            <div style="font-weight: 600;">${habitsActive}</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">æ´»å‹•ä¸­ã®ç¿’æ…£</div>
                        </div>
                        <div style="padding: 8px; background: var(--background); border-radius: 8px; text-align: center;">
                            <div style="font-weight: 600;">${monthlyAchievements}</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">é”æˆæ—¥æ•°</div>
                        </div>
                        <div style="padding: 8px; background: var(--background); border-radius: 8px; text-align: center;">
                            <div style="font-weight: 600;">${monthlyTotal - monthlyAchievements}</div>
                            <div style="font-size: 10px; color: var(--text-secondary);">æœªé”æˆæ—¥æ•°</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = report;
            container.style.display = 'block';
        }
        
        // å¹´æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’è¡¨ç¤º
        function showYearlyReport() {
            const data = loadData();
            const container = document.getElementById('report-container');
            const currentYear = new Date().getFullYear();
            
            let report = `<h4>ğŸ“Š ${currentYear}å¹´ã®ãƒ¬ãƒãƒ¼ãƒˆ</h4>`;
            
            // æœˆåˆ¥çµ±è¨ˆ
            const monthlyStats = [];
            for (let month = 0; month < 12; month++) {
                let achievements = 0;
                let total = 0;
                
                data.currentHypotheses.concat(data.completedHypotheses || []).forEach(h => {
                    const startDate = new Date(h.startDate);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + h.totalDays);
                    
                    for (let d = 1; d <= 31; d++) {
                        const checkDate = new Date(currentYear, month, d);
                        if (checkDate > new Date()) break;
                        if (checkDate >= startDate && checkDate <= endDate) {
                            total++;
                            const key = dateKeyLocal(checkDate);
                            if (h.achievements && h.achievements[key]) {
                                achievements++;
                            }
                        }
                    }
                });
                
                monthlyStats.push({
                    month: month + 1,
                    rate: total > 0 ? Math.round((achievements / total) * 100) : 0,
                    achievements,
                    total
                });
            }
            
            // å¹´é–“çµ±è¨ˆ
            const yearTotal = monthlyStats.reduce((sum, m) => sum + m.total, 0);
            const yearAchievements = monthlyStats.reduce((sum, m) => sum + m.achievements, 0);
            const yearRate = yearTotal > 0 ? Math.round((yearAchievements / yearTotal) * 100) : 0;
            
            report += `
                <div style="padding: 16px; background: var(--gradient-1); border-radius: 12px; margin: 16px 0; text-align: center; color: white;">
                    <div style="font-size: 32px; font-weight: 800;">${yearRate}%</div>
                    <div style="font-size: 14px; opacity: 0.9;">å¹´é–“é”æˆç‡</div>
                    <div style="margin-top: 8px; font-size: 12px; opacity: 0.8;">
                        ${yearAchievements} / ${yearTotal} æ—¥é”æˆ
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
            `;
            
            monthlyStats.forEach(m => {
                if (m.total > 0) {
                    const color = m.rate >= 80 ? '#10b981' : m.rate >= 50 ? '#3b82f6' : '#ef4444';
                    report += `
                        <div style="padding: 8px; background: var(--background); border-radius: 8px; text-align: center;">
                            <div style="font-size: 10px; color: var(--text-secondary);">${m.month}æœˆ</div>
                            <div style="font-size: 16px; font-weight: 700; color: ${color};">${m.rate}%</div>
                        </div>
                    `;
                }
            });
            
            report += '</div>';
            
            container.innerHTML = report;
            container.style.display = 'block';
        }
        
        // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ç‰ˆï¼‰
        function exportHabitData() {
            const data = loadData();
            const exportData = {
                exportDate: new Date().toISOString(),
                version: '2.0',
                data: data  // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãã®ã¾ã¾ä¿å­˜
            };
            
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pdca-lab-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('ğŸ“¤ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆæœ€åˆã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„ - å¾Œã®çµ±ä¸€ç‰ˆã‚’ä½¿ç”¨ï¼‰
        // function handleImportFile_old(event) {
        //     // ã“ã®é–¢æ•°ã¯ä½¿ç”¨ã—ãªã„ï¼ˆå¾Œã®çµ±ä¸€ç‰ˆã‚’ä½¿ç”¨ï¼‰
        //     return;
        // }

        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ­£è¦åŒ–
        function normalizeImportedData(src) {
            if (!src || typeof src !== 'object') return null;
            // æ—¢å­˜ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å½¢å¼ï¼ˆãã®ã¾ã¾ï¼‰
            if (Array.isArray(src.currentHypotheses) || Array.isArray(src.completedHypotheses)) {
                return {
                    currentHypotheses: src.currentHypotheses || [],
                    completedHypotheses: src.completedHypotheses || [],
                    cards: src.cards || { inventory: [], pendingPenalties: [] },
                    badges: src.badges || {},
                    meta: src.meta || {}
                };
            }
            // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ã‹ã‚‰ã®å¤‰æ›
            if (Array.isArray(src.currentHabits) || Array.isArray(src.completedHabits)) {
                return {
                    currentHypotheses: src.currentHabits || [],
                    completedHypotheses: src.completedHabits || [],
                    cards: src.cards || { inventory: [], pendingPenalties: [] },
                    badges: src.badges || {},
                    meta: src.meta || {}
                };
            }
            return null;
        }


        // ã‚«ãƒ¼ãƒ‰ç”»é¢ã‚’è¡¨ç¤º
        function showCardsView() {
            resetScrollToTop();
            document.getElementById('home-view').style.display = 'none';
            document.getElementById('new-hypothesis-view').style.display = 'none';
            document.getElementById('shuffle-view').style.display = 'none';
            document.getElementById('progress-view').style.display = 'none';
            document.getElementById('history-view').style.display = 'none';
            document.getElementById('stats-view').style.display = 'none';
            document.getElementById('points-view').style.display = 'none';
            document.getElementById('cards-view').style.display = 'block';
            
            updateNavigation('cards');
            updateCardDisplay();
            
            // ã‚«ãƒ¼ãƒ‰ç”»é¢ã§ã¯ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’éè¡¨ç¤º
            const pointDisplay = document.getElementById('point-display');
            if (pointDisplay) {
                pointDisplay.style.display = 'none';
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã‚’æ›´æ–°
        function updateCardDisplay() {
            const data = loadData();
            const inventoryContainer = document.getElementById('card-inventory');
            const penaltyContainer = document.getElementById('penalty-cards');
            
            // æ‰€æŒã‚«ãƒ¼ãƒ‰ã‚’é›†è¨ˆ
            const cardCounts = {};
            data.cards.inventory.forEach(card => {
                if (!card.used) {
                    cardCounts[card.cardId] = (cardCounts[card.cardId] || 0) + 1;
                }
            });
            
            // æ‰€æŒã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            inventoryContainer.innerHTML = '';
            if (Object.keys(cardCounts).length === 0) {
                inventoryContainer.innerHTML = '<p style="color: var(--text-secondary);">æ‰€æŒã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                Object.entries(cardCounts).forEach(([cardId, count]) => {
                    const card = CARD_MASTER[cardId];
                    if (card) {
                        const cardElement = createCardElement(card, count);
                        inventoryContainer.appendChild(cardElement);
                    }
                });
            }
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
            penaltyContainer.innerHTML = '';
            if (data.cards.pendingPenalties.length === 0) {
                penaltyContainer.innerHTML = '<p style="color: var(--text-secondary);">ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                const penaltyCounts = {};
                data.cards.pendingPenalties.forEach(penalty => {
                    penaltyCounts[penalty.cardId] = (penaltyCounts[penalty.cardId] || 0) + 1;
                });
                
                Object.entries(penaltyCounts).forEach(([cardId, count]) => {
                    const card = CARD_MASTER[cardId];
                    if (card) {
                        const cardElement = createCardElement(card, count);
                        penaltyContainer.appendChild(cardElement);
                    }
                });
            }
        }

        // ã‚«ãƒ¼ãƒ‰è¦ç´ ã‚’ä½œæˆ
        function createCardElement(card, count) {
            const div = document.createElement('div');
            div.className = `card-item ${card.type}`;
            div.innerHTML = `
                <div class="card-icon">${card.icon}</div>
                <div class="card-name">${card.name}</div>
                <div class="card-description">${card.description}</div>
                ${count > 1 ? `<div class="card-count">Ã—${count}</div>` : ''}
            `;
            return div;
        }

        // ã‚«ãƒ¼ãƒ‰ç²å¾—è¡¨ç¤º
        function showCardAcquisition(cardIds, callback) {
            const modal = document.getElementById('card-acquisition-modal');
            const container = document.getElementById('acquired-cards-container');
            
            container.innerHTML = '';
            cardIds.forEach((cardId, index) => {
                const card = CARD_MASTER[cardId];
                if (card) {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = `card-item ${card.type} card-reveal`;
                    cardDiv.style.animationDelay = `${index * 0.3}s`;
                    cardDiv.innerHTML = `
                        <div class="card-icon">${card.icon}</div>
                        <div class="card-name">${card.name}</div>
                        <div class="card-description">${card.description}</div>
                    `;
                    container.appendChild(cardDiv);
                }
            });
            
            modal.style.display = 'flex';
            
            window.cardAcquisitionCallback = callback;
        }

        // ã‚«ãƒ¼ãƒ‰ç²å¾—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeCardAcquisition() {
            document.getElementById('card-acquisition-modal').style.display = 'none';
            if (window.cardAcquisitionCallback) {
                window.cardAcquisitionCallback();
                window.cardAcquisitionCallback = null;
            }
        }

        // ã‚¹ãƒ¯ã‚¤ãƒ—æ©Ÿèƒ½
        let touchStartX = 0;
        let touchStartY = 0;
        let touchEndX = 0;
        let touchEndY = 0;
        let currentViewIndex = 0;
        const views = ['home', 'points', 'cards', 'stats', 'history'];
        const viewElements = {
            'home': 'home-view',
            'points': 'points-view',
            'cards': 'cards-view',
            'stats': 'stats-view',
            'history': 'history-view'
        };

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®è¨­å®š
        // ã‚¹ãƒ¯ã‚¤ãƒ—é–¢é€£ã®å¤‰æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç§»å‹•
        let swipeState = {
            isEnabled: true,
            isSwiping: false,
            scrolling: false,
            touchStartX: 0,
            touchStartY: 0,
            touchEndX: 0,
            touchEndY: 0
        };
        
        function setupSwipeListeners() {
            const container = document.querySelector('.container');
            
            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã§ã®ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–
            // å…¥åŠ›ç³»ã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—æŠ‘æ­¢ï¼ˆãƒœã‚¿ãƒ³ã¯è¨±å¯ï¼‰
            document.querySelectorAll('input, textarea').forEach(element => {
                element.addEventListener('touchstart', () => {
                    swipeState.isEnabled = false;
                }, { passive: true });
                
                element.addEventListener('touchend', () => {
                    setTimeout(() => {
                        swipeState.isEnabled = true;
                    }, 100);
                }, { passive: true });
            });
            
            // çµ±è¨ˆç”»é¢ã«å°‚ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const statsView = document.getElementById('stats-view');
            if (statsView) {
                console.log('[STATS] Adding direct event listeners to stats view');
                
                // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
                statsView.addEventListener('touchstart', (e) => {
                    console.log('[STATS DIRECT] touchstart on stats view!');
                    const currentView = getCurrentView();
                    if (currentView === 'stats') {
                        swipeState.touchStartX = e.changedTouches[0].screenX;
                        swipeState.touchStartY = e.changedTouches[0].screenY;
                        swipeState.scrolling = false;
                        swipeState.isSwiping = false;
                        console.log('[STATS DIRECT] Start position:', swipeState.touchStartX, swipeState.touchStartY);
                    }
                }, { passive: true, capture: true });
                
                statsView.addEventListener('touchmove', (e) => {
                    const currentView = getCurrentView();
                    if (currentView === 'stats') {
                        const diffX = Math.abs(e.changedTouches[0].screenX - swipeState.touchStartX);
                        const diffY = Math.abs(e.changedTouches[0].screenY - swipeState.touchStartY);
                        console.log('[STATS DIRECT] Move - diffX:', diffX, 'diffY:', diffY);
                        if (diffX > 30 && diffX > diffY) {
                            swipeState.isSwiping = true;
                            swipeState.scrolling = false;
                            e.preventDefault();
                        }
                    }
                }, { passive: false, capture: true });
                
                statsView.addEventListener('touchend', (e) => {
                    const currentView = getCurrentView();
                    if (currentView === 'stats' && swipeState.isSwiping) {
                        swipeState.touchEndX = e.changedTouches[0].screenX;
                        swipeState.touchEndY = e.changedTouches[0].screenY;
                        console.log('[STATS DIRECT] End - calling handleSwipe');
                        handleSwipe();
                        swipeState.isSwiping = false;
                    }
                }, { passive: true, capture: true });
            }
            
            // ãƒã‚¤ãƒ³ãƒˆç”»é¢ã«å°‚ç”¨ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const pointsView = document.getElementById('points-view');
            if (pointsView) {
                console.log('[POINTS] Adding direct event listeners to points view');
                
                // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ•æ‰
                pointsView.addEventListener('touchstart', (e) => {
                    console.log('[POINTS DIRECT] touchstart on points view!');
                    const currentView = getCurrentView();
                    if (currentView === 'points') {
                        swipeState.touchStartX = e.changedTouches[0].screenX;
                        swipeState.touchStartY = e.changedTouches[0].screenY;
                        swipeState.scrolling = false;
                        swipeState.isSwiping = false;
                        console.log('[POINTS DIRECT] Start position:', swipeState.touchStartX, swipeState.touchStartY);
                    }
                }, { passive: true, capture: true });
                
                pointsView.addEventListener('touchmove', (e) => {
                    const currentView = getCurrentView();
                    if (currentView === 'points') {
                        const diffX = Math.abs(e.changedTouches[0].screenX - swipeState.touchStartX);
                        const diffY = Math.abs(e.changedTouches[0].screenY - swipeState.touchStartY);
                        console.log('[POINTS DIRECT] Move - diffX:', diffX, 'diffY:', diffY);
                        if (diffX > 30 && diffX > diffY) {
                            swipeState.isSwiping = true;
                            swipeState.scrolling = false;
                            e.preventDefault();
                        }
                    }
                }, { passive: false, capture: true });
                
                pointsView.addEventListener('touchend', (e) => {
                    const currentView = getCurrentView();
                    if (currentView === 'points' && swipeState.isSwiping) {
                        swipeState.touchEndX = e.changedTouches[0].screenX;
                        swipeState.touchEndY = e.changedTouches[0].screenY;
                        console.log('[POINTS DIRECT] End - calling handleSwipe');
                        handleSwipe();
                        swipeState.isSwiping = false;
                    }
                }, { passive: true, capture: true });
            }
            
            container.addEventListener('touchstart', (e) => {
                if (!swipeState.isEnabled) {
                    console.log('[Swipe Debug] ã‚¹ãƒ¯ã‚¤ãƒ—ãŒç„¡åŠ¹ã§ã™');
                    return;
                }
                
                const currentView = getCurrentView();
                console.log('[Swipe Debug] touchstart - ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼:', currentView);
                
                // çµ±è¨ˆç”»é¢ã¨ãƒã‚¤ãƒ³ãƒˆç”»é¢ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¸¸ã«ç„¡åŠ¹åŒ–ã—ã¦ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’å„ªå…ˆ
                if (currentView === 'stats' || currentView === 'points') {
                    swipeState.scrolling = false;
                    console.log('[Swipe Debug] çµ±è¨ˆ/ãƒã‚¤ãƒ³ãƒˆç”»é¢ - scrollingã‚’falseã«è¨­å®š');
                } else if (currentView === 'cards') {
                    // ã‚«ãƒ¼ãƒ‰ç”»é¢ã§ã®ã¿ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ ä¸Šã®å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’ç„¡åŠ¹åŒ–
                    const target = e.target;
                    const cardsView = target.closest('#cards-view');
                    
                    if (cardsView) {
                        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
                        const scrollableParent = findScrollableParent(target);
                        if (scrollableParent && scrollableParent.scrollHeight > scrollableParent.clientHeight) {
                            swipeState.scrolling = true;
                            swipeState.touchStartX = e.changedTouches[0].screenX;
                            swipeState.touchStartY = e.changedTouches[0].screenY;
                            console.log('[Swipe Debug] ã‚«ãƒ¼ãƒ‰ç”»é¢ - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ç´ ã®ãŸã‚ä¸­æ–­');
                            return;
                        }
                    }
                    swipeState.scrolling = false;
                } else {
                    swipeState.scrolling = false;
                }
                
                swipeState.touchStartX = e.changedTouches[0].screenX;
                swipeState.touchStartY = e.changedTouches[0].screenY;
                swipeState.isSwiping = false;
                console.log('[Swipe Debug] ã‚¿ãƒƒãƒé–‹å§‹ä½ç½® X:', swipeState.touchStartX, 'Y:', swipeState.touchStartY);
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!swipeState.isEnabled) {
                    console.log('[Swipe Debug] touchmove - ã‚¹ãƒ¯ã‚¤ãƒ—ç„¡åŠ¹');
                    return;
                }
                
                const currentView = getCurrentView();
                
                // çµ±è¨ˆç”»é¢ã§ã¯ç‰¹åˆ¥ãªå‡¦ç†
                if (currentView === 'stats') {
                    const diffX = Math.abs(e.changedTouches[0].screenX - swipeState.touchStartX);
                    const diffY = Math.abs(e.changedTouches[0].screenY - swipeState.touchStartY);
                    
                    console.log('[Swipe Debug] çµ±è¨ˆç”»é¢ touchmove - diffX:', diffX, 'diffY:', diffY, 'isSwiping:', swipeState.isSwiping);
                    
                    // æ¨ªæ–¹å‘ã®å‹•ããŒç¸¦ã‚ˆã‚Šå¤§ãã‘ã‚Œã°ã‚¹ãƒ¯ã‚¤ãƒ—ã¨ã—ã¦æ‰±ã†
                    if (diffX > 20 && diffX > diffY * 0.8) {
                        swipeState.isSwiping = true;
                        swipeState.scrolling = false;
                        console.log('[Swipe Debug] çµ±è¨ˆç”»é¢ - ã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºï¼');
                        try {
                            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
                        } catch(err) {
                            console.log('[Swipe Debug] preventDefaultã‚¨ãƒ©ãƒ¼:', err);
                        }
                    }
                    return;
                }
                
                // çµ±è¨ˆç”»é¢ä»¥å¤–ã®å‡¦ç†
                if (swipeState.scrolling) return;
                
                const diffX = Math.abs(e.changedTouches[0].screenX - swipeState.touchStartX);
                const diffY = Math.abs(e.changedTouches[0].screenY - swipeState.touchStartY);
                
                // ç¸¦æ–¹å‘ã®å‹•ããŒå¤§ãã„å ´åˆã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¨ã¿ãªã™
                if (diffY > diffX && diffY > 10) {
                    swipeState.scrolling = true;
                    return;
                }
                
                // æ¨ªæ–¹å‘ã®å‹•ããŒå¤§ãã„å ´åˆã¯ã‚¹ãƒ¯ã‚¤ãƒ—ã¨ã¿ãªã™
                if (diffX > diffY && diffX > 10) {
                    swipeState.isSwiping = true;
                }
            }, { passive: false });

            container.addEventListener('touchend', (e) => {
                const currentView = getCurrentView();
                console.log('[Swipe Debug] touchend - ãƒ“ãƒ¥ãƒ¼:', currentView, 'isSwipeEnabled:', swipeState.isEnabled, 'isSwiping:', swipeState.isSwiping, 'scrolling:', swipeState.scrolling);
                
                // çµ±è¨ˆç”»é¢ã§ã¯scrollingãƒ•ãƒ©ã‚°ã‚’ç„¡è¦–
                if (!swipeState.isEnabled || (!swipeState.isSwiping) || (currentView !== 'stats' && swipeState.scrolling)) {
                    console.log('[Swipe Debug] touchend - ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
                    swipeState.scrolling = false;
                    swipeState.isSwiping = false;
                    return;
                }
                
                swipeState.touchEndX = e.changedTouches[0].screenX;
                swipeState.touchEndY = e.changedTouches[0].screenY;
                console.log('[Swipe Debug] ã‚¿ãƒƒãƒçµ‚äº†ä½ç½® X:', swipeState.touchEndX, 'Y:', swipeState.touchEndY);
                console.log('[Swipe Debug] ç§»å‹•é‡ X:', swipeState.touchStartX - swipeState.touchEndX, 'Y:', swipeState.touchStartY - swipeState.touchEndY);
                handleSwipe();
                swipeState.scrolling = false;
                swipeState.isSwiping = false;
            }, { passive: true });
        }
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ãªè¦ªè¦ç´ ã‚’æ¢ã™
        function findScrollableParent(element) {
            // çµ±è¨ˆç”»é¢ã§ã¯å¸¸ã«nullã‚’è¿”ã—ã¦ã‚¹ãƒ¯ã‚¤ãƒ—ã‚’å„ªå…ˆ
            if (getCurrentView() === 'stats') {
                return null;
            }
            
            let parent = element;
            while (parent && parent !== document.body) {
                const style = window.getComputedStyle(parent);
                if (style.overflowY === 'auto' || style.overflowY === 'scroll' || 
                    parent.scrollHeight > parent.clientHeight) {
                    return parent;
                }
                parent = parent.parentElement;
            }
            return null;
        }

        // ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†
        function handleSwipe() {
            const diffX = swipeState.touchStartX - swipeState.touchEndX;
            const diffY = swipeState.touchStartY - swipeState.touchEndY;
            const currentView = getCurrentView();
            
            // çµ±è¨ˆç”»é¢ã¨ãƒã‚¤ãƒ³ãƒˆç”»é¢ã§ã¯é–¾å€¤ã‚’ä¸‹ã’ã‚‹
            const minSwipeDistance = (currentView === 'stats' || currentView === 'points') ? 50 : 80;
            
            // çµ±è¨ˆç”»é¢ã¨ãƒã‚¤ãƒ³ãƒˆç”»é¢ã§ã¯æ¡ä»¶ã‚’ç·©å’Œ
            const horizontalRatio = (currentView === 'stats' || currentView === 'points') ? 1.2 : 2;
            
            console.log('[Swipe Debug] handleSwipe - ãƒ“ãƒ¥ãƒ¼:', currentView);
            console.log('[Swipe Debug] æœ€å°è·é›¢:', minSwipeDistance, 'æ¯”ç‡:', horizontalRatio);
            console.log('[Swipe Debug] æ¡ä»¶åˆ¤å®š: |diffX|:', Math.abs(diffX), '> |diffY| *', horizontalRatio, '=', Math.abs(diffY) * horizontalRatio);
            console.log('[Swipe Debug] è·é›¢åˆ¤å®š: |diffX|:', Math.abs(diffX), '>', minSwipeDistance);
            
            // æ°´å¹³ã‚¹ãƒ¯ã‚¤ãƒ—ã®ã¿ã‚’æ¤œå‡ºï¼ˆå‚ç›´ç§»å‹•ãŒå°‘ãªã„å ´åˆï¼‰
            if (Math.abs(diffX) > Math.abs(diffY) * horizontalRatio && Math.abs(diffX) > minSwipeDistance) {
                // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ç”»é¢ã‚„é€²æ—ç”»é¢ã§ã¯ã‚¹ãƒ¯ã‚¤ãƒ—ç„¡åŠ¹
                if (currentView === 'shuffle' || currentView === 'progress') {
                    console.log('[Swipe Debug] ã‚·ãƒ£ãƒƒãƒ•ãƒ«/é€²æ—ç”»é¢ã®ãŸã‚ã‚¹ãƒ¯ã‚¤ãƒ—ç„¡åŠ¹');
                    return;
                }
                
                if (diffX > 0) {
                    console.log('[Swipe Debug] å·¦ã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡º - æ¬¡ã®ç”»é¢ã¸');
                    // å·¦ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæŒ‡ã‚’å³ã‹ã‚‰å·¦ã¸ï¼‰ - æ¬¡ã®ç”»é¢ã¸
                    navigateToNextView();
                } else {
                    console.log('[Swipe Debug] å³ã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡º - å‰ã®ç”»é¢ã¸');
                    // å³ã‚¹ãƒ¯ã‚¤ãƒ—ï¼ˆæŒ‡ã‚’å·¦ã‹ã‚‰å³ã¸ï¼‰ - å‰ã®ç”»é¢ã¸
                    navigateToPreviousView();
                }
            } else {
                console.log('[Swipe Debug] ã‚¹ãƒ¯ã‚¤ãƒ—æ¡ä»¶ã‚’æº€ãŸã•ãš');
            }
        }

        // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’å–å¾—
        function getCurrentView() {
            if (document.getElementById('home-view').style.display !== 'none') return 'home';
            if (document.getElementById('new-hypothesis-view').style.display !== 'none') return 'new';
            if (document.getElementById('history-view').style.display !== 'none') return 'history';
            if (document.getElementById('stats-view').style.display !== 'none') return 'stats';
            if (document.getElementById('points-view').style.display !== 'none') return 'points';
            if (document.getElementById('cards-view').style.display !== 'none') return 'cards';
            if (document.getElementById('shuffle-view').style.display !== 'none') return 'shuffle';
            if (document.getElementById('progress-view').style.display !== 'none') return 'progress';
            return 'home';
        }

        // æ¬¡ã®ãƒ“ãƒ¥ãƒ¼ã¸é·ç§»
        function navigateToNextView() {
            const currentView = getCurrentView();
            const currentIndex = views.indexOf(currentView);
            if (currentIndex !== -1) {
                // æœ€å¾Œã®ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯æœ€åˆã«æˆ»ã‚‹ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
                const nextIndex = (currentIndex + 1) % views.length;
                const nextView = views[nextIndex];
                showViewWithAnimation(nextView, 'left');
            }
        }

        // å‰ã®ãƒ“ãƒ¥ãƒ¼ã¸é·ç§»
        function navigateToPreviousView() {
            const currentView = getCurrentView();
            const currentIndex = views.indexOf(currentView);
            if (currentIndex !== -1) {
                // æœ€åˆã®ãƒ“ãƒ¥ãƒ¼ã®å ´åˆã¯æœ€å¾Œã«æˆ»ã‚‹ï¼ˆãƒ«ãƒ¼ãƒ—ï¼‰
                const previousIndex = currentIndex === 0 ? views.length - 1 : currentIndex - 1;
                const previousView = views[previousIndex];
                showViewWithAnimation(previousView, 'right');
            }
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        function showViewWithAnimation(viewName, direction) {
            const container = document.querySelector('.container');
            container.style.transition = 'transform 0.3s ease-out';
            
            // ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆã‚’è¡¨ç¤º
            const hint = document.createElement('div');
            hint.className = `swipe-hint ${direction}`;
            hint.textContent = direction === 'left' ? 'â†’' : 'â†';
            document.body.appendChild(hint);
            setTimeout(() => hint.remove(), 500);
            
            // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            if (direction === 'left') {
                container.style.transform = 'translateX(-20px)';
            } else {
                container.style.transform = 'translateX(20px)';
            }
            
            setTimeout(() => {
                switch (viewName) {
                    case 'home':
                        showHomeView();
                        break;
                    case 'new':
                        showNewHypothesisView();
                        break;
                    case 'history':
                        showHistoryView();
                        break;
                    case 'stats':
                        showStatsView();
                        break;
                    case 'points':
                        showPointsView();
                        break;
                    case 'cards':
                        showCardsView();
                        break;
                }
                
                container.style.transform = 'translateX(0)';
                setTimeout(() => {
                    container.style.transition = '';
                }, 300);
            }, 150);
        }

        // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¿½åŠ 
        function addSwipeIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'swipe-indicator';
            indicator.innerHTML = 'â† ã‚¹ãƒ¯ã‚¤ãƒ—ã§ãƒšãƒ¼ã‚¸ç§»å‹• â†’';
            indicator.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
            `;
            document.body.appendChild(indicator);
            
            // åˆå›è¡¨ç¤º
            setTimeout(() => {
                indicator.style.opacity = '1';
                setTimeout(() => {
                    indicator.style.opacity = '0';
                }, 3000);
            }, 1000);
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼é«˜ã•ã‚’å®Ÿæ¸¬ã—ã¦CSSå¤‰æ•°ã‚’æ›´æ–°ï¼ˆç«¯æœ«å·®ã§ã®ã‚ºãƒ¬é˜²æ­¢ï¼‰
        function updateHeaderHeightVar() {
            const header = document.querySelector('.header');
            if (!header) return;
            const h = Math.ceil(header.getBoundingClientRect().height);
            document.documentElement.style.setProperty('--header-height', h + 'px');
        }

        // é€£ç¶šãƒªã‚µã‚¤ã‚ºæ™‚ã®è² è·è»½æ¸›
        function debounce(fn, wait) {
            let t;
            return function(...args) {
                clearTimeout(t);
                t = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        // ========== ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•° ==========
        
        // ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function checkComplete3Habits() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            let completedCount = 0;
            
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[todayKey]) {
                    completedCount++;
                }
            });
            
            return completedCount >= 3;
        }
        
        function checkMorningRoutine() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            const now = new Date();
            const noon = new Date();
            noon.setHours(12, 0, 0, 0);
            
            if (now.getHours() >= 12) {
                // åˆå¾Œã«ãªã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯å¯èƒ½
                let morningHabitsCompleted = 0;
                data.currentHypotheses.forEach(h => {
                    // æœã®å®£è¨€ãŒã‚ã‚‹ç¿’æ…£
                    if (h.morningDeclaration && h.achievements && h.achievements[todayKey]) {
                        morningHabitsCompleted++;
                    }
                });
                return morningHabitsCompleted > 0;
            }
            return false;
        }
        
        function checkHighIntensityDay() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            let allHighIntensity = true;
            let hasAchievements = false;
            
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[todayKey]) {
                    hasAchievements = true;
                    const intensity = h.intensity && h.intensity[todayKey] || 1.0;
                    if (intensity < 1.2) {
                        allHighIntensity = false;
                    }
                }
            });
            
            return hasAchievements && allHighIntensity;
        }
        
        function checkCategoryMaster() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            const categoryCount = {};
            
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[todayKey]) {
                    const category = h.category || 'other';
                    categoryCount[category] = (categoryCount[category] || 0) + 1;
                }
            });
            
            return Object.values(categoryCount).some(count => count >= 3);
        }
        
        function checkEarlyBird() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            const now = new Date();
            
            if (now.getHours() >= 12) {
                // åˆå¾Œã«ãªã£ãŸã‚‰ãƒã‚§ãƒƒã‚¯å¯èƒ½
                let morningAchievements = 0;
                data.currentHypotheses.forEach(h => {
                    if (h.achievements && h.achievements[todayKey]) {
                        // ç°¡æ˜“çš„ã«åˆå‰ä¸­ã®é”æˆã¨ã¿ãªã™
                        morningAchievements++;
                    }
                });
                return morningAchievements >= 2;
            }
            return false;
        }
        
        function checkVarietyDay() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            const categories = new Set();
            
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[todayKey]) {
                    categories.add(h.category || 'other');
                }
            });
            
            return categories.size >= 4;
        }
        
        function checkEffortBonusMax() {
            const data = loadData();
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã®æœ€å¤§ä½¿ç”¨ï¼ˆ11ç¨®é¡ã™ã¹ã¦ä½¿ç”¨ï¼‰
            return data.pointSystem.dailyEffortUsed >= 11;
        }
        
        function checkHabitAndChallenge() {
            const data = loadData();
            const todayKey = dateKeyLocal(new Date());
            let hasHabitAchievement = false;
            
            data.currentHypotheses.forEach(h => {
                if (h.achievements && h.achievements[todayKey]) {
                    hasHabitAchievement = true;
                }
            });
            
            const hasChallengeCompleted = data.challenges.completedToday.length > 0;
            
            return hasHabitAchievement && hasChallengeCompleted;
        }
        
        // ã‚¦ã‚£ãƒ¼ã‚¯ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯é–¢æ•°
        function checkWeekPerfect() {
            const data = loadData();
            let allAbove90 = true;
            
            data.currentHypotheses.forEach(h => {
                const achievedDays = Object.keys(h.achievements || {}).length;
                const totalDays = h.totalDays || 1;
                const rate = (achievedDays / totalDays) * 100;
                if (rate < 90) {
                    allAbove90 = false;
                }
            });
            
            return data.currentHypotheses.length > 0 && allAbove90;
        }
        
        function checkWeekCardCollector() {
            const data = loadData();
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            const recentCards = (data.cards.inventory || []).filter(card => {
                return new Date(card.earnedAt) > oneWeekAgo;
            });
            
            return recentCards.length >= 5;
        }
        
        function checkWeekChallengeMaster() {
            const data = loadData();
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚¹ãƒˆãƒªãƒ¼ã‚¯ãŒ7ä»¥ä¸Š
            return data.challenges.streak >= 7;
        }
        
        // ãã®ä»–ã®ãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆç°¡ç•¥åŒ–ï¼‰
        function checkPerfectStreak() { return false; }
        function checkIfThenExecute() { return false; }
        function checkDeclarationMaster() { return false; }
        function checkConsistencyBonus() { return false; }
        function checkWeekConsistency() { return false; }
        function checkWeekIntensityUp() { return false; }
        function checkWeekAllCategories() { return false; }
        function checkWeekIfThenMaster() { return false; }
        function checkWeekComeback() { return false; }
        function checkWeekHabitCombo() { return false; }
        function checkWeekDeclarationPerfect() { return false; }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            updateHeaderHeightVar();
            // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®‰å®šå¾Œã«ã‚‚å†æ¸¬å®šï¼ˆãƒ•ã‚©ãƒ³ãƒˆ/ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼åæ˜ ï¼‰
            setTimeout(updateHeaderHeightVar, 200);
            setTimeout(updateHeaderHeightVar, 800);
        });
        window.addEventListener('resize', debounce(updateHeaderHeightVar, 120));
        window.addEventListener('orientationchange', () => setTimeout(updateHeaderHeightVar, 100));

        // ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿æ™‚ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒˆãƒƒãƒ—ã¸æƒãˆã‚‹
        function resetScrollToTop() {
            try {
                // ã¾ãš window ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
                window.scrollTo({ top: 0, behavior: 'auto' });
                // å¿µã®ãŸã‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ«ãƒ¼ãƒˆã«ã‚‚é©ç”¨ï¼ˆiOS/Safari å¯¾ç­–ï¼‰
                const el = document.scrollingElement || document.documentElement;
                el.scrollTop = 0;
                document.body.scrollTop = 0;
            } catch (_) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                document.documentElement.scrollTop = 0;
                document.body.scrollTop = 0;
            }
        }

        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
        function debugAchieveToday() {
            if (!window.currentHypothesis) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateKey = dateKeyLocal(today);
            
            window.currentHypothesis.achievements[dateKey] = true;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();
            showNotification('âœ… ä»Šæ—¥ã‚’é”æˆã«ã—ã¾ã—ãŸ', 'success');
        }
        
        function debugFailToday() {
            if (!window.currentHypothesis) return;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const dateKey = dateKeyLocal(today);
            
            delete window.currentHypothesis.achievements[dateKey];
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();
            showNotification('âŒ ä»Šæ—¥ã‚’æœªé”æˆã«ã—ã¾ã—ãŸ', 'error');
        }
        
        // ========== æœŸé–“ä¸­ã‚¤ãƒ™ãƒ³ãƒˆé–¢é€£ã®é–¢æ•° ==========
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
        function checkDailyEvents() {
            const data = loadData();
            const today = new Date().toDateString();
            const todayStr = new Date().toISOString().split('T')[0];
            
            // æœ€å¾Œã®ãƒã‚§ãƒƒã‚¯æ—¥ã¨åŒã˜ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (data.events.lastEventCheck === today) return;
            
            data.events.lastEventCheck = today;
            data.events.activeBoosts = [];
            
            // ã‚¤ãƒ™ãƒ³ãƒˆå°å°ãƒã‚§ãƒƒã‚¯
            if (data.cards && data.cards.activeEffects) {
                const sealEffect = data.cards.activeEffects.find(effect => 
                    effect.type === 'event_seal' && 
                    new Date(effect.startDate) <= new Date() && 
                    new Date(effect.endDate) >= new Date()
                );
                if (sealEffect) {
                    saveData(data);
                    return; // ã‚¤ãƒ™ãƒ³ãƒˆå°å°ä¸­ã¯ä½•ã‚‚ã—ãªã„
                }
            }
            
            // ãƒ–ãƒ¼ã‚¹ãƒˆãŒæœ‰åŠ¹ãªã‚‰ãƒã‚§ãƒƒã‚¯
            if (data.events.boostEnabled) {
                let eventCount = 0;
                
                // å¼·åˆ¶ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
                if (data.events.forcedEvents && data.events.forcedEvents[todayStr]) {
                    eventCount = 1;  // å¼·åˆ¶ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ
                    delete data.events.forcedEvents[todayStr];  // ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
                } else {
                    // é€šå¸¸ã®ã‚¤ãƒ™ãƒ³ãƒˆå€‹æ•°ã‚’æ±ºå®šï¼ˆ0å€‹:50%, 1å€‹:45%, 2å€‹:5%ï¼‰
                    const eventRoll = Math.random();
                    if (eventRoll < 0.5) {
                        eventCount = 0;  // 50%ã®ç¢ºç‡ã§0å€‹
                    } else if (eventRoll < 0.95) {
                        eventCount = 1;  // 45%ã®ç¢ºç‡ã§1å€‹
                    } else {
                        eventCount = 2;  // 5%ã®ç¢ºç‡ã§2å€‹
                    }
                }
                
                if (eventCount > 0) {
                    // åˆ©ç”¨å¯èƒ½ãªãƒ–ãƒ¼ã‚¹ãƒˆã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
                    const availableBoosts = [...HABIT_EVENTS.boosts];
                    const shuffled = availableBoosts.sort(() => Math.random() - 0.5);
                    
                    // æŒ‡å®šã•ã‚ŒãŸå€‹æ•°ã ã‘ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠ
                    let selectedCount = 0;
                    for (const boost of shuffled) {
                        if (selectedCount >= eventCount) break;
                        
                        // æ¡ä»¶ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ¡ä»¶é–¢æ•°ãŒã‚ã‚‹å ´åˆã¯å®Ÿè¡Œï¼‰
                        let shouldActivate = false;
                        if (typeof boost.condition === 'function') {
                            // æ¡ä»¶é–¢æ•°ã®çµæœã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆæ—¢ã«ç¢ºç‡ãŒå«ã¾ã‚Œã¦ã„ã‚‹ï¼‰
                            shouldActivate = boost.condition(data);
                        } else {
                            // æ¡ä»¶é–¢æ•°ãŒãªã„å ´åˆã¯ãƒ¬ã‚¢ãƒªãƒ†ã‚£ã«åŸºã¥ãç¢ºç‡
                            const rarityChance = {
                                common: 0.4,
                                uncommon: 0.3,
                                rare: 0.2,
                                legendary: 0.1
                            };
                            shouldActivate = Math.random() < (rarityChance[boost.rarity] || 0.3);
                        }
                        
                        if (shouldActivate) {
                            data.events.activeBoosts.push({
                                ...boost,
                                activatedAt: new Date().toISOString()
                            });
                            selectedCount++;
                        }
                    }
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ–ãƒ¼ã‚¹ãƒˆãŒã‚ã‚Œã°é€šçŸ¥
                    if (data.events.activeBoosts.length > 0) {
                        data.events.activeBoosts.forEach(boost => {
                            showEventNotification(boost);
                        });
                    }
                }
            }
            
            saveData(data);
            updateEventDisplay();
        }
        
        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯
        function checkMilestoneEvent(hypothesis, achievedDays) {
            const data = loadData();
            const milestones = HABIT_EVENTS.milestones;
            
            Object.keys(milestones).forEach(days => {
                const daysNum = parseInt(days);
                if (achievedDays >= daysNum && !data.events.milestoneNotifications[`${hypothesis.id}_${days}`]) {
                    const milestone = milestones[days];
                    
                    // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å ±é…¬ã‚’ä»˜ä¸
                    if (milestone.rewards.includes('bonus_points')) {
                        earnPoints(daysNum * 5, 'milestone', `${hypothesis.title} ${days}æ—¥é”æˆè¨˜å¿µï¼`);
                        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€šçŸ¥ï¼ˆå„ªå…ˆåº¦6ï¼‰
                        showNotification(
                            `ğŸ† ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆï¼\n${hypothesis.title}\n${days}æ—¥ç¶™ç¶šï¼\n+${daysNum * 5}pt`,
                            'success',
                            6
                        );
                    }
                    if (milestone.rewards.includes('huge_bonus')) {
                        earnPoints(50, 'milestone', `${hypothesis.title} 21æ—¥é”æˆãŠã‚ã§ã¨ã†ï¼`);
                        // 21æ—¥é”æˆã¯ç‰¹åˆ¥ï¼ˆå„ªå…ˆåº¦7ï¼‰
                        showNotification(
                            `ğŸŠ ç¥ï¼21æ—¥é”æˆï¼\n${hypothesis.title}\nç¿’æ…£åŒ–æˆåŠŸï¼\n+50pt`,
                            'success',
                            7
                        );
                    }
                    
                    // é€šçŸ¥æ¸ˆã¿ã¨ã—ã¦è¨˜éŒ²
                    data.events.milestoneNotifications[`${hypothesis.id}_${days}`] = new Date().toISOString();
                    saveData(data);
                }
            });
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥è¡¨ç¤º
        function showEventNotification(boost) {
            const rarityColors = {
                common: '#64748b',
                uncommon: '#10b981',
                rare: '#3b82f6',
                legendary: '#fbbf24'
            };
            
            const notification = document.createElement('div');
            notification.className = 'event-notification';
            notification.innerHTML = `
                <div style="background: linear-gradient(135deg, ${rarityColors[boost.rarity]}33, ${rarityColors[boost.rarity]}11); 
                            border: 1px solid ${rarityColors[boost.rarity]}; 
                            border-radius: 12px; padding: 16px; margin: 8px;">
                    <div style="font-size: 20px; margin-bottom: 8px;">${boost.name}</div>
                    <div style="font-size: 14px; color: var(--text-secondary);">${boost.description}</div>
                    <div style="font-size: 12px; margin-top: 8px; color: ${rarityColors[boost.rarity]};">
                        ${boost.rarity.toUpperCase()} ã‚¤ãƒ™ãƒ³ãƒˆ
                    </div>
                </div>
            `;
            
            // é€šçŸ¥ã‚’ç”»é¢ã«è¡¨ç¤º
            const container = document.getElementById('notifications-container') || document.body;
            container.appendChild(notification);
            
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                notification.style.animation = 'slideInFromTop 0.5s ease-out';
            }, 100);
            
            // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 5000);
        }
        
        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é€šçŸ¥è¡¨ç¤º
        function showMilestoneNotification(milestone, habitTitle) {
            const notification = document.createElement('div');
            notification.className = 'milestone-notification';
            notification.innerHTML = `
                <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); 
                            color: white; border-radius: 12px; padding: 20px; margin: 8px; text-align: center;">
                    <div style="font-size: 24px; margin-bottom: 8px;">${milestone.title}</div>
                    <div style="font-size: 16px; margin-bottom: 8px;">ã€Œ${habitTitle}ã€</div>
                    <div style="font-size: 14px;">${milestone.message}</div>
                </div>
            `;
            
            const container = document.getElementById('notifications-container') || document.body;
            container.appendChild(notification);
            
            // ç‰¹åˆ¥ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            notification.style.animation = 'bounceIn 1s ease-out';
            
            // 10ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
            setTimeout(() => {
                notification.style.animation = 'fadeOut 0.5s ease-out';
                setTimeout(() => notification.remove(), 500);
            }, 10000);
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆè¡¨ç¤ºã®æ›´æ–°
        function updateEventDisplay() {
            const data = loadData();
            const eventContainer = document.getElementById('active-events');
            
            if (!eventContainer) return;
            
            if (!data.events || data.events.activeBoosts.length === 0) {
                eventContainer.style.display = 'none';
            } else {
                eventContainer.style.display = 'block';
                eventContainer.innerHTML = `
                    <h3 style="margin-bottom: 12px; font-size: 16px;">ğŸ‰ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆ</h3>
                    ${data.events.activeBoosts.map(boost => `
                        <div class="event-card" style="background: rgba(251, 191, 36, 0.15); border-radius: 8px; padding: 12px; margin: 8px 0;">
                            <div style="font-size: 16px; font-weight: bold;">${boost.name}</div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">${boost.description}</div>
                            <div style="font-size: 10px; margin-top: 8px; color: #f59e0b;">
                                æœŸé–“: ${boost.duration === 'today' ? 'æœ¬æ—¥ä¸­' : boost.duration}
                            </div>
                        </div>
                    `).join('')}
                `;
            }
        }
        
        // ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœã‚’é©ç”¨ã—ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è¨ˆç®—
        function calculatePointsWithBoosts(basePoints, source, category = null) {
            const data = loadData();
            let finalPoints = basePoints;
            let multiplier = 1.0;
            let bonus = 0;
            
            // ã‚«ãƒ¼ãƒ‰åŠ¹æœã®ãƒã‚§ãƒƒã‚¯
            if (data.cards && data.cards.activeEffects) {
                const now = new Date();
                
                // ãƒã‚¤ãƒ³ãƒˆã‚¸ã‚§ãƒ åŠ¹æœ
                const pointGem = data.cards.activeEffects.find(effect => 
                    effect.type === 'point_multiplier' && 
                    new Date(effect.startDate) <= now && 
                    new Date(effect.endDate) >= now
                );
                if (pointGem) {
                    multiplier *= pointGem.multiplier;
                }
                
                // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœ
                const rainbowBoost = data.cards.activeEffects.find(effect => 
                    effect.type === 'all_category_boost' && 
                    new Date(effect.startDate) <= now && 
                    new Date(effect.endDate) >= now
                );
                if (rainbowBoost && category) {
                    multiplier *= rainbowBoost.multiplier;
                }
                
                // ã‚¹ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³åŠ¹æœ
                const slowdown = data.cards.activeEffects.find(effect => 
                    effect.type === 'slowdown' && 
                    new Date(effect.startDate) <= now && 
                    new Date(effect.endDate) >= now
                );
                if (slowdown) {
                    multiplier *= 0.5;
                }
                
                // é€†è»¢ã®å‘ªã„åŠ¹æœ
                const reverseCurse = data.cards.activeEffects.find(effect => 
                    effect.type === 'reverse_curse' && 
                    new Date(effect.startDate) <= now && 
                    new Date(effect.endDate) >= now
                );
                if (reverseCurse && source === 'habit') {
                    // é”æˆã§0ãƒã‚¤ãƒ³ãƒˆã€æœªé”æˆã§é€šå¸¸ãƒã‚¤ãƒ³ãƒˆï¼ˆå‘¼ã³å‡ºã—å…ƒã§å‡¦ç†ï¼‰
                    return 0;
                }
            }
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ–ãƒ¼ã‚¹ãƒˆåŠ¹æœ
            if (data.events && data.events.activeBoosts) {
                data.events.activeBoosts.forEach(boost => {
                    const effect = boost.effect;
                    
                    switch (effect.type) {
                        case 'global_multiplier':
                            multiplier *= effect.value;
                            break;
                        case 'category_multiplier':
                            if (category === effect.target) {
                                multiplier *= effect.value;
                            }
                            break;
                        case 'category_bonus':
                            if (category === effect.target) {
                                bonus += effect.value;
                            }
                            break;
                        case 'challenge_multiplier':
                            if (source === 'challenge') {
                                multiplier *= effect.value;
                            }
                            break;
                        case 'time_bonus':
                            const hour = new Date().getHours();
                            if ((boost.duration === 'morning' && hour >= 6 && hour <= 9) ||
                                (boost.duration === 'night' && hour >= 20 && hour <= 23)) {
                                bonus += effect.value;
                            }
                            break;
                    }
                });
            }
            
            finalPoints = Math.round(basePoints * multiplier + bonus);
            return finalPoints;
        }

        // ========== ã‚«ãƒ¼ãƒ‰å›³é‘‘é–¢é€£ã®é–¢æ•° ==========
        
        // ã‚«ãƒ¼ãƒ‰å›³é‘‘ã®åˆæœŸåŒ–
        function initializeCardAlbum() {
            const data = loadData();
            if (!data.cardAlbum) {
                data.cardAlbum = {
                    collection: {},
                    totalCardsObtained: 0,
                    firstObtainedDates: {},
                    viewHistory: []
                };
            }
            
            // å…¨ã‚«ãƒ¼ãƒ‰ã®å®šç¾©ã‚’å›³é‘‘ã«ç™»éŒ²
            const allCards = { ...CARD_MASTER };
            Object.keys(allCards).forEach(cardId => {
                if (!data.cardAlbum.collection[cardId]) {
                    data.cardAlbum.collection[cardId] = {
                        obtained: false,
                        count: 0,
                        firstObtained: null,
                        hints: getCardHints(cardId)
                    };
                }
            });
            
            saveData(data);
        }
        
        // ã‚«ãƒ¼ãƒ‰å–å¾—æ™‚ã®å‡¦ç†
        function registerCardToAlbum(cardId) {
            const data = loadData();
            if (!data.cardAlbum.collection[cardId]) {
                data.cardAlbum.collection[cardId] = {
                    obtained: false,
                    count: 0,
                    firstObtained: null,
                    hints: getCardHints(cardId)
                };
            }
            
            const cardEntry = data.cardAlbum.collection[cardId];
            if (!cardEntry.obtained) {
                cardEntry.obtained = true;
                cardEntry.firstObtained = new Date().toISOString();
                data.cardAlbum.totalCardsObtained++;
                
                // å›³é‘‘ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡ã‚’ãƒã‚§ãƒƒã‚¯
                checkAlbumCompletion(data);
            }
            cardEntry.count++;
            
            saveData(data);
        }
        
        // ã‚«ãƒ¼ãƒ‰ãƒ’ãƒ³ãƒˆã®å–å¾—
        function getCardHints(cardId) {
            const hints = {
                // å ±é…¬ã‚«ãƒ¼ãƒ‰
                skip_ticket: 'ç¿’æ…£ã‚’ç¶™ç¶šçš„ã«é”æˆã—ã¦ã„ã‚‹ã¨å‡ºç¾ã—ã‚„ã™ã„',
                achievement_boost: 'é€£ç¶šé”æˆè¨˜éŒ²ã‚’æ›´æ–°ã™ã‚‹ã¨å‡ºç¾ç‡UP',
                perfect_bonus: 'å…¨ã¦ã®ç¿’æ…£ã‚’é”æˆã—ãŸæ—¥ã«é«˜ç¢ºç‡ã§å‡ºç¾',
                protect_shield: 'ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã„ãŸå¾Œã«å‡ºç¾ã—ã‚„ã™ã„',
                achievement_booster: 'é”æˆç‡ãŒä½ã„æ™‚ã«å¿œæ´ã¨ã—ã¦å‡ºç¾',
                second_chance: 'ç¿’æ…£æœŸé™ãŒè¿‘ã¥ãã¨å‡ºç¾ç‡UP',
                event_trigger: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒå°‘ãªã„æ—¥ãŒç¶šãã¨å‡ºç¾',
                event_combo: 'è¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆãŒåŒæ™‚ç™ºç”Ÿã—ãŸæ—¥ã«ç¨€ã«å‡ºç¾',
                point_gem: 'ãƒã‚¤ãƒ³ãƒˆã‚’å¤§é‡ã«ä½¿ã£ãŸå¾Œã«å‡ºç¾ã—ã‚„ã™ã„',
                mission_master: 'å…¨ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢ã§å‡ºç¾ç‡UP',
                rainbow_boost: 'å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ç¿’æ…£ã‚’æŒã¤ã¨å‡ºç¾',
                quick_start: 'æ–°ã—ã„ç¿’æ…£ã‚’å§‹ã‚ã‚‹æ™‚ã«å‡ºç¾ã—ã‚„ã™ã„',
                streak_bonus: 'é€£ç¶šé”æˆè¨˜éŒ²ãŒé€”åˆ‡ã‚ŒãŸå¾Œã«å‡ºç¾',
                lucky_seven: '7ã®ä»˜ãæ—¥ã«å‡ºç¾ç‡UP',
                
                // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰
                hard_mode: 'ç°¡å˜ã™ãã‚‹ç¿’æ…£ã«ã¯è©¦ç·´ãŒå¾…ã£ã¦ã„ã‚‹',
                reset_risk: 'æ²¹æ–­ã¯ç¦ç‰©ã€é€£ç¶šå¤±æ•—ã«æ³¨æ„',
                achievement_decrease: 'æœ€åˆã‹ã‚‰èº“ãã“ã¨ã‚‚ã‚ã‚‹',
                short_term: 'é•·æœŸç¿’æ…£ã®å¾Œã«ç¾ã‚Œã‚„ã™ã„',
                extension_card: 'çŸ­æœŸç¿’æ…£ã‚’é¸ã³ã™ãã‚‹ã¨...',
                chaos_vortex: 'ã‚«ã‚ªã‚¹ãªæ—¥ã€…ã‚’éã”ã™ã¨...',
                double_or_nothing: 'å¤§ããªè³­ã‘ã«ã¯å¤§ããªãƒªã‚¹ã‚¯',
                event_seal: 'ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤šã™ããŸæ—¥ã®ç¿Œæ—¥ã«',
                mission_overload: 'ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’æ€ ã‘ã¦ã„ã‚‹ã¨...',
                slowdown: 'æ€¥ãã™ãã«ã¯æ³¨æ„ãŒå¿…è¦',
                reverse_curse: 'ä¸è¦å‰‡ãªé”æˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§å‡ºç¾',
                
                // ç‰¹æ®Šã‚«ãƒ¼ãƒ‰
                conversion_magic: 'ä¼èª¬ã®ç¿’æ…£é”æˆè€…ã®ã¿ãŒæ‰‹ã«ã™ã‚‹',
                fate_dice: 'é‹å‘½ã‚’ä¿¡ã˜ã‚‹è€…ã«ä¸ãˆã‚‰ã‚Œã‚‹'
            };
            
            return hints[cardId] || 'æ¡ä»¶ã¯ç§˜å¯†...æ¢ã—å‡ºãã†ï¼';
        }
        
        // å›³é‘‘ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡ãƒã‚§ãƒƒã‚¯
        function checkAlbumCompletion(data) {
            const totalCards = Object.keys(CARD_MASTER).length;
            const obtainedCards = data.cardAlbum.totalCardsObtained;
            const completionRate = (obtainedCards / totalCards) * 100;
            
            // ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡ã«å¿œã˜ãŸå ±é…¬
            const milestones = [25, 50, 75, 100];
            milestones.forEach(rate => {
                if (completionRate >= rate && !data.badges?.[`album_${rate}`]) {
                    if (!data.badges) data.badges = {};
                    data.badges[`album_${rate}`] = { earnedAt: new Date().toISOString() };
                    
                    // å ±é…¬ãƒã‚¤ãƒ³ãƒˆ
                    earnPoints(rate * 10, 'album', `ã‚«ãƒ¼ãƒ‰å›³é‘‘${rate}%é”æˆï¼`);
                    
                    // ç‰¹åˆ¥é€šçŸ¥
                    showNotification(`ğŸ´ ã‚«ãƒ¼ãƒ‰å›³é‘‘${rate}%ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼`, 'success');
                }
            });
        }
        
        // ã‚«ãƒ¼ãƒ‰å›³é‘‘ã®è¡¨ç¤º
        function showCardAlbum() {
            const data = loadData();
            initializeCardAlbum();
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.98); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
            
            const totalCards = Object.keys(CARD_MASTER).length;
            const obtainedCards = data.cardAlbum.totalCardsObtained;
            const completionRate = Math.round((obtainedCards / totalCards) * 100);
            
            modal.innerHTML = `
                <div style="background: #0f172a; border-radius: 16px; padding: 24px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; border: 2px solid rgba(59, 130, 246, 0.5); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="font-size: 24px; font-weight: bold; color: #e2e8f0;">ğŸ´ ã‚«ãƒ¼ãƒ‰å›³é‘‘</h2>
                        <button onclick="this.closest('.modal-overlay').remove()" style="background: none; border: none; color: #94a3b8; font-size: 24px; cursor: pointer;">Ã—</button>
                    </div>
                    
                    <div style="background: rgba(139, 92, 246, 0.15); border-radius: 12px; padding: 16px; margin-bottom: 20px; border: 1px solid rgba(139, 92, 246, 0.3);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-size: 14px; color: #94a3b8;">ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç‡</div>
                                <div style="font-size: 28px; font-weight: bold; color: #8b5cf6;">${completionRate}%</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 14px; color: #94a3b8;">å–å¾—ã‚«ãƒ¼ãƒ‰</div>
                                <div style="font-size: 20px; font-weight: bold; color: #e2e8f0;">${obtainedCards} / ${totalCards}</div>
                            </div>
                        </div>
                        <div style="margin-top: 12px; background: rgba(0,0,0,0.5); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #10b981, #3b82f6); height: 100%; width: ${completionRate}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">
                        ${Object.entries(CARD_MASTER).map(([cardId, card]) => {
                            const entry = data.cardAlbum.collection[cardId] || { obtained: false, count: 0, hints: '' };
                            const isObtained = entry.obtained;
                            
                            return `
                                <div style="background: ${isObtained ? '#1e293b' : '#0f172a'}; 
                                            border: 2px solid ${isObtained ? card.color : '#334155'}; 
                                            border-radius: 12px; padding: 12px; 
                                            opacity: ${isObtained ? '1' : '0.6'};">
                                    <div style="font-size: 32px; text-align: center; margin-bottom: 8px;">
                                        ${isObtained ? card.icon : 'â“'}
                                    </div>
                                    <div style="font-size: 12px; font-weight: bold; text-align: center; color: ${isObtained ? '#e2e8f0' : '#94a3b8'};">
                                        ${isObtained ? card.name : '???'}
                                    </div>
                                    <div style="font-size: 10px; color: #94a3b8; text-align: center; margin-top: 4px;">
                                        ${isObtained ? `æ‰€æŒ: ${entry.count}æš` : entry.hints}
                                    </div>
                                    ${isObtained && entry.firstObtained ? `
                                        <div style="font-size: 9px; color: #64748b; text-align: center; margin-top: 4px;">
                                            åˆå›: ${new Date(entry.firstObtained).toLocaleDateString()}
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="margin-top: 20px; padding: 12px; background: rgba(59, 130, 246, 0.15); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.3);">
                        <div style="font-size: 12px; color: #94a3b8;">
                            ğŸ’¡ ãƒ’ãƒ³ãƒˆ: ã‚«ãƒ¼ãƒ‰ã¯ç¿’æ…£é”æˆæ™‚ã‚„ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«ç²å¾—ã§ãã¾ã™ã€‚å…¨ç¨®é¡é›†ã‚ã¦å›³é‘‘ã‚’ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆã—ã‚ˆã†ï¼
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // é–²è¦§å±¥æ­´ã‚’è¨˜éŒ²
            data.cardAlbum.viewHistory.push(new Date().toISOString());
            if (data.cardAlbum.viewHistory.length > 100) {
                data.cardAlbum.viewHistory = data.cardAlbum.viewHistory.slice(-100);
            }
            saveData(data);
        }

        function debugAchieveAllPast() {
            if (!window.currentHypothesis) return;
            
            const startDate = new Date(window.currentHypothesis.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // é–‹å§‹æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®å…¨ã¦ã®æ—¥ã‚’é”æˆã«ã™ã‚‹
            const currentDate = new Date(startDate);
            while (currentDate <= today) {
                const dateKey = dateKeyLocal(currentDate);
                window.currentHypothesis.achievements[dateKey] = true;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();
            showNotification('ğŸ“… éå»å…¨ã¦ã‚’é”æˆã«ã—ã¾ã—ãŸ', 'success');
        }
        
        function debugSkipDays() {
            if (!window.currentHypothesis) return;
            
            if (!confirm('ç¿’æ…£ã®é–‹å§‹æ—¥ã‚’3æ—¥å‰ã«ãšã‚‰ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // é–‹å§‹æ—¥ã‚’3æ—¥å‰ã«ãšã‚‰ã™
            const startDate = new Date(window.currentHypothesis.startDate);
            startDate.setDate(startDate.getDate() - 3);
            window.currentHypothesis.startDate = startDate.toISOString();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();  // å³åº§ã«é€²æ—ã‚’æ›´æ–°
            showNotification('â© æ—¥ä»˜ã‚’3æ—¥é€²ã‚ã¾ã—ãŸ', 'success');
        }
        
        function debugCompleteHypothesis() {
            if (!window.currentHypothesis) return;
            
            if (!confirm('ç¿’æ…£ã‚’å¼·åˆ¶çš„ã«å®Œäº†ã•ã›ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            // é–‹å§‹æ—¥ã‚’ totalDays æ—¥å‰ã«ãšã‚‰ã—ã¦æœŸé–“ã‚’çµ‚äº†ã•ã›ã‚‹ï¼ˆæœ€çµ‚æ—¥ã«ã™ã‚‹ï¼‰
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const newStartDate = new Date(today);
            newStartDate.setDate(today.getDate() - window.currentHypothesis.totalDays + 1);
            window.currentHypothesis.startDate = newStartDate.toISOString();
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const data = loadData();
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
                saveData(data);
            }
            
            updateCalendar();
            updateProgress();  // å³åº§ã«é€²æ—ã‚’æ›´æ–°
            showNotification('ğŸ ç¿’æ…£ã‚’å®Œäº†çŠ¶æ…‹ã«ã—ã¾ã—ãŸ', 'success');
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®æœ‰åŠ¹åŒ–ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§åˆ¶å¾¡ï¼‰
        function checkDebugMode() {
            const urlParams = new URLSearchParams(window.location.search);
            const debugMode = urlParams.get('debug') === 'true' || localStorage.getItem('debugMode') === 'true';
            
            if (debugMode) {
                const debugPanel = document.getElementById('debug-panel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                }
                // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ›´æ–°
                const debugToggle = document.getElementById('debug-toggle');
                if (debugToggle) {
                    debugToggle.style.background = 'var(--error)';
                    debugToggle.style.color = 'white';
                    debugToggle.style.border = 'none';
                }
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®ãƒˆã‚°ãƒ«
        function toggleDebugMode() {
            const currentMode = localStorage.getItem('debugMode') === 'true';
            const newMode = !currentMode;
            localStorage.setItem('debugMode', newMode.toString());
            
            const debugPanel = document.getElementById('debug-panel');
            const debugToggle = document.getElementById('debug-toggle');
            
            if (newMode) {
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                }
                if (debugToggle) {
                    debugToggle.style.background = 'var(--error)';
                    debugToggle.style.color = 'white';
                    debugToggle.style.border = 'none';
                }
                showNotification('ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ', 'success');
            } else {
                if (debugPanel) {
                    debugPanel.style.display = 'none';
                }
                if (debugToggle) {
                    debugToggle.style.background = 'none';
                    debugToggle.style.color = 'var(--text-secondary)';
                    debugToggle.style.border = '1px solid var(--border)';
                }
                showNotification('ğŸ› ï¸ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸ', 'info');
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ï¼šã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
        function debugAddCard(cardId) {
            const data = loadData();
            
            data.cards.inventory.push({
                cardId: cardId,
                acquiredDate: new Date().toISOString(),
                used: false
            });
            
            saveData(data);
            updateCardUseButton();
            
            const card = CARD_MASTER[cardId];
            showNotification(`ğŸ´ ${card.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸ`, 'success');
            
            // ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆãƒœãƒ¼ãƒŠã‚¹ã®å ´åˆã¯å³åº§ã«æœ‰åŠ¹åŒ–
            if (cardId === 'perfect_bonus') {
                updatePerfectBonusIndicator();
            }
        }
        
        // ãƒ‡ãƒãƒƒã‚°ï¼šãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœã‚’é©ç”¨
        function debugApplyPenalty(penaltyId) {
            if (!window.currentHypothesis && penaltyId !== 'double_or_nothing') {
                showNotification('âš ï¸ é€²è¡Œä¸­ã®ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const card = CARD_MASTER[penaltyId];
            
            switch(penaltyId) {
                case 'extension_card':
                    // æœŸé–“ã‚’å»¶é•·
                    window.currentHypothesis.totalDays += 3;
                    updateCalendar();
                    updateProgress();
                    showCardEffect('å»¶é•·ã‚«ãƒ¼ãƒ‰ç™ºå‹•ï¼', 'æ¤œè¨¼æœŸé–“ãŒ3æ—¥å»¶é•·ã•ã‚Œã¾ã—ãŸ', '#ef4444');
                    break;
                    
                case 'hard_mode':
                    // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
                    window.currentHypothesis.hardMode = true;
                    updatePenaltyIndicators();
                    showCardEffect('ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ç™ºå‹•ï¼', '90%ä»¥ä¸Šã®é”æˆç‡ãŒå¿…è¦ã«ãªã‚Šã¾ã—ãŸ', '#dc2626');
                    break;
                    
                case 'reset_risk':
                    // ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ã‚’æœ‰åŠ¹åŒ–
                    window.currentHypothesis.resetRisk = true;
                    updatePenaltyIndicators();
                    showCardEffect('ãƒªã‚»ãƒƒãƒˆãƒªã‚¹ã‚¯ç™ºå‹•ï¼', '3æ—¥é€£ç¶šæœªé”æˆã§å…¨ã¦ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™', '#dc2626');
                    break;
                    
                case 'achievement_decrease':
                    // é”æˆç‡æ¸›å°‘ã‚’è¨­å®š
                    window.currentHypothesis.achievementDecrease = 10;
                    updatePenaltyIndicators();
                    showCardEffect('é”æˆç‡æ¸›å°‘ç™ºå‹•ï¼', 'æœ€çµ‚é”æˆç‡ã‹ã‚‰10%æ¸›å°‘ã—ã¾ã™', '#ef4444');
                    break;
                    
                case 'chaos_vortex':
                    // æ··ä¹±ã®æ¸¦ã‚’ç™ºå‹•
                    applyChaosVortex();
                    break;
                    
                case 'double_or_nothing':
                    // ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ã‚’è¨­å®š
                    window.doubleOrNothingActive = true;
                    showCardEffect('ãƒ€ãƒ–ãƒ«ã‚ªã‚¢ãƒŠãƒƒã‚·ãƒ³ã‚°ç™ºå‹•ï¼', 'æ¬¡ã®ç¿’æ…£ã§100%é”æˆã—ãªã„ã¨ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰2æš', '#dc2626');
                    const data = loadData();
                    if (!data.cards.activeEffects) data.cards.activeEffects = [];
                    data.cards.activeEffects.push({
                        cardId: 'double_or_nothing',
                        activatedDate: new Date().toISOString()
                    });
                    saveData(data);
                    break;
                    
                case 'event_seal':
                    // ã‚¤ãƒ™ãƒ³ãƒˆå°å°åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                    const sealData = loadData();
                    const sealStart = new Date();
                    const sealEnd = new Date();
                    sealEnd.setDate(sealEnd.getDate() + 3);
                    if (!sealData.cards.activeEffects) sealData.cards.activeEffects = [];
                    sealData.cards.activeEffects.push({
                        type: 'event_seal',
                        startDate: sealStart.toISOString(),
                        endDate: sealEnd.toISOString()
                    });
                    saveData(sealData);
                    showCardEffect('ã‚¤ãƒ™ãƒ³ãƒˆå°å°ç™ºå‹•ï¼', '3æ—¥é–“ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã›ã‚“', '#64748b');
                    break;
                    
                case 'mission_overload':
                    // ãƒŸãƒƒã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã«2ã¤è¿½åŠ ï¼‰
                    window.additionalMissions = 2;
                    showCardEffect('ãƒŸãƒƒã‚·ãƒ§ãƒ³è¿½åŠ ç™ºå‹•ï¼', 'ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒ2ã¤è¿½åŠ ã•ã‚Œã¾ã—ãŸ', '#991b1b');
                    break;
                    
                case 'slowdown':
                    // ãƒã‚¤ãƒ³ãƒˆ0.5å€åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                    const slowData = loadData();
                    const slowStart = new Date();
                    const slowEnd = new Date();
                    slowEnd.setDate(slowEnd.getDate() + 3);
                    if (!slowData.cards.activeEffects) slowData.cards.activeEffects = [];
                    slowData.cards.activeEffects.push({
                        type: 'slowdown',
                        startDate: slowStart.toISOString(),
                        endDate: slowEnd.toISOString()
                    });
                    saveData(slowData);
                    showCardEffect('ã‚¹ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³ç™ºå‹•ï¼', '3æ—¥é–“ç²å¾—ãƒã‚¤ãƒ³ãƒˆãŒ0.5å€ã«ãªã‚Šã¾ã™', '#7c2d12');
                    break;
                    
                case 'reverse_curse':
                    // é€†è»¢ã®å‘ªã„åŠ¹æœã‚’3æ—¥é–“é©ç”¨
                    const curseData = loadData();
                    const curseStart = new Date();
                    const curseEnd = new Date();
                    curseEnd.setDate(curseEnd.getDate() + 3);
                    if (!curseData.cards.activeEffects) curseData.cards.activeEffects = [];
                    curseData.cards.activeEffects.push({
                        type: 'reverse_curse',
                        startDate: curseStart.toISOString(),
                        endDate: curseEnd.toISOString()
                    });
                    saveData(curseData);
                    showCardEffect('é€†è»¢ã®å‘ªã„ç™ºå‹•ï¼', '3æ—¥é–“ã€é”æˆã¨æœªé”æˆã®åŠ¹æœãŒåè»¢ã—ã¾ã™', '#581c87');
                    break;
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆdouble_or_nothingä»¥å¤–ï¼‰
            if (window.currentHypothesis && penaltyId !== 'double_or_nothing') {
                const data = loadData();
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index] = window.currentHypothesis;
                    saveData(data);
                }
            }
            
            showNotification(`âš ï¸ ${card.name}ã®åŠ¹æœã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'error');
        }
        
        // ãƒ‡ãƒãƒƒã‚°ï¼šå…¨ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢
        function debugClearAllCards() {
            if (!confirm('å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã¨åŠ¹æœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ã‚¯ãƒªã‚¢
            data.cards.inventory = [];
            data.cards.pendingPenalties = [];
            data.cards.activeEffects = [];
            
            // ç¾åœ¨ã®ç¿’æ…£ã®ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœã‚’ã‚¯ãƒªã‚¢
            if (window.currentHypothesis) {
                window.currentHypothesis.hardMode = false;
                window.currentHypothesis.resetRisk = false;
                window.currentHypothesis.achievementDecrease = 0;
                
                const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
                if (index !== -1) {
                    data.currentHypotheses[index] = window.currentHypothesis;
                }
            }
            
            saveData(data);
            
            // UIã‚’æ›´æ–°
            updateCardUseButton();
            updatePerfectBonusIndicator();
            updatePenaltyIndicators();
            
            showNotification('ğŸ—‘ï¸ å…¨ã¦ã®ã‚«ãƒ¼ãƒ‰ã¨åŠ¹æœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }
        
        // æ··ä¹±ã®æ¸¦ã‚’é©ç”¨
        function applyChaosVortex() {
            if (!window.currentHypothesis) return;
            
            const startDate = new Date(window.currentHypothesis.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            startDate.setHours(0, 0, 0, 0);
            
            // ç¾åœ¨ã¾ã§ã®æ—¥ä»˜ãƒªã‚¹ãƒˆã‚’ä½œæˆ
            const dates = [];
            const currentDate = new Date(startDate);
            while (currentDate <= today && dates.length < window.currentHypothesis.totalDays) {
                dates.push(dateKeyLocal(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«3æ—¥ã‚’é¸æŠ
            const shuffledDates = [...dates].sort(() => Math.random() - 0.5).slice(0, 3);
            
            // é¸æŠã•ã‚ŒãŸæ—¥ã®é”æˆçŠ¶æ…‹ã‚’åè»¢
            shuffledDates.forEach(dateKey => {
                if (window.currentHypothesis.achievements[dateKey]) {
                    delete window.currentHypothesis.achievements[dateKey];
                } else {
                    window.currentHypothesis.achievements[dateKey] = true;
                }
            });
            
            updateCalendar();
            updateProgress();
            
            showCardEffect('æ··ä¹±ã®æ¸¦ç™ºå‹•ï¼', `${shuffledDates.length}æ—¥åˆ†ã®é”æˆ/æœªé”æˆãŒå…¥ã‚Œæ›¿ã‚ã‚Šã¾ã—ãŸ`, '#dc2626');
        }
        
        // ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨
        function useProtectShield() {
            closeCardUseMenu();
            
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'protect_shield' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«è¿½åŠ 
            if (!data.cards.activeEffects) {
                data.cards.activeEffects = [];
            }
            
            data.cards.activeEffects.push({
                cardId: 'protect_shield',
                activatedDate: new Date().toISOString()
            });
            
            saveData(data);
            
            showNotification('ğŸ›¡ï¸ ãƒ—ãƒ­ãƒ†ã‚¯ãƒˆã‚·ãƒ¼ãƒ«ãƒ‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼\næ¬¡ã®ç¿’æ…£ã§ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™', 'success');
        }
        
        // é”æˆç‡ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ã‚’ä½¿ç”¨
        function useAchievementBooster() {
            closeCardUseMenu();
            
            if (!window.currentHypothesis || window.currentHypothesis.completed) {
                showNotification('âš ï¸ é€²è¡Œä¸­ã®ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'achievement_booster' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ é”æˆç‡ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«è¿½åŠ ï¼ˆã“ã®ç¿’æ…£ã«ç´ã¥ãï¼‰
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            data.cards.activeEffects.push({
                cardId: 'achievement_booster',
                activatedDate: new Date().toISOString(),
                targetHypothesisId: window.currentHypothesis.id
            });
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                // ç¿’æ…£æœ¬ä½“ã®å¤‰æ›´ã¯ä¸è¦
            }
            
            saveData(data);
            
            showCardEffect('é”æˆç‡ãƒ–ãƒ¼ã‚¹ã‚¿ãƒ¼ç™ºå‹•ï¼', 'æœ€çµ‚é”æˆç‡ã«+15%ã®ãƒœãƒ¼ãƒŠã‚¹ãŒä»˜ä¸ã•ã‚Œã¾ã™', '#3b82f6');
        }
        
        // ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ã‚’ä½¿ç”¨
        function useSecondChance() {
            closeCardUseMenu();
            
            if (!window.currentHypothesis) {
                showNotification('âš ï¸ é€²è¡Œä¸­ã®ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            const startDate = new Date(window.currentHypothesis.startDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            startDate.setHours(0, 0, 0, 0);
            
            // çµŒéæ—¥æ•°ã‚’è¨ˆç®—
            const timeDiff = today.getTime() - startDate.getTime();
            const daysPassed = Math.max(1, Math.floor(timeDiff / (1000 * 60 * 60 * 24)) + 1);
            
            // ã¾ã æœŸé–“ãŒçµ‚ã‚ã£ã¦ã„ãªã„å ´åˆã¯ä½¿ç”¨ä¸å¯
            if (daysPassed < window.currentHypothesis.totalDays) {
                showNotification('âš ï¸ ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ã¯ç¿’æ…£çµ‚äº†å¾Œã«ä½¿ç”¨ã§ãã¾ã™', 'error');
                return;
            }
            
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'second_chance' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // æœŸé–“ã‚’3æ—¥å»¶é•·
            window.currentHypothesis.totalDays += 3;
            window.currentHypothesis.secondChanceUsed = true;
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            const index = data.currentHypotheses.findIndex(h => h.id === window.currentHypothesis.id);
            if (index !== -1) {
                data.currentHypotheses[index] = window.currentHypothesis;
            }
            
            saveData(data);
            
            // UIã‚’æ›´æ–°
            updateCalendar();
            updateProgress();
            
            showCardEffect('ã‚»ã‚«ãƒ³ãƒ‰ãƒãƒ£ãƒ³ã‚¹ç™ºå‹•ï¼', '3æ—¥åˆ†ã®è¿½åŠ ãƒãƒ£ãƒ³ã‚¹ã‚’ç²å¾—ã—ã¾ã—ãŸ', '#10b981');
        }

        // æ–°ã—ã„ã‚«ãƒ¼ãƒ‰åŠ¹æœé–¢æ•°

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼
        function useEventTrigger() {
            closeCardUseMenu();
            const data = loadData();
            
            // ã‚«ãƒ¼ãƒ‰ã‚’æ¶ˆè²»
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'event_trigger' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒªã‚¬ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // æ˜æ—¥ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®šã•ã›ã‚‹
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().split('T')[0];
            
            if (!data.events) data.events = {};
            if (!data.events.forcedEvents) data.events.forcedEvents = {};
            data.events.forcedEvents[tomorrowStr] = true;
            
            saveData(data);
            showNotification('ğŸª æ˜æ—¥ã¯å¿…ãšã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ï¼', 'success');
            updateCardUseButton();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ³ãƒœ
        function useEventCombo() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'event_combo' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ã‚¤ãƒ™ãƒ³ãƒˆã‚³ãƒ³ãƒœãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // 3æ—¥é–“é€£ç¶šã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºå®š
            if (!data.events) data.events = {};
            if (!data.events.forcedEvents) data.events.forcedEvents = {};
            
            for (let i = 1; i <= 3; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                data.events.forcedEvents[dateStr] = true;
            }
            
            saveData(data);
            showNotification('ğŸ”® 3æ—¥é–“é€£ç¶šã§ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç”Ÿã—ã¾ã™ï¼', 'success');
            updateCardUseButton();
        }

        // ãƒã‚¤ãƒ³ãƒˆã‚¸ã‚§ãƒ 
        function usePointGem() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'point_gem' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒã‚¤ãƒ³ãƒˆã‚¸ã‚§ãƒ ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // 3æ—¥é–“ãƒã‚¤ãƒ³ãƒˆ2å€åŠ¹æœã‚’ä»˜ä¸
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 3);
            
            data.cards.activeEffects.push({
                cardId: 'point_gem',
                type: 'point_multiplier',
                multiplier: 2,
                startDate: today.toISOString(),
                endDate: endDate.toISOString()
            });
            
            saveData(data);
            showNotification('ğŸ’ 3æ—¥é–“ãƒã‚¤ãƒ³ãƒˆãŒ2å€ã«ãªã‚Šã¾ã™ï¼', 'success');
            updateCardUseButton();
        }

        // ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ãƒ¼
        function useMissionMaster() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'mission_master' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒŸãƒƒã‚·ãƒ§ãƒ³ãƒã‚¹ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•é”æˆ
            const today = new Date().toISOString().split('T')[0];
            if (!data.challenges) data.challenges = {};
            if (!data.challenges.daily) data.challenges.daily = {};
            if (!data.challenges.missions) data.challenges.missions = {};
            
            // ãƒ‡ã‚¤ãƒªãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚’ã™ã¹ã¦é”æˆæ‰±ã„ã«ã™ã‚‹
            const dailyMissions = ['3habits', '5achievements_C', 'continuous_3days', 'morning_achievement', 
                                   'effort_bonus_5pt', 'all_categories', 'perfect_1habit', 'weekend_10habits',
                                   'weekday_consistency', 'evening_achievement', 'total_20pt', 'any_challenge'];
            
            dailyMissions.forEach(missionId => {
                if (!data.challenges.missions[missionId]) {
                    data.challenges.missions[missionId] = {};
                }
                data.challenges.missions[missionId][today] = true;
            });
            
            saveData(data);
            showNotification('ğŸ¯ ä»Šæ—¥ã®ãƒŸãƒƒã‚·ãƒ§ãƒ³ãŒã™ã¹ã¦é”æˆã•ã‚Œã¾ã—ãŸï¼', 'success');
            updateCardUseButton();
            updateChallenges();
        }

        // ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ–ãƒ¼ã‚¹ãƒˆ
        function useRainbowBoost() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'rainbow_boost' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼ãƒ–ãƒ¼ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ä»Šæ—¥ã®ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ2å€
            const today = new Date();
            const endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            data.cards.activeEffects.push({
                cardId: 'rainbow_boost',
                type: 'all_category_boost',
                multiplier: 2,
                startDate: today.toISOString(),
                endDate: endDate.toISOString()
            });
            
            saveData(data);
            showNotification('ğŸŒˆ ä»Šæ—¥ã¯ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã§ãƒã‚¤ãƒ³ãƒˆ2å€ï¼', 'success');
            updateCardUseButton();
        }

        // ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ
        function useQuickStart() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'quick_start' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // æ¬¡ã®ç¿’æ…£ä½œæˆæ™‚ã«åŠ¹æœã‚’é©ç”¨ã™ã‚‹ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            if (!data.cards.pendingEffects) data.cards.pendingEffects = [];
            data.cards.pendingEffects.push({
                cardId: 'quick_start',
                type: 'auto_achieve_first_days',
                days: 3
            });
            
            saveData(data);
            showNotification('âš¡ æ¬¡ã®ç¿’æ…£ã®æœ€åˆã®3æ—¥ãŒè‡ªå‹•é”æˆã•ã‚Œã¾ã™ï¼', 'success');
            updateCardUseButton();
        }

        // é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹
        function useStreakBonus() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'streak_bonus' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ é€£ç¶šé”æˆãƒœãƒ¼ãƒŠã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // 7æ—¥é€£ç¶šé”æˆã§ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ç¢ºå®š
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 7);
            
            data.cards.activeEffects.push({
                cardId: 'streak_bonus',
                type: 'streak_rare_guarantee',
                targetDays: 7,
                startDate: today.toISOString(),
                endDate: endDate.toISOString()
            });
            
            saveData(data);
            showNotification('ğŸ”¥ 7æ—¥é€£ç¶šé”æˆã§ãƒ¬ã‚¢ã‚«ãƒ¼ãƒ‰ç¢ºå®šï¼', 'success');
            updateCardUseButton();
        }

        // ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³
        function useLuckySeven() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'lucky_seven' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒ–ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // 7æ—¥é–“ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ç‡2å€
            if (!data.cards.activeEffects) data.cards.activeEffects = [];
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(endDate.getDate() + 7);
            
            data.cards.activeEffects.push({
                cardId: 'lucky_seven',
                type: 'drop_rate_boost',
                multiplier: 2,
                startDate: today.toISOString(),
                endDate: endDate.toISOString()
            });
            
            saveData(data);
            showNotification('ğŸ° 7æ—¥é–“ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ—ç‡ãŒ2å€ã«ãªã‚Šã¾ã—ãŸï¼', 'success');
            updateCardUseButton();
        }

        // å¤‰æ›ã®é­”æ³•
        function useConversionMagic() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'conversion_magic' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ å¤‰æ›ã®é­”æ³•ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’æ¢ã™
            const penaltyCards = data.cards.inventory.filter(
                card => !card.used && CARD_MASTER[card.cardId] && CARD_MASTER[card.cardId].type === 'penalty'
            );
            
            if (penaltyCards.length === 0) {
                showNotification('âš ï¸ å¤‰æ›ã§ãã‚‹ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
            const targetCard = penaltyCards[Math.floor(Math.random() * penaltyCards.length)];
            const targetIndex = data.cards.inventory.indexOf(targetCard);
            
            // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã«ã™ã‚‹
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            data.cards.inventory.splice(targetIndex, 1);
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªå ±é…¬ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
            const rewardCards = Object.keys(CARD_MASTER).filter(
                id => CARD_MASTER[id].type === 'reward'
            );
            const newCardId = rewardCards[Math.floor(Math.random() * rewardCards.length)];
            
            data.cards.inventory.push({
                cardId: newCardId,
                acquiredDate: new Date().toISOString(),
                used: false
            });
            
            // ã‚«ãƒ¼ãƒ‰å›³é‘‘ã«ç™»éŒ²
            registerCardToAlbum(newCardId);
            
            saveData(data);
            showNotification(`ğŸª„ ${CARD_MASTER[targetCard.cardId].name}ã‚’${CARD_MASTER[newCardId].name}ã«å¤‰æ›ã—ã¾ã—ãŸï¼`, 'success');
            updateCardUseButton();
        }

        // é‹å‘½ã®ãƒ€ã‚¤ã‚¹
        function useFateDice() {
            closeCardUseMenu();
            const data = loadData();
            
            const cardIndex = data.cards.inventory.findIndex(
                card => card.cardId === 'fate_dice' && !card.used
            );
            
            if (cardIndex === -1) {
                showNotification('âš ï¸ é‹å‘½ã®ãƒ€ã‚¤ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }
            
            data.cards.inventory[cardIndex].used = true;
            data.cards.inventory[cardIndex].usedDate = new Date().toISOString();
            
            // 50/50ã§å ±é…¬ã‹ãƒšãƒŠãƒ«ãƒ†ã‚£
            const isReward = Math.random() < 0.5;
            
            if (isReward) {
                // å ±é…¬åŠ¹æœï¼š10-30ãƒã‚¤ãƒ³ãƒˆç²å¾—
                const points = Math.floor(Math.random() * 21) + 10;
                earnPoints(points, `é‹å‘½ã®ãƒ€ã‚¤ã‚¹ï¼ˆå¤§å½“ãŸã‚Šï¼ï¼‰`);
                showNotification(`ğŸ² å¤§å½“ãŸã‚Šï¼${points}ãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼`, 'success');
            } else {
                // ãƒšãƒŠãƒ«ãƒ†ã‚£åŠ¹æœï¼š5-15ãƒã‚¤ãƒ³ãƒˆå¤±ã†
                const points = Math.floor(Math.random() * 11) + 5;
                data.pointSystem.currentPoints = Math.max(0, data.pointSystem.currentPoints - points);
                addTransaction(-points, 'penalty', 'é‹å‘½ã®ãƒ€ã‚¤ã‚¹ï¼ˆãƒã‚ºãƒ¬ï¼‰');
                showNotification(`ğŸ² æ®‹å¿µ...${points}ãƒã‚¤ãƒ³ãƒˆå¤±ã„ã¾ã—ãŸ`, 'error');
            }
            
            saveData(data);
            updateCardUseButton();
            updatePointsDisplay();
        }
        
        // é€šçŸ¥ã‚’è¡¨ç¤º
        // ========== ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
        
        // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportAllData() {
            try {
                const data = loadData();
                
                // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
                const exportData = {
                    version: '1.0.0',
                    exportDate: new Date().toISOString(),
                    appVersion: 'PDCA-Lab v3.3.0',
                    data: {
                        // ç¿’æ…£ãƒ‡ãƒ¼ã‚¿
                        currentHypotheses: data.currentHypotheses || [],
                        completedHypotheses: data.completedHypotheses || [],
                        
                        // ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
                        pointSystem: data.pointSystem || {
                            currentPoints: 0,
                            lifetimeEarned: 0,
                            lifetimeSpent: 0,
                            currentLevel: 1,
                            levelProgress: 0,
                            transactions: [],
                            customRewards: [],
                            dailyEffortUsed: 0,
                            dailyEffortLastReset: null
                        },
                        
                        // ãƒãƒ£ãƒ¬ãƒ³ã‚¸
                        challenges: data.challenges || {
                            daily: {},
                            weekly: {},
                            customChallenges: [],
                            completedToday: [],
                            completedThisWeek: [],
                            history: [],
                            streak: 0,
                            lastStreakDate: null
                        },
                        
                        // ã‚«ãƒ¼ãƒ‰
                        cards: data.cards || {
                            inventory: [],
                            activeEffects: [],
                            pendingPenalties: []
                        },
                        
                        // ã‚¤ãƒ™ãƒ³ãƒˆ
                        events: data.events || {
                            activeBoosts: [],
                            lastEventDate: null,
                            milestoneRewards: {}
                        },
                        
                        // ã‚«ãƒ¼ãƒ‰å›³é‘‘
                        cardAlbum: data.cardAlbum || {
                            collection: {},
                            totalCardsObtained: 0,
                            rewardsEarned: []
                        },
                        
                        // ãƒãƒƒã‚¸
                        badges: data.badges || {
                            earned: []
                        },
                        
                        // ãƒ‡ã‚¤ãƒªãƒ¼ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
                        dailyJournal: data.dailyJournal || {
                            entries: {},
                            stats: {
                                currentStreak: 0,
                                longestStreak: 0,
                                totalEntries: 0,
                                lastEntry: null
                            },
                            settings: {
                                morningReminderTime: "06:00",
                                eveningReminderTime: "21:00",
                                remindersEnabled: true
                            }
                        },
                        
                        // UIè¨­å®š
                        uiSettings: data.uiSettings || {
                            categoryOpenStates: {},
                            lastOpenedView: 'home'
                        }
                    }
                };
                
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const dateStr = new Date().toISOString().split('T')[0];
                a.href = url;
                a.download = `pdca-lab-backup-${dateStr}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                console.log('ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†:', exportData);
                
            } catch (error) {
                console.error('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showNotification('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆçµ±ä¸€ç‰ˆï¼‰
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    let dataToImport = null;
                    let exportDate = 'Unknown';
                    
                    console.log('ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç¢ºèª:', importedData);
                    
                    // æ–°å½¢å¼ï¼ˆv2.0ï¼‰ã®ãƒã‚§ãƒƒã‚¯
                    if (importedData.version === '2.0' && importedData.data) {
                        dataToImport = importedData.data;
                        exportDate = importedData.exportDate || 'Unknown';
                        console.log('v2.0å½¢å¼ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
                    }
                    // æ—§å½¢å¼ï¼ˆv1.0ï¼‰ã®ãƒã‚§ãƒƒã‚¯
                    else if (importedData.version === '1.0') {
                        // æ—§å½¢å¼ã‹ã‚‰æ–°å½¢å¼ã«å¤‰æ›
                        const currentData = loadData();
                        dataToImport = {
                            ...currentData,
                            currentHypotheses: importedData.currentHabits || importedData.currentHypotheses || [],
                            completedHypotheses: importedData.completedHabits || importedData.completedHypotheses || [],
                            badges: importedData.badges || {},
                            cards: importedData.cards || currentData.cards
                        };
                        exportDate = importedData.exportDate || 'Unknown';
                        console.log('v1.0å½¢å¼ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¤‰æ›ï¼‰');
                    }
                    // ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆversionç„¡ã—ã ãŒdataãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚ã‚Šï¼‰
                    else if (importedData.data && typeof importedData.data === 'object') {
                        dataToImport = importedData.data;
                        exportDate = importedData.exportDate || 'Unknown';
                        console.log('ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
                    }
                    // ç›´æ¥ãƒ‡ãƒ¼ã‚¿å½¢å¼ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ãªã—ï¼‰
                    else if (importedData.currentHypotheses !== undefined || 
                             importedData.pointSystem !== undefined ||
                             importedData.dailyJournal !== undefined) {
                        dataToImport = importedData;
                        exportDate = 'Unknown';
                        console.log('ç›´æ¥ãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
                    }
                    else {
                        console.error('èªè­˜ã§ããªã„ãƒ‡ãƒ¼ã‚¿å½¢å¼:', importedData);
                        throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚\n\nPDCA-Labã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèªãƒ»è£œå®Œ
                    if (!dataToImport.currentHypotheses) dataToImport.currentHypotheses = [];
                    if (!dataToImport.completedHypotheses) dataToImport.completedHypotheses = [];
                    if (!dataToImport.cards) dataToImport.cards = { inventory: [], pendingPenalties: [] };
                    if (!dataToImport.badges) dataToImport.badges = {};
                    if (!dataToImport.pointSystem) {
                        dataToImport.pointSystem = {
                            currentPoints: 0,
                            lifetimeEarned: 0,
                            lifetimeSpent: 0,
                            transactions: [],
                            customRewards: []
                        };
                    }
                    if (!dataToImport.dailyJournal) {
                        dataToImport.dailyJournal = {
                            entries: {},
                            stats: {
                                currentStreak: 0,
                                longestStreak: 0,
                                totalEntries: 0,
                                lastEntry: null
                            }
                        };
                    }
                    if (!dataToImport.challengeSystem) {
                        dataToImport.challengeSystem = {
                            daily: [],
                            weekly: [],
                            custom: [],
                            stats: {
                                dailyStreak: 0,
                                weeklyStreak: 0,
                                totalCompleted: 0,
                                dailyCompletedCount: 0,
                                weeklyCompletedCount: 0
                            },
                            history: []
                        };
                    }
                    
                    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
                    const dateStr = exportDate !== 'Unknown' ? `${exportDate} ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸ` : '';
                    if (!confirm(`${dateStr}ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚\n\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                        event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                        return;
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    saveData(dataToImport);
                    
                    showNotification('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
                    console.log('ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†:', dataToImport);
                    
                    // 2ç§’å¾Œã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                    
                } catch (error) {
                    console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                    showNotification('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
                
                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // é€šçŸ¥ã‚­ãƒ¥ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
        let notificationQueue = [];
        let isShowingNotification = false;
        
        function showNotification(message, type = 'info', priority = 0) {
            // é€šçŸ¥ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ï¼ˆpriorityãŒé«˜ã„ã‚‚ã®ã»ã©å„ªå…ˆï¼‰
            notificationQueue.push({ message, type, priority });
            
            // priorityã§ã‚½ãƒ¼ãƒˆï¼ˆé«˜ã„é †ï¼‰
            notificationQueue.sort((a, b) => b.priority - a.priority);
            
            // è¡¨ç¤ºä¸­ã§ãªã‘ã‚Œã°æ¬¡ã®é€šçŸ¥ã‚’è¡¨ç¤º
            if (!isShowingNotification) {
                showNextNotification();
            }
        }
        
        function showNextNotification() {
            if (notificationQueue.length === 0) {
                isShowingNotification = false;
                return;
            }
            
            isShowingNotification = true;
            const { message, type } = notificationQueue.shift();
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 16px 24px;
                border-radius: 12px;
                font-weight: 600;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
                z-index: 3000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                white-space: pre-line;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // è¡¨ç¤ºæ™‚é–“ã‚’èª¿æ•´ï¼ˆé‡è¦ãªé€šçŸ¥ã¯é•·ã‚ã«è¡¨ç¤ºï¼‰
            const displayTime = message.includes('ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—') ? 4000 : 
                               message.includes('é”æˆç‡') ? 3500 : 
                               3000;
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                    // å°‘ã—é–“ã‚’ç©ºã‘ã¦æ¬¡ã®é€šçŸ¥ã‚’è¡¨ç¤º
                    setTimeout(() => {
                        showNextNotification();
                    }, 300);
                }, 300);
            }, displayTime);
        }

        // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
        
        // åˆæœŸåŒ–
        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’åˆæœŸåŒ–
        function initTouchHandlers() {
            let touchTimer = null;
            let touchTarget = null;
            
            document.addEventListener('touchstart', function(e) {
                const target = e.target.closest('.journal-entry-item');
                if (target && (target.dataset.type === 'morning' || target.dataset.type === 'evening')) {
                    const data = loadData();
                    const todayKey = dateKeyLocal(new Date());
                    const todayEntry = data.dailyJournal?.entries?.[todayKey];
                    
                    // ã‚¨ãƒ³ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿é•·æŠ¼ã—ã‚’æœ‰åŠ¹åŒ–
                    const hasEntry = target.dataset.type === 'morning' 
                        ? todayEntry?.morning?.timestamp
                        : todayEntry?.evening?.timestamp;
                    
                    if (hasEntry) {
                        touchTarget = target;
                        touchTimer = setTimeout(() => {
                            // é•·æŠ¼ã—ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                            const touch = e.touches[0];
                            showJournalContextMenu({
                                preventDefault: () => {},
                                clientX: touch.clientX,
                                clientY: touch.clientY
                            }, target.dataset.type);
                            
                            // æŒ¯å‹•ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã®ã¿ï¼‰
                            if (navigator.vibrate) {
                                navigator.vibrate(50);
                            }
                        }, 500); // 500msé•·æŠ¼ã—
                    }
                }
            });
            
            document.addEventListener('touchend', function() {
                if (touchTimer) {
                    clearTimeout(touchTimer);
                    touchTimer = null;
                }
                touchTarget = null;
            });
            
            document.addEventListener('touchmove', function() {
                if (touchTimer) {
                    clearTimeout(touchTimer);
                    touchTimer = null;
                }
                touchTarget = null;
            });
        }
        
        // DOMãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰å„ç¨®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeApp();
                initTouchHandlers();
            });
        } else {
            // ã™ã§ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
            initializeApp();
            initTouchHandlers();
        }
        
        function initializeApp() {
            // ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
            initializeTheme();
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–
            updateCategoryDropdowns();
            
            // ãƒ›ãƒ¼ãƒ ç”»é¢ã‚’è¡¨ç¤ºï¼ˆã“ã‚ŒãŒç¿’æ…£ãƒªã‚¹ãƒˆã‚‚æ›´æ–°ã™ã‚‹ï¼‰
            showHomeView();
            
            // ãƒã‚¤ãƒ³ãƒˆè¡¨ç¤ºã‚’åˆæœŸåŒ–
            updatePointDisplay();
            
            // åŠªåŠ›ãƒœãƒ¼ãƒŠã‚¹ã‚¨ãƒªã‚¢ã‚’åˆæœŸåŒ–
            updateEffortBonusArea();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
            checkDailyEvents();
            
            // ã‚«ãƒ¼ãƒ‰å›³é‘‘åˆæœŸåŒ–
            initializeCardAlbum();
            
            // å±¥æ­´åˆæœŸåŒ–ï¼ˆãƒ›ãƒ¼ãƒ ã‚’ç¾åœ¨ã®çŠ¶æ…‹ã¨ã—ã¦è¨˜éŒ²ï¼‰
            try {
                history.replaceState({ view: 'home' }, '');
            } catch (e) { 
                /* noop */
            }
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æœŸé–“ã‚’è¨­å®š
            selectDuration('medium');
            
            // é–‹å§‹æ—¥ã®åˆæœŸè¨­å®š
            setStartDate('today');
        }

        // ç‰©ç†æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆpopstateï¼‰ã§ãƒ›ãƒ¼ãƒ ã¸æˆ»ã™
        window.addEventListener('popstate', (event) => {
            const state = event.state || {};
            if (state.view === 'home' || !state.view) {
                // ç¿’æ…£ã®ä¸­èº«ï¼ˆprogressï¼‰ãªã©ã‹ã‚‰æˆ»ã‚‹ â†’ ãƒ›ãƒ¼ãƒ è¡¨ç¤º
                showHomeView();
            }
        });
        
        // åˆæœŸåŒ–é–¢æ•°å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã‚ˆã†ã«ç§»å‹•
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupSwipeListeners();
                checkDebugMode();
                
                // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
                if ('ontouchstart' in window) {
                    addSwipeIndicator();
                }
            });
        } else {
            setupSwipeListeners();
            checkDebugMode();
            
            // ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ã®å ´åˆã®ã¿ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
            if ('ontouchstart' in window) {
                addSwipeIndicator();
            }
        }

        // windowã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«é–¢æ•°ã‚’ç™»éŒ²
        window.initializeCategoryMaster = initializeCategoryMaster;
        window.updateCategoryDropdowns = updateCategoryDropdowns;
        window.editCategoryMaster = editCategoryMaster;
        window.addNewCategory = addNewCategory;
        
        // ãƒ¢ãƒã‚¤ãƒ«ã®ã‚ºãƒ¼ãƒ æŠ‘æ­¢ï¼ˆãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ”ãƒ³ãƒï¼‰
        (function preventZoom() {
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            }, { passive: false });
        })();
    </script>
</body>
</html>
